

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bancomicina</title>
<link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
  <style>


/* FORZAR tamaño base de 12px en TODA la app */
html {
  font-size: 12px !important; /* ← Base = 12px en lugar de 16px */
  -webkit-text-size-adjust: none !important; /* Desactiva auto-scaling */
  -moz-text-size-adjust: none !important;
  -ms-text-size-adjust: none !important;
  text-size-adjust: none !important;
}

body {
  font-size: 12px !important; /* Refuerza en body */
  line-height: 1.5;
}

/* Ahora 1rem = 12px (en lugar de 16px) */



@font-face {
  font-family:Lato-Light;
  font-weight:300;
  font-style:normal;
  font-display: swap;
   src: local('Lato Regular'), local('Lato-Regular'),
       url('/fonts/Lato.400.normal.woff2') format('woff2');
}
@font-face {
  font-family:Lato-Light;
  font-weight:300;
  font-style:italic;
  font-display: swap;
   src: local('Lato Regular'), local('Lato-Regular'),
       url('/fonts/Lato.400.normal.woff2') format('woff2');
}
@font-face {
  font-family:Lato-Regular;
  font-weight:400;
  font-style:normal;
  font-display: swap;
  src: local('Lato Regular'), local('Lato-Regular'),
       url('/fonts/Lato.400.normal.woff2') format('woff2');
}
@font-face {
  font-family:Lato;
  font-weight:400;
  font-style:normal;
  font-display: swap;
  src: local('Lato Regular'), local('Lato-Regular'),
       url('/fonts/Lato.400.normal.woff2') format('woff2');
}
@font-face {
  font-family:Lato;
  font-weight:400;
  font-style:italic;
  font-display: swap;
  src: local('Lato Regular'), local('Lato-Regular'),
       url('/fonts/Lato.400.normal.woff2') format('woff2');
}
@font-face {
  font-family:Lato;
  font-weight:700;
  font-style:normal;
  font-display: swap;
 src: local('Lato Regular'), local('Lato-Regular'),
       url('/fonts/Lato.400.normal.woff2') format('woff2');
}
@font-face {
  font-family:Lato;
  font-weight:700;
  font-style:italic;
  font-display: swap;
   src: local('Lato Regular'), local('Lato-Regular'),
       url('/fonts/Lato.400.normal.woff2') format('woff2');
}
@font-face {
  font-family:Lato;
  font-weight:900;
  font-style:normal;
  font-display: swap;
   src: local('Lato Regular'), local('Lato-Regular'),
       url('/fonts/Lato.400.normal.woff2') format('woff2');
}




/* Base tipográfica → usa Lato en todo */
html, body {
  height: 100%;
   margin: 0;
  overflow: hidden; /* evita que el body/html haga scroll */
  font-family: 'Lato', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
}

/* Cualquier zona que antes llevaba Inter: sobreescribe */
.highlighting-bar,
#main-content,
#sidebar,
#subcategoria-content {
  font-family: 'Lato', 'Lato-Regular', 'Lato-Light', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
}


.highlighting-bar {
  font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial;
}



/* === HL close: igual a fav-actions === */
#subcat-header.is-stuck .highlighting-bar .hl-right{ padding-right: 1rem; } /* alinea en X */
#subcat-header.is-stuck .highlighting-bar .hl-close{
  display: inline-flex !important;
  width: 1.5rem; height: 1.5rem;           /* caja como fav */
  align-items: center; justify-content: center;
  color: #475569 !important;               /* color como fav */
}
#subcat-header.is-stuck .highlighting-bar .hl-close i{
  font-size: 1rem;                          /* tamaño de icono como fav */
  line-height: 1;
}


    /* Estilos específicos para la sidebar y el contenido principal */
    .dashboard-container {
        display: flex;
  bottom: 0; 
        height: calc(100vh - 3rem); /* Altura restante de la ventana después del header */
        position: relative; /* Para que la sidebar fixed se posicione correctamente dentro */
    }


    

    #sidebar {
        width: 0; /* Inicialmente cerrada */
        height: 100%; /* Ocupa toda la altura del contenedor padre */
        position: relative; /* Fija la sidebar para que no afecte el flujo del main content */
        top: 0; /* Se posiciona debajo del header */
        left: 0;
        background-color: white;
        border-right: 1px solid #e5e7eb; /* gray-200 */
        overflow-x: hidden; /* Oculta el contenido horizontalmente cuando está cerrada */
        transition: width 0.3s ease, padding 0.3s ease; /* Transición suave para ancho y padding */
        flex-shrink: 0; /* Evita que se encoja */
        z-index: 150 !important; /* Asegura que esté por encima del contenido principal */
        padding-top: 1rem; /* Espacio superior dentro de la sidebar */
    }

    /* Overlay del sidebar principal sobre cualquier otro */
#sidebar.open {
  width: calc(var(--sb-collapsed) + var(--subcat-width));
  /* … */
}
#sidebar.collapsed:hover,
#sidebar.collapsed.hover-expanded {
  position: absolute; /* Sale del flujo y flota sobre el resto */
  top: 0;
  left: 0;
  z-index: 70;       /* Asegúrate de que sea mayor que el secundario */
}

/* Sidebar secundario por debajo */
#subcategoria-sidebar {
  z-index: 140 !important;      /* Menor que el principal */
}
#main-content { overflow-x: clip; } /* o hidden */

    

   #main-content {
    flex-grow: 1;
    margin-left: 0;
    width: 100%;
    padding: 1rem 2.5rem;
    transition: none !important;
    overflow-y: auto;
    overscroll-behavior: contain;  /* ← esta línea */
}

   


    /* Estilos para los elementos internos de la sidebar */
    .sidebar-group {
        margin-bottom: 0px; /* Pequeño espacio entre grupos */
    }
    .sidebar-group a,
    .sidebar-group button {
        padding-left: 12px; /* px-3 = 0.75rem = 12px */
        padding-right: 12px;
        display: flex;
        align-items: center;
        height: 40px; /* Altura de cada elemento para consistencia */
        font-size: 1rem; /* fs-base */
        color: #374151; /* gray-700 */
        width: 100%; /* Asegura que los botones y enlaces ocupen todo el ancho disponible */
        text-align: left; /* Alinea el texto a la izquierda */
        /* Transiciones para suavizar los cambios de estado */
        transition: background-color 0.2s ease, color 0.2s ease, font-weight 0.2s ease;
    }
    .sidebar-group a i,
    .sidebar-group button i:not(.fa-chevron-down) { /* Afecta a los iconos principales, no a la flecha */
      transition: color 0.2s ease;
    }
    .sidebar-group .fa-chevron-down {
        font-size: 0.75rem; /* text-xs = 0.75rem = 12px */
        transition: transform 0.2s ease, color 0.2s ease; /* Transición para la rotación y color de la flecha */
    }
    .sidebar-group .flex.items-center span {
        margin-left: 8px; /* space-x-2 = 0.5rem = 8px */
    }

    .sidebar-group div[id^="accordion-"] a {
        padding-left: 48px; /* ml-8 + px-2 = 2rem + 0.5rem = 40px + 8px = 48px */
        height: 32px; /* py-1 = 0.25rem = 4px + 0.25rem = 4px + 16px (line-height) = 24px, ajuste para que se vea más como en la imagen */
        font-size: 0.875rem; /* text-sm = 0.875rem = 14px */
        color: #6b7280; /* gray-600 */
        transition: background-color 0.2s ease, color 0.2s ease, font-weight 0.2s ease;
    }
    .sidebar-group div[id^="accordion-"].hidden {
        display: none;
    }

    /* Estilo para el enlace o item de submenú activo */
    .active-link {
        background-color: #e0f2fe; /* blue-100 */
        color: #1d4ed8 !important; /* blue-700 */
        font-weight: 500 !important; /* medium */
    }
    .active-link i {
         color: #1d4ed8 !important; /* blue-700 */
    }
    /* Estilo para los botones de grupo cuando su acordeón está abierto */
    .sidebar-group button.accordion-open {
        background-color: #e0f2fe; /* blue-100 */
        color: #1d4ed8; /* blue-700 */
        font-weight: 500; /* medium */
    }
    .sidebar-group button.accordion-open i {
        color: #1d4ed8; /* blue-700 */
    }
    .sidebar-group button.accordion-open .fa-chevron-down {
        transform: rotate(180deg); /* Gira la flecha hacia arriba */
    }

    /* Estilos específicos para los paneles de artículos para coincidir con la imagen */
    .articles-panel-column {
        width: 18rem; /* 288px, para un ancho similar a la imagen */
        flex-shrink: 0; /* Evita que los paneles se encojan */
    }
    #articles-panel {
        align-items: flex-start; /* Asegura que los ítems flex no se estiren verticalmente y se ajusten a su contenido */
    }
    .articles-panel-list-item {
        display: flex;
        align-items: center;
        /* Padding vertical aquí se anula un poco por el divide-y, pero lo dejamos por si acaso */
        padding: 0.5rem 0.75rem; /* py-2 px-3 */
        border-radius: 0.25rem; /* rounded */
        color: #4b5563; /* gray-700 */
        transition: background-color 0.2s ease, color 0.2s ease;
    }
   /* Library: hover sin “línea blanca” debajo */
#articles-panel .articles-panel-column > ul > li { background:#fff; }
#articles-panel .articles-panel-column > ul > li:hover { background:#f3f4f6; }

/* Oculta la divide line del item actual y del siguiente */
#articles-panel .articles-panel-column > ul > li:hover,
#articles-panel .articles-panel-column > ul > li:hover + li {
  border-top-color: transparent !important;
}

/* Mantén el padding en el <a>, pero sin fondo propio */
#articles-panel .articles-panel-column > ul > li > a {
  display:flex; align-items:center;
  padding:.5rem .75rem; border-radius:0;
}
#articles-panel .articles-panel-column > ul > li > a:hover {
  background:transparent !important;
}

/* +2px arriba/abajo para el texto de cada item en las 3 columnas */
#articles-panel .articles-panel-column > ul > li > a {
  padding-top: .8rem !important;   /* antes .5rem */
  padding-bottom: .8rem !important; /* antes .5rem */
}

    .articles-panel-list-item i {
        margin-right: 0.5rem; /* space-x-2 */
        color: #6b7280; /* gray-600 */
    }
    .articles-panel-list-item.selected {
        background-color: #e0f2fe; /* blue-100 */
        color: #1d4ed8; /* blue-700 */
        font-weight: 500;
    }
    .articles-panel-list-item.selected i {
        color: #1d4ed8; /* blue-700 */
    
    }



/* Las 3 columnas del panel (título + card) comparten el mismo ancho */
#articles-panel > .flex.flex-col {
  width: 18rem;         /* = ancho de .articles-panel-column */
  flex-shrink: 0;       /* que no se encoja */
}

/* Por si el título es largo, que envuelva dentro del ancho */
#articles-panel > .flex.flex-col > h2 {
  overflow-wrap: anywhere;  /* permite corte en cualquier punto */
  word-break: break-word;   /* fallback */
}
#sidebar.collapsed .sidebar-group span {
    display: none;
}
#sidebar.collapsed .sidebar-group i {
    margin: auto;
    justify-content: center;
}
#sidebar.collapsed .sidebar-group a,
#sidebar.collapsed .sidebar-group button {
    padding-left: 0;
    padding-right: 0;
}



/* Siempre oculta la flecha en colapsado, incluso cuando está en hover */
#sidebar.collapsed .sidebar-group button .fa-chevron-down {
  display: none !important;
}




/* —— TOC (subcategoria-sidebar) —— */
#subcategoria-sidebar .toc{ padding: .25rem 0; }
#subcategoria-sidebar .toc-section{ margin: .125rem 0; }

/* Título/sección (negro, seminegrita) */
#subcategoria-sidebar .toc-h2{
  width:100%;
  padding: .35rem .65rem; 
  display:block;
  text-align:left;
  background:transparent;
  border:none;
  border-left:0 solid transparent;
  padding:.5rem .75rem;
  font-weight:400;
  font-size:0.85rem;                 /* ~16px */
  color:#111827;                  /* gray-900 */
  border-radius:.5rem;
  cursor:pointer;
}

#subcategoria-sidebar .toc-topic{
  padding:.5rem .75rem;
  font-size:1rem;
  font-weight:600;
  color:#111827;           /* gray-900 */
  background:#fff;
  position:sticky;         /* queda fijo arriba si la lista es larga */
  top:0;
  z-index:5;
}
/* Seleccionado (banda izquierda + fondo suave) */
#subcategoria-sidebar .toc-h2.is-active{
  /* fondo gris */
  background: #f3f4f6;                 /* gray-100 */
  color: #111827;                       /* gray-900 */
  font-weight: 400;

  /* sin radios para que “toque” los bordes */
  border-radius: 0 !important;

  /* hairlines arriba/abajo y borde derecho sutil SIN alterar layout */
  box-shadow:
    inset 2px 0 0 #9ca3af,             /* ← banda izquierda (un poco gruesa) */
    inset 0 .5px 0 #e5e7eb,            /* borde superior fino */
    inset 0 -.5px 0 #e5e7eb,           /* borde inferior fino */
    inset -.5px 0 0 #e5e7eb;           /* borde derecho fino */

  /* asegurá la misma altura/padding que el estado base */
  padding: .5rem .75rem;
}

/* Hover sutil (no cambia la banda ni “salta” de color) */
#subcategoria-sidebar .toc-h2:hover{
  background: #f8fafc;                 /* slate-50 */
}

/* Mantener los subenlaces como están; si querés que el activo haga juego: */
#subcategoria-sidebar .toc-a.is-active{
  background: transparent !important;
  color: #111827 !important;
  font-weight: 500;
  box-shadow: inset 3px 0 0 #9ca3af;   /* mini banda izquierda */
}
/* Quita el padding lateral del contenedor de la TOC */
#subcategoria-sidebar-content{
  padding-left: 0 !important;
  padding-right: 0 !important;
}
/* (opcional) que el item activo no tenga esquinas redondeadas */
#subcategoria-sidebar .toc-h2.is-active{ border-radius: 0; }




/* Variables de anchos para sincronizar el overlay con el TOC */
:root{
  --sb-collapsed: 40px;      /* ya la tienes */
  --subcat-width: 180px;     /* ya la tienes */
  --split-left: 0px;         /* OFFSET desde la izquierda (calculado en JS) */
  --split-w: 50vw;           /* ANCHO del panel derecho (calculado en JS) */
}

/* Split real, pegado al header de 3rem */
#video-modal.split-view{
  position: fixed;
  z-index: 40 !important;
  top: 3rem !important;
  bottom: 0 !important;
  left: var(--split-left) !important;
  width: var(--split-w) !important;
  height: auto !important;
  background-color: transparent !important;
  border-left: 1px solid rgba(229,231,235,.9);
}

/* Quita el viejo “60vw” para el área de lectura o sobrescríbelo */
body.split-view-active .dashboard-container{
  position: fixed;
  top: 3rem;
  bottom: 0;
  left: 0;
  width: calc(var(--split-left)); /* lo que NO ocupa el panel derecho */
  overflow-y: auto;
}


















#subcategoria-sidebar {
  width: var(--subcat-width);         /* mismo ancho que la principal */
  flex-shrink: 0;         /* no se encoja */
  transition: transform 0.3s ease;
}
#subcategoria-sidebar.hidden {
  display: none;
}







  /* 1) Mantener el ancho colapsado por defecto */
#sidebar.collapsed {
  width: var(--sb-collapsed);
  padding-left: 0;
  padding-right: 0;
  position: relative;
  z-index: 50; /* sobre el sub-sidebar */
  transition: width 0.0s ease;
}

/* 2) Mostrar sólo iconos cuando está colapsada */
#sidebar.collapsed .sidebar-group span { display: none; }
#sidebar.collapsed .sidebar-group button i:not(.fa-chevron-down),
#sidebar.collapsed .sidebar-group a i {
  margin: auto;
  justify-content: center;
}

/* 3) En hover o expansión temporal, “desplegar” provisionalmente la sidebar completa */
#sidebar.collapsed:hover,
#sidebar.collapsed.hover-expanded {
  width: calc(var(--sb-collapsed) + var(--subcat-width));           /* ancho del overlay */
  background: rgba(255,255,255,0.95) !important;
  padding-left: 0;          /* ← sin gutter izquierdo */
  padding-right: 0;         /* ← sin gutter derecho */
  box-shadow: 2px 0 8px rgba(0,0,0,0.1);
}

/* 4) Al desplegar, mostrar textos y submenús */
#sidebar.collapsed:hover .sidebar-group span,
#sidebar.collapsed.hover-expanded .sidebar-group span {
  display: inline;         /* reaparecen los labels */
}

#sidebar.collapsed:hover .sidebar-group button.accordion-open i.fa-chevron-down,
#sidebar.collapsed.hover-expanded .sidebar-group button.accordion-open i.fa-chevron-down {
  color: inherit;
}

#sidebar.collapsed:hover .sidebar-group a,
#sidebar.collapsed:hover .sidebar-group button,
#sidebar.collapsed.hover-expanded .sidebar-group a,
#sidebar.collapsed.hover-expanded .sidebar-group button {
  justify-content: flex-start; /* Alínea a la izquierda */
  padding-left: 12px;
  padding-right: 12px;
}

#sidebar.collapsed:hover .sidebar-group i,
#sidebar.collapsed.hover-expanded .sidebar-group i {
  margin: 0; /* Quita el margin auto del ícono para que se alinee bien con el texto */
}

/* Mostrar la flecha cuando la barra se expande temporalmente */
#sidebar.collapsed:hover .sidebar-group button .fa-chevron-down,
#sidebar.collapsed.hover-expanded .sidebar-group button .fa-chevron-down {
  display: inline-block !important;
}

/* Separación extra entre texto y flecha cuando el menú está desplegado */
#sidebar.collapsed:hover .sidebar-group button.sidebar-item {
  justify-content: space-between;
}
#sidebar.collapsed.hover-expanded .sidebar-group button.sidebar-item {
  justify-content: space-between;
}
#sidebar.collapsed:hover .sidebar-group button.sidebar-item i.fa-chevron-down,
#sidebar.collapsed.hover-expanded .sidebar-group button.sidebar-item i.fa-chevron-down {
  margin-left: auto;
  margin-right: 6px;
}



/* 5) Mantén la lógica de apertura/cierre normal intacta */
  

/* ———————————————— */
/*  Mantener main-content fijo al pasar el ratón sobre la barra comprimida  */
/* ———————————————— */

/* Si hay un segundo sidebar, lo desplazamos también para que no empuje el main */
#sidebar.collapsed:hover ~ #subcategoria-sidebar,
#sidebar.collapsed.hover-expanded ~ #subcategoria-sidebar {
  left: 40px;
}

/* El main siempre a 60px de la izquierda y ancho = 100% − 60px */
#sidebar.collapsed:hover ~ #main-content,
#sidebar.collapsed.hover-expanded ~ #main-content {
  margin-left: var(--sb-collapsed) !important;
}

/* La barra ya no es sticky sola */
#main-content .highlighting-bar { position: static; }

/* El bloque entero (barra + breadcrumb) es sticky */
#subcat-header { position: sticky; top: 0; z-index: 40; background: #fff; }

/* Breadcrumb: oculto por defecto (lo refuerza por si quitas la clase hidden) */
#breadcrumbs { display: none; }

/* Cuando #subcat-header esté “stuck” le pondremos .is-stuck desde JS */
#subcat-header.is-stuck #breadcrumbs { display: block; }

/* Ajuste de scroll para que no tape summaries al anclar */
#main-content { scroll-padding-top: 88px; }           /* ≈ alto barra + breadcrumb */
#subcategoria-body details summary { scroll-margin-top: 88px; }




/* Primero quita ese margin-top en split-view */
#video-modal.split-view #toggle-thumbnails {
  position: absolute;
  top: auto;
  bottom: 0;   /* que quede justo encima del carrusel */
  left: 50%;
  transform: translateX(-50%);
  width: 5.5rem;
  height: 1.5rem;
  background-color: rgb(225, 230, 234);      /* gray-100 */
  border-radius: 0.3rem;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}
#video-modal.split-view #toggle-thumbnails i {
  color: #475569; /* gray-600 */
  font-size: 0.75rem;
}








/* 1) Estilo para el details/summary */
#subcategoria-body details {
  border-bottom: 1px solid #e5e7eb;
}
#subcategoria-body summary {
  list-style: none; /* quita marcador por defecto */
  background-color: #f8f9fa;
  padding: 1rem 1.5rem;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
#subcategoria-body summary::-webkit-details-marker {
  display: none;
}
/* 2) Listas con viñetas */
#subcategoria-body .texto-lista ul {
  margin-top: 0.5rem;
  margin-bottom: 0.5rem;
}
#subcategoria-body .texto-lista > ul {
  list-style: disc inside;
}
#subcategoria-body .texto-lista > ul ul {
  list-style: circle inside;
}






/* 3) Galería de imágenes con captions */
/* ===== Thumbs de IMAGEN dentro del contenido ===== */
#subcategoria-body .galeria {
  display: grid;
  gap: 8px !important;                                   /* separación entre items */
  grid-template-columns: repeat(auto-fit, minmax(70px, auto)) !important;
}

/* El <figure> aloja cuadrado + caption debajo */
#subcategoria-body .galeria .media-thumb.image-thumb{
  width: 70px !important;
  height: auto !important;
  margin: 0 !important;                                   /* el gap controla el espacio */
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  gap: 8px !important;                                    /* espacio entre cuadro y caption */
}

/* El CUADRADO 60×60 */
#subcategoria-body .galeria .media-thumb.image-thumb .thumb-box{
  width: 70px; 
  height: 70px;
  border-radius: .5rem;                                   /* bordes redondeados */
  overflow: hidden;                                       /* recorta sobrante */
  box-shadow: 0 1px 2px rgba(0,0,0,.06);
  background:#000;                                        /* por si hay transparencia */
}

/* La imagen rellena el cuadrado como cover */
#subcategoria-body .galeria .media-thumb.image-thumb .thumb-box img{
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;
  display: block;
}

/* Caption debajo del cuadrado */
#subcategoria-body .galeria .media-thumb.image-thumb .thumb-caption{
  max-width: 60px;
  font-size: 6px;
  line-height: .5;
  color: #111827;
  text-align: left;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Anula reglas previas más genéricas que ponían 115×115 */
#subcategoria-body .galeria img{
  width: auto !important;
  height: auto !important;
}





#subcategoria-body .galeria figure {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}
#subcategoria-body .galeria img {
  border-radius: 0.375rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  max-width: 100%;
  width: 115px;
  height: 115px;
  object-fit: cover;

}
#subcategoria-body .galeria figcaption {
  margin-top: 0.5rem;
  font-size: 0.875rem;
  color: #6b7280;
}

/* Contenedor de cada thumbnail de vídeo */
.video-thumb {
  position: relative;
  width: 8rem;    /* 128px, igual que las img de la galería */
  height: 8rem;
  flex-shrink: 0;
  border-radius: 0.375rem; /* same rounded corners */
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  margin-bottom: 2rem;
}

/*  Garantizar tamaño mínimo de todas las miniaturas  */
.media-thumb {
  min-width: 8rem;   /* ancho mínimo 128px */
  min-height: 8rem;  /* alto mínimo 128px */
}
.video-thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 0.5rem;
  border: 1px solid #d1d5db;
  box-shadow: 0 1px 2px rgba(0,0,0,0.06);
}

#video-modal .media-thumb {
  width: 60px !important;
  height: 60px !important;
  min-width: 60px !important;
  min-height: 60px !important;
}
#video-modal .media-thumb img {
  width: 60px !important;
  height: 60px !important;
  object-fit: cover;
}
/* Icono de play superpuesto */
.video-thumb .play-icon {
    position: absolute !important;
  left: 4px;
  bottom: 4px;
  width: 16px;
  height: 16px;
  border-radius: .2rem;
  background: rgba(17,24,39,.75);
  display: grid;
  place-items: center;
}
.video-thumb .play-icon i {
  font-size: 8px;
  color: #fff;
}


/* Ya tenías .video-thumb y .play-icon */

/* Para que el modal aparezca centrado y cubra todo */
#video-modal {
  position: fixed;
  inset: 0;
  z-index: 1000;
  background-color: rgba(0, 0, 0, 0.9);
  flex-direction: column;
  justify-content: stretch;
  align-items: stretch;
}

#video-modal > div {
  flex: 1;
  display: flex;
  flex-direction: row;
  width: 100%;
  height: 100%;
  overflow: visible !important;
  margin: 0; /* Asegura que no haya margen por el padding anterior */
  border-radius: 0; /* Elimina bordes redondeados */
}



/* Estilo para el modal en modo expandido */
#video-modal.expanded {
  display: flex;
  flex-direction: row;
}

#video-modal.expanded > div {
  width: 50%;
  height: 100%;
  position: relative;
}

#video-modal.expanded #main-content {
  width: 50%;
  height: 100%;
  overflow-y: auto;
  background: white;
}

#video-modal.expanded .dashboard-container {
  height: 100vh;
}

#video-modal.expanded iframe {
  height: 100% !important;
}





#video-modal.split-view {
  /* Anula inset:0 */
  position: fixed;
  z-index: 40 !important;
  top: 3rem !important; 
  right: 0 !important;
  bottom: 0 !important;
  left: 60% !important;
  width: 40% !important;
  height: calc(100% - 1rem) !important; /* 100% de la pantalla menos esos 4rem */

 background-color: transparent !important; 
}

/* Ajusta su contenedor interno para que ocupe todo */
#video-modal.split-view > div {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  display: flex;
  flex-direction: row; /* si necesitas */
}







/* ————————————————————————
   Evita que el carrusel desborde en split-view 
   ———————————————————————— */
#video-modal.split-view .absolute.inset-x-0.top-10.bottom-0.flex {
  overflow-x: hidden !important;
  padding-bottom: 1.75rem;
}

/* Asegura que el carrusel ocupe sólo el 100% de su contenedor */
#video-modal.split-view #thumbnail-carousel {
  position: absolute;
  bottom: 0;
  left: 0; right: 0;
  
  background-color: rgb(255, 255, 255) !important;
  border-top: 1px solid #e5e7eb !important; /* border-gray-200 */
  padding: 2rem 1.5rem 0.5rem;      
             /* espacio arriba/abajo y a los lados */
  box-shadow: 0 -1px 4px rgba(0,0,0,0.05); /* ligera sombra si la quieres */
}

/* Oculta la scrollbar nativa para que no se vea el riel gris */
#video-modal.split-view #video-thumbnails {
  overflow-x: auto;
  scrollbar-width: none;    /* Firefox */
  -ms-overflow-style: none; /* IE 10+ */
}
#video-modal.split-view #video-thumbnails::-webkit-scrollbar {
  display: none;            /* Chrome, Safari */
}

/* Espaciado uniforme entre miniaturas */
#video-modal.split-view .media-thumb {
  margin: 0 2px;
}

/* Opcional: quita el backdrop sobre la mitad izquierda,
   para que el usuario pueda seguir interactuando con el contenido */
#video-modal.split-view {
  pointer-events: none;
}
/* pero que el modal y sus hijos sigan recibiendo clicks */
#video-modal.split-view > * {
  pointer-events: auto;
}

/* ——————————————— */
/* Ajuste del contenido al 50% izquierdo */
/* ——————————————— */
body.split-view-active .dashboard-container {
  position: fixed;      /* para que no se mueva */
  bottom: 0;
  left: 0;
  width: 60vw;          /* ocupa la mitad izquierda */
  overflow-y: auto;     /* scroll interno si hace falta */
}

body.split-view-active .dashboard-container aside#sidebar {
  height: 100%;         /* sidebar siempre al 100% de este contenedor */
}

body.split-view-active .dashboard-container #main-content {
  flex-grow: 1;         /* ya rellena el espacio restante del 50% */
}




/* Cuando esté en split-view, oculta la columna de descripción y haz que el vídeo ocupe todo el ancho */
#video-modal.split-view .absolute.inset-x-0.top-10.bottom-0.flex > aside {
  display: none !important;
}
#video-modal.split-view .absolute.inset-x-0.top-10.bottom-0.flex > div {
  display: flex;
    width: 100% !important;

  align-items: center;
  justify-content: center;
}

 /* Split-only: respeta el header (h-12 = 3rem) */
 #video-modal.split-view > div.absolute.inset-x-0.top-10.bottom-0 {
   top: 3rem !important;
   height: calc(100% - 3rem) !important;
 }

#video-modal.split-view button span {
  display: none !important;
}


/* Panel de descripción en split-view */
#video-modal.split-view .video-desc-panel {
  position: absolute;
  top: 3rem;    /* coincide con h-12 (3rem) de tu header */
  bottom: 0; left: 0;
  width: 240px;
  background: rgba(0,0,0,0.9);
  color: #fff;
  z-index: 80;               /* por encima del iframe */
  overflow-y: auto;
  transition: transform .3s ease;
}
/* Cuando no esté activo, lo desplazamos fuera de pantalla */
#video-modal.split-view .video-desc-panel.hidden {
  transform: translateX(-100%);
}
/* Ajustar el vídeo para dejar espacio */
/* ✅ solo desplaza el vídeo cuando el panel de descripción está abierto */
#video-modal.split-view .video-desc-panel:not(.hidden) + .absolute.inset-x-0.top-10.bottom-0.flex {
  margin-left: 240px !important;
}



/* permite a las miniaturas “salirse” un poco */
#video-modal > div.absolute.inset-x-0.top-10.bottom-0.flex {
  overflow: visible !important;
}

/* Miniaturas de imagen: altura fija y ancho auto para mantener proporciones */
#video-thumbnails .image-thumb img {
  height: 8rem;   /* mismo alto que antes (h-32) */
  width: auto;    /* ancho automático según proporción */
  object-fit: cover;
}
#video-thumbnails {
  max-width: 100%;
  overflow-x: auto;
  overflow-y: hidden;
  -webkit-overflow-scrolling: touch; /* para scroll suave en iOS */
  scroll-behavior: smooth;
}


/* En split-view, que el fondo detrás de la imagen/vídeo sea blanco */
#video-modal.split-view .w-3\/4.relative {
  background-color: rgb(245, 246, 248) !important;
}

/* Header del modal en split-view */
#video-modal.split-view .absolute.top-0.left-0.w-full.h-12 {
  background-color: #fff !important;
  border-color: #e5e7eb !important;
  color: #000 !important;
}

/* Fondo del carrusel en split-view */







.media-thumb.selected {
  border-radius: 0.5rem;
  border: 0.3rem solid #525354;             /* gris interior */
  outline: 0.2rem solid rgba(255,255,255,0.8); /* blanco exterior */
  outline-offset: -0.2rem;                   /* sin espacio entre border y outline */
}


/* En split-view, botones transparentes y flechas grises */
#video-modal.split-view #scroll-left,
#video-modal.split-view #scroll-right {
  background-color: transparent !important;
}

#video-modal.split-view #scroll-left i,
#video-modal.split-view #scroll-right i {
  color: #6b7280 !important; /* gray-600 de Tailwind */
}


/* En modo completo (no split-view), fondo gris semitransparente en el carrusel */
#video-modal:not(.split-view) #thumbnail-carousel {
  background-color: rgba(55, 65, 81, 0.3) !important; /* gray-700 al 30% de opacidad */
}


.zoom-menu {
  position: absolute;
  top: 100%;
  right: 2rem;
  background: #1f2937;
  /* Aumentamos el padding para más espacio interior */
  padding: .75rem 1rem;     /* antes .25rem .5rem */
  /* Garantizamos un tamaño mínimo */
  min-width: 8rem;          /* 128px */
  min-height: 2.5rem;       /* 40px */
  border-radius: .375rem;
  display: flex;
  align-items: center;
  gap: .75rem;              /* antes .5rem */
  z-index: 30;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

/* Opcional: agrandar un poco los botones y el texto */
.zoom-menu button {
  font-size: 1rem;          /* antes .875rem */
  padding: .25rem .5rem;    /* un poquito más grande */
}
.zoom-menu span {
  font-size: 1.2rem;
}
.zoom-menu.hidden { display: none; }
.zoom-menu button {
  background: none;
  border: none;
  color: white;
  font-size: 1rem;
  cursor: pointer;
}
.zoom-menu span {
  color: white;
  font-size: 1rem;
  min-width: 2ch;
  text-align: center;
}


/* 1) Clippear el zoom dentro de la zona de vídeo */
#video-modal .w-3\/4.relative {
  overflow: hidden;
}

/* 2) Centrar el origen del zoom */
#modal-image {
  transform-origin: center center;
}

/* 3) Mantener la descripción siempre por encima */
#video-desc-panel {
  z-index: 30;
}


/* Split-view: descripción con fondo blanco y texto negro */
#video-modal.split-view .video-desc-panel {
  background-color: #ffffff !important;
  color: #000000 !important;
}
/* Asegúrate de que todos los elementos hijos (títulos, párrafos, etc.) hereden el color */
#video-modal.split-view .video-desc-panel h3,
#video-modal.split-view .video-desc-panel p {
  color: inherit !important;
}

/* Título en split-view: más grande y en negrita */
#video-modal.split-view .video-desc-panel h3#video-desc-title {
  font-size: 1.25rem !important;   /* aprox. 20px */
  font-weight: 700     !important; /* negrita */
  margin-bottom: 0.5rem !important; /* separa un poquito del copyright */
  display: block        !important; /* aseguramos que ocupe línea propia */
  order: -1             !important; /* si hiciera falta reposicionarlo */
}


/* estilos del footer de cada details */
.collapse-controls {
  display: none;
  padding: 0.75rem 1.5rem;
  border-top: 1px solid #e5e7eb;
  align-items: center;
  justify-content: space-between;
  background: #fff;
  font-size: 0.875rem;
  color: #475569;
}
details[open] > .collapse-controls {
  display: flex;
}
/* iconos un poco más grandes y espaciados */
.collapse-controls i {
  font-size: 0.875rem;
}
.collapse-controls span {
  font-weight: 500;
}

/* Hago sticky la barra de MY HIGHLIGHTING dentro del scroll de subcategoría */

/* Hace sticky la barra MY HIGHLIGHTING en todo el scroll de main-content */


/* 1) Asegúrate de que #main-content sea el contenedor de scroll */
#main-content {
  
  position: relative;
}






/* quita el padding-top del scroll container */
#main-content {
  /* preserve el padding horizontal si lo necesitas */
  padding: 0 2.5rem !important;
}

/* quita el margin y padding superior solo de esta sección */
#subcategoria-content {
  margin-top: 0 !important;
  padding-top: 0 !important;
  /* si quieres seguir teniendo padding a los lados y abajo: */
  padding-right: 1.5rem;
  padding-bottom: 1.5rem;
  padding-left: 1.5rem;
    background-color: #ffffff !important;

}

/* Resetea el fondo de los summary cuando el details está cerrado */
#subcategoria-body details:not([open]) > summary {
  background-color: transparent;
  min-height: calc(30px * var(--content-spacing-scale));
  padding-top: calc(.25rem * var(--content-spacing-scale));
  padding-bottom: calc(.25rem * var(--content-spacing-scale));
  line-height: .5; 
  padding-left: 1.5rem !important;
  padding-right: 1.5rem !important;
}

#subcategoria-body details[open] > summary {
  padding-top: calc(.75rem * var(--content-spacing-scale));
  padding-bottom: calc(.7rem * var(--content-spacing-scale));
  padding-left: 1.5rem !important;
  padding-right: 1.5rem !important;

}

/* Evita que el chevron ensanche la fila */
#subcategoria-body summary svg { flex-shrink: 0; }
.collapse-controls {
  background-color: transparent !important;
  border-top: none !important;
}

details[open] > summary {
  background-color: rgb(247, 248, 249);
}

body:not(.favorites-split) #main-content:has(#subcategoria-content:not(.hidden)) {
  background-color: #ffffff !important;
}

/* —— Estilos finos para que se vea EXACTO —— */

.hl-title{
  font-size: 13.5px;           /* muy parecido al screenshot */
  font-weight: 600;
  letter-spacing: .02em;
  text-transform: uppercase;
  color: #475569;              /* slate-600 */
}
.hl-btn{
  padding: 2px 4px;
  color: #475569;
}
.hl-btn:hover{ color:#111827; } /* hover sutil */
/* Separadores solo cuando la barra está sticky */
.hl-sep {
  width: 1px;
  height: 18px;
  background: #e5e7eb;   /* gray-200 */
  margin: 0 .75rem;
  display: inline-block; /* ← antes estaba en none */
}

/* Menú de fuentes “AA” */
#lang-menu { scrollbar-width: thin; scrollbar-color: #e5e7eb transparent; }
#lang-menu::-webkit-scrollbar{ width: 8px; }
#lang-menu::-webkit-scrollbar-thumb{ background-color:#e5e7eb; border-radius:9999px; }
#lang-menu::-webkit-scrollbar-track{ background:transparent; }



/* —— Escala solo del CONTENIDO —— */
/* Variable con el porcentaje de fuente del contenido */
#subcategoria-content {
  --content-font-scale: 100%;
  --content-spacing-scale: 1;
}

/* Aplico la escala SOLO a texto típico del contenido */
#subcategoria-content p,
#subcategoria-content li,
#subcategoria-content figcaption,
#subcategoria-content summary span,
#subcategoria-content .texto-lista,
#subcategoria-content .collapse-controls span {
  font-size: var(--content-font-scale);
}




/* Líneas separadoras (hairline) más finas bajo cada título */
@supports (border-width: .5px) {
  #subcategoria-body details { border-bottom-width: .5px; }
}
@supports not (border-width: .5px) {
  /* Fallback para navegadores que no aceptan .5px */
  #subcategoria-body details {
    border-bottom: none;
    box-shadow: inset 0 -0.5px 0 0 #e5e7eb;
  }
}


/* Afinar la línea superior e inferior de la barra MY HIGHLIGHTING */
#subcat-header .highlighting-bar {
  border-top-width: .5px !important;
  border-bottom-width: .5px !important;
}

/* Distribución 3 columnas: izq / centro / der */
.highlighting-bar{display:flex;align-items:center;}
.highlighting-bar .hl-left{flex:0 0 auto;display:flex;align-items:center;gap:.25rem;}
.highlighting-bar .hl-center{flex:0 1 auto;display:flex;justify-content:center;margin:0 auto;}
.highlighting-bar .hl-right{flex:0 0 auto;margin-left:auto;display:flex;align-items:center;justify-content:flex-end;gap:.5rem;}

#subcat-header.is-stuck .highlighting-bar .hl-right,
#subcat-header.is-stuck .highlighting-bar .bookmark-toggle,

#subcat-header.is-stuck .highlighting-bar .hl-close {
  
  padding-left: 0 !important;
  padding-right: 0 !important;
  margin-left: 0 !important;
  margin-right: 0 !important;
  gap: 0 !important;
}

#subcat-header.is-stuck .highlighting-bar .hl-sep {
  margin: 0 .75rem !important; /* igual que topbar */
}

/* Back solo cuando está pegada (segunda captura) */
.highlighting-bar .fav-back{margin-left:1rem;display:none;}
#subcat-header.is-stuck .highlighting-bar .fav-back{display:inline-flex!important;}

#subcat-header.is-stuck .highlighting-bar .fav-back{
  position: relative; /* permite posicionar el pseudo-elemento correctamente */
  display: inline-flex;
  align-items: center;
  justify-content: center;
  height: 3rem;            /* misma altura que la barra */
  min-height: 3rem;       /* asegura centrado vertical */
}
#subcat-header.is-stuck .highlighting-bar .fav-back::after{
  content: "";
  display: inline-block;
  width: 1px;
  height: 18px;                /* mismo alto que .hl-sep */
  background: #e5e7eb;         /* gray-200 */
  margin-left: .75rem;         /* separación a la derecha del botón */
  margin-right: .75rem;        /* mantiene el mismo gap que otros separadores */
}

/* Bookmark y Cerrar solo en barra pegada */
.highlighting-bar .bookmark-toggle,
.highlighting-bar .hl-close{display:none;}
#subcat-header.is-stuck .highlighting-bar .bookmark-toggle,
#subcat-header.is-stuck .highlighting-bar .hl-close{display:inline-flex!important;}


#topbar {
  height: 3rem !important;
  box-sizing: border-box;
}
.highlighting-bar {
  height: 3rem !important;
  min-height: 3rem !important;
  padding-top: 0 !important;
  padding-bottom: 0 !important;
  box-sizing: border-box;
}

/* Base para items (enlaces y botones) */
#sidebar .sidebar-item{
  display:flex; align-items:center; height:40px;
  width:100%; text-align:left; padding:0 .75rem;
  color:#374151; /* gray-700 */
  border-radius:.375rem;
  transition:background-color .2s, color .2s, font-weight .2s;
}

/* Hover consistente */
#sidebar .sidebar-item:hover{ background:#eff6ff; } /* blue-50 */

/* — Estado activo unificado — */
#sidebar .sidebar-item.is-active{
  background:#e0f2fe;        /* blue-100 */
  color:#1d4ed8 !important;  /* blue-700 */
  font-weight:500 !important;
}
#sidebar .sidebar-item.is-active i:not(.fa-chevron-down){
  color:#1d4ed8 !important;  /* icono principal azul */
}

/* Chevrón: solo rota cuando el grupo está “abierto” */
#sidebar .sidebar-item.is-active .fa-chevron-down{
  color:#1d4ed8;
}
#sidebar .sidebar-item.chev-open .fa-chevron-down{
  transform:rotate(180deg);
}

/* Sub-items (los <a> dentro de acordeones) siguen con su tamaño menor */
#sidebar div[id^="accordion-"] a.sidebar-item{
  height:32px; font-size:.875rem; color:#6b7280;
}


/* ==== Sidebar: estado seleccionado EXACTO ==== */
/* Aplica tanto a enlaces como a botones del grupo */
#sidebar .sidebar-item.active-link,
#sidebar .sidebar-item.is-active,
#sidebar .sidebar-group > button.active-link {
  /* fondo gris */
  background-color: #f3f4f6;              /* gray-100 */
  /* texto un poco más oscuro y fuerte */
  color: #111827 !important;              /* gray-900 */
  font-weight: 600 !important;

  /* hairlines arriba/abajo (sin “engordar” el layout) */
  border-radius: 0 !important;
  border-top: .5px solid #e5e7eb;         /* gray-200 */
  border-bottom: .5px solid #e5e7eb;      /* gray-200 */

  /* banda lateral “un poco gruesa” SIN mover el contenido */
  /* usamos inset box-shadow para no alterar el ancho */
  box-shadow: inset 3px 0 0 0 #9ca3af;    /* gray-400 ~ 4px */
}

/* Icono del ítem seleccionado: que herede el color del texto */
#sidebar .sidebar-item.active-link i:not(.fa-chevron-down),
#sidebar .sidebar-item.is-active i:not(.fa-chevron-down) {
  color: inherit !important;
}

/* Hover consistente cuando ya está seleccionado (no “salta” a azul) */
#sidebar .sidebar-item.active-link:hover,
#sidebar .sidebar-item.is-active:hover {
  background-color: #f3f4f6;              /* mantiene el mismo gris */
}

/* Subitems dentro de acordeones: mantienen tipografía más pequeña
   pero heredan el look seleccionado cuando corresponda */


/* Colapsado: evitamos que la banda lateral “ensucie” el pill de iconos */
#sidebar.collapsed .sidebar-item.active-link,
#sidebar.collapsed .sidebar-item.is-active {
  box-shadow: none;
  border-top-color: transparent;
  border-bottom-color: transparent;
  background-color: transparent;
}

/* —— Botones de grupo abiertos: solo rota chevron —— */
#sidebar .sidebar-group > button.accordion-open {
  background: transparent !important;
  color: #374151 !important;          /* gray-700 */
  font-weight: 400 !important;
  border-top: none !important;
  border-bottom: none !important;
  box-shadow: none !important;
}

/* Chevron rotado */
#sidebar .sidebar-group > button.accordion-open .fa-chevron-down {
  transform: rotate(180deg);
  color: #6b7280;                      /* gray-600 */
}

.toggle-icons{display:flex;align-items:center;gap:.35rem;}
/* Acciones a la derecha en MY HIGHLIGHTING */
.highlighting-bar .toggle-icons{margin-left:auto;display:flex;gap:.5rem;justify-content:flex-end;}
/* Espaciador flexible entre título e iconos */
.highlighting-bar .hl-center{flex:1 1 0;display:flex;align-items:center;justify-content:flex-start;margin:0;}
.bookmark-toggle{display:none;align-items:center;justify-content:center;width:1.5rem;height:1.5rem;border-radius:9999px;color:#94a3b8;cursor:pointer;transition:color .2s ease;}
.bookmark-toggle:hover{color:#1e293b;}
.bookmark-toggle:focus-visible{outline:2px solid #38bdf8;outline-offset:2px;}
[data-bookmarked="true"] .bookmark-toggle{color:#0f172a;}
[data-bookmarked="true"]>.toggle-icons>.bookmark-toggle,
.accordion-open .bookmark-toggle,
details[open] summary .bookmark-toggle,
details[data-bookmarked="true"] summary .bookmark-toggle{display:inline-flex;}
#sidebar .bookmark-toggle{display:none!important;}

body.favorites-split #main-content{
  display:flex;
  gap:0;
  align-items:stretch;
  overflow:hidden;
  padding:0 !important;
  margin:0 !important;
  background:#e9eff6 !important;
  box-sizing:border-box;
  flex:1 1 auto;
}
/* En favoritos: si la barra MY HIGHLIGHTING está sticky, oculta la topbar del split derecho */
body.favorites-split:has(#subcat-header.is-stuck) #fav-topbar { display: none !important; }
body.favorites-split #favorites-view{
  display:block;
  width:320px;
  flex-shrink:0;
  padding:1.75rem;
  background:#e9eff6;
  border-right:1px solid #d5dbe5;
  box-sizing:border-box;
  margin:0 !important;
}
body.favorites-split #subcategoria-content{
  flex:1;
  display:block !important;
  padding:0 2.5rem 2.5rem !important;
  margin:0 !important;
  background:#fff;
}
body.favorites-split #subcat-header{margin-bottom:1.5rem;}
body.favorites-split #subcategoria-sidebar{display:none!important;}
body.favorites-split #subcat-header .highlighting-bar{margin-left:0!important;margin-right:0!important;padding-left:0!important;padding-right:0!important;}
body.favorites-split #favorites-view,
body.favorites-split #subcategoria-content{height:100%;overflow-y:auto;}
body.favorites-split .dashboard-container{
  background:#e9eff6;
  gap:0;
  width:100%;
}
body.favorites-split #sidebar{border-right:1px solid #d5dbe5;}
body.favorites-split #sb-switch{background:#e9eff6;border-color:#d5dbe5;}
body.favorites-split #user-section,
body.favorites-split{background:#e9eff6;}
#favorites-view{display:none;}
#favorites-view:not(.hidden){display:block;}
body.favorites-split #favorites-view.hidden{display:none;}
#favorites-list{display:flex;flex-direction:column;gap:.75rem;}
.favorite-item{display:flex;align-items:center;justify-content:space-between;gap:.75rem;padding:.9rem 1rem;border:1px solid #e2e8f0;border-radius:.75rem;background:#fff;transition:box-shadow .2s ease,border-color .2s ease,background .2s ease;text-align:left;}
.favorite-item:hover{box-shadow:0 8px 20px rgba(15,23,42,.08);border-color:#cbd5f5;}
.favorite-item--active{border-color:#3b82f6;background:#eff6ff;}
.favorite-item__meta{font-size:.75rem;line-height:1rem;color:#64748b;}
.favorite-empty{padding:2.5rem;border:1px dashed #cbd5f5;border-radius:.75rem;background:#f8fafc;text-align:center;color:#64748b;}
.favorite-highlight{animation:favoritePulse 1.2s ease forwards;}
@keyframes favoritePulse{0%{box-shadow:0 0 0 0 rgba(59,130,246,.35);}100%{box-shadow:0 0 0 16px rgba(59,130,246,0);}}

/* Bloque activo */
#sidebar .sidebar-group.segment-active {
  background:#f3f4f6;
  box-shadow: inset 4px 0 0 #9ca3af;
  border-top:.5px solid #e5e7eb;
  border-bottom:.5px solid #e5e7eb;
  border-radius:0;
}
#sidebar.collapsed .sidebar-group.segment-active {
  background:transparent;
  box-shadow:none;
  border-color:transparent;
}

/* Mantener el bloque gris del grupo cuando algún subitem está activo */
#sidebar .sidebar-group:has(> div[id^="accordion-"] a.sidebar-item.is-active),
#sidebar .sidebar-group:has(> div[id^="accordion-"] a.sidebar-item.active-link) {
  background:#f3f4f6 !important;
  box-shadow: inset 4px 0 0 #9ca3af !important;
  border-top:.5px solid #e5e7eb !important;
  border-bottom:.5px solid #e5e7eb !important;
  border-radius:0 !important;
}


/* Ítems principales (Home, Drugs, etc.) */
#sidebar .sidebar-group > a.sidebar-item span,
#sidebar .sidebar-group > button .flex.items-center > span {
  font-size: 0.875rem; /* ≈14px */
}



/* Hover de SUBITEMS: texto negro, sin fondo */
#sidebar div[id^="accordion-"] a.sidebar-item:hover {
  color: #000 !important;
  background: transparent !important;
  box-shadow: none !important;
}

/* Si algún subitem tiene ícono, que acompañe el color */
#sidebar div[id^="accordion-"] a.sidebar-item:hover i {
  color: inherit !important;
}

/* Accesibilidad: al navegar con teclado, mismo look en focus */
#sidebar div[id^="accordion-"] a.sidebar-item:focus-visible {
  color: #000 !important;
  background: transparent !important;
  outline: 2px solid #d1d5db; /* opcional, quitalo si no lo querés */
  outline-offset: 2px;
}

/* Fondo gris al pasar el mouse por el grupo cuando su acordeón está abierto */
#sidebar .sidebar-group:has(> div[id^="accordion-"]:not(.hidden)):hover {
  background:#f3f4f6;               /* gris OK */
  box-shadow: none;                  /* ← quita la banda */
  border-top:.5px solid #e5e7eb;
  border-bottom:.5px solid #e5e7eb;
  border-radius:0;
}

/* Si la barra está colapsada, no pintes el hover “grande” */
#sidebar.collapsed .sidebar-group:has(> div[id^="accordion-"]:not(.hidden)):hover {
  background: transparent;
  box-shadow: none;
  border: none;
}


/* Fallback JS: mismo estilo pero con clase */
#sidebar .sidebar-group.hover-open:hover {
  background:#f3f4f6;
  box-shadow: inset 2px 0 0 #9ca3af;
  border-top:.5px solid #e5e7eb;
  border-bottom:.5px solid #e5e7eb;
  border-radius:0;
}
#sidebar.collapsed .sidebar-group.hover-open:hover {
  background: transparent;
  box-shadow: none;
  border: none;
}

/* Subitems seleccionados: sin banda, sin fondo y sin cambio de color */
#sidebar div[id^="accordion-"] a.sidebar-item.active-link,
#sidebar div[id^="accordion-"] a.sidebar-item.is-active {
  font-size: .875rem;                     /* text-sm */
  color: #111827 !important;
  box-shadow: inset 4px 0 0 0 #9ca3af;
  border-top: .5px solid #e5e7eb;
  border-bottom: .5px solid #e5e7eb;
}


/* Subitems seleccionados: texto negro, sin fondo ni banda */
#sidebar div[id^="accordion-"] a.sidebar-item.active-link,
#sidebar div[id^="accordion-"] a.sidebar-item.is-active {
  background: transparent !important;
  box-shadow: none !important;            
  border-top-color: transparent !important;
  border-bottom-color: transparent !important;
  color: #000 !important;                 
  font-weight: 500 !important;            
}


/* Subítems mucho más juntos */
#sidebar div[id^="accordion-"] a.sidebar-item {
  font-size: 0.75rem;   /* ≈12px */
  line-height: 1rem;    /* ≈16px */
  padding-top: 0.15rem; /* menos espacio arriba */
  padding-bottom: 0.15rem; /* menos espacio abajo */
  margin: 0; /* sin separación extra */
}

/* ===== Preset ultra-compacto tipo Amboss ===== */
:root{
  --subitem-font: 9px;   /* tamaño de fuente */
  --subitem-line: 22px;   /* altura total deseada por ítem */
  --subitem-vpad: 0px;    /* relleno vertical */
  --subitem-gap: 0px;     /* separación entre ítems */
}

/* Quita el espaciado vertical que añade Tailwind (space-y-1) a todos los acordeones */
#sidebar div[id^="accordion-"].space-y-1 > * + * { margin-top: var(--subitem-gap) !important; }

#sidebar div[id^="accordion-"] {
  padding-bottom: 6px; /* ajusta el valor a tu gusto */
}

/* Subitems: altura fija y muy compacta */
#sidebar div[id^="accordion-"] a.sidebar-item{
  font-size: var(--subitem-font);
  line-height: var(--subitem-line);   /* controla la altura exacta */
  padding-top: var(--subitem-vpad);
  padding-bottom: var(--subitem-vpad);
  margin: 0;                          /* sin margen extra entre ítems */
  height: var(--subitem-line);        /* asegura consistencia */
}

/* Estado seleccionado: sin banda ni bordes; texto negro y semibold */
#sidebar div[id^="accordion-"] a.sidebar-item.active-link,
#sidebar div[id^="accordion-"] a.sidebar-item.is-active{
  background: transparent !important;
  box-shadow: none !important;
  border-top-color: transparent !important;
  border-bottom-color: transparent !important;
  color: #000 !important;
  font-weight: 500 !important;
}

/* Hover sutil, sin alterar la altura */
#sidebar div[id^="accordion-"] a.sidebar-item:hover{
  background: transparent !important;
  color: #0f172a; /* slate-900 */
}

/* Quitar el espacio entre el header y el primer item de la sidebar */
#sidebar{
  padding-top: 0 !important;
}
#sidebar .sidebar-group:first-child{
  margin-top: 0 !important;
}

/* — Sangría extra para los títulos (icono más separado del borde izq.) — */
:root{ --sb-left-pad: 1.25rem; } /* prueba 1rem / 1.25rem / 1.5rem */

#sidebar .sidebar-group > a.sidebar-item,
#sidebar .sidebar-group > button.sidebar-item{
  padding-left: var(--sb-left-pad) !important;
}

/* Si en colapsado+hover también quieres esa misma sangría: */
#sidebar.collapsed:hover .sidebar-group > a.sidebar-item,
#sidebar.collapsed:hover .sidebar-group > button.sidebar-item,
#sidebar.collapsed.hover-expanded .sidebar-group > a.sidebar-item,
#sidebar.collapsed.hover-expanded .sidebar-group > button.sidebar-item{
  padding-left: var(--sb-left-pad) !important;
}


/* Library: que las líneas divisorias toquen los bordes de las cards */
#articles-panel .articles-panel-column > ul{
  margin-left: -1rem;   /* compensa el px-4 del contenedor */
  margin-right: -1rem;  /* idem */
}

/* Reponemos el padding en cada item para alinear con el título de la card */
#articles-panel .articles-panel-list-item{
  padding-left: 1rem !important;   /* antes 0.75rem */
  padding-right: 1rem !important;
  border-radius: 0 !important;     /* opcional: evita “islas” redondeadas al hover */
}


/* Selección en las 3 columnas de materias/temas/subtemas */
#articles-panel .articles-panel-column > ul > li.is-selected {
  background: #f3f4f6; /* gray-100 */
  box-shadow:
    inset 3px 0 0 #9ca3af,         /* banda lateral gris */
    inset 0 0.5px 0 #e5e7eb,       /* borde superior más fino */
    inset 0 -0.5px 0 #e5e7eb,      /* borde inferior más fino */
    inset -0.5px 0 0 #e5e7eb;      /* borde derecho más fino */
  border-radius: 0;
}

/* Texto un poco más oscuro y semibold */
#articles-panel .articles-panel-column > ul > li.is-selected > a {
  color:#111827;                      /* gray-900 */
  font-weight:600;
}

/* Quita la “divide line” del item actual y del siguiente */
#articles-panel .articles-panel-column > ul > li.is-selected,
#articles-panel .articles-panel-column > ul > li.is-selected + li {
  border-top-color: transparent !important;
}

/* El contenedor mantiene esquinas */
.articles-panel-column {
  border-radius: 0.5rem; /* = rounded-lg */
  overflow: hidden;      /* recorta el hover dentro de las esquinas */
  /* sombra un poco más marcada */
  box-shadow: 0 4px 12px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.06);
  transition: box-shadow .2s ease, transform .15s ease;
}

/* leve “lift” al hover */
#articles-panel .articles-panel-column:hover {
  box-shadow: 0 8px 20px rgba(0,0,0,0.12), 0 2px 6px rgba(0,0,0,0.08);
  transform: translateY(-1px);
}

/* Iconos de las listas del panel */
/* Iconos de las listas del panel */
.ap-icon{
  width: 16px; height: 16px; display: inline-block;
  background-size: contain; background-repeat: no-repeat;
  margin-right: .5rem; flex-shrink: 0;
}

/* Columnas 1 (Library) y 2 (Temas): icopanel2b / icopanel2n al seleccionar */
.ap-icon.ap2{ background-image: url('./assets/icopanel2b.png'); }
#articles-panel > .flex:first-child li.is-selected .ap-icon.ap2,
#panel-2 li.is-selected .ap-icon.ap2{
  background-image: url('./assets/icopanel2n.png');
}

/* Subtemas */
.ap-icon.ap3{ background-image: url('./assets/icopanel3.png'); }

/* ——— Más separación icono–texto SOLO en las 3 listas del panel ——— */
:root { --ap-gap: 0.95rem; } /* ~12px; súbelo/bájalo a gusto */

#articles-panel .articles-panel-list-item{
  display: flex; 
  align-items: center;
  gap: var(--ap-gap);           /* separación uniforme */
}

/* Evita “doble” separación si ya hay margin-right en los iconos */
#articles-panel .articles-panel-list-item > .ap-icon { 
  margin-right: 0 !important; 
}
#articles-panel .articles-panel-list-item > i {
  margin-right: 0 !important;
}

/* Ocultar totalmente la barra principal (sin hover-expand) */
#sidebar.force-hidden{
  width:0 !important;
  padding-left:0 !important;
  padding-right:0 !important;
  box-shadow:none !important;
}
#sidebar.force-hidden:hover{
  width:0 !important;
}

/* Anima color/fondo cuando cambia .is-active */
#subcategoria-sidebar .toc-h2{
  transition: background-color .2s ease, color .2s ease, box-shadow .2s ease;
}


/* Contenedor del TOC relativo para posicionar el indicador */
#subcategoria-sidebar .toc { position: relative; }

/* Indicador vertical a la izquierda que se desplaza */
#subcategoria-sidebar .toc-indicator{
  position: absolute; left: 0; top: 0;
  width: 3px; height: var(--h, 40px);
  background: #9ca3af;
  transform: translateY(var(--y, 0));
  transition: transform .2s ease, height .2s ease;
  border-radius: 2px;
}


/* === FULL (no split) — estilo/behaviour idéntico al split === */
#video-modal:not(.split-view) #thumbnail-carousel{
  position:absolute; bottom:0; left:0; right:0; z-index:10;
  background:#fff !important;
  border-top:1px solid #e5e7eb !important;
  padding:2rem 1.5rem .5rem;
  box-shadow:0 -1px 4px rgba(0,0,0,.05);
}
#video-modal:not(.split-view) #video-thumbnails{
  overflow-x:auto; scrollbar-width:none; -ms-overflow-style:none;
}
#video-modal:not(.split-view) #video-thumbnails::-webkit-scrollbar{ display:none; }
#video-modal:not(.split-view) .media-thumb{ margin: 0 2px;  }

#video-modal:not(.split-view) #scroll-left,
#video-modal:not(.split-view) #scroll-right{
  background:transparent !important;
}
#video-modal:not(.split-view) #scroll-left i,
#video-modal:not(.split-view) #scroll-right i{
  color:#6b7280 !important; /* gray-600 */
}

/* Botón flotante de toggle igual que en split */
 #video-modal:not(.split-view) #toggle-thumbnails{
   position:absolute; bottom: calc(env(safe-area-inset-bottom) + 8px); left:50%; transform:translateX(-50%);
  width:5.5rem; height:1.2rem; z-index:20;
  background:rgb(42, 43, 43); border-radius:.3rem;
  display:flex; align-items:center; justify-content:center;
  z-index: 100;
  
  
}

#video-modal:not(.split-view) #toggle-thumbnails i{ color: rgb(246, 247, 250) !important; ; font-size:.75rem; }

/* Evita desbordes y deja espacio inferior como en split */
#video-modal:not(.split-view) .absolute.inset-x-0.top-10.bottom-0.flex{
  overflow-x:hidden !important; padding-bottom:1.96rem;
}

/* Viewer: centra y aprovecha todo el espacio disponible */
#video-area{
  display:flex;
  align-items:center;
  justify-content:center;
}

  /* Enable custom touch panning on mobile (Chrome/Safari) */
  #video-area,
  #modal-image{
    touch-action: none;
    -ms-touch-action: none; /* legacy */
  }

/* Imagen a ancho/alto del área visible, respetando proporción y centrada */
#modal-image{
  width: 100% !important;
  height: calc(100% - 6rem) !important;     /* sin carrusel */
  object-fit: contain !important;
  display: block;
  margin: 0 auto;
  will-change: transform;
}

/* Iframe iguala comportamiento de altura (centra por el flex del contenedor) */
#modal-iframe{
  width: 100% !important;
  height: calc(100% - 6rem) !important;     /* sin carrusel */
}

/* Cuando el carrusel está abierto, restamos más altura */





/* Modo completo: carrusel gris medio translúcido (con ligero blur opcional) */
#video-modal:not(.split-view) #thumbnail-carousel{
  backdrop-filter: blur(2px);
  background-color: rgba(41, 41, 41, 0.7) !important; /* gray-500 @ 50% */
  backdrop-filter: blur(2px);
  border-top: none !important;       /* ← quita la línea */
  box-shadow: none !important;      
}

/* Modo completo: carrusel gris translúcido SIN línea/borde superior */


/* Extra por si hay otras reglas heredadas */
#video-modal #thumbnail-carousel{ border-top: none !important; }
#video-modal #thumbnail-carousel::before{ content: none !important; }


#thumbnail-carousel #toggle-thumbnails.in-carousel{
   position: absolute;
   top: .25rem;                 /* pegado al borde superior */
   left: 50%;
   transform: translateX(-50%);
   bottom: auto !important;     /* anula el bottom previo */
   z-index: 100;
}

/* ——— Viewer fijo: imagen/iframe SIEMPRE llenan el área ——— */
#video-area { position: relative !important; }

/* La imagen y el iframe ocupan todo el alto disponible del área */
#modal-image,
#modal-iframe{
  position: absolute !important;
  inset: 0 !important;
  width: 100% !important;
  height: 100% !important;
  max-height: none !important;
  object-fit: contain !important;
  transform-origin: center center;
}

/* Carrusel superpuesto (overlay) sin empujar el contenido */
#thumbnail-carousel{
  position: absolute !important;
  left: 0; right: 0; bottom: 0;
  z-index: 30;
}

/* Botón flotante para abrir/cerrar (siempre en el mismo sitio) */
#toggle-thumbnails{
  position: absolute !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  bottom: calc(env(safe-area-inset-bottom) + 8px) !important;
  z-index: 40 !important;
}

/* Cuando el carrusel esté oculto, simplemente no se pinta */
#thumbnail-carousel.hidden{ display: none !important; }


/* ——— Split-view: carrusel translúcido ——— */
#video-modal.split-view #thumbnail-carousel{
  background-color: rgba(255,255,255,.85) !important; /* antes blanco sólido */
  border-top: 1px solid rgba(229,231,235,.7) !important;
  backdrop-filter: blur(2px);
  box-shadow: 0 -1px 6px rgba(0,0,0,.06);
}

/* ——— Split-view: toggle con el MISMO tamaño que en full ——— */
#video-modal.split-view #toggle-thumbnails{
  width: 5.5rem !important;   /* igual que full */
  height: 1.2rem !important;  /* igual que full (antes 1.5rem) */
  line-height: 1.2rem;        /* por si el icono no queda centrado */
}

/* Si el botón está dentro del carrusel (.in-carousel), mantiene el tamaño */
#video-modal.split-view #thumbnail-carousel #toggle-thumbnails.in-carousel{
  width: 5.5rem !important;
  height: 1.2rem !important;
}

/* ——— Modo video: nada debe tapar al iframe ——— */
#video-modal.video-mode #modal-image { 
  display: none !important; 
  pointer-events: none !important; 
}

#video-modal.video-mode #zoom-menu,
#video-modal.video-mode #zoom-btn {
  display: none !important;
}

#video-modal.video-mode #modal-iframe {
  pointer-events: auto !important;
}


/* Miniaturas en CONTENT (no modal) */
#subcategoria-body .galeria{
  grid-template-columns: repeat(auto-fit, 50px) !important;
  gap: 4px !important;
  justify-content: start;
}
#subcategoria-body .galeria figure{ width: 50px !important; }

#subcategoria-body .media-thumb,
#subcategoria-body .video-thumb{
  width: 50px !important;
  height: 50px !important;
  min-width: 50px !important;
  min-height: 50px !important;
  border-radius: .5rem !important;   /* bordes redondeados */
  overflow: hidden !important;
  margin: 0 !important;              /* sin márgenes extra */
  box-shadow: none;                   /* opcional: limpio */
}

/* Imágenes y thumbnails de video: siempre cover y heredando el radio */
#subcategoria-body .image-thumb img,
#subcategoria-body .video-thumb img{
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;
  border-radius: inherit !important;
}

/* Los contenedores de videos en content se generan con gap-2 (8px):
   forzamos 4px entre miniaturas */
#subcategoria-body .flex.flex-wrap{ gap: 4px !important; }

/* Quita separación vertical extra de los videos en content */
#subcategoria-body .video-thumb{ margin-bottom: 0 !important; }


/* === Thumbs en CONTENT: 60x60, cover, cuadradas, redondeadas y gap 4px === */

/* Galería de imágenes (grid) */
#subcategoria-body .galeria{
  gap: 4px !important;
  grid-template-columns: repeat(auto-fit, minmax(60px, 60px)) !important;
}

/* Cualquier miniatura (imagen o video) dentro del contenido */
#subcategoria-body .media-thumb{
  width: 60px !important;
  height: 60px !important;
  min-width: 60px !important;
  min-height: 60px !important;
  margin: 0 !important;            /* el espaciado lo da el gap del contenedor */
  border-radius: .5rem !important; /* bordes redondeados */
  overflow: hidden !important;     /* recorta para el cover */
  box-shadow: none;                /* opcional */
}

/* Imagen interna: 60x60 y cover */
#subcategoria-body .media-thumb img{
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;
  border-radius: .5rem !important;
  display: block;
}

/* Video thumbs en contenido (no modal) */
#subcategoria-body .video-thumb{
  width: 60px !important;
  height: 60px !important;
  min-width: 60px !important;
  min-height: 60px !important;
  margin: 0 !important;
}
#subcategoria-body .video-thumb img{
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;
  border-radius: .5rem !important;
}

/* Si el contenedor de videos usa "flex flex-wrap gap-2", fuerza gap=4px */
#subcategoria-body details .flex.flex-wrap.gap-2 { gap: 4px !important; }

/* Por si alguna regla previa fija tamaños de galería */
#subcategoria-body .galeria img,
#subcategoria-body .image-thumb img { 
  width: 60px !important; 
  height: 60px !important; 
}



/* ======== CONTENT → Galería miniaturas 70×70 px ======== */
/* === Galería de imágenes y videos con thumbs 70x70 === */
#main-content #subcategoria-body .galeria{
  display: grid !important;
  grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)) !important;
  gap: 10px !important;
  justify-content: start !important;
}

/* Tarjeta base (imagen o video) */
#main-content #subcategoria-body .galeria .media-thumb{
  width: 70px !important;
  margin: 0 !important;
  display: flex !important;
  flex-direction: column !important;
  align-items: flex-start !important;
  gap: 4px !important;
}

/* Caja cuadrada */
#main-content #subcategoria-body .galeria .media-thumb .thumb-box{
  position: relative !important;
  width: 70px !important;
  height: 70px !important;
  border-radius: .5rem !important;
  overflow: hidden !important;
  background: #000 !important;
  box-shadow: 0 1px 2px rgba(0,0,0,.06);
}

/* Imagen interna */
#main-content #subcategoria-body .galeria .media-thumb .thumb-box img{
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;
  display: block !important;
  border-radius: inherit !important;
}

/* Texto de descripción */
#main-content #subcategoria-body .galeria .media-thumb .thumb-caption{
  max-width: 70px !important;
  margin: 0 !important;
  font-size: 0.6rem !important;
  line-height: 0.85rem !important;
  color: #111827 !important;
  text-align: left !important;
  white-space: normal !important;
  overflow: visible !important;
  display: block !important;
}

/* — Play badge SOLO en videos — */
#main-content #subcategoria-body .galeria .media-thumb.video-thumb .play-badge{
  position: absolute !important;
  left: 4px;
  bottom: 4px;
  width: 16px;
  height: 16px;
  border-radius: .2rem;
  background: rgba(17,24,39,.75);
  display: grid;
  place-items: center;
}
#main-content #subcategoria-body .galeria .media-thumb.video-thumb .play-badge i{
  font-size: 8px;
  color: #fff;
}

/* Evita tamaños antiguos que agranden videos */
#subcategoria-body .video-thumb,
#subcategoria-body .video-thumb img{
  width: auto !important;
  height: auto !important;
  min-width: 0 !important;
  min-height: 0 !important;
}

/* Forzar Lato incluso donde se usa la clase Tailwind `font-[Inter]` */
.font-\[Inter\]{
  font-family: 'Lato', 'Lato-Regular', 'Lato-Light', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
}

/* Tamaño base del texto en content sin zoom */
#main-content #subcategoria-body {
  font-size: 0.9rem !important;   /* antes probablemente era 1rem */
  line-height: 1.5 !important;    /* ajusta el interlineado para que no quede demasiado separado */
}

/* Split + UP: botón pegado abajo sin hueco */
#video-modal.split-view #toggle-thumbnails:not(.in-carousel){
  bottom: 0 !important;
}


/* Split + DOWN: botón arriba dentro del carrusel */
#video-modal.split-view #thumbnail-carousel #toggle-thumbnails.in-carousel{
  top: .25rem;               /* ya lo tenías, lo afirmamos aquí */
  bottom: auto !important;   /* anula cualquier bottom heredado */
}

/* Split: que el contenedor no recorte el carrusel abajo */
#video-modal.split-view .absolute.inset-x-0.top-10.bottom-0.flex{
  overflow-x: hidden !important;  /* como querías */
  overflow-y: visible !important; /* evita corte vertical */
  padding-bottom: 0 !important;   /* sin relleno que deje hueco */
}



/* 1) El modal en split debe llegar exactamente hasta abajo */
#video-modal.split-view{
  bottom: 0 !important;               /* quita el hueco */
  height: auto !important;            /* que la altura la determinen top/bottom */
  pointer-events: auto !important;    /* por si quedó deshabilitado */
  overflow: hidden !important;
  border-left: 1px solid rgba(229,231,235,.9);
}

/* 2) Botón en modo UP pegado al borde inferior (sin espacio) */
#video-modal.split-view #toggle-thumbnails:not(.in-carousel){
  position: absolute !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  bottom: 0 !important;               /* a ras del borde inferior */
  z-index: 200 !important;
}

/* 3) En modo DOWN: carrusel completo y botón arriba dentro del carrusel */
#video-modal.split-view #thumbnail-carousel{
  position: absolute !important;
  left: 0; right: 0; bottom: 0;
  padding: 2rem 1.5rem calc(.6rem + env(safe-area-inset-bottom)) !important;
  overflow: visible !important;       /* que no recorte el borde inferior */
  z-index: 150 !important;
}
#video-modal.split-view #thumbnail-carousel #toggle-thumbnails.in-carousel{
  top: .25rem !important;             /* arriba, dentro del carrusel */
  bottom: auto !important;
  z-index: 200 !important;
}

/* 4) Evitar que el contenedor intermedio recorte por abajo en split */
#video-modal.split-view .absolute.inset-x-0.top-10.bottom-0.flex,
#video-modal.split-view #video-area{
  overflow: hidden !important;
  padding-bottom: 0 !important;
}


/* ——— Menú de zoom con caret superior ——— */
.zoom-menu{
  position: absolute;
  top: calc(100% + 6px);   /* ↓ un poco más abajo */
  right: 1rem;
  background: rgb(31, 41, 55);
  color: #fff;
  padding: .3rem .6rem;   /* menos alta/ancha */
  min-width: 4rem;         /* menos ancha */
  min-height: 1.3rem;      /* menos alta */
  border-radius: .6rem;
  border: 1px solid rgba(255,255,255,.08);
  box-shadow: 0 8px 24px rgba(0,0,0,.35);
  display: flex;
  align-items: center;
  gap: .2rem;              /* compacto */
  z-index: 30;
}

/* Punta (caret) que apunta hacia arriba (sin cambios) */
.zoom-menu::after{
  content:"";
  position: absolute;
  left: var(--arrow-x, 50%);
  transform: translateX(-50%) rotate(45deg);
  top: -7px;
  width: 14px;
  height: 14px;
  background: #1f2937;
  border-left: 1px solid rgba(255,255,255,.08);
  border-top: 1px solid rgba(255,255,255,.08);
  box-shadow: -2px -2px 2px rgba(0,0,0,.08);
  pointer-events: none;
}
.zoom-menu span,
.zoom-menu button,
.zoom-menu i 
.zoom-menu .zoom-reset {

  font-size: 10px;   /* ajusta tamaño del texto e íconos */
  line-height: 1;    /* compacta la altura */
}

#video-modal.split-view .zoom-menu {
  background: #f9fafb;       /* fondo claro */
  color: rgb(31, 41, 55);            /* texto oscuro */
  
}
#video-modal.split-view .zoom-menu span,
#video-modal.split-view .zoom-menu button,
#video-modal.split-view .zoom-menu i {
  color: rgb(31, 41, 55);               /* íconos y texto oscuros */
}
#video-modal.split-view .zoom-menu::after{
  background: #f9fafb;       /* mismo color que el menú */
  border-left: none;         /* ← sin línea gris */
  border-top: none;          /* ← sin línea gris */
  box-shadow: none;  
}


.header-dark .zoom-menu{
  border-color: rgba(255,255,255,.12);
}
.header-dark .zoom-menu::after{
  border-color: rgba(255,255,255,.12);
}


/* Modal NO split: flechas del carrusel en blanco */
#video-modal:not(.split-view) #scroll-left i,
#video-modal:not(.split-view) #scroll-right i {
  color: #fff !important;            /* blanco */
  text-shadow: 0 1px 2px rgba(0,0,0,.35); /* (opcional) mejor contraste */
}


#video-modal #scroll-left,
#video-modal #scroll-right {
  top: calc(50% + 8px) !important;    /* apenas debajo del centro */
  transform: translateY(-50%) !important;
}

#video-modal.split-view #scroll-left,
#video-modal.split-view #scroll-right {
  top: calc(50% + 8px) !important;    /* menos abajo en modo split */
}

/* Footer de cada <details>: más pequeño y separado de abajo */
#subcategoria-body .collapse-controls{
  padding: .35rem .8rem;           /* más compacto */
  font-size: .6875rem;             /* ~11px */
  margin-bottom: .75rem;           /* separa un poco del borde inferior */
}

#subcategoria-body .collapse-controls button{
  gap: .2rem;                      /* menos separación icono–texto */
  padding: 0;
}

#subcategoria-body .collapse-controls i{
  font-size: .75rem;               /* iconos un poco más chicos */
}

#subcategoria-body .collapse-controls span{
  font-size: .6875rem;             /* texto aún más pequeño */
  letter-spacing: .02em;
}

/* Reduce la separación entre los dos botones de la derecha */
#subcategoria-body .collapse-controls .space-x-6 > :not([hidden]) ~ :not([hidden]){
  margin-left: .4rem !important;   /* más compacto aún */
}

/* FULL modal: un poco más de aire bajo las miniaturas del carrusel */
#video-modal:not(.split-view) #thumbnail-carousel{
  /* antes tenías .5rem; subimos un poco y respetamos el safe area en móviles */
  padding-bottom: calc(.9rem + env(safe-area-inset-bottom)) !important;
}

/* Micro-aire dentro del contenedor de thumbs (opcional) */
#video-modal:not(.split-view) #video-thumbnails{
  padding-bottom: .25rem !important;
}



/* FULL modal (no split): borde superpuesto sin cambiar el tamaño */
#video-modal:not(.split-view) .media-thumb{
  position: relative;
  overflow: hidden;
  border-radius: .4rem;
}

#video-modal:not(.split-view) .media-thumb img{
  display: block;
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;
  border: 0 !important;
}

#video-modal:not(.split-view) .media-thumb.selected{
  border: 0 !important;
  outline: 0 !important;
}

#video-modal:not(.split-view) .media-thumb.selected::after{
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  pointer-events: none;
  box-sizing: border-box;
  box-shadow:
    inset 0 0 0 1.5px rgba(255,255,255,.85),
    inset 0 0 0 3px #525354;
}

/* SPLIT modal: mismo marco pero invertido */
#video-modal.split-view .media-thumb{
  position: relative;
  overflow: hidden;
  border-radius: .4rem;
}

#video-modal.split-view .media-thumb img{
  display: block;
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;
  border: 0 !important;
}

#video-modal.split-view .media-thumb.selected{
  border: 0 !important;
  outline: 0 !important;
}

#video-modal.split-view .media-thumb.selected::after{
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  pointer-events: none;
  box-sizing: border-box;
  /* invertido: gris fino primero, blanco grueso afuera */
  box-shadow:
    inset 0 0 0 1.5px #525354,
    inset 0 0 0 3px rgba(255,255,255,.85);
}







/* —— FIX: split a base de variables, anulando el 60/40 ——————————— */
#video-modal.split-view{
  left: var(--split-left) !important;
  width: var(--split-w) !important;
  right: auto !important;     /* anula cualquier right:0 previo */
  height: auto !important;
}

body.split-view-active .dashboard-container{
  width: calc(var(--split-left)) !important; /* mitad izquierda real */
}

/* Sugerencia: si aún tienes algo así en tu CSS, bórralo o déjalo comentado:
#video-modal.split-view { right:0 !important; left:60% !important; width:40% !important; }
body.split-view-active .dashboard-container{ width:60vw; }
*/


#subcategoria-body .texto-lista p{margin:.5rem 0;}
#subcategoria-body .texto-lista ul{list-style:disc; margin:.5rem 0 .5rem 1.25rem;}
#subcategoria-body .texto-lista ol{list-style:decimal; margin:.5rem 0 .5rem 1.25rem;}
#subcategoria-body .texto-lista li{margin:.25rem 0;}
#subcategoria-body .texto-lista li > ul{list-style:circle; margin-top:.25rem;}
#subcategoria-body .texto-lista strong{font-weight:700;}


/* === TOC: subtítulos (h3) === */
#subcategoria-sidebar .toc-sub{ margin:.125rem 0 .25rem 0; }
#subcategoria-sidebar .toc-h3{
  width:100%;
  display:block;
  text-align:left;
  background:transparent;
  border:none;
  padding:.25rem .75rem .25rem 1.5rem; /* sangría bajo el h2 */
  font-size:.7rem;                   /* ~14px */
  color:#374151;                       /* gray-700 */
  border-radius:.375rem;
  cursor:pointer;
}
#subcategoria-sidebar .toc-h3:hover{ background:#f8fafc; }
#subcategoria-sidebar .toc-h3.is-active{
  background:transparent !important;
  color:#111827 !important;
  font-weight:500 !important;
  box-shadow: inset 3px 0 0 #9ca3af;  /* mini banda izquierda */
}


/* === TOC: resaltar CONTENEDOR cuando el activo es un h2 con subtítulos === */
#subcategoria-sidebar .toc-section{
  transition: background-color .2s ease, box-shadow .2s ease;
  border-radius:.5rem; /* redondeo normal cuando no está activo */
}
#subcategoria-sidebar .toc-section.is-active{
  background:#f3f4f6;                 /* gris suave a todo el bloque */
  border-radius:0 !important;
  box-shadow:
    inset 3px 0 0 #9ca3af,            /* banda izquierda */
    inset 0 .5px 0 #e5e7eb,           /* hairline superior */
    inset 0 -.5px 0 #e5e7eb,          /* hairline inferior */
    inset -.5px 0 0 #e5e7eb;          /* borde derecho fino */
}
#subcategoria-sidebar .toc-section.is-active .toc-h2{
  background:transparent !important;  /* evita doble fondo en el h2 */
  color:#111827;
  font-weight:500;
}

/* Subtítulo activo: solo él lleva la banda (no todo el bloque) */
#subcategoria-sidebar .toc-h3.is-active{
    border-radius: 0 !important;     /* ← quita la curva */
  background:transparent !important;
  color:#111827 !important;
  font-weight:500 !important;
  box-shadow: inset 3px 0 0 #9ca3af;
}

/* Opcional: enderezar también el contenedor cuando el activo es un h3 */
#subcategoria-sidebar .toc-section:has(.toc-h3.is-active){
  border-radius: 0 !important;
}

/* TOC: subtítulo activo con borde gris completo, igual a los títulos */
#subcategoria-sidebar .toc-h3.is-active {
  /* mismo fondo gris que los títulos activos */
  background: #f3f4f6 !important;    /* ← pisa el "transparent !important" anterior */
  color: #111827;                     /* gray-900 */
  font-weight: normal;

  /* sin radios para que “toque” los bordes */
  border-radius: 0 !important;

  /* hairlines arriba/abajo y borde derecho sutil SIN alterar layout */
  box-shadow:
    inset 2px 0 0 #9ca3af,            /* banda izquierda */
    inset 0 .5px 0 #e5e7eb,           /* borde superior */
    inset 0 -.5px 0 #e5e7eb,          /* borde inferior */
    inset -.5px 0 0 #e5e7eb;          /* borde derecho */
}


/* === Sweep celeste por DETRÁS del texto, un poco más lento === */
.flash-mark{
  position: relative;
  display: inline-block;
  z-index: 0;                 /* crea stacking context para apilar detrás */
}
.flash-mark::after{
  content: "";
  position: absolute;
  inset: 0 .06em;             /* mini margen lateral */
  background: rgba(186,230,253,.9); /* sky-200 */
  border-radius: .18em;
  pointer-events: none;

  /* detrás del texto */
  z-index: -1;                /* ← clave: queda por debajo del contenido */
  transform-origin: left center;
  transform: scaleX(0);

  /* más lento: barrido 0.8s + desvanecido 0.5s */
  animation:
    flash-sweep .9s cubic-bezier(.22,.61,.36,1) forwards,
    flash-fade  .6s ease-out .8s forwards;
}

@keyframes flash-sweep { to { transform: scaleX(1); } }
@keyframes flash-fade  { to { opacity: 0; } }



/* Botón activo del selector Light/Dark/System */
/* Botón activo del selector Light/Dark/System */
#um-theme button.is-active {
  background:#E6F3F5;
  color:rgb(53,120,134);
  border: 1.5px solid rgb(53,120,134);  /* borde teal */
  box-shadow: none;              /* quitamos el inset */
}

/* Segmento activo estilo Amboss */
.seg-active {
  background: rgb(222,241,243) !important;
  color: rgb(53,120,134) !important;
  border: 1.5px solid rgb(53,120,134);  /* borde teal */
  box-shadow: none !important;           /* sin doble borde */
  font-weight: 700 !important;
}

/* Botón flotante tipo AMBOSS para contraer/expandir sidebars */
#sb-switch{
    transform: scale(0.7);   /* Reduce todo el bloque al 80% */
  padding: 4px 6px;        /* Ajusta el relleno interno */
  font-size: 0.85rem;      /* Texto más chico, si lo tuviera */
  position: fixed;
  top: calc(3rem + 8px);                 /* justo debajo del header */
  left: var(--btn-left, 280px);          /* la calcula JS según ancho real */
  width: 28px; height: 28px;
  display:grid; place-items:center;
  background:rgb(245, 247, 249);
  border: 1px solid rgba(0,0,0,.08);
  border-radius: 9999px;
  box-shadow: 0 6px 6px rgba(164, 163, 163, 0.12);
  color:#546E7A;
   z-index: 150 !important;                         /* por encima de las barras */
  cursor: pointer;
}
#sb-switch i{ font-size: 10px; }

/* Cuando las barras están ocultas, el botón se pega al borde izquierdo */
body.bars-hidden #sb-switch{
  left: 8px;
}
body.bars-hidden #sb-switch i{
  transform: rotate(180deg);             /* chevron hacia la derecha */
}

/* Pequeña protección para que no tape el hover de tu sidebar colapsada */
#sidebar.collapsed:hover + #subcategoria-sidebar ~ #sb-switch,
#sidebar.collapsed.hover-expanded + #subcategoria-sidebar ~ #sb-switch{
  pointer-events: none;
}

/* Oculta el botón flotante cuando las barras están ocultas */
body.bars-hidden #sb-switch { display: none !important; }

/* —— Opciones tipo AMBOSS (línea fina, círculo y botón X) —— */
/* Lista de opciones con líneas finas */
/* —— Opciones tipo AMBOSS (compactas) —— */
/* Lista de opciones con líneas finas */
.opt-list { margin: 0; padding: 0; list-style: none; }
.opt-list > li { padding: .15rem .2rem .15rem 0; }   /* 🔽 menos padding vertical */
.opt-list > li + li {
  border-top: none;                 /* quita la línea gris */
  box-shadow: inset 0 1px 0 #e5e7eb; /* simula línea interna */
}

/* Fila */
/* —— Opciones compactas y homogéneas —— */
/* —— Opciones compactas y homogéneas —— */
.option-row { 
  display: flex; 
  align-items: center; 
  gap: .05rem; 
  padding-top: .05rem; 
  padding-bottom: .05rem;   /* compacto */
}
.option-row:hover { background: #f9fafb; }

/* Círculo con la letra (A, B, …) */
.opt-bullet {
  width: 14px; height: 14px;          /* círculo se mantiene */
  flex: 0 0 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid #cbd5e1;          /* gris */
  border-radius: 9999px;
  font-weight: 600;
  font-size: 7px;                     /* 🔽 más pequeño dentro del mismo círculo */
  line-height: 1;
  color: #334155;                     /* slate-700 */
  background: transparent;
}

/* Texto de la opción */
.opt-text { 
  color: #334155; 
  font-size: 10px;                    /* tamaño legible pero discreto */
  line-height: 1.2;
}

/* Texto tachado */
.opt-text.striked {
  text-decoration: line-through;
  color: #94a3b8;                     /* gris apagado */
}

/* Botón X */
.opt-x{
  margin-left:auto;
  width: 16px; height: 16px;          /* 🔽 más chico */
  display:grid; place-items:center;
  border-radius:9999px;
  color:#64748b;
  background:transparent;
  border: 1px solid transparent;
}
.opt-x:hover{
  background:#f1f5f9;
  border-color:#e2e8f0;
  color:#0f172a;
}
.opt-x i{ font-size: 9px; }           /* 🔽 más chico */

/* Base (tal como la tienes) */
.opt-bullet{
  width: 14px; height: 14px;
  flex: 0 0 14px;
  display:flex; align-items:center; justify-content:center;
  border: 1px solid #cbd5e1;      /* gris por defecto */
  border-radius:9999px;
  font-weight:600;
  font-size:7px;
  line-height:1;
  color:#334155;                   /* gris por defecto */
  background:transparent;
}

/* Estados para corrección */
.opt-bullet.ok      { border-color:#16a34a; color:#16a34a; background:transparent; } 
.opt-bullet.ok-solid{ border-color:#15803d; background:#15803d; color:#fff; } /* ✅ más oscuro */

.opt-bullet.err     { border-color:#dc2626; color:#dc2626; background:transparent; } /* rojo contorno/letra */
.opt-bullet.err-solid{border-color:#dc2626; background:#dc2626; color:#fff; }        /* rojo sólido (letra blanca) */


/* Verde más oscuro (para la opción correcta) */
/* Verde más oscuro SOLO de fondo para la opción correcta */
.option-row.correct {
  background-color:#dcfce7 !important; /* green-100 */
  border-color:#22c55e !important;     /* igual que la explicación */
}

/* Barra fija SOLO en split derecho (favoritos/guardados) */
/* Barra fija SOLO en split derecho (favoritos/guardados) */
body.favorites-split #subcategoria-content{
  position: relative;
  padding-top: 0 !important;     /* la barra real ocupa su alto */
}
/* anula cualquier pseudo-barra previa */
body.favorites-split #subcategoria-content::before{ content: none !important; }

/* barra real con el look de la captura */
.fav-topbar{ display: none; }     /* oculta por defecto */
body.favorites-split .fav-topbar{
  position: sticky;
  top: 0;                         /* pegada al borde superior del split */
  height: 3rem;
  display: flex;                  /* visible solo en favorites-split */
  align-items: center;
  justify-content: space-between;
  padding: 0 .75rem;
  background: linear-gradient(to bottom,#f8fafc,#ffffff);
  border-bottom: 1px solid #e5e7eb;
  z-index: 20;
}

/* íconos y separador como en la captura */
.fav-topbar .fav-btn{
  display:inline-flex; align-items:center; justify-content:center;
  width:1.5rem; height:1.5rem; border-radius:9999px; border:0; background:transparent;
}
.fav-topbar .fav-btn i{ font-size:1rem; color:#475569; }           /* slate-600 */
.fav-topbar .fav-actions{ display:inline-flex; align-items:center; gap:.75rem; }
.fav-topbar .fav-actions i{ font-size:1.05rem; color:#475569; }     /* slate-600 */
.fav-topbar .fav-sep{ width:1px; height:18px; background:#e5e7eb; display:inline-block; }





/* Verde más claro (para la explicación) */
.explicacion-box > div {
  border-color:#22c55e !important;   /* green-500 */
  background-color:#f0fdf4 !important; /* green-50 */
}

/* Texto de la opción: siempre negro (o casi) */
.opt-text{ color:#111827 !important; font-size:10px; line-height:1.2; }




/* deshabilita click en botones de tachar cuando están "disable" */
.opt-x[aria-disabled="true"] { pointer-events: none; cursor: default; }


/* Sin hover cuando la pregunta está respondida (locked) */
.opt-list.locked .option-row {
  pointer-events: none;   /* desactiva :hover y clicks */
  cursor: default;
}

/* Footer bajo las opciones */
.opt-footer{ margin-top:.25rem; padding-top:.25rem; }

/* Línea igual a las internas (hairline) */
.opt-divider{
  height:1px;
  background:#e5e7eb;     /* slate-200 */
  width:100%;
  margin:.25rem 0 .35rem 0;
}

/* Botón Reset */
.opt-reset{
  font-size:10px;
  line-height:1;
  padding:.35rem .55rem;
  border:1px solid #cbd5e1;           /* slate-300 */
  border-radius:.375rem;
  background:#f8fafc;                 /* slate-50 */
  color:#64748b;                      /* slate-500 */
  opacity:.6;
  cursor:default;
}
.opt-reset.enabled{
  opacity:1;
  cursor:pointer;
  background:#ffffff;
  color:#0f172a;                       /* slate-900 */
}
.opt-reset:disabled{ pointer-events:none; }

#subcategoria-sidebar-content { scroll-behavior: smooth; }


blockquote {
  white-space: normal;   /* asegura saltos de línea normales */
  overflow-wrap: break-word; /* permite cortar solo si no hay espacios */
}




/* ===== Tabs estilo normal ===== */
.tabsbar {
  position: relative;
  display: flex;
  gap: 28px;
  align-items: center;
  border-bottom: 1px solid #e6edf3;   /* línea gris clarita */
  padding-bottom: 10px;
  margin-bottom: 4px;
}

.tab-btn {
  appearance: none;
  border: 0;
  background: none;
  padding: 0;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  font-size: 18px;
  line-height: 1.2;
  color: #2e4454;
  opacity: .92;
  cursor: pointer;
}

.tab-btn .count {
  font-weight: 600;
  opacity: .9;
}

.tab-btn i {
  font-size: 18px;
  color: #2e4454;
  opacity: .9;
}

.tab-btn.is-active {
  color: #0ea5e9;           /* celeste activo */
}

.tab-btn.is-active i {
  color: #0ea5e9;
}

.tabs-ink {
  position: absolute;
  left: 0;
  bottom: -2px;
  height: 4px;
  width: 0;
  background: #0ea5e9;
  border-radius: 2px;
  transition: left .22s ease, width .22s ease;
}


/* ===== Tabs ultracompactas (versión pequeña) ===== */
.tabsbar.tabsbar--xs {
  gap: 12px;
  padding-bottom: 4px;
  border-bottom-width: 1px;
}

.tabsbar.tabsbar--xs .tab-btn {
  font-size: 10px;       /* texto mucho más pequeño */
  line-height: 1.05;
  gap: 4px;
}

.tabsbar.tabsbar--xs .tab-btn i {
  font-size: 9px;        /* icono más pequeño */
}

.tabsbar.tabsbar--xs .tab-btn .count {
  font-weight: 600;
  opacity: .75;
  font-size: 10px;
}

.tabsbar.tabsbar--xs .tabs-ink {
  height: 2px;           /* subrayado muy fino */
  bottom: -2px;
}


/* === Fondo blanco para la página de resultados (Overview/Articles/Drugs/…) === */
#main-content:has(#search-page:not(.hidden)),
#search-page {
  background-color: #ffffff !important;
}

/* Mostrar el contenido del grupo que esté abierto (o el grupo bajo el puntero)
   incluso si el panel tiene la clase .hidden */
#articles-panel > div {
  margin-right: 2rem !important;  /* separación propia de cada panel */
}





/* Solo en móvil y SOLO cuando #subcategoria-content está visible */
@media (max-width: 639.98px){
  #main-content.subcat-active{
    padding-left: 0 !important;
    padding-right: 0 !important;
  }
  #main-content.subcat-active #subcategoria-content{
    padding-left: 0 !important;
    padding-right: 0 !important;
  }
}



/* Overlay móvil: solo se activa en < 640px */
#mobile-overlay { display: none; }
@media (max-width: 639.98px){
  #mobile-overlay.show {
    position: fixed;
    top: 3rem;   /* igual a la altura de tu header h-[3rem] */
    left: 0; right: 0; bottom: 0;
    background: rgba(2, 6, 23, .45); /* gris oscuro translúcido */
    /* Debe quedar POR DEBAJO de ambas sidebars y POR ENCIMA del contenido */
    display: block;
  }
}


#results{
  position: relative;   /* o fixed/absolute según tu layout */
  z-index: 90;          /* > 45 del overlay móvil */
}
/* el header / topbar que contiene el input */
#topbar, .site-header, #global-search-wrap {
  position: relative;     /* crea stacking context propio */
  z-index: 250;           /* mayor que el sidebar (60/70) y el #sb-switch (120) */
}

/* el wrapper REAL del buscador */
#searchbox { position: relative; z-index: 255; }
/* el dropdown */
#search-results { position: absolute; z-index: 260; }
#search-results.history-mode,
#search-results.results-mode {
  padding: 0;
  background: linear-gradient(180deg, #f5f8fb 0%, #e8eef5 100%);
  border: 1px solid #ccd6e3;
  border-radius: 12px;
  box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
  overflow: hidden;
}
#search-results.history-mode .history-container,
#search-results.results-mode .history-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 12px;
  font-family: 'Lato', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}
#search-results.history-mode .history-header,
#search-results.results-mode .history-header {
  font-size: 10px;
  font-weight: 800;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #4a6684;
}
#search-results.history-mode .history-list,
#search-results.results-mode .history-list {
  background: #ffffff;
  border: 1px solid #dfe6f0;
  border-radius: 10px;
  overflow: hidden;
}
#search-results.history-mode .history-item,
#search-results.results-mode .history-item {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  padding: 10px 14px;
  font-size: 12px;
  color: #1f2933;
  background: #ffffff;
  transition: background-color 0.2s ease;
  border: none;
  text-align: left;
  cursor: pointer;
}
#search-results .history-item.is-active {
  background: #e3e9f3;
}
#search-results .history-item.is-active .history-icon {
  color: #2f4c6b;
}
#search-results.history-mode .history-item.history-empty,
#search-results.results-mode .history-item.history-empty {
  cursor: default;
  color: #64748b;
  pointer-events: none;
}
#search-results.history-mode .history-item + .history-item,
#search-results.results-mode .history-item + .history-item {
  border-top: 1px solid #edf1f7;
}
#search-results.history-mode .history-item:hover,
#search-results.results-mode .history-item:hover {
  background: #f1f5f9;
}
#search-results.history-mode .history-item.history-empty:hover,
#search-results.results-mode .history-item.history-empty:hover {
  background: #ffffff;
}
#search-results.history-mode .history-icon,
#search-results.results-mode .history-icon {
  font-size: 12px;
  color: #6b7f99;
}
#search-results.history-mode .history-footer,
#search-results.results-mode .history-footer {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  font-size: 10px;
  color: #5b6c7c;
  padding: 0 2px 4px 2px;
}
#search-results.history-mode .history-footer span,
#search-results.results-mode .history-footer span {
  display: inline-flex;
  align-items: center;
  gap: 4px;
}
#search-results.history-mode .history-shortcut,
#search-results.results-mode .history-shortcut {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 20px;
  padding: 2px 6px;
  border-radius: 4px;
  background: #eef3f8;
  border: 1px solid #d6dde7;
  font-weight: 600;
  color: #25364c;
}

#search-results.history-mode .history-badge,
#search-results.results-mode .history-badge {
  margin-left: auto;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 9999px;
  background: #eef3f8;
  border: 1px solid #d6dde7;
  font-weight: 600;
  color: #425a78;
}










/* ====== VARIABLES GLOBALES ====== */
:root{
  --sb-collapsed: 40px;
  --subcat-width: 180px;
  --bars-w: calc(var(--sb-collapsed) + var(--subcat-width));
}

/* ====== OVERLAY BASE ====== */
#mobile-overlay{ display:none; }
#mobile-overlay.show{
  position: fixed;
  top: 3rem; bottom: 0; right: 0;
  left: var(--bars-w);
  background: rgba(2,6,23,.45);
  z-index: 110 !important;
  display: block !important;
  pointer-events: auto;
}
/* Estados especiales del overlay */
.toc-hidden #mobile-overlay.show{ left: var(--sb-collapsed); }
body.bars-hidden #mobile-overlay.show{ left: 0; }


/* ===================== <640px ===================== */
@media (max-width: 639.98px){

  /* Estado base: solo un panel (mobile-solo) */
  body.split-view-active.mobile-solo{
    --split-left: 0px;
    --split-w: 100vw;
  }

  /* Panel izquierdo (app) a pantalla completa */
  body.split-view-active.mobile-solo .dashboard-container{
    position: fixed;
    top: 3rem; left: 0; right: 0; bottom: 0;
    width: 100% !important;
    height: auto;
    overflow: hidden;     /* el scroll vive en #main-content */
    background: #fff;
    z-index: 30 !important;
  }

  /* Scroller real */
  body.split-view-active.mobile-solo #main-content{
    position: absolute; inset: 0;
    overflow-y: auto; -webkit-overflow-scrolling: touch;
    padding: 0 1rem !important;
    background: #fff !important;
    scroll-padding-top: 56px;
  }

  /* Afinados del contenido izquierdo */
  body.split-view-active.mobile-solo #subcategoria-content{
    margin-top: 0 !important; padding-top: 0 !important;
  }
  body.split-view-active.mobile-solo #subcat-header{
    position: sticky; top: 0; z-index: 50; background:#fff;
  }
  body.split-view-active.mobile-solo #subcategoria-body > :first-child{
    margin-top: 0 !important;
  }

  /* Sin gutter y ancho total reales */
  body.split-view-active.mobile-solo .dashboard-container{
    left: 0 !important; right: 0 !important; width: 100vw !important;
  }
  body.split-view-active.mobile-solo #main-content{
    margin: 0 !important; width: 100% !important; max-width: none !important;
    padding: 0 !important; box-sizing: border-box;
  }
  body.split-view-active.mobile-solo #main-content.sidebar-open{ margin-left: 0 !important; }

  /* Ocultar barras por defecto en mobile-solo */
  body.split-view-active.mobile-solo #sidebar,
  body.split-view-active.mobile-solo #subcategoria-sidebar{
    display: none !important;
  }

  /* RIGHT (modal) a pantalla completa */
  body.split-view-active.mobile-solo #video-modal.split-view{
    position: fixed !important;
    top: 3rem !important; left: 0 !important; right: 0 !important; bottom: 0 !important;
    width: 100% !important; height: auto !important;
    pointer-events: auto !important;
  }
  body.split-view-active.mobile-solo #video-modal.split-view > div{ position: absolute; inset: 0; }

  /* Toggle de qué lado se ve */
  body.split-view-active.mobile-solo.show-left  .dashboard-container{ display:block !important; }
  body.split-view-active.mobile-solo.show-left  #video-modal{        display:none  !important; }
  body.split-view-active.mobile-solo.show-right .dashboard-container{ display:none  !important; }
  body.split-view-active.mobile-solo.show-right #video-modal{         display:flex !important; }

  /* Botón flotante para alternar */
  #mobile-split-switch{
    position: fixed; left: 50%; transform: translateX(-50%);
    bottom: calc(env(safe-area-inset-bottom) + 10px);
    z-index: 300; padding: .55rem .9rem; border-radius: 9999px;
    background: #1f2937; color: #fff; font-weight: 700; font-size: .75rem;
    box-shadow: 0 4px 14px rgba(0,0,0,.25); display: none;
  }
  body.split-view-active.mobile-solo #mobile-split-switch{ display:block; }

  /* ===== Mostrar la DERECHA (imagen) con barras superpuestas ===== */
  body.split-view-active.mobile-solo.show-right .dashboard-container{ display: contents !important; }
  body.split-view-active.mobile-solo.show-right #main-content{ display: none !important; }

  /* Barra principal colapsada fija */
  body.split-view-active.mobile-solo.show-right #sidebar{
    position: fixed !important; top: 3rem !important; bottom: 0 !important; left: 0 !important;
    z-index: 120 !important; width: var(--sb-collapsed) !important;
    padding-left: 0 !important; padding-right: 0 !important;
    border-right: 1px solid #e5e7eb; background: #fff;
    display: block !important;
  }
  /* Look colapsado: solo iconos */
  body.split-view-active.mobile-solo.show-right #sidebar .sidebar-group span{ display: none !important; }
  body.split-view-active.mobile-solo.show-right #sidebar .sidebar-group i{
    margin: auto !important; justify-content: center !important;
  }

  /* TOC fijo junto a la principal (visible aunque tenga .hidden) */
  body.split-view-active.mobile-solo.show-right #subcategoria-sidebar,
  body.split-view-active.mobile-solo.show-right #subcategoria-sidebar.hidden{
    position: fixed !important; top: 3rem !important; bottom: 0 !important;
    left: var(--sb-collapsed) !important; width: var(--subcat-width) !important;
    z-index: 120 !important; background: #fff; border-right: 1px solid #e5e7eb;
    overflow-y: auto; display: block !important;
  }
  /* (tenías padding solo en show-right) */

  /* Modal por debajo de las barras */
  body.split-view-active.mobile-solo.show-right #video-modal.split-view{ z-index: 40 !important; }

  /* Alternar visibilidad con .bars-hidden (ambos lados) */
  body.split-view-active.mobile-solo.show-right.bars-hidden #sidebar,
  body.split-view-active.mobile-solo.show-right.bars-hidden #subcategoria-sidebar{
    display: none !important;
  }

  /* ===== Mostrar la IZQUIERDA con barras superpuestas ===== */
  body.split-view-active.mobile-solo.show-left #sidebar{
    display: block !important; position: fixed !important;
    top: 3rem !important; bottom: 0 !important; left: 0 !important;
    z-index: 120 !important; width: var(--sb-collapsed) !important;
    border-right: 1px solid #e5e7eb; background: #fff;
  }
  body.split-view-active.mobile-solo.show-left #subcategoria-sidebar,
  body.split-view-active.mobile-solo.show-left #subcategoria-sidebar.hidden{
    display: block !important; position: fixed !important;
    top: 3rem !important; bottom: 0 !important; left: var(--sb-collapsed) !important;
    width: var(--subcat-width) !important; z-index: 120 !important;
    background: #fff; border-right: 1px solid #e5e7eb; overflow-y: auto;
  }
  /* Overlay visible en show-left (además del modo .show base) */
  body.split-view-active.mobile-solo.show-left #mobile-overlay{ display: block !important; }
  body.split-view-active.mobile-solo.show-left.bars-hidden #sidebar,
  body.split-view-active.mobile-solo.show-left.bars-hidden #subcategoria-sidebar,
  body.split-view-active.mobile-solo.show-left.bars-hidden #mobile-overlay{
    display: none !important;
  }

  /* ===== Hover: la barra principal flota SOBRE el TOC ===== */
  body.split-view-active.mobile-solo.show-left  #sidebar.collapsed:hover,
  body.split-view-active.mobile-solo.show-left  #sidebar.collapsed.hover-expanded,
  body.split-view-active.mobile-solo.show-right #sidebar.collapsed:hover,
  body.split-view-active.mobile-solo.show-right #sidebar.collapsed.hover-expanded{
    position: fixed !important; top: 3rem !important; bottom: 0 !important; left: 0 !important;
    width: calc(var(--sb-collapsed) + var(--subcat-width)) !important;
    z-index: 140 !important; background: #fff !important;
    box-shadow: 2px 0 12px rgba(0,0,0,.14);
  }
  body.split-view-active.mobile-solo.show-left  #sidebar.collapsed:hover ~ #subcategoria-sidebar,
  body.split-view-active.mobile-solo.show-left  #sidebar.collapsed.hover-expanded ~ #subcategoria-sidebar,
  body.split-view-active.mobile-solo.show-right #sidebar.collapsed:hover ~ #subcategoria-sidebar,
  body.split-view-active.mobile-solo.show-right #sidebar.collapsed.hover-expanded ~ #subcategoria-sidebar{
    left: var(--sb-collapsed) !important;
    z-index: 120 !important;
    pointer-events: none;
  }

  /* FIX: en show-right, mostrar textos al expandir la barra principal */
  body.split-view-active.mobile-solo.show-right #sidebar.collapsed:hover,
  body.split-view-active.mobile-solo.show-right #sidebar.collapsed.hover-expanded{
    width: calc(var(--sb-collapsed) + var(--subcat-width)) !important;
  }
  body.split-view-active.mobile-solo.show-right #sidebar.collapsed:hover .sidebar-group span,
  body.split-view-active.mobile-solo.show-right #sidebar.collapsed.hover-expanded .sidebar-group span{
    display: inline !important;
  }
  body.split-view-active.mobile-solo.show-right #sidebar.collapsed:hover .sidebar-group i,
  body.split-view-active.mobile-solo.show-right #sidebar.collapsed.hover-expanded .sidebar-group i{
    margin: 0 !important; justify-content: flex-start !important;
  }
  body.split-view-active.mobile-solo.show-right #sidebar.open .sidebar-group span{
    display: inline !important;
  }
  body.split-view-active.mobile-solo.show-right #sidebar.open .sidebar-group i{
    margin: 0 !important; justify-content: flex-start !important;
  }

  /* === FIX TOC alignment — padding igual en ambos lados === */
  body.split-view-active.mobile-solo #subcategoria-sidebar-content{
    padding-left: 0 !important;
    padding-right: 0 !important;
    /* si querés menos alto arriba/abajo, ajustá este padding-top/bottom */
    padding-top: .5rem;
    padding-bottom: .5rem;
  }

  /* Lista limpia (sin sangrías por defecto) */
  #subcategoria-sidebar-content ul{
    list-style: none; margin: 0; padding: 0;
  }
  #subcategoria-sidebar-content li{ margin: 0; }

  /* Fila del TOC ocupando todo el ancho, sin padding lateral */
  #subcategoria-sidebar-content a.toc-row{
    display: flex; align-items: center;
    gap: .5rem;                /* espacio entre icono y texto (no agrega sangría lateral) */
    padding: .45rem 0 !important; /* <-- sin padding L/R */
    margin-left: 0 !important;
    margin-right: 0 !important;
    border-radius: 0 !important;  /* bordes rectos, pegados a la columna */
    text-decoration: none;
    box-sizing: border-box;
  }

  /* Resaltado que toca los bordes de la columna */
  #subcategoria-sidebar-content a.toc-row.is-active{
    background: #eef2f7;
    border-left: 3px solid #93c5fd; /* opcional; toca el borde izquierdo */
  }

  /* Icono sin “empujar” raro: ancho fijo y alineado */
  #subcategoria-sidebar-content a.toc-row i{
    min-width: 1rem; text-align: center;
  }
}


/* Asegura que al hacer scroll el título quede justo debajo del header de 4rem */

/* —— MOBILE <640 + split —— */
@media (max-width: 639.98px){
  /* --- altura del switch en móvil (mantenela en sync con el botón) --- */
  :root {
    --switch-h: 34px;
    --toc-px: .75rem; /* usado arriba; podés cambiarlo una sola vez aquí */
  }

  /* SWITCH VIEW full-width al fondo */
  #mobile-split-switch{
    position: fixed;
    left: 0 !important;
    right: 0 !important;
    bottom: env(safe-area-inset-bottom);
    min-height: var(--switch-h);
    transform: none !important;
    
     
    align-items: center; justify-content: center; gap:.5rem;
    padding: .55rem 1rem;
    padding-left: calc(1rem + env(safe-area-inset-left));
    padding-right: calc(1rem + env(safe-area-inset-right));
    border: 0; border-radius: 0;
    background:rgb(95, 112, 130); color:#fff; font-weight:700; font-size:.75rem; letter-spacing:.04em;
    z-index: 400;
    width: 100% !important;
  
  }

  /* Flecha → cuando estás en el panel izquierdo */
  body.split-view-active.mobile-solo.show-left #mobile-split-switch::after{
    content: "\f061"; /* fas fa-arrow-right */
    font-family: "Font Awesome 5 Free";
    font-weight: 900;
    margin-left: .5rem;
  }

  /* Flecha ← cuando estás en el panel derecho */
  body.split-view-active.mobile-solo.show-right #mobile-split-switch::before{
    content: "\f060"; /* fas fa-arrow-left */
    font-family: "Font Awesome 5 Free";
    font-weight: 900;
    margin-right: .5rem;
  }

  /* Riel detrás del switch */
  body.split-view-active.mobile-solo #video-modal.split-view::after{
    content:""; position: fixed; left:0; right:0; bottom:0;
    height: var(--switch-h);
    background:#f1f5f9; border-top:1px solid #e5e7eb; z-index:380;
  }

  /* UP (cuando NO está dentro del carrusel) → por encima del switch */
  #video-modal.split-view #toggle-thumbnails:not(.in-carousel){
    position: fixed !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    bottom: calc(env(safe-area-inset-bottom) + var(--switch-h) + 2px) !important;
    z-index: 410 !important;
  }

  /* Si el UP está dentro del carrusel */
  #video-modal.split-view #thumbnail-carousel #toggle-thumbnails.in-carousel{
    position: absolute !important;
    top: .25rem !important;
    bottom: auto !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    z-index: 420 !important;
  }

  /* Que el carrusel no tape al switch */
  body.split-view-active.mobile-solo #video-modal.split-view #thumbnail-carousel{
    bottom: calc(var(--switch-h)) !important;
    z-index: 350 !important;
  }
}

/* ==== Ubicación del TOC como en la captura (ambos lados) ==== */


@media (max-width: 639.98px){
  body.bars-hidden #sidebar,
  body.bars-hidden #sb-switch,
  body.bars-hidden #mobile-overlay {
    display: none !important;
  }
}

#sidebar, #subcategoria-sidebar {
  transition: opacity .12s ease, transform .12s ease;
}
#sidebar.force-hidden,
body.bars-hidden #sidebar,
#subcategoria-sidebar.hidden {
  opacity: 0;
  transform: translateX(-8px);
}

/* ≥640px: mostrar barras y eliminar cualquier “invisibilidad” heredada */
@media (min-width: 640px){
  body.bars-hidden #sidebar,
  body.bars-hidden #sb-switch,
  body.bars-hidden #mobile-overlay {
    display: block !important;     /* evita display:none heredados */
  }
  body.bars-hidden #sidebar {
    opacity: 1 !important;
    transform: none !important;    /* que NO quede “fantasma” ocupando ancho */
  }

  /* Deja oculta la segunda barra si no tienes contenido para ella,
     así no aparece la columna blanca vacía */
  #subcategoria-sidebar.hidden { display: none !important; }
}

/* <640px: barras ocultas por defecto (móvil) */
@media (max-width: 639.98px){
  body.bars-hidden #sidebar,
  body.bars-hidden #subcategoria-sidebar {
    display: none !important;
  }
}


/* ——— POPUP de resaltado ——— */
#hl-popover{
  position: fixed;
  display: none;                 /* se muestra por JS */
  background:#0f172a;
  color:#fff;
  padding:3px 4px;               /* compacto */
  border-radius:6px;
  box-shadow:0 6px 16px rgba(0,0,0,.25);
  z-index:1000;
  transform:translate(-50%, -100%);
  gap:2px;                       /* separación mínima entre botones */
}

/* flechita apuntando al texto */
#hl-popover::after{
  content:"";
  position:absolute;
  left:50%;
  bottom:-5px;
  transform:translateX(-50%);
  border-width:5px 5px 0 5px;
  border-style:solid;
  border-color:#0f172a transparent transparent transparent;
}

#hl-popover .hlp-btn{
  width:24px; height:24px;       /* botones más pequeños */
  border-radius:9999px;
  display:inline-flex; align-items:center; justify-content:center;
  border:1px solid rgba(255,255,255,.18);
  cursor:pointer;
}
#hl-popover .hlp-apply{ background:rgb(56, 189, 248); border-color:transparent; }
#hl-popover .hlp-clear{ background:transparent; }
#hl-popover i{ font-size:12px; line-height:1; }

/* Texto resaltado por el usuario */
.my-hl{
  background:rgb(153, 230, 255);
  border-radius:2px;
  padding:0;


}

/* Cuando el toggle esté OFF, quitamos TODA la apariencia del resaltado */
#subcategoria-body.hl-hidden .my-hl{
  background: transparent !important;
  color: inherit !important;
  box-shadow: none !important;
  outline: none !important;
  text-shadow: none !important;
  border: 0 !important;
  border-radius: 0 !important;
  padding: 0 !important;
  background-image: none !important;
  /* (opcional) si tu tema usa subrayados/efectos con pseudo-elementos */
}
#subcategoria-body.hl-hidden .my-hl::before,
#subcategoria-body.hl-hidden .my-hl::after{
  display: none !important;
}



/* === NOTES panel (limpio) === */
.notes-card {
  border: 1px solid #e5e7eb;
  border-radius: .5rem;
  background: #fff;
  box-shadow: 0 6px 18px rgba(0,0,0,.08);
  margin: .5rem 1rem 1rem;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* Toolbar superior */
.notes-toolbar {
  order: 1;
  display: flex;
  gap: .25rem;
  padding: .35rem .5rem;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;         /* gris suave */
}

/* Botones de formato (iconos) */
.notes-tool {
  width: 28px;
  height: 28px;
  display: grid;
  place-items: center;
  border: 1px solid transparent; /* borde transparente (no blanco) */
  border-radius: .375rem;
  color: #475569;
  background: transparent;
  cursor: pointer;
}
.notes-tool:hover,
.notes-tool:focus-visible {
  background: #f1f5f9;
  border-color: #e2e8f0;
  color: #0f172a;
  outline: none;
}

/* ===== Dropdown "Formato" (ventana flotante) ===== */
.notes-format { position: relative; }            /* contenedor del botón ¶ */
.notes-format .notes-tool { padding: 0; }        /* mismo tamaño que los demás */

/* caja flotante */
.notes-menu {
  position: absolute;
  top: calc(100% + .25rem);
  left: 0;
  min-width: 220px;
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: .5rem;
  box-shadow: 0 12px 30px rgba(2,6,23,.12), 0 4px 10px rgba(2,6,23,.06);
  padding: .25rem;
  z-index: 20;
  display: none;                                  /* se muestra con .open */
}
.notes-menu.open { display: block; }

/* cada opción del menú */
.notes-menu-item {
  width: 100%;
  display: block;
  text-align: left;
  background: transparent;
  border: 1px solid transparent;
  border-radius: .375rem;
  padding: .55rem .65rem;
  color: #0f172a;
  font-size: .92rem;
  line-height: 1.2;
  cursor: pointer;
}
.notes-menu-item .subtitle {                      /* por si añades "Normal" vs tamaños */
  display: block;
  font-size: .78rem;
  color: #64748b;
  margin-top: .15rem;
}

.notes-menu-item:hover,
.notes-menu-item:focus-visible {
  background: #f8fafc;
  border-color: #e2e8f0;
  outline: none;
}

.notes-menu-item.is-active {
  background: #eef2ff;                            /* leve señal de activo */
  border-color: #c7d2fe;
}

/* pip/triangulito opcional */
.notes-menu::before {
  content: "";
  position: absolute;
  top: -6px;
  left: 14px;
  width: 10px;
  height: 10px;
  background: #fff;
  border-left: 1px solid #e5e7eb;
  border-top: 1px solid #e5e7eb;
  transform: rotate(45deg);
}

/* Editor */
.notes-editor {
  order: 2;
  flex: 1 1 auto;
  overflow: auto;
  min-height: 140px;
  padding: .75rem .9rem;
  font-size: .9rem;
  line-height: 1.5;
  outline: none;
}
.notes-empty { color: #94a3b8; }

/* Footer sticky con título/contador + acciones */
.notes-head {
  order: 3;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: .5rem .75rem;
  border-top: 1px solid #e5e7eb;
  background: transparent;
  position: sticky;
  bottom: 0;
  z-index: 1;
}

/* Título + contador */
.notes-title-wrap { display: flex; align-items: baseline; gap: .5rem; }
.notes-title      { color: #94a3b8; font-weight: 600; font-size: .9rem; line-height: 1; }
.notes-counter    { font-size: .75rem; color: #94a3b8; letter-spacing: .02em; line-height: 1; }
.notes-counter.is-over { color: #dc2626; font-weight: 600; }

/* Acciones */
.notes-actions { display: flex; gap: .5rem; }

/* Botones Cancel/Save */
.notes-btn-sm {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;

  padding: .25rem 1rem;     /* menos vertical, más horizontal */
  min-height: 25px;
  min-width: 70px;
  line-height: 1.4;

  font-size: .8rem;
  font-weight: 600;

  border: 1px solid #cbd5e1;   /* borde gris como la captura */
  border-radius: .375rem;
  background: #fff;
  color: #334155;
}
.notes-btn-sm.primary {
  background: #0ea5e9;
  border-color: #0ea5e9;
  color: #fff;
}


/* ▼ Pégalo en tu CSS (o inyecta un <style>) */
.notes-card .notes-editor ol{
  list-style: decimal !important;
  margin-left: 1.25rem;   /* sangría cómoda */
  padding-left: .75rem;
}
.notes-card .notes-editor ul{
  list-style: disc !important;
  margin-left: 1.25rem;
  padding-left: .75rem;
}
.notes-card .notes-editor li{
  display: list-item;     /* por si algún reset puso display:block */
  margin: .2rem 0;
}

/* Separadores personalizados para sticky bar: fav y close */
#subcat-header.is-stuck .highlighting-bar .fav-btn.fav{ position: relative; }
#subcat-header.is-stuck .highlighting-bar .fav-btn.fav::after{
  content: "";
  display: inline-block;
  width: 1px; height: 18px;
  background: #e5e7eb;           /* mismo tono que .hl-sep */
  margin-left: .75rem;            /* aire a la derecha del botón */
}

#subcat-header.is-stuck .highlighting-bar .hl-close{ position: relative; }
#subcat-header.is-stuck .highlighting-bar .hl-close::before{
  content: "";
  display: inline-block;
  width: 1px; height: 18px;
  background: #e5e7eb;           /* separador a la izquierda de la X */
  margin-right: .75rem;           /* aire antes de la línea */
}



/* Línea divisoria que acompaña al botón X */
.highlighting-bar .hl-close::before {
  content: "";
  width: 1px;
  height: 18px;
  background: #e5e7eb;
  margin: 0 .75rem;
  display: none; /* por defecto oculta */
}

/* Oculta por defecto */
.highlighting-bar .hl-sep.sticky-only {
  display: none;
}

/* Cuando la barra está sticky, mostrar */
#subcat-header.is-stuck .highlighting-bar .hl-sep.sticky-only {
  display: inline-block;
}

/* Ocultar también el separador izquierdo de la X fuera de favoritos */
body:not(.favorites-split) #subcat-header .hl-sep.sticky-only {
  display: none !important;
}


/* Fuera de favoritos: spacing más compacto aunque esté sticky */
body:not(.favorites-split) #subcat-header .highlighting-bar .hl-right {
  gap: .35rem !important;
}
body:not(.favorites-split) #subcat-header .highlighting-bar .hl-sep {
  margin: 0 .5rem !important;
}


body.favorites-split #subcat-header {
  z-index: 10 !important;
}







  
  
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
<script>
  // Renderer: links abren en nueva pestaña
  const mdRenderer = new marked.Renderer();
  mdRenderer.link = (href, title, text) => {
    const t = title ? ` title="${title}"` : "";
    const h = href || "#";
    return `<a href="${h}"${t} target="_blank" rel="noopener noreferrer">${text}</a>`;
  };

  function renderMD(source) {
    const src = (source ?? "").trim();
    marked.setOptions({
      gfm: true,
      breaks: true,       // respeta saltos de línea simples
      smartLists: true,
      renderer: mdRenderer
    });
    const raw = marked.parse(src);
    return DOMPurify.sanitize(raw);
  }
</script>







  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCK8SLFcVDyvLUUzVjOWOBDGHi0kD8-cKs",
      authDomain: "bancomicina-62bfe.firebaseapp.com",
      projectId: "bancomicina-62bfe",
      storageBucket: "bancomicina-62bfe.appspot.com",
      messagingSenderId: "737254665977",
      appId: "1:737254665977:web:dbafb6c16ad9d96fae7c28"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
  </script>
</head>
<body class="bg-gray-100">

<div id="login-section" class="flex flex-col items-center justify-center min-h-screen px-4 space-y-8">
  <div class="flex items-center">
    <img src="./assets/logo.png" alt="Logo" class="w-12 h-12" />
    <span class="ml-4 text-4xl font-bold text-gray-900">bancomicina</span>
  </div>
  <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-8">
    <h2 class="text-2xl font-bold text-center mb-1">Bienvenido</h2>
    <p class="text-gray-500 text-center mb-6">Inicia sesión o crea una cuenta</p>
    <form id="login-form" class="space-y-4">
      <input type="email" id="email" placeholder="Email" required class="w-full px-4 py-2 bg-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500" />
      <div class="relative">
        <input id="password" type="password" placeholder="Contraseña" required class="w-full px-4 py-2 bg-gray-100 rounded-md pr-10 focus:outline-none focus:ring-2 focus:ring-teal-500" />
        <button type="button" id="togglePassword" class="absolute inset-y-0 right-3 flex items-center text-gray-400">
          <i class="fas fa-eye"></i>
        </button>
      </div>
      <div class="space-y-2 pt-4">
        <button type="submit" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 rounded-md">Iniciar sesión</button>
        <button type="button" id="register-btn" class="w-full border border-teal-500 text-teal-600 font-semibold py-2 rounded-md hover:bg-teal-50">Registrarse</button>
        <button type="button" id="google-signin" class="w-full flex items-center justify-center border border-gray-300 bg-white text-gray-700 font-semibold py-2 rounded-md hover:bg-gray-50">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="w-5 h-5 mr-2">
          Continuar con Google
        </button>
      </div>
    </form>
  </div>
</div>

<div id="user-section" class="hidden min-h-screen w-full">



  
<header id="topbar" class="fixed top-0 left-0 right-0 z-50 bg-white border-b flex items-center px-4 h-[3rem] shadow">
  <!-- Izquierda -->
  <div class="flex items-center space-x-4 shrink-0">
    <!-- Botón menú -->
    <button id="menu-toggle" class="text-gray-700 hover:text-black focus:outline-none">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>

 <!-- Logo + texto -->
    <div class="flex items-center space-x-2 max-[420px]:hidden">
      <img src="./assets/logo.png" alt="Logo" class="w-6 h-6" />
      <span class="hidden sm:inline text-xl font-semibold text-gray-800 font-[Inter]">BANCOMICINA</span>
    </div>

    <!-- Dropdown modo -->
    <div class="relative max-sm:hidden" id="mode-dropdown">
      <button id="mode-btn"
        class="text-xs font-medium bg-[rgb(234,245,248)] text-[rgb(29,125,138)] px-2 py-1 rounded-full flex items-center space-x-1">
        <span id="mode-label">CLÍNICO</span>
        <i class="fas fa-chevron-down text-xs"></i>
      </button>
      <!-- ... menú desplegable ... -->
    </div>
  </div>

<!-- Buscador centrado -->
<div class="flex-1 flex justify-center mr-3">
    <div class="flex items-center gap-1 w-full max-w-[980px] min-w-0">

    <!-- Selector idioma con dropdown -->
    <div class="relative ml-2" id="lang-dropdown">
      <button id="lang-btn"
        class="flex items-center gap-1 bg-[#EEF3F7] text-slate-700 rounded-md px-2.5 h-7 text-xs shadow-sm">
        <span class="font-medium">EN</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 20 20" fill="currentColor">
          <path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 011.08 1.04l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z"/>
        </svg>
      </button>

      <!-- Dropdown oculto -->
      <div id="lang-menu"
           class="absolute top-full left-0 mt-1 w-36 bg-white border border-gray-200 rounded-md shadow-lg hidden text-sm z-50">
        <button class="w-full text-left px-3 py-2 hover:bg-gray-100">EN <span class="text-gray-500">(English)</span></button>
        <button class="w-full text-left px-3 py-2 hover:bg-gray-100">ES <span class="text-gray-500">(Español)</span></button>
      </div>
    </div>

    <!-- Barra de búsqueda -->
      <div id="searchbox"
           class="relative flex items-center gap-2 bg-[#EEF3F7] rounded-md px-2 h-7
                  flex-1 basis-0 min-w-0">
  <!-- Icono lupa -->
<!-- Icono lupa -->
<svg xmlns="http://www.w3.org/2000/svg"
     viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
     class="w-4 h-4 text-slate-500 ml-1 shrink-0">
  <path stroke-linecap="round" stroke-linejoin="round"
        d="m21 21-4.35-4.35m1.1-5.4a7.25 7.25 0 1 1-14.5 0 7.25 7.25 0 0 1 14.5 0Z"/>
</svg>

  <!-- Input (con ellipsis) -->
<input id="global-search" type="text" placeholder="Ask a medical question" autocomplete="off"
               class="flex-1 min-w-0 bg-transparent border-0 focus:outline-none focus:ring-0
                      placeholder-slate-400 text-[12px] leading-6 truncate" />




<!-- Hint o botón clear -->
<span id="search-hint"
      class="pr-1 text-slate-500 text-sm font-medium shrink-0 max-sm:hidden">⌘+K</span>

<button id="search-clear"
        class="hidden text-slate-500 hover:text-slate-700 shrink-0 focus:outline-none">
  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
  </svg>
</button>


  <!-- Resultados -->
  <div id="search-results"
       class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-md shadow-lg hidden
              max-h-80 overflow-auto text-[12px]">
    <!-- items dinámicos -->
  </div>
</div>
    </div>
  </div>

   <!-- Derecha -->
  <div class="flex items-center space-x-4 shrink-0">
    <button id="favorites-trigger" class="text-gray-600 hover:text-black max-sm:hidden" title="Open favorites">
      <i class="far fa-bookmark text-lg"></i>
    </button>
    <div id="user-initial" class="w-8 h-8 rounded-full bg-teal-600 text-white flex items-center justify-center font-semibold cursor-pointer">M</div>
  </div>
</header>


<div id="mobile-overlay" class="hidden"></div>

<!-- Menú flotante de usuario -->
<!-- Menú flotante de usuario (compacto) -->
<div id="user-menu"
     class="hidden fixed z-[100] w-[240px] rounded-[4px] border border-[rgba(15,23,42,.06)]
            bg-white shadow-[0_6px_16px_rgba(0,0,0,.12)]">
  <!-- caret (punta) -->
  <div id="user-menu-caret"
       class="absolute -top-[5px] right-[10px] w-2.5 h-2.5 rotate-45
              bg-white border-t border-l border-[rgba(15,23,42,.06)]"></div>

  <div class="p-3">
    <!-- Nombre + institución -->
    <div class="mb-2">
      <div id="um-name" class="text-[13px] font-[700] leading-[1.3] text-slate-900">
        jhon ramos
      </div>
      <div id="um-sub" class="text-[11px] leading-[1.4] text-slate-400">
        Instituto Universitario CEMIC Escuela de Medicina
      </div>
    </div>

    <!-- Appearance en línea -->
    <div class="mt-3 flex items-center justify-between gap-2">
      <div class="text-[12px] leading-[1.4] text-slate-800 whitespace-nowrap">Appearance</div>

      <!-- Contenedor con borde gris -->
      <div id="appearance-group" class="inline-flex rounded-[4px]">
  <button type="button" data-theme="light"
          class="seg px-2 py-1.5 text-[11px] font-[700]
                 border border-[rgba(15,23,42,.14)]
                 first:rounded-l-[4px] rounded-none
                 text-slate-600">
    Light
  </button>

  <button type="button" data-theme="dark"
          class="seg px-2 py-1.5 text-[11px] font-[600]
                 border border-[rgba(15,23,42,.14)] -ml-px
                 rounded-none text-slate-600">
    Dark
  </button>

  <button type="button" data-theme="system"
          class="seg px-2 py-1.5 text-[11px] font-[600]
                 border border-[rgba(15,23,42,.14)] -ml-px
                 last:rounded-r-[4px] rounded-none text-slate-600">
    System
  </button>
</div>
    </div>

    <!-- Acciones -->
    <div class="mt-3 space-y-1.5">
      <button id="um-edit"
              class="w-full flex items-center justify-between text-left
                     text-[11px] leading-[1.4] text-slate-800 py-1">
        <span>Edit profile</span>
        <i class="fas fa-angle-right text-slate-400 text-[11px]"></i>
      </button>

      <button id="um-logout"
              class="w-full flex items-center justify-between text-left
                     text-[11px] leading-[1.4] text-slate-800 py-1">
        <span>Log out</span>
        <i class="fas fa-angle-right text-slate-400 text-[11px]"></i>
      </button>
    </div>
  </div>
</div>






  <div class="dashboard-container">


















<aside id="sidebar" class="open">
  
<!-- Home -->
  <div class="sidebar-group" id="group-home">
    <a href="#" class="sidebar-item px-3 py-2 rounded" onclick="setActiveLink(this); showHome()">
      <div class="flex items-center">
       <img src="./assets/aaa2.png" data-icon="aaa" class="w-4.3 h-5 shrink-0 sidebar-icon" />
        <span class="ml-2">Home</span>
      </div>
    </a>
  </div>

  <!-- Drugs -->
  <div class="sidebar-group" id="group-drugs">
    <a href="#" class="sidebar-item px-3 py-2 rounded" onclick="setActiveLink(this)">
      <div class="flex items-center">
        <img src="./assets/bbb2.png" data-icon="bbb" class="w-4.3 h-5 shrink-0 sidebar-icon" />
        <span class="ml-2">Drugs</span>
      </div>
    </a>
  </div>

<!-- Clinical resources (botón + acordeón) -->
<div class="sidebar-group" id="group-clinical">
  <button onclick="toggleAccordion('clinical')"
          class="sidebar-item w-full flex items-center justify-between px-3 py-2 rounded"
          data-bookmark-key="clinical"
          data-bookmarked="false">
    <div class="flex items-center">
      <img src="./assets/ccc2.png" data-icon="ccc" class="w-4.3 h-5 shrink-0 sidebar-icon" />
      <span class="ml-2">Clinical resources</span>
    </div>
    <span class="toggle-icons">
      <span class="bookmark-toggle" data-label="Clinical resources" role="button" tabindex="0" aria-pressed="false"><i class="far fa-bookmark text-xs"></i></span>
      <i class="fas fa-chevron-down text-xs transition-transform duration-200"></i>
    </span>
  </button>

  <div id="accordion-clinical" class="ml-8 mt-1 space-y-1 hidden">
    <a id="link-quick" href="#" class="sidebar-item block px-2 py-1 rounded"
       onclick="setActiveLink(this)">Quick Guides</a>
    <a id="link-acute" href="#" class="sidebar-item block px-2 py-1 rounded"
       onclick="setActiveLink(this)">Acute management checklists</a>
    <a id="link-flowcharts" href="#" class="sidebar-item block px-2 py-1 rounded"
       onclick="setActiveLink(this)">Flowcharts</a>
    <a id="link-calculators" href="#" class="sidebar-item block px-2 py-1 rounded"
       onclick="setActiveLink(this)">Calculators</a>
    <a href="#" class="sidebar-item block px-2 py-1 rounded"
       onclick="setActiveLink(this)">Clinical guidelines</a>
    <a href="#" class="sidebar-item block px-2 py-1 rounded"
       onclick="setActiveLink(this)">Dot Phrases</a>
  </div>
</div>

      <div class="sidebar-group" id="group-exams">
  <button onclick="toggleAccordion('exams')"
          class="sidebar-item w-full flex items-center justify-between px-3 py-2 rounded"
          data-bookmark-key="exams"
          data-bookmarked="false">
    <div class="flex items-center">
      <img src="./assets/ddd2.png" data-icon="ddd" class="w-4.3 h-5  shrink-0 sidebar-icon" />
      <span class="ml-2">Exams & CME</span>
    </div>
    <span class="toggle-icons">
      <span class="bookmark-toggle" data-label="Exams &amp; CME" role="button" tabindex="0" aria-pressed="false"><i class="far fa-bookmark text-xs"></i></span>
      <i class="fas fa-chevron-down text-xs transition-transform duration-200"></i>
    </span>
  </button>

  <div id="accordion-exams" class="ml-8 mt-1 space-y-1 hidden">
    <a href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this)">Qbank</a>
    <a href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this)">Session history</a>
    <a href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this)">Study plans and courses</a>
    <a href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this)">Study summary</a>
    <a href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this)">USMLE score predictor</a>
    <a href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this)">CME credits</a>
  </div>
</div>

      <div class="sidebar-group" id="group-library">
  <button onclick="toggleAccordion('library')"
          class="sidebar-item w-full flex items-center justify-between px-3 py-2 rounded"
          data-bookmark-key="library"
          data-bookmarked="false">
    <div class="flex items-center">
     <img src="./assets/eee2.png" data-icon="eee" class="w-4.3 h-5  shrink-0 sidebar-icon" />
      <span class="ml-2">Library</span>
    </div>
    <span class="toggle-icons">
      <span class="bookmark-toggle" data-label="Library" role="button" tabindex="0" aria-pressed="false"><i class="far fa-bookmark text-xs"></i></span>
      <i class="fas fa-chevron-down text-xs transition-transform duration-200"></i>
    </span>
  </button>

  <div id="accordion-library" class="ml-8 mt-1 space-y-1 hidden">
<a id="lib-articles" href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this); showArticles()">Articles</a>
    <a href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this)">Videos</a>
    <a href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this)">Media Library</a>
  </div>
</div>

      <div class="sidebar-group" id="group-account">
  <button onclick="toggleAccordion('account')"
          class="sidebar-item w-full flex items-center justify-between px-3 py-2 rounded"
          data-bookmark-key="account"
          data-bookmarked="false">
    <div class="flex items-center">
      <img src="./assets/fff2.png" data-icon="fff" class="w-4.3 h-5  shrink-0 sidebar-icon" />
      <span class="ml-2">Account & settings</span>
    </div>
    <span class="toggle-icons">
      <span class="bookmark-toggle" data-label="Account &amp; settings" role="button" tabindex="0" aria-pressed="false"><i class="far fa-bookmark text-xs"></i></span>
      <i class="fas fa-chevron-down text-xs transition-transform duration-200"></i>
    </span>
  </button>

  <div id="accordion-account" class="ml-8 mt-1 space-y-1 hidden">
    <a href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this)">Career & study profile</a>
    <a href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this)">Contact details & settings</a>
    <a href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this)">Membership & licenses</a>
    <a href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this)">Invoices</a>
    <a href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this)">Payment info</a>
    <a href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this)">Redeem a code</a>
    <a href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this)">Activate institutional license</a>
    <a href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this)">Notes & more</a>
  </div>
</div>

      <div class="sidebar-group" id="group-help">
  <button onclick="toggleAccordion('help')"
          class="sidebar-item w-full flex items-center justify-between px-3 py-2 rounded"
          data-bookmark-key="help"
          data-bookmarked="false">
    <div class="flex items-center">
      <img src="./assets/ggg2.png" data-icon="ggg" class="w-4.3 h-5  shrink-0 sidebar-icon" />
      <span class="ml-2">Help & privacy</span>
    </div>
    <span class="toggle-icons">
      <span class="bookmark-toggle" data-label="Help &amp; privacy" role="button" tabindex="0" aria-pressed="false"><i class="far fa-bookmark text-xs"></i></span>
      <i class="fas fa-chevron-down text-xs transition-transform duration-200"></i>
    </span>
  </button>

  <div id="accordion-help" class="ml-8 mt-1 space-y-1 hidden">
    <a href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this)">Help Center</a>
    <a href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this)">Privacy Policy</a>
    <a href="#" class="sidebar-item block px-2 py-1 rounded" onclick="setActiveLink(this)">Terms of Service</a>
  </div>
</div>
    </aside>



        <!-- Segunda sidebar para subcategorías -->
    <aside id="subcategoria-sidebar" class="hidden bg-white border-r border-gray-200 h-full overflow-y-auto">
      <div id="subcategoria-sidebar-content" class="p-4"></div>
    </aside>







<main id="main-content" class="bg-gray-100 sidebar-open">
       <div id="articles-panel" class="hidden flex-nowrap gap-x-4 transition-all mt-4">
  <!-- Columna 1: título fuera y card con la lista -->
<div class="flex flex-col pb-6">
    <h2 class="text-lg font-bold mb-2 text-gray-800">Library</h2>
    <div class="bg-white rounded-lg shadow-sm articles-panel-column px-4 py-0">
      <ul class="text-sm divide-y divide-gray-200">
<li>
  <a href="#" onclick="showSecondPanel(this, 'Basic sciences')" class="articles-panel-list-item">
    <span class="ap-icon ap2" aria-hidden="true"></span><span>Basic sciences</span>
  </a>
</li>
      </ul>
    </div>
  </div>

  <!-- Columna 2: título fuera y card con la lista -->
  <div id="panel-2" class="flex flex-col hidden">
    <h2 class="text-lg font-bold mb-2 text-gray-800" id="second-panel-title"></h2>
    <div class="bg-white rounded-lg shadow-sm articles-panel-column px-4 py-0">
      <ul class="text-sm divide-y divide-gray-200">
<li>
  <a href="#" onclick="showThirdPanel(this, 'By discipline')" class="articles-panel-list-item">
    <span class="ap-icon ap2" aria-hidden="true"></span><span>By discipline</span>
  </a>
</li>
      </ul>
    </div>
  </div>

  <!-- Columna 3: título fuera y card con la lista -->
  <div id="panel-3" class="flex flex-col hidden">
    <h2 class="text-lg font-bold mb-2 text-gray-800" id="third-panel-title"></h2>
    <div class="bg-white rounded-lg shadow-sm articles-panel-column px-4 py-0">
      <ul class="text-sm divide-y divide-gray-200">
<li>
  <a href="#" class="articles-panel-list-item">
    <span class="ap-icon ap3" aria-hidden="true"></span>
    <span>General principles of foundational science</span>
  </a>
</li>
      </ul>
    </div>
  </div>
</div>

  <!-- === Página de resultados de búsqueda (tipo AMBOSS) === -->
  <div id="search-page" class="hidden mx-auto max-w-3xl px-6 py-6"></div>

<div id="home-content" class="pt-6">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-semibold">Welcome, <span id="user-name">Usuario</span></h1>
  </div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
  
  <!-- Izquierda: 2/3 -->
  <div id="recent-articles-card" class="col-span-2 bg-white rounded-lg shadow overflow-hidden">
    <div class="px-4 py-2 border-b border-gray-200">
      <h2 class="text-sm font-semibold text-slate-800">Recently viewed articles</h2>
    </div>

    <div id="recent-articles-loading" class="flex items-center justify-center px-4 py-6 text-sm text-slate-500 gap-3">
      <img src="https://i.gifer.com/ZZ5H.gif" alt="Loading" class="w-8 h-8">
      <span>Loading your recently viewed articles…</span>
    </div>

    <div id="recent-articles-empty" class="hidden flex items-center justify-between px-4 py-6 text-sm text-slate-500">
      <span>Your recently viewed articles will appear here.</span>
      <button class="border border-gray-300 text-slate-700 rounded px-3 py-1 text-sm hover:bg-gray-50"
              onclick="goToLibraryArticles()">
        Go to library
      </button>
    </div>

    <ul id="recent-articles-list" class="hidden divide-y divide-gray-200 text-sm text-slate-700">
      <!-- items injected via JS -->
    </ul>
  </div>

  <!-- Derecha: 1/3 -->
  <div class="bg-white rounded-lg shadow border text-center p-4">
    <div>
      <div class="text-xl font-bold mb-2">NEJM Knowledge<span class="text-red-600">+</span></div>
      <p class="text-sm text-gray-600 mb-2">Board Exams and CME</p>
      <p class="text-sm text-gray-500">Study for ABIM, ABFM, and ABP boards and earn CME credits.</p>
    </div>
    <div class="pt-4">
      <button class="px-4 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded">
        Go to Qbank
      </button>
    </div>
  </div>

</div>
</div>



<div id="favorites-view" class="hidden pt-6">
  <div class="flex flex-col gap-4">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-500 font-semibold">Collections</p>
        <h2 class="text-2xl font-bold text-slate-800">Favorites</h2>
        <p class="text-sm text-slate-500 mt-1">Quick access to the sections you saved for later.</p>
      </div>
    </div>

    <div id="favorites-empty" class="favorite-empty hidden">
      Save sections using the bookmark icon to build your personal collection.
    </div>

    <div id="favorites-list" class="hidden"></div>
  </div>
</div>


<div id="subcategoria-content" class="hidden !px-0 sm:!px-1 md:!px-2 pt-10 mt-6">
  <!-- Topbar fija para split derecho (favoritos/guardados) -->
<div id="fav-topbar" class="fav-topbar" aria-hidden="true">
<button class="fav-btn fav-back" type="button" title="Back">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 26 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
    <!-- Línea vertical más a la izquierda -->
    <path stroke-linecap="round" stroke-linejoin="round" d="M2.5 6v12" />
    <!-- Flecha separada -->
    <path stroke-linecap="round" stroke-linejoin="round" d="M21 12H6m0 0l6 6m-6-6l6-6" />
  </svg>
</button>

  <div class="fav-actions">

    <i class="fa-solid fa-xmark" title="Close"></i>
  </div>
</div>
  <h2 id="subcategoria-title" class="text-2xl font-bold mb-4"></h2>
  <div id="subcategoria-body" class="space-y-6"></div>
</div>



    </main>
  </div>

</div>









<script>
  const loginForm = document.getElementById("login-form");
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const togglePassword = document.getElementById("togglePassword");
  const registerBtn = document.getElementById("register-btn");
  const loginSection = document.getElementById("login-section");
  const userSection = document.getElementById("user-section");
  const userName = document.getElementById("user-name");

  togglePassword.addEventListener("click", () => {
    passwordInput.type = passwordInput.type === "password" ? "text" : "password";
  });

  loginForm.addEventListener("submit", (e) => {
    e.preventDefault();
    firebase.auth().signInWithEmailAndPassword(emailInput.value, passwordInput.value)
      .catch(error => alert("Error: " + error.message));
  });

  registerBtn.addEventListener("click", () => {
    if (!emailInput.value || !passwordInput.value) {
      alert("Completa email y contraseña.");
      return;
    }
    firebase.auth().createUserWithEmailAndPassword(emailInput.value, passwordInput.value)
      .catch(error => alert("Error al registrarse: " + error.message));
  });

  document.getElementById("google-signin").addEventListener("click", () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    firebase.auth().signInWithPopup(provider).catch(error => alert("Error con Google: " + error.message));
  });

  firebase.auth().onAuthStateChanged((user) => {
    if (user) {
      loginSection.classList.add("hidden");
      userSection.classList.remove("hidden");
      userName.textContent = user.displayName?.split(" ")[0] || user.email.split("@")[0];
      const userInitial = (user.displayName?.charAt(0) || user.email.charAt(0)).toUpperCase();

      const userInitialElement = document.getElementById("user-initial");
      userInitialElement.textContent = userInitial;

      // Función para generar color en base al texto (hash)
      function stringToColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        const hue = hash % 360;
        return `hsl(${hue}, 70%, 45%)`; // color agradable
      }

      // Aplica color al fondo
      const bgColor = stringToColor(user.displayName || user.email);
      userInitialElement.style.backgroundColor = bgColor;
    } else {
      loginSection.classList.remove("hidden");
      userSection.classList.add("hidden");
    }
  });

  

  
  
  (function(){
  const trigger = document.getElementById('user-initial');
  const menu    = document.getElementById('user-menu');
  const caret   = document.getElementById('user-menu-caret');

  // Rellena nombre/institución si los tienes en Firebase
  firebase.auth().onAuthStateChanged((user) => {
    if (!user) return;
    // nombre tal cual (minúsculas si quieres el look exacto):
    const name = (user.displayName || user.email.split('@')[0] || 'Usuario');
    document.getElementById('um-name').textContent = name.toLowerCase();
    // institución (si tienes un customClaim o perfil guardado en Firestore, tráelo aquí):
    // document.getElementById('um-sub').textContent = perfil.institucion || '—';
  });

  function ensureWidth(){
    const wasHidden = menu.classList.contains('hidden');
    if (wasHidden) {
      menu.classList.remove('hidden');
      menu.style.visibility = 'hidden';
    }
    const w = menu.getBoundingClientRect().width || 360;
    if (wasHidden) { menu.classList.add('hidden'); menu.style.visibility=''; }
    return w;
  }

  function positionMenu(){
    const r  = trigger.getBoundingClientRect();
    const mw = ensureWidth();
    const gap = 10;
    const margin = 12;
    const idealLeft = r.left + r.width/2 - mw/2;
    const left = Math.max(margin, Math.min(window.innerWidth - mw - margin, idealLeft));
    const top  = r.bottom + gap;

    menu.style.left = `${left}px`;
    menu.style.top  = `${top}px`;

    // caret apuntando exactamente al centro del avatar (clamp en bordes)
    const caretHalf = 10; // w-5 => 20px, /2
    const caretX = (r.left + r.width/2) - left;
    const minX = 14 + caretHalf;
    const maxX = mw - 14 - caretHalf;
    const x = Math.max(minX, Math.min(maxX, caretX));
    caret.style.left = `${x - caretHalf}px`;
  }

  function openMenu(){
    positionMenu();
    menu.classList.remove('hidden');
    // fuerza un frame para transición
    requestAnimationFrame(()=>menu.classList.add('open'));
    setTimeout(()=>document.addEventListener('click', onOutside, { once:true }),0);
    window.addEventListener('resize', onResize, { once:true });
    document.addEventListener('keydown', onEsc,   { once:true });
  }
  function closeMenu(){
    menu.classList.remove('open');
    setTimeout(()=>menu.classList.add('hidden'), 120);
  }
  function onOutside(e){ if(!menu.contains(e.target) && e.target!==trigger) closeMenu(); }
  function onEsc(e){ if(e.key==='Escape') closeMenu(); }
  function onResize(){ positionMenu(); window.addEventListener('resize', onResize, { once:true }); }

  trigger.addEventListener('click', (e)=>{
    e.stopPropagation();
    menu.classList.contains('hidden') ? openMenu() : closeMenu();
  });

  // Segmented control (Light/Dark/System)
  document.querySelectorAll('#user-menu .seg').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('#user-menu .seg').forEach(b=>b.classList.remove('seg-active'));
      btn.classList.add('seg-active');
      const theme = btn.dataset.theme;
      // aquí aplica tu tema si ya lo tienes implementado:
      // setTheme(theme);
    });
  });

  // Acciones (completa con tus handlers)
  document.getElementById('um-edit').addEventListener('click', ()=>{/* abrir perfil */});
  document.getElementById('um-logout').addEventListener('click', ()=>firebase.auth().signOut());
})();
  
  
  
  
  
  
  document.getElementById("logout").addEventListener("click", () => {
    firebase.auth().signOut();
  });

  // Toggle de la sidebar

const ICON_PATH = './assets/';
const iconSrc = (base, active) => `${ICON_PATH}${base}${active ? '1' : '2'}.png`;

// Hijos directos que cumplan un selector (sin :scope ni '>').
function directChildren(el, selector) {
  return Array.from(el.children).filter(ch => ch.matches(selector));
}

function updateSidebarIcons() {
  document.querySelectorAll('#sidebar .sidebar-group').forEach(group => {
    const img = group.querySelector('img.sidebar-icon');
    if (!img) return;

    const base = img.dataset.icon; // ej: 'aaa', 'bbb', 'ccc'

    // a) link directo activo (Home/Drugs…)
    const directActive =
      directChildren(group, 'a.sidebar-item.is-active').length > 0 ||
      directChildren(group, 'a.sidebar-item.active-link').length > 0;

    // b) botón de acordeón y si está abierto
    const btn = directChildren(group, 'button.sidebar-item')[0] || null;
    const accordionOpen = !!(btn && btn.classList.contains('accordion-open'));

    // c) subitem activo dentro del acordeón
    const acc = group.querySelector('div[id^="accordion-"]');
    const childActive = !!(acc && acc.querySelector('.sidebar-item.is-active, .sidebar-item.active-link'));

    const active = directActive || accordionOpen || childActive;
    const newSrc = iconSrc(base, active);
    if (img.src.endsWith(`${base}${active ? '2' : '1'}.png`) || img.getAttribute('src') !== newSrc) {
      img.setAttribute('src', newSrc);
    }
  });
}

// Marca activo un item
window.setActiveLink = function (el) {
  document.querySelectorAll('#sidebar .sidebar-item.is-active')
    .forEach(a => a.classList.remove('is-active'));
  el.classList.add('is-active');
  updateSidebarIcons();
};

// Abre/cierra acordeón
window.toggleAccordion = function (key) {
  const acc = document.getElementById(`accordion-${key}`);
  const btn = document.querySelector(`#group-${key} > button.sidebar-item`);
  if (!acc || !btn) return;

  acc.classList.toggle('hidden');
  btn.classList.toggle('accordion-open');

  if (acc.classList.contains('hidden')) {
    acc.querySelectorAll('.sidebar-item.is-active').forEach(a => a.classList.remove('is-active'));
  }
  updateSidebarIcons();
};

// Observa cambios de clase dentro del sidebar para refrescar automáticamente
const mo = new MutationObserver(muts => {
  for (const m of muts) {
    if (m.type === 'attributes' && m.attributeName === 'class') { updateSidebarIcons(); break; }
  }
});
mo.observe(sidebar, { subtree: true, attributes: true, attributeFilter: ['class'] });

document.addEventListener('DOMContentLoaded', updateSidebarIcons);



// Desplaza horizontalmente #articles-panel para mostrar el panel pedido
function scrollPanelIntoView(panelEl){
  const art = document.getElementById('articles-panel');
  if (!art || !panelEl) return;
  const c = art.getBoundingClientRect();
  const r = panelEl.getBoundingClientRect();
  const gutter = 8; // pequeño margen visual
  const targetLeft = art.scrollLeft + (r.left - c.left) - gutter;
  art.scrollTo({ left: targetLeft, behavior: 'smooth' });
}
  
</script>

<script>
let STICKY_H = 0; // altura actual del header sticky

function updateStickyHeight() {
  const hdr = document.querySelector('#subcat-header');
  STICKY_H = hdr ? (hdr.getBoundingClientRect().height || 0) : 0;
}



/* === Library (Articles) view — history/state helpers === */
// Single source of truth for current Library selection and horizontal scroll
window.__LIB_CTX__ = { sup: null, cat: null, scrollLeft: 0 };

window.setLibraryState = function(partial) {
  window.__LIB_CTX__ = Object.assign({}, window.__LIB_CTX__, partial || {});
};

window.getLibraryState = function() {
  return window.__LIB_CTX__;
};

// Snapshot current Library state into History so Back/Forward can restore it
window.snapshotLibraryAndPush = function() {
  try {
    const art = document.getElementById('articles-panel');
    const snap = {
      view: 'library',
      sup: window.__LIB_CTX__.sup || null,
      cat: window.__LIB_CTX__.cat || null,
      scrollLeft: (art && typeof art.scrollLeft === 'number') ? art.scrollLeft : 0
    };
    if (history.state && history.state.view === 'library') {
      history.replaceState(snap, '', '');
    } else {
      history.pushState(snap, '', '');
    }
  } catch {}
};

// Rebuild the three-column Library view (P1/P2/P3) from a saved state
window.restoreLibraryFromState = async function(s) {
  // Ensure the Library view is shown and data is present
  showArticles();
  await cargarSupracategorias();

  // Select the supracategory in Panel 1 (by id used in onclick)
  const p1a = Array.from(document.querySelectorAll('#articles-panel > div:first-child a.articles-panel-list-item'))
    .find(a => (a.getAttribute('onclick') || '').includes(`'${s.sup}'`));
  if (p1a) {
    document.querySelectorAll('#articles-panel > div:first-child li').forEach(li => li.classList.remove('is-selected'));
    p1a.closest('li')?.classList.add('is-selected');
  }

  // Build Panel 2 for the selected supracategory
  await showSecondPanel(p1a || null, s.sup);

  // If a category was saved, select it and build Panel 3
  if (s.cat) {
    const p2a = Array.from(document.querySelectorAll('#panel-2 a.articles-panel-list-item'))
      .find(a => (a.getAttribute('onclick') || '').includes(`'${s.cat}'`));
    if (p2a) {
      await showThirdPanel(p2a, s.cat);
    }
  }

  // Restore horizontal scroll position
  const art = document.getElementById('articles-panel');
  if (art) art.scrollLeft = s.scrollLeft || 0;

  // Sync live context
  setLibraryState({ sup: s.sup || null, cat: s.cat || null, scrollLeft: s.scrollLeft || 0 });
};

</script>


<!-- === Simple View Manager (oculta todo y muestra sólo la vista pedida) === -->
<script>
  // Vistas principales de tu app
  const VIEW_IDS = ['home-content','articles-panel','search-page','favorites-view','subcategoria-content'];

  function hideAllViews(){
    VIEW_IDS.forEach(id => document.getElementById(id)?.classList.add('hidden'));
    // columas internas del panel de artículos
    document.getElementById('panel-2')?.classList.add('hidden');
    document.getElementById('panel-3')?.classList.add('hidden');
    // sidebar de subcategoría y dropdown de búsqueda
    document.getElementById('subcategoria-sidebar')?.classList.add('hidden');
    document.getElementById('search-results')?.classList.add('hidden');
  }

  // Cierra el modal y resetea todo (vídeo/imagen/zoom/split)
function hardCloseModal(){
  const modal = document.getElementById('video-modal');
  if (!modal) return;
  modal.classList.add('hidden');
  modal.classList.remove('split-view');
  document.body.classList.remove('split-view-active');
  // limpiar medios
  const iframe = document.getElementById('modal-iframe');
  const img    = document.getElementById('modal-image');
  if (iframe) { iframe.src = ''; iframe.classList.add('hidden'); }
  if (img)    { img.src = ''; img.classList.add('hidden'); }
  // paneles
  document.getElementById('video-desc-panel')?.classList.add('hidden');
  document.getElementById('video-main-panel')?.classList.remove('hidden');
}


  
  
  function showView(id){
    hardCloseModal(); // ← asegura estado limpio SIEMPRE
    hideAllViews();
    document.getElementById(id)?.classList.remove('hidden');
    if (id !== 'favorites-view') {
      document.body.classList.remove('favorites-split');
    }
    // confort: sube al top del contenedor scrolleable

    const mc = document.getElementById('main-content');
  mc.classList.toggle('subcat-active', id === 'subcategoria-content');




    document.getElementById('main-content')?.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // Helpers públicos para usar en tus onClick
  window.showHome     = () => showView('home-content');
  window.showArticles = () => showView('articles-panel');
  window.showSearch   = () => showView('search-page');
  window.showSubcat   = () => showView('subcategoria-content');

  // Botón "Go to library" ya existente en Home
window.goToLibraryArticles = () => showArticles();
</script>
<script>
  let currentActivePanel2Item = null; // Para mantener el elemento seleccionado en el panel 2
  let currentActivePanel3Item = null; // Para mantener el elemento seleccionado en el panel 3

  async function showSecondPanel(clickedElement, supracategoriaId) {
    showArticles(); // ← oculta previos y muestra #articles-panel
  const panel2 = document.getElementById("panel-2");
  const panel3 = document.getElementById("panel-3");
  const secondPanelTitle = document.getElementById("second-panel-title");

  // Reiniciar selección visual en panel 1
  // Reiniciar selección visual en panel 1
document.querySelectorAll('#articles-panel > div:first-child li')
  .forEach(li => li.classList.remove('is-selected'));
clickedElement.closest('li').classList.add('is-selected');

  // Mostrar el panel 2
  panel2.classList.remove("hidden");
  secondPanelTitle.textContent = supracategoriaId;

  // Ocultar panel 3
  panel3.classList.add("hidden");

  // Limpiar contenido anterior del panel 2
  const panel2List = panel2.querySelector("ul");
  panel2List.innerHTML = "";

  // Obtener categorías desde Firestore
  const snapshot = await db
  .collection("supracategorias")
  .doc(supracategoriaId)
  .collection("categorias")
  .orderBy("orden", "asc")
  .get();

  snapshot.forEach(doc => {
const nombreCategoria = doc.id; // usa el ID del documento como nombre visible

    const li = document.createElement("li");
    li.innerHTML = `
  <a href="#" onclick="showThirdPanel(this, '${doc.id}')" class="articles-panel-list-item">
    <span class="ap-icon ap2" aria-hidden="true"></span><span>${nombreCategoria}</span>
  </a>`;
    panel2List.appendChild(li);
  });

  // Resetear selección visual
  document.querySelectorAll('#panel-2 .articles-panel-list-item').forEach(item => {
    item.classList.remove('selected');
  });
  currentActivePanel2Item = null;
  currentActivePanel3Item = null;



  scrollPanelIntoView(panel2);


  // Persist Library selection (Panel 1 opened) in History
  setLibraryState({ sup: supracategoriaId, cat: null });
  snapshotLibraryAndPush();
}

async function showThirdPanel(clickedElement, categoriaId) {
  const panel3 = document.getElementById("panel-3");
  const thirdPanelTitle = document.getElementById("third-panel-title");

  // selección en panel 2
  document.querySelectorAll('#panel-2 li').forEach(li => li.classList.remove('is-selected'));
  clickedElement.closest('li').classList.add('is-selected');
  currentActivePanel2Item = clickedElement;

  // mostrar panel 3
  panel3.classList.remove("hidden");
  thirdPanelTitle.textContent = categoriaId;

  const panel3List = panel3.querySelector("ul");
  panel3List.innerHTML = "";

  // supracategoría seleccionada desde panel 1
  const supracategoriaId = document
    .querySelector('#articles-panel > div:first-child li.is-selected span')
    ?.textContent;
  if (!supracategoriaId) { console.error("No se encontró la supracategoría seleccionada"); return; }

  // traer subcategorías (ordenadas)
  const snapshot = await db.collection("supracategorias")
    .doc(supracategoriaId)
    .collection("categorias").doc(categoriaId)
    .collection("subcategorias")
    .orderBy("orden", "asc")
    .get();

  // 1) Construir TODO en memoria y pintar de una
  const frag   = document.createDocumentFragment();
  const liById = new Map();

  snapshot.forEach(doc => {
    const data   = doc.data();
    const nombre = data.denominacion || doc.id;

    const li = document.createElement("li");
    li.dataset.sub = doc.id;
    li.innerHTML = `
      <a href="#" class="articles-panel-list-item"
         onclick="markSelected(this); showSubcategoriaContent('${doc.id}','${categoriaId}','${supracategoriaId}')">
        <span class="ap-icon ap3" aria-hidden="true"></span>
        <span>${nombre}</span>
      </a>`;
    liById.set(doc.id, li);
    frag.appendChild(li);
  });

  panel3List.appendChild(frag); // ← aparece toda la lista inmediata

  // 2) Resolver “learned” en paralelo (sin bloquear el render)
// learned: solo pinta is-learned (NO is-selected)
Promise.allSettled(
  [...liById.keys()].map(id =>
    isLearned(id).then(on => { liById.get(id)?.classList.toggle('is-learned', on); })
  )
).catch(()=>{});

// reset correcto (quita selección, no el learned)
panel3.querySelectorAll('#panel-3 li').forEach(li => li.classList.remove('is-selected'));
currentActivePanel3Item = null;

  scrollPanelIntoView(panel3);



  // Persist Library selection (Panel 2 -> Panel 3) in History
  setLibraryState({ cat: categoriaId });
  snapshotLibraryAndPush();
}




function markSelected(el) {
  const ul = el.closest('ul');
  if (!ul) return;
  ul.querySelectorAll('li').forEach(li => li.classList.remove('is-selected'));
  el.closest('li').classList.add('is-selected');
}

async function showSubcategoriaContent(subcategoriaId, categoriaId, supracategoriaId, opts = {}) {
  const options = typeof opts === 'object' && opts !== null ? opts : {};
  const skipShowView = !!options.skipShowView;
  // — Cambiar de vista de forma centralizada —
  // Oculta la TOC desde el inicio para evitar el "flash"
  setCurrentSubcatCtx({ supracategoriaId, categoriaId, subcategoriaId });
  const tocEl = document.getElementById('subcategoria-sidebar');
  tocEl?.classList.add('hidden');


    // — Móvil: ocultar sidebars (principal y TOC) de inicio —
  const isMobile = window.matchMedia('(max-width: 639.98px)').matches;
  if (isMobile) {
    // principal
    const mainSidebar = document.getElementById('sidebar');
    mainSidebar?.classList.add('force-hidden'); // usa tu CSS existente
    // opcional: marca de estado para ocultar el botón flotante, etc.
    document.body.classList.add('bars-hidden');
  }

  if (skipShowView) {
    document.getElementById('subcategoria-content')?.classList.remove('hidden');
  } else {
    showSubcat();
  }

  // — Referencias al DOM —
  const contentSection = document.getElementById("subcategoria-content");
  const titleEl        = document.getElementById("subcategoria-title");
  const bodyEl         = document.getElementById("subcategoria-body");
  

  // — Obtener datos de Firestore —
  const doc = await db
    .collection("supracategorias").doc(supracategoriaId)
    .collection("categorias").doc(categoriaId)
    .collection("subcategorias").doc(subcategoriaId)
    .get();
  if (!doc.exists) return;
  const data = doc.data();

  const displayTitle =
    data?.titulo ||
    data?.title ||
    data?.nombre ||
    data?.denominacion ||
    data?.label ||
    subcategoriaId;

  setCurrentSubcatCtx({ supracategoriaId, categoriaId, subcategoriaId, title: displayTitle });

  window.recordRecentArticle?.({
    supracategoriaId,
    categoriaId,
    subcategoriaId,
    title: displayTitle
  });

  // — Poner título —

  // — Construir contenido en el main —
  bodyEl.innerHTML = "";
  const wrapper = document.createElement("div");
  wrapper.className = "";


  const headerHtml = `
<!-- fila principal: columna en xs, fila en sm+ -->
<div class="px-6 flex flex-col sm:flex-row sm:justify-between items-start gap-2 pb-4">
  <!-- Columna izquierda: título y botón -->
  <div class="flex flex-col space-y-3">
    <h1 class="text-3xl font-bold">
      ${data.nombre || subcategoriaId}
    </h1>

    <button class="flex items-center justify-center bg-gray-100 text-[#546E7A] text-[8px] font-semibold uppercase rounded-sm space-x-1"
            style="width:95px; height:18px;">
      <svg class="w-5 h-5 fill-current" viewBox="0 0 20 20"><path d="M6 4l8 6-8 6V4z"/></svg>
      <span>Qbank Session</span>
    </button>
  </div>

  <!-- Columna derecha: metadata -->
  <div class="flex flex-col w-full sm:w-auto items-start sm:items-end mt-2 sm:mt-0 text-sm">
    <span class="text-gray-500">Last edited: ${data.lastEdited || '—'}</span>

    <!-- En xs: fila con justify-between; en sm+: apilados -->
    <div class="flex w-full sm:w-auto flex-row sm:flex-col justify-between sm:justify-end items-center sm:items-end gap-1 mt-1">
      <a href="#" class="text-blue-600 hover:underline">Content policy</a>

<label class="inline-flex items-center gap-1">
  <input id="learned-checkbox" data-sub="{{subcategoriaId}}"
         type="checkbox" class="form-checkbox h-4 w-4 text-blue-600"/>
  <span>Learned</span>
</label>
    </div>
  </div>
</div>

<!-- solo este bloque irá dentro de #subcat-header -->
<div id="subcat-header">
  <div class="highlighting-bar border-y border-gray-200 bg-white z-30 relative overflow-visible">
<button class="fav-btn fav-back" type="button" title="Back">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 26 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
    <!-- Línea vertical más a la izquierda -->
    <path stroke-linecap="round" stroke-linejoin="round" d="M2.5 6v12" />
    <!-- Flecha separada -->
    <path stroke-linecap="round" stroke-linejoin="round" d="M21 12H6m0 0l6 6m-6-6l6-6" />
  </svg>
</button>
    <div class="pl-6 pr-4 py-1 flex items-center w-full overflow-visible">
      <!-- Izquierda -->
      <div id="highlight-toggle" class="flex items-center cursor-pointer select-none">
        <i id="highlight-icon" class="fas fa-highlighter text-slate-600 text-sm mr-0 sm:mr-1.5"></i>
        <span class="hl-title text-sm hidden sm:inline" style="font-weight:400; font-size:0.8rem;">
          MY HIGHLIGHTING
        </span>
      </div>

      <div class="hl-spacer flex-1"></div>

      <!-- Derecha -->
      <div class="hl-right flex items-center text-slate-600 space-x-1.5 relative overflow-visible ml-auto">
        <button class="hl-btn" aria-label="Bookmark">
          <i class="far fa-bookmark text-sm"></i>
        </button>

        <span class="hl-sep" aria-hidden="true"></span>

        <button id="expand-all-btn" class="hl-btn" aria-label="Expand/Collapse all" type="button">
          <i class="fas fa-sort-amount-up-alt text-sm"></i>
        </button>

        <span class="hl-sep" aria-hidden="true"></span>

        <!-- “AA” más pequeño -->
        <button id="font-btn" class="hl-btn font-semibold tracking-wide text-xs">AA</button>

       <!-- Menú de zoom sobrepuestos -->
       <div id="font-menu"
     class="font-menu hidden absolute right-0 top-full mt-1 z-50 inline-block rounded-l bg-white shadow-[0_8px_30px_rgba(0,0,0,0.12)]">
  <div class="grid grid-cols-[auto_auto_auto] items-center gap-2 px-3 py-2 whitespace-nowrap">
    <!-- − -->
    <button id="font-dec" aria-label="Disminuir"
            class="h-6 w-6 inline-flex items-center justify-center text-slate-600 text-l leading-none select-none">−</button>

    <!-- AA (centro / reset) -->
   <span id="font-reset" role="button" tabindex="0"
      class="justify-self-center text-slate-400 font-semibold cursor-pointer select-none leading-none transition-colors">
  AA
</span>

    <!-- + -->
    <button id="font-inc" aria-label="Aumentar"
            class="h-6 w-6 inline-flex items-center justify-center text-slate-600 text-l leading-none select-none">+</button>
  </div>
</div>

        <span class="hl-sep" aria-hidden="true"></span>
        <!-- Language dropdown -->
        <div id="lang-wrap" class="relative">
          <button id="lang-btn" class="hl-btn flex items-center" aria-haspopup="listbox" aria-expanded="false">
            <span id="lang-current" class="text-xs font-medium mr-1">EN</span>
            <i class="fas fa-chevron-down text-[9px]"></i>
          </button>
          <div id="lang-menu"
     class="hidden absolute right-0 top-full mt-2 w-56 max-h-96 overflow-y-auto
            rounded-xl border border-gray-200 bg-white
            shadow-[0_8px_30px_rgba(0,0,0,0.12)] z-50">
</div>


        </div>
<!-- Después ✅ -->
<span class="hl-sep sticky-only"></span>
  <button class="hl-btn hl-close" data-favonly="true"><i class="fa-solid fa-xmark"></i></button>
      </div>
    </div>
  </div>

  <!-- Breadcrumbs debajo en la pila -->
  <nav id="breadcrumbs" class="hidden bg-white border-b z-20 relative">
    <div class="px-6 py-2 flex items-center gap-1.5 text-slate-600 text-xs leading-tight">
      <a id="bc-topic" href="#" class="hover:text-slate-800">—</a>
      <i id="bc-sep" class="fas fa-chevron-right text-[10px] text-slate-400"></i>
      <span id="bc-section" class="text-slate-800 font-medium">—</span>
    </div>
  </nav>
</div>
`;
  // Convertir el string a nodos y añadir al wrapper
  const headerNode = document.createRange().createContextualFragment(headerHtml);
  wrapper.appendChild(headerNode);

// ---- My Highlighting: toggle + persistencia ----
const subcatHeaderEl = wrapper.querySelector('#subcat-header');
const hlToggle = subcatHeaderEl.querySelector('#highlight-toggle');
const hlIcon   = subcatHeaderEl.querySelector('#highlight-icon');
const hlTitle  = subcatHeaderEl.querySelector('.hl-title');

// estado guardado
let hlOn = JSON.parse(localStorage.getItem('hl:on') || 'false');
applyHL();

hlToggle.addEventListener('click', (e) => {
  e.preventDefault();
  hlOn = !hlOn;
  localStorage.setItem('hl:on', JSON.stringify(hlOn));
  applyHL();
});

function applyHL(){
  // UI del botón
  hlIcon.classList.toggle('text-blue-500', hlOn);
  hlIcon.classList.toggle('text-slate-600', !hlOn);
  hlTitle?.classList.toggle('font-bold', hlOn);
  subcatHeaderEl.classList.toggle('hl-on', hlOn);

  // ⬇️ NUEVO: cuando está OFF, escondemos visualmente TODOS los resaltados
  const bodyEl = document.getElementById('subcategoria-body');
  bodyEl?.classList.toggle('hl-hidden', !hlOn);

  // Asegura que el popover no quede visible al apagar
  if (!hlOn) document.getElementById('hl-popover')?.style && 
              (document.getElementById('hl-popover').style.display = 'none');
}





// —— Fuente “AA” (solo contenido) ——
const fontBtn   = wrapper.querySelector('#font-btn');
const fontMenu  = wrapper.querySelector('#font-menu');
const fontInc   = wrapper.querySelector('#font-inc');
const fontDec   = wrapper.querySelector('#font-dec');
const fontReset = wrapper.querySelector('#font-reset');


const contentRoot = document.getElementById('subcategoria-content');

let fontPct = 100;
const MIN = 80, MAX = 160, STEP = 5;


function updateResetVisual() {
  const isDefault = fontPct === 100;
  fontReset.classList.toggle('text-slate-400', isDefault); // gris si 100%
  fontReset.classList.toggle('text-black', !isDefault);    // negro si ≠100%
}

function applyContentFont() {
  contentRoot.style.setProperty('--content-font-scale', fontPct + '%');
  contentRoot.style.setProperty('--content-spacing-scale', String(fontPct / 100));
  updateResetVisual();
}

// botones +/− ya llaman a applyContentFont(); si no, asegurate:
fontInc.addEventListener('click', () => { fontPct = Math.min(MAX, fontPct + STEP); applyContentFont(); });
fontDec.addEventListener('click', () => { fontPct = Math.max(MIN, fontPct - STEP); applyContentFont(); });

// reset sin cerrar menú
fontReset.addEventListener('click', () => { fontPct = 100; applyContentFont(); });
fontReset.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fontPct = 100; applyContentFont(); }
});

fontBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  fontMenu.classList.toggle('hidden');
});

// Cerrar al clickear fuera
document.addEventListener('click', (e) => {
  if (!fontMenu.contains(e.target) && e.target !== fontBtn) {
    fontMenu.classList.add('hidden');
  }
});

fontInc.addEventListener('click', () => {
  fontPct = Math.min(MAX, fontPct + STEP);
  applyContentFont();
});

fontDec.addEventListener('click', () => {
  fontPct = Math.max(MIN, fontPct - STEP);
  applyContentFont();
});

function resetFont() {
  fontPct = 100;
  applyContentFont();
  fontMenu.classList.add('hidden'); // opcional: cerrar el menú
}

fontReset.addEventListener('click', (e) => {
  e.stopPropagation();       // evita que burbujee
  fontPct = 100;
  applyContentFont();
  // NO cerramos el menú
});

fontReset.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    fontPct = 100;
    applyContentFont();
  }
});

applyContentFont();
// ——— Dropdown de idioma (igual a la captura) ———
const langBtn     = wrapper.querySelector('#lang-btn');
const langMenu    = wrapper.querySelector('#lang-menu');
const langCurrent = wrapper.querySelector('#lang-current');

const LANGS = [
  { code:'ES', name:'Español' },
  { code:'AR', name:'العربية' },
  { code:'BG', name:'български' },
  { code:'CZ', name:'čeština' },
  { code:'EN', name:'English' },
  { code:'ET', name:'Eesti' },
  { code:'FA', name:'فارسی' },
  { code:'FI', name:'Suomi' },
  { code:'FR', name:'Français' },
  { code:'HR', name:'Hrvatski' },
  { code:'HU', name:'magyar' },
];

function renderLangMenu(selected) {
  langMenu.innerHTML = LANGS.map(l => `
    <button type="button" data-code="${l.code}"
      class="w-full grid grid-cols-[auto_1fr_auto] items-center gap-2 px-4 py-2.5
             hover:bg-gray-50 text-[10px] text-left">
      <span class="font-semibold text-slate-700">${l.code}</span>
      <span class="text-slate-600">(${l.name})</span>
      <i class="fas fa-check text-slate-500 ${selected===l.code ? '' : 'invisible'}"></i>
    </button>
  `).join('');
}
renderLangMenu(langCurrent.textContent.trim() || 'EN');

langBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  langMenu.classList.toggle('hidden');
  langBtn.setAttribute('aria-expanded', String(!langMenu.classList.contains('hidden')));
});

document.addEventListener('click', (e) => {
  if (!langMenu.contains(e.target) && !langBtn.contains(e.target)) {
    langMenu.classList.add('hidden');
    langBtn.setAttribute('aria-expanded', 'false');
  }
});

langMenu.addEventListener('click', (e) => {
  const item = e.target.closest('button[data-code]');
  if (!item) return;
  const code = item.dataset.code;
  // actualizar etiqueta
  langCurrent.textContent = code;
  // mover check
  langMenu.querySelectorAll('button[data-code] i').forEach(i => i.classList.add('invisible'));
  item.querySelector('i').classList.remove('invisible');
  // Hook opcional de traducción
  if (typeof setLanguage === 'function') setLanguage(code); // no cierra el menú
});



  const expandAllBtn = wrapper.querySelector('#expand-all-btn');

if (expandAllBtn) {
  expandAllBtn.addEventListener('click', () => {
    const allDetails = Array.from(wrapper.querySelectorAll('details'));
    const anyClosed = allDetails.some(d => !d.open);
    allDetails.forEach(d => d.open = anyClosed);
  });
}












  // dentro de showSubcategoriaContent, al construir cada bloque:
// 1) Extraemos las entradas y las ordenamos por bloque.orden









const sortedDefs = Object
  .entries(data.definiciondetallada || {})
  .sort(([, a], [, b]) => (a.orden ?? 0) - (b.orden ?? 0));



// ——— Helpers para renderizar la "clave" (tip con foquito) ———
const esc = (s) =>
  String(s ?? "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");

// Si quieres permitir resaltar frases, escribe [[así]] en Firestore y saldrá con subrayado punteado
function formatClaveText(t){
  return esc(t).replace(/\[\[(.+?)\]\]/g,'<span class="key-dotted">$1</span>');
}

// Un “callout” azul con el ícono de foco
function renderClave(t){
  return `
  <div class="flex items-start gap-3 rounded-lg border border-blue-200 bg-blue-50 px-3 py-2 text-blue-900">
    <div class="mt-[2px] flex h-5 w-5 items-center justify-center rounded-full bg-blue-100">
      <i class="fas fa-lightbulb text-[11px] text-blue-600"></i>
    </div>
    <p class="m-0 text-sm leading-5">${formatClaveText(t)}</p>
  </div>`;
}

// Acepta bloque.clave (string) o bloque.claves (array de strings)
function renderClaveBlock(bloque){
  if (Array.isArray(bloque?.claves)) return bloque.claves.map(renderClave).join("");
  if (bloque?.clave) return renderClave(bloque.clave);
  return "";
}

// Convierte claves como "special_surface_epithelia" -> "Special Surface Epithelia"
const makeTitle = (k) => k.replace(/_/g,' ').replace(/\b\w/g, l => l.toUpperCase());
const bookmarkToggleMarkup = (label = 'item') => {
  const safe = String(label ?? '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;');
  return `<span class="bookmark-toggle" data-label="${safe}"
          role="button" tabindex="0" aria-pressed="false"><i class="far fa-bookmark text-xs"></i></span>`;
};

// Renderiza hijos (subsubtítulos) ordenados por "orden"
// Renderiza hijos (subsubtítulos) con look de "título" + prefijo ⤷
function renderChildren(children) {
  if (!children || typeof children !== 'object') return '';

  const childEntries = Object.entries(children)
    .sort(([,a],[,b]) => (a?.orden ?? 0) - (b?.orden ?? 0));

  return `
    <div class="divide-y divide-gray-200 -mx-6">
      ${childEntries.map(([ck, ch]) => `
        <details class="group subhead" data-bookmark-key="sub:${ck}" data-bookmarked="false">
          <summary class="px-6 py-2 group-open:py-3 flex items-center justify-between hover:bg-slate-50 transition-colors">
            <span class="text-xs md:text-sm leading-5">
              <span aria-hidden="true" class="mr-2 text-slate-400">⤷</span>${makeTitle(ck)}
            </span>
            <span class="toggle-icons">
              ${bookmarkToggleMarkup(makeTitle(ck))}
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                   fill="none" stroke="currentColor" stroke-width="2"
                   class="h-4 w-4 text-gray-500 transition-transform group-open:rotate-180" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
              </svg>
            </span>
          </summary>

          <div class="px-6 py-4 text-gray-700 space-y-3">
            ${ch?.clave ? renderClave(ch.clave) : ''}

            ${ch?.texto ? `<div class="texto-lista">${renderMD(ch.texto)}</div>` : ''}

            ${Array.isArray(ch?.imagenes) && ch.imagenes.length ? `
              <div class="galeria">
                ${ch.imagenes.map(img => `
                  <figure class="media-thumb image-thumb" data-img-url="${img.url}" data-img-desc="${img.descripcion || ''}">
                    <div class="thumb-box"><img src="${img.url}" alt="${img.descripcion || ''}"></div>
                    <figcaption class="thumb-caption">${img.descripcion || ''}</figcaption>
                  </figure>
                `).join('')}
              </div>
            ` : ''}

            ${Array.isArray(ch?.videos) && ch.videos.length ? `
              <div class="galeria videos">
                ${ch.videos.map(v => `
                  <figure class="media-thumb video-thumb" data-video-id="${v.videoId}" data-video-title="${v.titulo || ''}">
                    <div class="thumb-box">
                      <img src="https://img.youtube.com/vi/${v.videoId}/hqdefault.jpg" alt="${(v.descripcion || v.titulo || 'Video').replace(/"/g,'&quot;')}" />
                      <span class="play-badge" aria-hidden="true"><i class="fas fa-play"></i></span>
                    </div>
                    <figcaption class="thumb-caption">${v.descripcion || v.titulo || ''}</figcaption>
                  </figure>
                `).join('')}
              </div>
            ` : ''}
          </div>
        </details>
      `).join('')}
    </div>
  `;
}








// 2) Iteramos en el orden correcto
sortedDefs.forEach(([key, bloque]) => {
  const title = key
    .replace(/_/g, ' ')
    .replace(/\b\w/g, l => l.toUpperCase());
  const imgs = Array.isArray(bloque.imagenes) ? bloque.imagenes : [];
  const vids = Array.isArray(bloque.videos) ? bloque.videos : [];

  const section = document.createElement("details");
  section.className = "group";
  section.dataset.level = 'h2';
  section.dataset.title = title;
  section.dataset.bookmarkKey = `h2:${key}`;
  section.dataset.bookmarked = 'false';
  section.dataset.supracategoriaId = supracategoriaId;
  section.dataset.categoriaId = categoriaId;
  section.dataset.subcategoriaId = subcategoriaId;
  section.dataset.subcategoriaTitle = displayTitle;
    // ID estable para notas de este H2
  section.dataset.noteId = `${supracategoriaId}/${categoriaId}/${subcategoriaId}/h2:${key}`;
   section.innerHTML = `
  <summary class="py-2 group-open:py-3 flex items-center justify-between">
    <span class="text-xs md:text-sm leading-5 transition-[font-size] duration-150 group-open:!text-[16px] group-open:leading-[22px]">
      ${title}
    </span>
    <span class="toggle-icons">
      ${bookmarkToggleMarkup(title)}
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           class="h-4 w-4 text-gray-500 transition-transform group-open:rotate-180" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
      </svg>
    </span>
  </summary>

  <div class="px-6 py-4 text-gray-700 space-y-4">
    

    ${renderClaveBlock(bloque)}      <!-- 👈 NUEVO: tip con foquito si existe “clave” -->

${bloque.texto ? `<div class="texto-lista">${renderMD(bloque.texto)}</div>` : ``}

    ${imgs.length ? `
      <div class="galeria">
        ${imgs.map(img => `
          <figure class="media-thumb image-thumb" data-img-url="${img.url}" data-img-desc="${img.descripcion || ''}">
            <div class="thumb-box"><img src="${img.url}" alt="${img.descripcion || ''}"></div>
            <figcaption class="thumb-caption">${img.descripcion || ''}</figcaption>
          </figure>`).join("")}
      </div>` : ``}

    ${vids.length ? `
      <div class="galeria videos">
        ${vids.map(v => `
          <figure class="media-thumb video-thumb" data-video-id="${v.videoId}" data-video-title="${v.titulo || ''}">
            <div class="thumb-box">
              <img src="https://img.youtube.com/vi/${v.videoId}/hqdefault.jpg" alt="${(v.descripcion || v.titulo || 'Video').replace(/"/g,'&quot;')}" />
              <span class="play-badge" aria-hidden="true"><i class="fas fa-play"></i></span>
            </div>
            <figcaption class="thumb-caption">${v.descripcion || v.titulo || ''}</figcaption>
          </figure>`).join("")}
      </div>` : ``}

  
  
      </div>

  <div class="collapse-controls">
  <button class="flex items-center space-x-1">
    <i class="fas fa-grip-lines-vertical"></i>
    <span>COLLAPSE</span>
  </button>
  <div class="flex items-center space-x-6">
   <button type="button" class="flex items-center space-x-1 notes-btn relative">
<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-2.5 h-2.5 rounded-full notes-indicator"></span>       <i class="fas fa-pen"></i>
       <span>NOTES</span>
   </button>
    <button class="flex items-center space-x-1">
      <i class="fas fa-comment-dots"></i>
      <span>FEEDBACK</span>
    </button>
  </div>






</div>



  `;

  initializeBookmarkControls(section);
  wrapper.appendChild(section);



  

  // —— Subsubtítulos como títulos hermanos (con prefijo ⤷) ——
if (bloque.children && typeof bloque.children === 'object') {
  const childEntries = Object.entries(bloque.children)
    .sort(([,a],[,b]) => (a?.orden ?? 0) - (b?.orden ?? 0));

  childEntries.forEach(([ck, ch]) => {
    const cImgs = Array.isArray(ch.imagenes) ? ch.imagenes : [];
    const cVids = Array.isArray(ch.videos)  ? ch.videos  : [];

    const child = document.createElement('details');
    child.className = 'group';
    child.dataset.level = 'h3';
    child.dataset.title = makeTitle(ck);
    child.dataset.parentTitle = title;
    child.dataset.bookmarkKey = `h3:${ck}`;
    child.dataset.bookmarked = 'false';
    child.dataset.supracategoriaId = supracategoriaId;
    child.dataset.categoriaId = categoriaId;
    child.dataset.subcategoriaId = subcategoriaId;
    child.dataset.subcategoriaTitle = displayTitle;
    // ID estable para notas de este H3
child.dataset.noteId = `${supracategoriaId}/${categoriaId}/${subcategoriaId}/h3:${ck}`;
    child.innerHTML = `
      <summary class="py-2 group-open:py-3 flex items-center justify-between">
        <span class="text-xs md:text-sm leading-5">
          <span class="mr-2 text-slate-400">⤷</span>${makeTitle(ck)}
        </span>
        <span class="toggle-icons">
          ${bookmarkToggleMarkup(makeTitle(ck))}
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               class="h-4 w-4 text-gray-500 transition-transform group-open:rotate-180" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
          </svg>
        </span>
      </summary>

      <div class="px-6 py-4 text-gray-700 space-y-4">
        ${renderClaveBlock(ch)}
        ${ch?.texto ? `<div class="texto-lista">${renderMD(ch.texto)}</div>` : ``}

        ${cImgs.length ? `
          <div class="galeria">
            ${cImgs.map(img => `
              <figure class="media-thumb image-thumb" data-img-url="${img.url}" data-img-desc="${img.descripcion || ''}">
                <div class="thumb-box"><img src="${img.url}" alt="${img.descripcion || ''}"></div>
                <figcaption class="thumb-caption">${img.descripcion || ''}</figcaption>
              </figure>`).join("")}
          </div>` : ``}

        ${cVids.length ? `
          <div class="galeria videos">
            ${cVids.map(v => `
              <figure class="media-thumb video-thumb" data-video-id="${v.videoId}" data-video-title="${v.titulo || ''}">
                <div class="thumb-box">
                  <img src="https://img.youtube.com/vi/${v.videoId}/hqdefault.jpg" alt="${(v.descripcion || v.titulo || 'Video').replace(/"/g,'&quot;')}" />
                  <span class="play-badge" aria-hidden="true"><i class="fas fa-play"></i></span>
                </div>
                <figcaption class="thumb-caption">${v.descripcion || v.titulo || ''}</figcaption>
              </figure>`).join("")}
          </div>` : ``}
      </div>

      <div class="collapse-controls">
        <button class="flex items-center space-x-1">
          <i class="fas fa-grip-lines-vertical"></i><span>COLLAPSE</span>
        </button>
        <div class="flex items-center space-x-6">
   <button type="button" class="flex items-center space-x-1 notes-btn relative">
<span class="absolute -left-3 top-1/2 -translate-y-1/2 w-2.5 h-2.5 rounded-full notes-indicator"></span>
       <i class="fas fa-pen"></i>
      <span>NOTES</span>
  </button>          <button class="flex items-center space-x-1"><i class="fas fa-comment-dots"></i><span>FEEDBACK</span></button>
        </div>
      </div>
    `;
    initializeBookmarkControls(child);
    wrapper.appendChild(child);
  });
}

  






});

  bodyEl.appendChild(wrapper);

    // selecciona el contenedor de scroll y tu nuevo header
  // Sentinel para detectar cuando el header se pega arriba
const content = document.getElementById('main-content');
const subcatHeader = wrapper.querySelector('#subcat-header');

// crea un sentinel justo ANTES del subcat-header
const sentinel = document.createElement('div');
sentinel.id = 'subcat-header-sentinel';
sentinel.style.height = '1px';
wrapper.insertBefore(sentinel, subcatHeader);

// observa el sentinel dentro del scroll-container (#main-content)
const io = new IntersectionObserver(
  ([entry]) => {
    // Cuando el sentinel sale por el borde superior, el header está "stuck"
    const stuck = !entry.isIntersecting;
    subcatHeader.classList.toggle('is-stuck', stuck);
    // muestra/oculta el breadcrumb sin tocar tus tamaños de summary
    const bc = subcatHeader.querySelector('#breadcrumbs');
    if (bc) bc.classList.toggle('hidden', !stuck);

    updateStickyHeight();
  },
  { root: content, threshold: 0 }
);
updateStickyHeight();
io.observe(sentinel);


// ——— Breadcrumb dinámico (tema > sección visible) ———
const bcTopic   = subcatHeader.querySelector('#bc-topic');
const bcSection = subcatHeader.querySelector('#bc-section');
const bcSep     = subcatHeader.querySelector('#bc-sep');
const baseTopic = (data.nombre || subcategoriaId);
// Tema base = título de la subcategoría
bcTopic.textContent = baseTopic;
if (bcSection) {
  bcSection.textContent = '';
  bcSection.classList.add('hidden');
}
bcSep?.classList.add('hidden');
bcTopic.addEventListener('click', (e) => {
  e.preventDefault();
  content.scrollTo({ top: 0, behavior: 'smooth' });
});
// Sección actual según el summary más alto visible
const summaries = Array.from(wrapper.querySelectorAll('#subcategoria-body details > summary'));
function cleanSummaryText(summaryEl) {
  if (!summaryEl) return '';
  const raw = summaryEl.querySelector('span')?.textContent || summaryEl.textContent || '';
  return raw.replace(/^⤷\s*/,'').replace(/\s+/g,' ').trim();
}
function updateBreadcrumbSection() {
  if (!summaries.length) {
    bcTopic.textContent = baseTopic;
    if (bcSection) {
      bcSection.textContent = '';
      bcSection.classList.add('hidden');
    }
    bcSep?.classList.add('hidden');
    return;
  }

  const offset = STICKY_H || (subcatHeader.classList.contains('is-stuck') ? subcatHeader.offsetHeight : 0);
  const scrollTop = content.scrollTop + offset + 1;
  const containerTop = content.getBoundingClientRect().top;

  const pickSummary = () => {
    let current = summaries[0];
    for (const s of summaries) {
      const top = s.getBoundingClientRect().top - containerTop + content.scrollTop;
      if (top <= scrollTop) current = s; else break;
    }
    return current;
  };

  const current = pickSummary();
  const detailsEl = current?.closest('details');
  const level = detailsEl?.dataset.level || 'h2';

  bcTopic.textContent = baseTopic;

  if (!bcSection) return;

  let subtitle = '';
  if (level === 'h3') {
    const parent = detailsEl?.dataset.parentTitle || cleanSummaryText(current) || baseTopic;
    const child  = detailsEl?.dataset.title || cleanSummaryText(current);
    subtitle = child ? `${parent} > ${child}` : parent;
  } else {
    subtitle = detailsEl?.dataset.title || cleanSummaryText(current) || '';
  }

  if (subtitle) {
    bcSection.textContent = subtitle;
    bcSection.classList.remove('hidden');
    bcSep?.classList.remove('hidden');
  } else {
    bcSection.textContent = '';
    bcSection.classList.add('hidden');
    bcSep?.classList.add('hidden');
  }
}
// también al abrir/cerrar secciones
summaries.forEach(s => s.addEventListener('click', () => setTimeout(updateBreadcrumbSection, 0)));
// estado inicial
updateBreadcrumbSection();

function getActiveTOCIndex() {
  const content = document.getElementById('main-content');
  const subcatHeader = document.querySelector('#subcat-header');
  const offset = subcatHeader?.classList.contains('is-stuck') ? subcatHeader.offsetHeight : 0;

  const summaries = Array.from(document.querySelectorAll('#subcategoria-body details > summary'));
  const containerTop = content.getBoundingClientRect().top + offset + 1;

  let current = 0;
  for (let i = 0; i < summaries.length; i++) {
    if (summaries[i].getBoundingClientRect().top <= containerTop) current = i; else break;
  }
  return current;
}

// No-op para que no rompa (luego lo mejoras si quieres animación)
function animateTOCTraversal() {/* noop */}

// —— Vincular activo de la TOC usando el contenedor cuando toca ——
function updateTOCActive(){
  const idx = getActiveTOCIndex();
  setTOCActiveByIndex(idx);
}
summaries.forEach(s => s.addEventListener('click', () => setTimeout(updateTOCActive, 0)));
updateTOCActive();



// vuelve a enlazar eventos a cada .video-thumb recién creado
wrapper.querySelectorAll('.media-thumb').forEach(thumb => {
 thumb.addEventListener('click', abrirModalMedio);
});





// — TOC: títulos (h2) + subtítulos (h3) como en la captura —
const topicTitle = (data.nombre || subcategoriaId);

// 1) Lista real de <details> en el orden en que se pintaron
// Todos los <details> recién renderizados
const detailsList = Array.from(document.querySelectorAll('#subcategoria-body details'));

// Pinta por defecto VERDE (si aún no sabemos)
detailsList.forEach(d => paintNotesIndicator(d, false));

// Al expandir: chequea Firestore y pinta rojo/verde
detailsList.forEach(d => {
  d.addEventListener('toggle', () => {
    if (d.open) updateNotesBadge(d);
  });
});

// Si alguno ya viene abierto, actualízalo ahora
detailsList.filter(d => d.hasAttribute('open')).forEach(updateNotesBadge);
// 2) Calculamos los índices que tendrá cada botón del TOC
let cursor = 0;
const tocSections = sortedDefs.map(([k, bloque]) => {
  const h2Title = makeTitle(k);
  const h2Index = cursor++;
  const children = Object.entries(bloque.children || {})
    .sort(([,a],[,b]) => (a?.orden ?? 0) - (b?.orden ?? 0))
    .map(([ck]) => ({ title: makeTitle(ck), index: cursor++ }));
  return { title:h2Title, index:h2Index, children };
});




function flashSummaryAtIndex(idx){
  const det = detailsList[idx];
  if (!det) return;
  const summary = det.querySelector('summary');
  const target  = summary?.querySelector('span') || summary; // solo el texto, si existe
  if (!target) return;

  // reinicia la animación si ya estaba corriendo
  target.classList.remove('flash-mark');
  void target.offsetWidth;            // reflow para reiniciar
  target.classList.add('flash-mark');

  // limpia la clase al terminar
  target.addEventListener('animationend', () => {
    target.classList.remove('flash-mark');
  }, { once:true });
}

// 3) Pintamos el TOC con h2 + h3
const subSidebar = document.getElementById('subcategoria-sidebar');
const subWrap    = document.getElementById('subcategoria-sidebar-content');

let tocHTML = `
  <div class="toc-topic" id="toc-topic">${topicTitle}</div>
  <nav class="toc">
`;
tocSections.forEach(sec => {
  tocHTML += `
    <div class="toc-section">
      <button class="toc-h2" data-index="${sec.index}">${sec.title}</button>
      ${sec.children.length ? `
        <div class="toc-sub">
          ${sec.children.map(ch => `
            <button class="toc-h3" data-index="${ch.index}">${ch.title}</button>
          `).join('')}
        </div>
      ` : ``}
    </div>
  `;
});
tocHTML += `</nav>`;
subWrap.innerHTML = tocHTML;
  // Muestra la TOC SOLO cuando el contenido ya está pintado
  
  
    // Muestra la TOC SOLO cuando el contenido ya está pintado (NO en móvil)
  requestAnimationFrame(() => requestAnimationFrame(() => {
    const isDesktop = window.matchMedia('(min-width: 640px)').matches;
    if (isDesktop && !document.body.classList.contains('favorites-split')) {
      subSidebar.classList.remove('hidden');
    }
  }));

// —— FIX: lock de selección TOC durante scroll programático ——
let tocLockIdx = -1;
let tocLockTimer = null;
// El lock ahora se libera al terminar el scroll; este es solo un fallback
const LOCK_FALLBACK_MS = 2000;


















// === TOC: marcar contenedor (h2+subtítulos) o solo el subtítulo ===
function setTOCActiveByIndex(activeIdx){
  const tocRoot  = document.getElementById('subcategoria-sidebar-content');
  if (!tocRoot) return;
  const h2Btns   = tocRoot.querySelectorAll('.toc-h2');
  const h3Btns   = tocRoot.querySelectorAll('.toc-h3');
  const sections = tocRoot.querySelectorAll('.toc-section');

  // limpia todo
  h2Btns.forEach(b => b.classList.remove('is-active'));
  h3Btns.forEach(b => b.classList.remove('is-active'));
  sections.forEach(s => s.classList.remove('is-active'));

  if (activeIdx == null || activeIdx < 0) return;

  const btn = tocRoot.querySelector(`[data-index="${activeIdx}"]`);
  if (!btn) return;

  if (btn.classList.contains('toc-h2')) {
    const sec = btn.closest('.toc-section');
    // si el h2 tiene subtítulos => marcar TODO el bloque; si no, marcar solo el h2 (fallback)
    if (sec && sec.querySelector('.toc-sub')) {
      sec.classList.add('is-active');
    } else {
      btn.classList.add('is-active');
    }
  } else if (btn.classList.contains('toc-h3')) {
    btn.classList.add('is-active');
  }
}



















// 4) Click: abrir la sección objetivo y hacer scroll con offset correcto
function scrollToDetailIndex(targetIdx){
  const container = document.getElementById('main-content');
  const det = detailsList[targetIdx];
  if (!det) return;
  if (!det.open) det.open = true;
  const summary = det.querySelector('summary');
  requestAnimationFrame(() => {
    const cR = container.getBoundingClientRect();
    const sR = summary.getBoundingClientRect();
    const offset = STICKY_H + 1;
    const top = container.scrollTop + (sR.top - cR.top) - offset;
    container.scrollTo({ top, behavior:'smooth' });
  });
}

// Espera hasta que el contenedor deje de desplazarse (con fallback)
function waitForScrollEnd(container, idleMs = 140, hardTimeout = 2000){
  return new Promise(resolve => {
    let idleTimer = null;
    let finished = false;

    const finish = () => {
      if (finished) return;
      finished = true;
      container.removeEventListener('scroll', onScroll, { passive:true });
      container.removeEventListener('scrollend', finish); // si existe
      clearTimeout(hardTimer);
      resolve();
    };

    const onScroll = () => {
      clearTimeout(idleTimer);
      idleTimer = setTimeout(finish, idleMs); // “no se mueve” por idleMs
    };

    // Soporte nativo si el navegador emite 'scrollend'
    container.addEventListener('scrollend', finish, { once:true });

    // Fallback por inactividad del evento scroll
    container.addEventListener('scroll', onScroll, { passive:true });
    onScroll(); // arranca el contador

    // Cortafuegos por si algo queda colgado
    const hardTimer = setTimeout(finish, hardTimeout);
  });
}


// ✅ ÚNICO handler de click
// ✅ ÚNICO handler de click (con lock anti-parpadeo)
const tocBtns = Array.from(subWrap.querySelectorAll('.toc-h2, .toc-h3'));
tocBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    const idx = Number(btn.dataset.index || -1);
    if (idx < 0) return;

    // Activa lock para evitar que el sync por scroll “robe” la selección
    tocLockIdx = idx;
    setTOCActiveByIndex(idx); // pinta activo inmediatamente

    const container = document.getElementById('main-content');
    const det = detailsList[idx];
    if (!det.open) det.open = true;

    const summary = det.querySelector('summary');
    requestAnimationFrame(() => {
      const cR = container.getBoundingClientRect();
      const sR = summary.getBoundingClientRect();
      const target = container.scrollTop + (sR.top - cR.top) - STICKY_H - 1;
      container.scrollTo({ top: target, behavior: 'smooth' });
    });


    // … después de hacer container.scrollTo({ top, behavior:'smooth' });
    waitForScrollEnd(container).then(() => {
      // asegurar selección final del item pulsado
      setTOCActiveByIndex(idx);
      const btnEl = document.querySelector(`#subcategoria-sidebar-content [data-index="${idx}"]`);
      btnEl?.scrollIntoView({ block: 'nearest', inline: 'nearest', behavior: 'smooth' });
      flashSummaryAtIndex(idx);
      tocLockIdx = -1; // liberar lock al terminar de verdad
    });

    // Fallback por si 'scrollend' no dispara (navegador viejo)
    if (tocLockTimer) clearTimeout(tocLockTimer);
    tocLockTimer = setTimeout(() => { tocLockIdx = -1; }, LOCK_FALLBACK_MS);
  }, { passive: true });
});






// 5) Sincronizar estado activo al cargar
updateTOCActive();

  // === Sincronía TOC priorizando "abierto + contenido visible" ===
(function syncTOCByVisibility(){
  const content = document.getElementById('main-content');

  function getContainerBounds(){
    const r = content.getBoundingClientRect();
    const off = STICKY_H || 0; // respeta header/crumbs pegados (tomado del observer)
    return { top: r.top + off + 1, bottom: r.bottom };
  }

  function isVisible(el, top, bottom){
    if (!el) return false;
    const b = el.getBoundingClientRect();
    const visTop = Math.max(b.top, top);
    const visBot = Math.min(b.bottom, bottom);
    return (visBot - visTop) > 6; // umbral de 6px evita falsos positivos
  }

  function pickActiveIndex(){
  // ⛔️ Si TODO está colapsado, no seleccionar nada
  const anyOpen = detailsList.some(d => d.open);
  if (!anyOpen) return -1;

  const { top, bottom } = getContainerBounds();

  // 1) Preferir "abierto + contenido visible", y el más arriba
  let bestIdx = -1, bestY = Infinity;
  detailsList.forEach((det, idx) => {
    const sum  = det.querySelector('summary');
    const body = sum?.nextElementSibling;
    const sumVis  = isVisible(sum,  top, bottom);
    const bodyVis = det.open && isVisible(body, top, bottom);
    if (sumVis && bodyVis) {
      const y = sum.getBoundingClientRect().top;
      if (y < bestY) { bestY = y; bestIdx = idx; }
    }
  });
  if (bestIdx !== -1) return bestIdx;

  // 2) Si hay alguno abierto pero ninguno con cuerpo visible,
  //    caer al PRIMER título visible
  bestIdx = -1; bestY = Infinity;
  detailsList.forEach((det, idx) => {
    const sum = det.querySelector('summary');
    const r   = sum.getBoundingClientRect();
    const { top, bottom } = getContainerBounds();
    if (isVisible(sum, top, bottom)) {
      if (r.top < bestY) { bestY = r.top; bestIdx = idx; }
    }
  });

  return bestIdx; // puede ser -1 si no hay ninguno visible
}





function applyActive(idx){
  if (idx == null || idx < 0) return;
  setTOCActiveByIndex(idx);
  // mantener auto-scroll del ítem activo en la TOC (suave)
  const activeBtn = document.querySelector(`#subcategoria-sidebar-content [data-index="${idx}"]`);
  activeBtn?.scrollIntoView({ block: 'nearest', inline: 'nearest', behavior: 'smooth' });
}

  // Ejecuta en scroll, al abrir/cerrar <details> y al inicializar
  const onScrollSync = () => {
  if (tocLockIdx !== -1) {
    applyActive(tocLockIdx);   // mientras haya lock, mantené el activo clickeado
  } else {
    applyActive(pickActiveIndex());
  }
  updateBreadcrumbSection();
};
content.addEventListener('scroll', onScrollSync, { passive: true });
  detailsList.forEach(d => d.addEventListener('toggle', () => {
    // Espera al reflow del toggle para medir correctamente
    requestAnimationFrame(onScrollSync);
  }));
  // primer sync
  requestAnimationFrame(onScrollSync);
})();

  function setActiveTOC(idx){
    tocBtns.forEach(b=>b.classList.remove('is-active'));
    if (idx>=0 && tocBtns[idx]) tocBtns[idx].classList.add('is-active');
  }

  




  // — Mostrar la sección dentro del main —
  contentSection.classList.remove("hidden");



  // Al final de showSubcategoriaContent(...)
window.dispatchEvent(new CustomEvent('subcat:rendered', {
  detail: {
    sup: supracategoriaId,
    cat: categoriaId,
    sub: subcategoriaId
  }
}));

  // En modo favoritos la barra debe permanecer expandida.
  if (!document.body.classList.contains('favorites-split')) {
    toggleSidebarCollapse(true);
  }
  applyNotesBadgesInPage();  // pinta el botón NOTES en teal si ya hay nota guardada
  



  // ✅ ⬇️ Pega aquí el bloque del checkbox learned
  const cb = document.querySelector('#learned-checkbox');
  if (cb) {
    cb.checked = await isLearned(subcategoriaId);
cb.addEventListener('change', async (e) => {
  const on = e.target.checked;
  await setLearned(subcategoriaId, on);
  document.querySelector(`#panel-3 li[data-sub="${subcategoriaId}"]`)
    ?.classList.toggle('is-learned', on);
});
  }

  // ← al final de showSubcategoriaContent(...)


  try {


    snapshotLibraryAndPush();
  history.pushState(
    { view: 'subcat',
      sub: subcategoriaId,
      cat: categoriaId,
      sup: supracategoriaId
    },
    '',
    '' // opcional: '#sub=' + subcategoriaId
  );
} catch {}



// Habilita “Atrás/Adelante” del navegador
if (!window.__POPSTATE_WIRED__) {
  window.__POPSTATE_WIRED__ = true;

  window.addEventListener('popstate', async (e) => {
    const s = e.state;
    if (s && s.view === 'subcat') {
      // Navegar entre subcategorías con Atrás/Adelante
      await showSubcategoriaContent(s.sub, s.cat, s.sup);
    } else if (s && s.view === 'library') {
      // ← Volver a los 3 paneles tal como estaban, y reabrir barra
      await restoreLibraryFromState(s);
    } else {
      // Fallback sensato
      toggleSidebarCollapse(false);
      showArticles();
    }
  });
}


}









// === CSS para ocultar botones fav-back y close fuera de favoritos ===
</script>
<style>
/* Ocultar botones fav-back y close (y sus separadores adyacentes) fuera de favoritos */
body:not(.favorites-split) #subcat-header .fav-btn[data-favonly="true"],
body:not(.favorites-split) #subcat-header .hl-btn.hl-close[data-favonly="true"],
body:not(.favorites-split) #subcat-header .fav-btn[data-favonly="true"] + .hl-sep,
body:not(.favorites-split) #subcat-header .hl-btn.hl-close[data-favonly="true"] ~ .hl-sep {
  display: none !important;
}
</style>


<script>
  // Hacemos globales para que todos los scripts puedan usarlas
  window.slugify = s => String(s||'')
    .toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^\p{L}\p{N}]+/gu,'-')
    .replace(/^-+|-+$/g,'')
    .slice(0,80);

  // ID seguro de Firestore: supracat__cat__sub__titulo
  window.noteDocIdFromDetails = function(detailsEl){
    const ctx = window.__CURRENT_SUBCAT_CTX__ || {};
    const title =
      detailsEl?.querySelector('summary span')?.textContent?.trim() ||
      detailsEl?.querySelector('summary')?.textContent?.trim() || 'section';
    return [
      window.slugify(ctx.supracategoriaId),
      window.slugify(ctx.categoriaId),
      window.slugify(ctx.subcategoriaId),
      window.slugify(title)
    ].filter(Boolean).join('__');
  };

  // Helper para considerar “vacío” HTML como <p><br></p>, &nbsp;, etc.
  window.isEmptyHtml = function(html){
    const s = String(html||'')
      .replace(/<br\s*\/?>/gi,'')
      .replace(/<\/?p[^>]*>/gi,'')
      .replace(/&nbsp;/gi,' ')
      .replace(/\s+/g,' ')
      .trim();
    return s.length === 0;
  };
</script>



<script>
  let lastOpenedAccordionId = null;

// === Vista centralizada: oculta todo y muestra la sección pedida ===
function switchView(target) {
  const home  = document.getElementById("home-content");
  const art   = document.getElementById("articles-panel");
  const p2    = document.getElementById("panel-2");
  const p3    = document.getElementById("panel-3");
  const subc  = document.getElementById("subcategoria-content");
  const subSB = document.getElementById("subcategoria-sidebar");

   if (target !== "content" && !subc.classList.contains("hidden")) {
    exitSplitIfAny();
  }


  // Ocultar todo primero (sin parpadeos)
  home.classList.add("hidden");
  art.classList.add("hidden"); 
  art.classList.remove("flex");
  p2.classList.add("hidden");
  p3.classList.add("hidden");
  subc.classList.add("hidden");
  subSB.classList.add("hidden");

  if (target === "home") {
    home.classList.remove("hidden");
    return;
  }
if (target === "library") {
  art.classList.remove("hidden");
  art.classList.add("flex");

  // derecha siempre sin padding; izquierda respeta CSS al inicio
  art.style.paddingRight = '0';
  art.style.paddingLeft  = '';
  art.style.overflowX    = 'auto';
  art.style.boxSizing    = 'border-box';

  // paddings del padre
  const host = art.parentElement;
  const cs   = getComputedStyle(host);
  const pl   = parseFloat(cs.paddingLeft)  || 0;
  const pr   = parseFloat(cs.paddingRight) || 0;

  // 👉 Eliminar SIEMPRE el hueco derecho (full-bleed a la derecha)
  art.style.marginRight = `-${pr}px`;
  art.style.marginLeft  = '0';
  art.style.width       = `calc(100% + ${pr}px)`;

  // 👉 Al scrollear: también “comerse” el gutter izquierdo
  const bleedOnScroll = () => {
    if (art.scrollLeft >= 1) {
      art.style.marginLeft = `-${pl}px`;
      art.style.width      = `calc(100% + ${pl + pr}px)`;
    } else {
      art.style.marginLeft = '0';
      art.style.width      = `calc(100% + ${pr}px)`; // mantiene el bleed derecho
    }
  };

  // evitar listeners duplicados
  if (art._bleedHandler) art.removeEventListener('scroll', art._bleedHandler);
  art._bleedHandler = bleedOnScroll;
  art.addEventListener('scroll', bleedOnScroll, { passive: true });

  bleedOnScroll(); // sincroniza estado actual
  cargarSupracategorias();
  return;
}







}

function toggleAccordion(id) {
  const sidebar = document.getElementById('sidebar');
  const acc     = document.getElementById(`accordion-${id}`);
  const btn     = acc?.previousElementSibling;                 // <button> del grupo
  const group   = btn?.closest('.sidebar-group');
  const icon    = btn?.querySelector('.fa-chevron-down');

  const isCollapsed     = sidebar.classList.contains('collapsed');
  const isHoverExpanded = sidebar.classList.contains('hover-expanded');

  // Si la barra está colapsada y no está expandida temporalmente: no abrir acordeón.
  if (isCollapsed && !isHoverExpanded) {
    closeAllAccordions();
    acc?.classList.add('hidden');
    btn?.classList.remove('accordion-open');
    icon?.classList.remove('rotate-180');
    group?.classList.remove('hover-open');

    // Marcá solo el ícono como activo (tu CSS ya lo deja “limpio” en colapsado)
    document.querySelectorAll('#sidebar .sidebar-item')
      .forEach(el => el.classList.remove('is-active','active-link'));
    btn?.classList.add('is-active');
    return; // ⛔️ corta acá en colapsado
  }

  // —— Comportamiento normal cuando NO está colapsada ——
  const willOpen = acc.classList.contains('hidden');

  // Cerrar todos
  document.querySelectorAll('div[id^="accordion-"]').forEach(el => {
    el.classList.add('hidden');
    el.previousElementSibling?.classList.remove('accordion-open');
    el.previousElementSibling?.querySelector('.fa-chevron-down')?.classList.remove('rotate-180');
    el.closest('.sidebar-group')?.classList.remove('hover-open');
  });

  // Abrir/cerrar el pedido
  if (willOpen) {
    acc.classList.remove('hidden');
    btn?.classList.add('accordion-open');
    icon?.classList.add('rotate-180');
    group?.classList.add('hover-open');
  } else {
    acc.classList.add('hidden');
    btn?.classList.remove('accordion-open');
    icon?.classList.remove('rotate-180');
    group?.classList.remove('hover-open');
  }
}

const BOOKMARK_HOST = '[data-bookmark-key]';
const cssEscape = (window.CSS && window.CSS.escape) ? window.CSS.escape : (value) =>
  String(value).replace(/[^a-zA-Z0-9_\-]/g, (m) => `\\${m}`);

function updateBookmarkVisual(btn, active) {
  btn.setAttribute('aria-pressed', active);
  const icon = btn.querySelector('i');
  if (icon) {
    icon.classList.toggle('fas', active);
    icon.classList.toggle('far', !active);
  }
}

function buildFavoritePayload(host) {
  if (!host) return null;
  const key = host.dataset.bookmarkKey;
  if (!key) return null;

  const rawLabel =
    host.dataset.title ||
    host.dataset.label ||
    host.dataset.bookmarkLabel ||
    host.querySelector('summary span')?.textContent ||
    host.textContent;

  const label = (rawLabel || key).replace(/\s+/g, ' ').trim();
  const level = host.dataset.level || null;
  const type = level ? 'segment' : 'item';

  const ctx = window.__CURRENT_SUBCAT_CTX__ || {};
  const payload = {
    key,
    label,
    type: level ? 'segment' : 'item',
    level,
    parentTitle: host.dataset.parentTitle || null,
    supracategoriaId: host.dataset.supracategoriaId || ctx.supracategoriaId || null,
    categoriaId: host.dataset.categoriaId || ctx.categoriaId || null,
    subcategoriaId: host.dataset.subcategoriaId || ctx.subcategoriaId || null,
    subcategoriaTitle: host.dataset.subcategoriaTitle || ctx.title || null,
    noteId: host.dataset.noteId || null
  };

  if (payload.type !== 'segment') return null;
  if (!payload.supracategoriaId || !payload.categoriaId || !payload.subcategoriaId) return null;

  return payload;
}

const favoritesManager = (() => {
  const store = new Map();
  const listeners = new Set();
  let unsubscribe = null;

  const dbInstance = () => window.db || (firebase?.firestore ? firebase.firestore() : null);
  const currentUid = () => firebase?.auth ? firebase.auth().currentUser?.uid || null : null;
  const collectionRef = () => {
    const uid = currentUid();
    const db = dbInstance();
    return uid && db ? db.collection('users').doc(uid).collection('favorites') : null;
  };

  const applyDom = (key, active) => {
    if (!key) return;
    const selector = `[data-bookmark-key="${cssEscape(key)}"]`;
    document.querySelectorAll(selector).forEach(host => {
      host.dataset.bookmarked = active ? 'true' : 'false';
      host.querySelectorAll('.bookmark-toggle').forEach(btn => updateBookmarkVisual(btn, active));
    });
  };

  const getList = () =>
    Array.from(store.values()).sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));

  const notify = () => {
    const list = getList();
    listeners.forEach(fn => {
      try { fn(list); } catch (err) { console.error('favorites listener error', err); }
    });
  };

  const resetDom = () => {
    document.querySelectorAll(BOOKMARK_HOST).forEach(host => {
      host.dataset.bookmarked = 'false';
      host.querySelectorAll('.bookmark-toggle').forEach(btn => updateBookmarkVisual(btn, false));
    });
  };

  const stop = () => {
    if (unsubscribe) { unsubscribe(); unsubscribe = null; }
    if (store.size) {
      store.forEach((_, key) => applyDom(key, false));
    }
    store.clear();
    notify();
  };

  const start = () => {
    const ref = collectionRef();
    if (!ref) return;
    unsubscribe = ref.onSnapshot(snapshot => {
      let changed = false;
      snapshot.docChanges().forEach(change => {
        const id = change.doc.id;
        if (change.type === 'removed') {
          store.delete(id);
          applyDom(id, false);
          changed = true;
        } else {
          const data = change.doc.data() || {};
          const ts = data.updatedAt && data.updatedAt.toMillis ? data.updatedAt.toMillis() : Date.now();
          store.set(id, { key: id, ...data, updatedAt: ts });
          applyDom(id, true);
          changed = true;
        }
      });
      if (changed) notify();
    }, err => console.error('favorites snapshot error', err));
  };

  if (firebase?.auth) {
    firebase.auth().onAuthStateChanged(user => {
      stop();
      if (user) start();
      else resetDom();
    });
  }

  return {
    has: key => store.has(key),
    getList,
    subscribe(fn) { listeners.add(fn); return () => listeners.delete(fn); },
    async set(host, active) {
      const key = host.dataset.bookmarkKey;
      if (!key) return;
      const ref = collectionRef();
      if (!ref) throw new Error('auth-required');

      if (active) {
        const payload = buildFavoritePayload(host);
        if (!payload) throw new Error('unsupported');
        const docRef = ref.doc(key);
        const snap = await docRef.get();
        const now = firebase.firestore.FieldValue.serverTimestamp();
        const data = {
          bookmarkKey: key,
          label: payload.label,
          type: payload.type,
          level: payload.level || null,
          parentTitle: payload.parentTitle || null,
          supracategoriaId: payload.supracategoriaId || null,
          categoriaId: payload.categoriaId || null,
          subcategoriaId: payload.subcategoriaId || null,
          subcategoriaTitle: payload.subcategoriaTitle || null,
          noteId: payload.noteId || null,
          updatedAt: now
        };
        if (!snap.exists) data.createdAt = now;
        await docRef.set(data, { merge: true });
      } else {
        await ref.doc(key).delete();
      }
    }
  };
})();

function initializeBookmarkControls(root = document) {
  root.querySelectorAll('.bookmark-toggle').forEach(btn => {
    const host = btn.closest(BOOKMARK_HOST);
    if (!host) return;
    const key = host.dataset.bookmarkKey;
    const active = key ? favoritesManager.has(key) || host.dataset.bookmarked === 'true' : host.dataset.bookmarked === 'true';
    host.dataset.bookmarked = active ? 'true' : 'false';
    updateBookmarkVisual(btn, active);
    if (btn.dataset.label) btn.setAttribute('aria-label', `Guardar ${btn.dataset.label}`);
  });
}

async function toggleBookmark(btn, evt) {
  if (evt) { evt.preventDefault(); evt.stopPropagation(); }
  const host = btn.closest(BOOKMARK_HOST);
  if (!host) return;
  const prev = host.dataset.bookmarked === 'true';
  const next = !prev;
  host.dataset.bookmarked = next ? 'true' : 'false';
  updateBookmarkVisual(btn, next);
  try {
    await favoritesManager.set(host, next);
  } catch (err) {
    host.dataset.bookmarked = prev ? 'true' : 'false';
    updateBookmarkVisual(btn, prev);
    if (err && err.message === 'auth-required') {
      console.warn('You need to be logged in to save favorites.');
    } else if (err && err.message === 'unsupported') {
      console.warn('This element cannot be saved as a favorite yet.');
    } else {
      console.error('Bookmark toggle failed', err);
    }
  }
}

document.addEventListener('click', e => {
  const btn = e.target.closest('.bookmark-toggle');
  if (btn) toggleBookmark(btn, e);
});

document.addEventListener('keydown', e => {
  if (e.key !== 'Enter' && e.key !== ' ') return;
  const btn = e.target.closest('.bookmark-toggle');
  if (btn) toggleBookmark(btn, e);
});

if (typeof window !== 'undefined') window.initializeBookmarkControls = initializeBookmarkControls;
initializeBookmarkControls();

(function setupFavoritesUI(){
  const favoritesTriggerBtn = document.getElementById('favorites-trigger');
  const favoritesListEl = document.getElementById('favorites-list');
  const favoritesEmptyEl = document.getElementById('favorites-empty');
  let currentFavoriteKey = null;

  const escapeHTML = (value) =>
    String(value ?? '').replace(/&/g,'&amp;')
                       .replace(/</g,'&lt;')
                       .replace(/>/g,'&gt;')
                       .replace(/"/g,'&quot;');

  function renderFavoritesList(list) {
    if (!favoritesListEl) return;
    const segments = (list || []).filter(item => item.type === 'segment');
    if (!segments.length) {
      favoritesListEl.innerHTML = '';
      favoritesListEl.classList.add('hidden');
      favoritesEmptyEl?.classList.remove('hidden');
      currentFavoriteKey = null;
      return;
    }
    favoritesEmptyEl?.classList.add('hidden');
    favoritesListEl.classList.remove('hidden');
    favoritesListEl.innerHTML = segments.map(item => `
      <button class="favorite-item ${item.bookmarkKey === currentFavoriteKey ? 'favorite-item--active' : ''}"
              data-fav-key="${escapeHTML(item.bookmarkKey)}"
              data-sup="${escapeHTML(item.supracategoriaId || '')}"
              data-cat="${escapeHTML(item.categoriaId || '')}"
              data-sub="${escapeHTML(item.subcategoriaId || '')}">
        <span>
          <span class="block text-sm font-semibold text-slate-800">${escapeHTML(item.label)}</span>
          <span class="favorite-item__meta">${escapeHTML(item.subcategoriaTitle || '')}</span>
        </span>
        <i class="far fa-bookmark text-slate-400 text-sm"></i>
      </button>
    `).join('');
  }

  function setActiveFavorite(key) {
    currentFavoriteKey = key || null;
    document.querySelectorAll('.favorite-item').forEach(btn => {
      btn.classList.toggle('favorite-item--active', btn.dataset.favKey === currentFavoriteKey);
    });
  }

  function highlightFavoriteSegment(key) {
    if (!key) return;
    const selector = `[data-bookmark-key="${cssEscape(key)}"]`;
    document.querySelectorAll('#subcategoria-content .favorite-highlight')
      .forEach(el => el.classList.remove('favorite-highlight'));
    const host = document.querySelector(`#subcategoria-content ${selector}`);
    if (!host) return;
    if (host.tagName === 'DETAILS') {
      host.open = true;
      const parentH2 = host.closest('details[data-level="h2"]');
      if (parentH2 && parentH2 !== host) parentH2.open = true;
    }
    host.classList.add('favorite-highlight');
    host.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });
    setTimeout(() => host.classList.remove('favorite-highlight'), 1400);
  }

  async function openFavoriteDetail({ sup, cat, sub, key }) {
    if (!sup || !cat || !sub || !key) return;
    document.body.classList.add('favorites-split');
    document.getElementById('favorites-view')?.classList.remove('hidden');
    document.body.classList.remove('bars-hidden');
    const mainSidebar = document.getElementById('sidebar');
    const tocSidebar = document.getElementById('subcategoria-sidebar');
    const mainContent = document.getElementById('main-content');
    mainSidebar?.classList.remove('force-hidden','collapsed');
    mainSidebar?.classList.add('open');
    tocSidebar?.classList.add('hidden');
    if (mainContent) {
      mainContent.style.marginLeft = '0px';
      mainContent.style.paddingLeft = '0px';
      mainContent.style.width = '100%';
    }
    const content = document.getElementById('subcategoria-content');
    content?.classList.remove('hidden');
    try {
      await showSubcategoriaContent(sub, cat, sup, { skipShowView: true });
      if (typeof toggleSidebarCollapse === 'function') toggleSidebarCollapse(false);
      mainSidebar?.classList.remove('collapsed');
      mainSidebar?.classList.add('open');
      setActiveFavorite(key);
      highlightFavoriteSegment(key);
    } catch (err) {
      console.error('Unable to open favorite segment', err);
    }
  }

  function openFavoritesView() {
    showView('favorites-view');
    document.body.classList.remove('favorites-split');
    document.getElementById('subcategoria-content')?.classList.add('hidden');

    document.body.classList.remove('bars-hidden');
    const mainSidebar = document.getElementById('sidebar');
    const tocSidebar = document.getElementById('subcategoria-sidebar');
    const mainContent = document.getElementById('main-content');
    mainSidebar?.classList.remove('force-hidden','collapsed');
    mainSidebar?.classList.add('open');
    tocSidebar?.classList.add('hidden');
    if (mainContent) {
      mainContent.style.marginLeft = '';
      mainContent.style.width = '';
      mainContent.style.paddingLeft = '';
    }
    renderFavoritesList(favoritesManager.getList());
  }

  favoritesManager.subscribe(renderFavoritesList);
  renderFavoritesList(favoritesManager.getList());

  favoritesListEl?.addEventListener('click', (event) => {
    const button = event.target.closest('.favorite-item');
    if (!button) return;
    openFavoriteDetail({
      sup: button.dataset.sup,
      cat: button.dataset.cat,
      sub: button.dataset.sub,
      key: button.dataset.favKey
    });
  });

  favoritesTriggerBtn?.addEventListener('click', () => {
    openFavoritesView();
  });

  function closeFavoritesSplit() {
    if (!document.body.classList.contains('favorites-split')) return;
    document.body.classList.remove('favorites-split', 'bars-hidden');
    document.getElementById('favorites-view')?.classList.add('hidden');
    document.getElementById('subcategoria-content')?.classList.remove('hidden');
    const mainSidebar = document.getElementById('sidebar');
    mainSidebar?.classList.remove('force-hidden','open');
    mainSidebar?.classList.add('collapsed');
    const mainContent = document.getElementById('main-content');
    if (mainContent) {
      mainContent.style.marginLeft = '';
      mainContent.style.paddingLeft = '';
      mainContent.style.width = '';
    }
    const tocSidebar = document.getElementById('subcategoria-sidebar');
    if (window.matchMedia('(min-width: 640px)').matches) {
      tocSidebar?.classList.remove('hidden');
    }
  }

  document.addEventListener('click', (event) => {
    if (event.target.closest('.fav-btn.fav-back')) {
      closeFavoritesSplit();
      return;
    }
    if (event.target.closest('#subcat-header .hl-btn.hl-close') ||
        event.target.closest('#fav-topbar .fa-xmark')) {
      openFavoritesView();
    }
  });

  window.showFavorites = openFavoritesView;
})();

// Función para establecer el enlace o botón activo (marcado con active-link)
function setActiveLink(element) {
  // Oculta sub-sidebar cada vez que cambias de sección
  document.getElementById("subcategoria-sidebar").classList.add("hidden");

  // Limpia bloques grises del grupo
  document.querySelectorAll('#sidebar .sidebar-group')
    .forEach(g => g.classList.remove('segment-active'));

  // Quita activos visuales de TODO
  document.querySelectorAll('#sidebar a, #sidebar button').forEach(item => {
    item.classList.remove('active-link', 'accordion-open');
    item.querySelector('.fa-chevron-down')?.classList.remove('rotate-180');
  });

  // 1) Si es BOTÓN de grupo: NO marcar activo; solo abrir acordeón y salir
  if (element.tagName === 'BUTTON' && element.closest('.sidebar-group')) {
    const acc  = element.nextElementSibling;
    const open = acc && acc.classList.contains('hidden');
    // cerrar todos los acordeones
    document.querySelectorAll('div[id^="accordion-"]').forEach(el => {
      el.classList.add('hidden');
      el.previousElementSibling.classList.remove('accordion-open');
      el.previousElementSibling.querySelector('.fa-chevron-down')?.classList.remove('rotate-180');
    });
    // abrir el propio si tocaba
    if (open) {
      acc.classList.remove('hidden');
      element.classList.add('accordion-open');
      element.querySelector('.fa-chevron-down')?.classList.add('rotate-180');
    }
    return; // <- nada de active-link aquí
  }

  // 2) Si es un ENLACE de nivel 1 (Home/Drugs), márcalo normal
  const isTopLevelLink =
    element.tagName === 'A' &&
    element.closest('.sidebar-group') &&
    !element.closest('div[id^="accordion-"]');
  if (isTopLevelLink) {
    element.classList.add('active-link');
    // cierra acordeones
    document.querySelectorAll('div[id^="accordion-"]').forEach(el => el.classList.add('hidden'));
    // Home: muestra y limpia lo demás (como ya lo tenías)
    if (element.textContent.trim() === 'Home' && element.closest('#group-home')) {
      toggleSidebarCollapse(false);
      switchView('home');
    }
    return;
  }

  // 3) Si es SUBITEM dentro de acordeón: marca el subitem y pinta el bloque
  const parentAccordionDiv = element.closest('div[id^="accordion-"]');
  if (parentAccordionDiv) {
    element.classList.add('active-link');                // subitem
    const parentButton = parentAccordionDiv.previousElementSibling;
    parentAccordionDiv.classList.remove('hidden');
    parentButton.classList.add('accordion-open');        // solo para chevron
    parentButton.querySelector('.fa-chevron-down')?.classList.add('rotate-180');
    parentButton.closest('.sidebar-group')?.classList.add('segment-active'); // bloque gris
  }

  // (tu lógica de Articles/subcategoría sigue funcionando igual)
    if (element.textContent.trim() === 'Articles' && element.closest('#group-library')) {
    switchView('library');
    // limpiar selección en las 3 columnas
    document.querySelectorAll('#articles-panel .articles-panel-list-item').forEach(i => i.classList.remove('selected'));
    currentActivePanel2Item = null;
    currentActivePanel3Item = null;

    
  }
}










  // Inicializar la sidebar al cargar el DOM
    document.addEventListener('DOMContentLoaded', () => {
    const thumbsContainer = document.getElementById('video-thumbnails');
    const toggleBtn       = document.getElementById('toggle-thumbnails');
      const toggleIcon      = toggleBtn.querySelector('i');
       const carousel  = document.getElementById('thumbnail-carousel');
 const videoArea = document.getElementById('video-area');



    toggleBtn.addEventListener('click', () => {
  const thumbsHidden = document.getElementById('thumbnail-carousel')
                            .classList.toggle('hidden');

        const img    = document.getElementById('modal-image');
    const iframe = document.getElementById('modal-iframe');
    [img, iframe].forEach(el => el.style.transition = 'max-height 0.1s ease');




    // 2) Cambiar la flecha
    if (thumbsHidden) {
          img.style.maxHeight    = 'calc(100% - 6rem)';
      iframe.style.maxHeight = 'calc(100% - 6rem)';
      videoArea.appendChild(toggleBtn);
  toggleBtn.classList.remove('in-carousel');
toggleBtn.style.bottom = '0';

    toggleIcon.classList.remove('fa-chevron-down');
    toggleIcon.classList.add('fa-chevron-up');
  } else {
      img.style.maxHeight    = 'calc(100% - 14rem)';
      iframe.style.maxHeight = 'calc(100% - 14rem)';
     // 80px (thumb) + 2rem (padding-top del carrusel) + .5rem (padding-bottom)
  carousel.prepend(toggleBtn);
  toggleBtn.classList.add('in-carousel');
  toggleBtn.style.bottom = '';   // lo controla el CSS de .in-carousel


    toggleIcon.classList.remove('fa-chevron-up');
    toggleIcon.classList.add('fa-chevron-down');
  }
});

     
     
      document.querySelectorAll('div[id^="accordion-"]').forEach(accordion => {
          accordion.classList.add('hidden');
          const button = accordion.previousElementSibling;
          button.classList.remove('accordion-open'); // Asegurarse de que no tenga esta clase
          const icon = button.querySelector('.fa-chevron-down');
          if (icon) {
              icon.classList.remove('rotate-180');
          }
      });

      // 2. Deseleccionar todos los enlaces y botones de grupo (asegurando limpieza total)
      document.querySelectorAll('#sidebar a, #sidebar button').forEach(item => {
          item.classList.remove('active-link');
          const itemIcon = item.querySelector('i');
          if (itemIcon) {
            itemIcon.classList.remove('text-blue-700'); // Quita el color azul de todos los iconos
            itemIcon.style.color = ''; // Restablece el color por defecto (gray-700 en este caso)
          }
      });

      // 3. Ocultar los paneles de artículos y subpaneles al inicio
      const articlesPanel = document.getElementById("articles-panel");
      articlesPanel.classList.add("hidden");
      articlesPanel.classList.remove("flex"); // Asegurarse de que no tenga flex
      document.getElementById("panel-2").classList.add("hidden");
      document.getElementById("panel-3").classList.add("hidden");

      // También, asegurarse de que no haya elementos seleccionados en los paneles de artículos
      document.querySelectorAll('#articles-panel .articles-panel-list-item').forEach(item => {
          item.classList.remove('selected');
      });
      currentActivePanel2Item = null;
      currentActivePanel3Item = null;


      // 4. Ocultar el contenido de Home al inicio (será mostrado por setActiveLink)
      document.getElementById("home-content").classList.add("hidden");

      // 5. Activar "Home" por defecto
      const homeLink = document.querySelector('#group-home a');
      if (homeLink) {
          setActiveLink(homeLink); // Esto aplicará la clase 'active-link' a "Home" y mostrará su contenido
      }
  });
</script>




<!-- Asegúrate de tener Firestore compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  // si no existe 'db' en tu código, créalo:
  window.db = window.db || firebase.firestore();
</script>



<script>
/* === NOTES BADGES — rojo si hay nota, verde si no === */

// Usa data-note-id que setearemos al crear cada <details>
function getNoteRefFor(detailsEl) {
  const user = firebase.auth().currentUser;
  if (!user || !window.db) return null;
  const noteId = window.noteDocIdFromDetails(detailsEl); // 👈 unificado
  return db.collection('users').doc(user.uid).collection('notes').doc(noteId);
}

function paintNotesIndicator(detailsEl, hasNote) {
  const btn = detailsEl.querySelector('.notes-btn');
  if (!btn) return;

  // Reutiliza o crea el dot
  let dot = btn.querySelector('.notes-indicator');
  if (!dot) {
    dot = document.createElement('span');
    dot.className = 'absolute -left-3 top-1/2 -translate-y-1/2 w-2.5 h-2.5 rounded-full notes-indicator';
    btn.prepend(dot);
  }

  // Asegura uno u otro color SIEMPRE
  dot.classList.remove('bg-red-500', 'bg-transparent-500');
  dot.classList.add(hasNote ? 'bg-red-500' : 'bg-transparent-500');
}

async function updateNotesBadge(detailsEl) {
  try {
    const ref = getNoteRefFor(detailsEl);
    if (!ref) { paintNotesIndicator(detailsEl, false); return; }
    const snap = await ref.get();
    const content = snap.exists ? (snap.data()?.content || '') : '';
    const hasNote = !window.isEmptyHtml(content);
    paintNotesIndicator(detailsEl, hasNote);   // rojo si hay nota, verde si no
  } catch (err) {
    console.error('Notes badge check failed:', err);
    paintNotesIndicator(detailsEl, false);     // en error, verde
  }
}

// Llamar tras renderizar #subcategoria-body (la invocas al final de showSubcategoriaContent)
window.applyNotesBadgesInPage = function () {
  const list = Array.from(document.querySelectorAll('#subcategoria-body details'));
  // default verde hasta tener respuesta
  list.forEach(d => paintNotesIndicator(d, false));
  // al expandir, mirar Firestore
  list.forEach(d => {
    d.addEventListener('toggle', () => {
      if (d.open) updateNotesBadge(d);
    });
  });
  // si alguno ya llega abierto
  list.filter(d => d.hasAttribute('open')).forEach(updateNotesBadge);
};
</script>



<script>
function toggleSidebarCollapse(force = null) {
  const sidebar     = document.getElementById("sidebar");
  const mainContent = document.getElementById("main-content");

  const shouldCollapse = (force !== null) ? force : !sidebar.classList.contains("collapsed");

  // — Helper: limpia selección/estados visuales en la sidebar —
  function clearSidebarSelection() {
    // Quita estados activos/abiertos
    document.querySelectorAll('#sidebar a, #sidebar button').forEach(el => {
      el.classList.remove('active-link', 'is-active', 'accordion-open');
      el.querySelector('.fa-chevron-down')?.classList.remove('rotate-180');
    });
    // Quita “bloques” o resaltados de grupo
    document.querySelectorAll('#sidebar .sidebar-group').forEach(g => {
      g.classList.remove('segment-active', 'hover-open');
    });
  }

  // — Cierra TODOS los acordeones (utilidad local) —
  function closeAllAccordions() {
    document.querySelectorAll('div[id^="accordion-"]').forEach(acc => {
      acc.classList.add('hidden');
      const btn = acc.previousElementSibling;
      btn?.classList.remove('accordion-open');
      btn?.querySelector('.fa-chevron-down')?.classList.remove('rotate-180');
      btn?.closest('.sidebar-group')?.classList.remove('hover-open');
    });
  }

  // — Vincula una sola vez el handler de mouseleave para el estado colapsado —
  if (!sidebar._mouseleaveBound) {
    sidebar.addEventListener("mouseleave", () => {
      if (!sidebar.classList.contains("collapsed")) return; // solo actúa si está colapsada
      closeAllAccordions();
      clearSidebarSelection();
      // si querés “olvidar” el último abierto cuando el usuario salga, dejá esta línea:
      // lastOpenedAccordionId = null;
    });
    sidebar._mouseleaveBound = true;
  }

  if (shouldCollapse) {
    // —— COLAPSAR ——
    sidebar.classList.add("collapsed");

    // Ajustes de layout (si los usás)
    if (document.body.classList.contains('favorites-split')) {
      mainContent.style.marginLeft = "0px";
      mainContent.style.width      = "100%";
      mainContent.style.paddingLeft = "0px";
    } else {
      mainContent.style.marginLeft = "0px";
      mainContent.style.width      = "calc(100% - 64px)";
      mainContent.style.paddingLeft = ""; // limpia el padding del expand
    }

    // Cierra acordeones y limpia selección
    closeAllAccordions();
    clearSidebarSelection();

  } else {
    // —— EXPANDIR ——
    sidebar.classList.remove("collapsed");

    // (Opcional) restablecer margenes/paddings que tocaste al colapsar
    if (document.body.classList.contains('favorites-split')) {
      mainContent.style.marginLeft  = "0px";
      mainContent.style.width       = "100%";
      mainContent.style.paddingLeft = "0px";
    } else {
      mainContent.style.marginLeft  = "";
      mainContent.style.width       = "100%";
      mainContent.style.paddingLeft = "64px";
    }

    // Primero cerramos todo…
    closeAllAccordions();
    clearSidebarSelection();

    // …y luego reabrimos el último acordeón si había uno recordado
    if (window.lastOpenedAccordionId) {
      const acc = document.getElementById(`accordion-${lastOpenedAccordionId}`);
      if (acc) {
        acc.classList.remove('hidden');
        const btn = acc.previousElementSibling;
        btn?.classList.add('accordion-open', 'is-active');
        btn?.querySelector('.fa-chevron-down')?.classList.add('rotate-180');
        btn?.closest('.sidebar-group')?.classList.add('hover-open');
      }
    }

    // Asegura que las flechas se muestren (por si quedaron con style inline)
    document.querySelectorAll('.sidebar-group button .fa-chevron-down').forEach(icon => {
      icon.style.display = ''; // deja que el CSS normal gobierne
    });
  }
}

function toggleReadingSidebars() {
  const sidebar   = document.getElementById('sidebar');
  const subTOC    = document.getElementById('subcategoria-sidebar');
  const main      = document.getElementById('main-content');

  // ¿Estamos en el estado A (lectura)?
  const isReadingShown =
    !subTOC.classList.contains('hidden') &&
    sidebar.classList.contains('collapsed') &&
    !sidebar.classList.contains('force-hidden');

  if (isReadingShown) {
    // -> B) Ocultar ambas
    subTOC.classList.add('hidden');
    sidebar.classList.add('force-hidden');

    // Limpieza visual opcional
    document.querySelectorAll('div[id^="accordion-"]').forEach(acc => {
      acc.classList.add('hidden');
      const btn = acc.previousElementSibling;
      btn?.classList.remove('accordion-open');
      btn?.querySelector('.fa-chevron-down')?.classList.remove('rotate-180');
    });

    // El main ocupa todo
    main.style.marginLeft = '0';
    main.style.width = '100%';
    return;
  }

  // -> A) Mostrar lectura: principal colapsada + TOC visible
  sidebar.classList.remove('force-hidden');
  // Asegura "colapsada" (40px de iconos); tu función ya hace todo lo demás
  toggleSidebarCollapse(true);

  // Muestra TOC si hay contenido de subcategoría
  subTOC.classList.remove('hidden');

  // Deja que el flex haga su trabajo (sin márgenes raros)
  main.style.marginLeft = '';
  main.style.width = '';
}

/* Hook al botón del header:
   - Si hay contenido de subcategoría abierto, usa el toggle de lectura.
   - Si NO hay contenido (home, library, etc.), conserva el comportamiento actual (colapsar/expandir). */
document.addEventListener('DOMContentLoaded', () => {
  const btn  = document.getElementById('menu-toggle');
  const subc = document.getElementById('subcategoria-content');
  const sb   = document.getElementById('sidebar');
  const toc  = document.getElementById('subcategoria-sidebar');
  const body = document.body;

  const handleClick = () => {
    const inSubcat = subc && !subc.classList.contains('hidden');

    if (inSubcat) {
      // Subcategoría: principal colapsada + TOC visible, o ambas ocultas
      const isHidden = body.classList.contains('bars-hidden')
                    || sb.classList.contains('force-hidden')
                    || (!body.classList.contains('favorites-split') && toc && toc.classList.contains('hidden'));

      if (isHidden) {
        body.classList.remove('bars-hidden');
        sb.classList.remove('force-hidden');
        if (body.classList.contains('favorites-split')) {
          sb.classList.remove('collapsed');
          sb.classList.add('open');
        } else {
          sb.classList.remove('open');
          sb.classList.add('collapsed');     // aquí sí, colapsada
        }
        if (toc) toc.classList.remove('hidden');
      } else {
        body.classList.add('bars-hidden');
        sb.classList.add('force-hidden');
        if (body.classList.contains('favorites-split')) {
          sb.classList.remove('open','collapsed');
        }
        if (toc) toc.classList.add('hidden');
      }
      return;
    }

    // HOME: solo expandida u oculta (sin 'collapsed')
    const hiddenNow = body.classList.contains('bars-hidden') || sb.classList.contains('force-hidden');

    if (hiddenNow) {
      body.classList.remove('bars-hidden');
      sb.classList.remove('force-hidden','collapsed');
      sb.classList.add('open');            // expandida
    } else {
      body.classList.add('bars-hidden');
      sb.classList.add('force-hidden');    // oculta
      sb.classList.remove('open','collapsed');
    }
  };

  const fresh = btn.cloneNode(true);
  btn.replaceWith(fresh);
  fresh.addEventListener('click', handleClick);

  

  const _showView = window.showView;
  window.showHome = () => {
    body.classList.remove('bars-hidden');
    sb.classList.remove('force-hidden','collapsed');
    sb.classList.add('open');           
    toc && toc.classList.add('hidden'); 
    _showView('home-content');
  };
});







</script>

<script>
const db = firebase.firestore();

// ✅ Variable para evitar múltiples cargas simultáneas
let isLoadingSupracategorias = false;

async function cargarSupracategorias() {
  // ⛔ Evitar ejecuciones simultáneas
  if (isLoadingSupracategorias) return;
  isLoadingSupracategorias = true;
  
  try {
    const panel1 = document.querySelector('#articles-panel > div:first-child ul');
    if (!panel1) return;
    
    // ✅ Limpiar completamente el panel antes de cargar
    panel1.innerHTML = "";
    
    const snapshot = await db.collection("supracategorias").get();
    
    // ✅ Crear un fragmento para insertar todo de una vez (más eficiente)
    const fragment = document.createDocumentFragment();
    
    snapshot.forEach(doc => {
      const nombre = doc.data().nombre;
      const li = document.createElement("li");
      li.innerHTML = `<a href="#" onclick="showSecondPanel(this, '${doc.id}')" class="articles-panel-list-item"><i class="ap-icon ap2"></i><span>${nombre}</span></a>`;
      fragment.appendChild(li);
    });
    
    panel1.appendChild(fragment);
  } finally {
    isLoadingSupracategorias = false;
  }
}

// ✅ Llamar SOLO cuando el usuario hace clic en "Articles" (una sola vez por sesión)
(function setupArticlesLoader() {
  const articlesLink = document.querySelector('#group-library a');
  if (!articlesLink) return;
  
  // Reemplazar cualquier listener existente clonando el elemento
  const newLink = articlesLink.cloneNode(true);
  articlesLink.replaceWith(newLink);
  
  // Agregar el listener una sola vez
  newLink.addEventListener('click', cargarSupracategorias);
})();

</script>







<script>
document.addEventListener('DOMContentLoaded', () => {
  // Permite expandir temporalmente la barra colapsada fuera de Home.
  const sidebar = document.getElementById('sidebar');
  const main    = document.getElementById('main-content');
  if (!sidebar || !main) return;

  let storedMainStyles = null;

  const storeMainStyles = () => {
    if (storedMainStyles) return;
    storedMainStyles = {
      marginLeft: main.style.marginLeft,
      width: main.style.width,
      paddingLeft: main.style.paddingLeft
    };
  };

  const restoreMainStyles = () => {
    if (!storedMainStyles) return;
    main.style.marginLeft  = storedMainStyles.marginLeft;
    main.style.width       = storedMainStyles.width;
    main.style.paddingLeft = storedMainStyles.paddingLeft;
    storedMainStyles = null;
  };

  sidebar.addEventListener('mouseenter', () => {
    if (!sidebar.classList.contains('collapsed')) return;
    if (sidebar.classList.contains('force-hidden')) return;
    const homeContent = document.getElementById('home-content');
    if (homeContent && !homeContent.classList.contains('hidden')) return;
    if (sidebar.classList.contains('hover-expanded')) return;

    storeMainStyles();
    sidebar.classList.add('hover-expanded');
    main.style.marginLeft  = '';
    main.style.width       = '100%';
    main.style.paddingLeft = '64px';
  });

  sidebar.addEventListener('mouseleave', () => {
    if (!sidebar.classList.contains('hover-expanded')) return;
    sidebar.classList.remove('hover-expanded');
    if (!sidebar.classList.contains('collapsed')) {
      storedMainStyles = null;
      return;
    }
    restoreMainStyles();
  });
});
</script>

<script>
document.getElementById("sidebar").addEventListener("mouseleave", () => {
  // Solo ejecutar si está colapsado
  const sidebar = document.getElementById("sidebar");
  if (!sidebar.classList.contains("collapsed")) return;

  // Cerrar todos los acordeones
  document.querySelectorAll('div[id^="accordion-"]').forEach(acc => {
    acc.classList.add('hidden');
    const btn = acc.previousElementSibling;
    btn.classList.remove('accordion-open');
    const icn = btn.querySelector('.fa-chevron-down');
    if (icn) icn.classList.remove('rotate-180');
  });

  lastOpenedAccordionId = null;
});
</script>
</script>







<div id="video-modal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-80">

  <!-- Contenedor con posición relativa -->
  <div class="relative w-full h-full">

    <!-- Barra superior en posición absoluta -->
    <div class="absolute top-0 left-0 w-full h-12 bg-gray-800 text-white border-b border-gray-700 z-20 flex items-center justify-between px-4">
      <!-- Botón izquierdo -->
<button class="flex items-center space-x-1.5 border border-cyan-500 text-cyan-400 px-2.5 py-0.5 rounded hover:bg-cyan-900/30">
  <i class="fas fa-file-alt text-sm"></i>
  <span class="text-xs font-medium">Description</span>
</button>



<!-- Íconos derechos -->
<div class="flex items-center space-x-3 relative">
  <button class="hover:text-gray-300">
    <i class="far fa-bookmark text-sm"></i>
  </button>

  <button id="zoom-btn" class="hover:text-gray-300">
    <i class="fas fa-search-plus text-sm"></i>
  </button>

  <div id="zoom-menu" class="zoom-menu hidden">
    <button id="zoom-out">−</button>
    <span id="zoom-level">100%</span>
    <button id="zoom-in">+</button>
    <button id="zoom-reset"><i class="fas fa-redo"></i></button>
  </div>

  <button id="expand-video" class="hover:text-gray-300">
    <i class="fas fa-expand text-sm"></i>
  </button>
  <button id="modal-close" class="hover:text-gray-300" onclick="cerrarModal()">
    <i class="fas fa-times text-sm"></i>
  </button>
</div>


    </div>

      <!-- Panel de descripción oculto -->
  <!-- Panel de descripción en split-view -->
<aside id="video-desc-panel" class="video-desc-panel hidden" style="min-width:200px;">
  <div class="p-4 overflow-y-auto h-full">
    <!-- 1) Aquí irá el título del vídeo -->
    <h3 id="video-desc-title" class="text-lg font-semibold mb-2"></h3>
    <!-- 2) Siempre © BANCOMICINA -->
    <p id="video-desc-copyright" class="text-sm text-gray-400 mb-4">© BANCOMICINA</p>
    <!-- 3) Aquí insertaremos dinámicamente la descripción desde YouTube -->
    <p id="video-desc-text" class="text-sm text-white whitespace-pre-wrap"></p>
  </div>
</aside>






      


    </div>

    <!-- Contenido principal desplazado sólo 2rem (h-8) hacia abajo -->
    <div class="absolute inset-x-0 top-10 bottom-0 flex overflow-visible">

<!-- Sidebar izquierdo -->
<aside 
  id="video-main-panel" 
  class="w-1/4 bg-gray-900 text-white p-6 flex flex-col overflow-y-auto"
  style="height:100%; min-width:200px;"
>
  <h2 id="modal-title" class="text-xl font-semibold mb-2">Título del vídeo</h2>
  <span class="text-sm text-gray-400">© BANCOMICINA</span>
  <p id="video-main-text" class="text-sm text-gray-200 mt-4"></p>
</aside>

<!-- Área de vídeo -->
<div id="video-area" class="w-3/4 relative bg-black flex flex-col">
  <iframe
    id="modal-iframe"
    class="w-full"
    style="height: calc(100% - 70px);"
    src=""
    frameborder="0"
    allow="autoplay; encrypted-media"
    allowfullscreen
  ></iframe>

<!-- ▼ Imagen en modal: añadido para soportar imágenes -->
 <img id="modal-image" class="hidden w-full h-auto object-contain" alt="" aria-hidden="true" role="presentation"/>
        <button
  id="toggle-thumbnails"
  class="self-center z-50 w-20 h-6 flex items-center justify-center bg-gray-800 bg-opacity-75 hover:bg-opacity-100 rounded-full text-white "
>
  <i class="fas fa-chevron-up text-xs"></i>
</button>

        <!-- Carrusel con botones laterales -->
<div id="thumbnail-carousel" class="relative hidden bg-black py-4">
  <!-- Botón izquierdo -->
  <button id="scroll-left" class="absolute left-0 top-1/2 transform -translate-y-1/2 z-10 bg-black bg-opacity-30 hover:bg-opacity-60 text-white px-2 py-1 rounded-l">
    <i class="fas fa-chevron-left"></i>
  </button>

  <!-- Contenedor scrollable -->
  <div id="video-thumbnails" class="flex gap-1 overflow-x-auto scroll-smooth px-10">
    <!-- aquí se inyectan miniaturas dinámicamente -->
  </div>

  <!-- Botón derecho -->
  <button id="scroll-right" class="absolute right-0 top-1/2 transform -translate-y-1/2 z-10 bg-black bg-opacity-30 hover:bg-opacity-60 text-white px-2 py-1 rounded-r">
    <i class="fas fa-chevron-right"></i>
  </button>
</div>
    </div>
  </div>
</div>







<script>
// 1) Selecciona todas las miniaturas y el modal
const thumbs     = document.querySelectorAll('.media-thumb');
const modal      = document.getElementById('video-modal');
const imgEl      = document.getElementById('modal-image');

const iframe     = document.getElementById('modal-iframe');
const titleEl    = document.getElementById('modal-title');
const closeBtn   = document.getElementById('modal-close');

// justo después de definir `modal` y `closeBtn`
const expandBtn = document.getElementById('expand-video');
const splitDesc = document.getElementById('video-desc-panel');  // panel flotante de split
const mainDesc  = document.getElementById('video-main-panel');  // panel izquierdo de modo completo

expandBtn.addEventListener('click', e => {
  // 1) Alternamos split-view en el modal y en body
  modal.classList.toggle('split-view');
  document.body.classList.toggle('split-view-active');

  // 2) Si acabamos de entrar en split-view, ocultamos el panel de modo completo:
  if (modal.classList.contains('split-view')) {
    mainDesc.classList.add('hidden');
  } 
  // 3) Si acabamos de salir (modo completo), ocultamos el panel flotante de split:
  else {
    splitDesc.classList.add('hidden');
    // (opcional) y nos aseguramos de que el panel completo esté visible
    mainDesc.classList.remove('hidden');
  }
});


// Referencias
const descBtn   = document
  .querySelector('#video-modal button i.fa-file-alt')
  .closest('button');

// Panel flotante para split-view


descBtn.addEventListener('click', () => {
  const isSplit = modal.classList.contains('split-view');

  if (isSplit) {
    // En split-view: mostramos/ocultamos el panel flotante
    splitDesc.classList.toggle('hidden');
    return;
  }

  // En modo completo: mostramos/ocultamos el panel izquierdo
  const container = modal.querySelector('.absolute.inset-x-0.top-10.bottom-0.flex');
  const videoArea = container.querySelector('div');

  if (mainDesc.classList.contains('hidden')) {
    // Mostrar descripción → restablecemos ancho
    mainDesc.classList.remove('hidden');
    videoArea.style.width = '75%';
  } else {
    // Ocultar descripción → vídeo a ancho completo
    mainDesc.classList.add('hidden');
    videoArea.style.width = '100%';
  }
});

function resetModalLayout({ keepCarousel = false, preserveSplit = false } = {}) {
  modal.classList.remove('video-mode');

  // ← solo quita/añade split según corresponda
  if (preserveSplit) {
    modal.classList.add('split-view');
    document.body.classList.add('split-view-active');
  } else {
    modal.classList.remove('split-view');
    document.body.classList.remove('split-view-active');
  }

  document.getElementById('video-main-panel').classList.remove('hidden');
  document.getElementById('video-desc-panel').classList.add('hidden');

  const car      = document.getElementById('thumbnail-carousel');
  const btn      = document.getElementById('toggle-thumbnails');
  const ico      = btn?.querySelector('i');
  const videoArea= document.getElementById('video-area');
  const mi       = document.getElementById('modal-image');
  const iframeEl = document.getElementById('modal-iframe');

  // Ahora: en <640px la descripción arranca cerrada
const isMobile = window.matchMedia('(max-width: 639.98px)').matches;
const mainDesc  = document.getElementById('video-main-panel');
const splitDesc = document.getElementById('video-desc-panel');

mainDesc.classList.toggle('hidden', isMobile); // oculto en móvil
splitDesc.classList.add('hidden');             // siempre cerrada al iniciar
if (videoArea) videoArea.style.width = isMobile ? '100%' : '75%';

  // Estado base imagen
  mi.classList.add('hidden');
  mi.removeAttribute('src');
  mi.setAttribute('alt', '');

  if (keepCarousel && car && btn) {
    car.classList.remove('hidden');
    car.prepend(btn);
    btn.classList.add('in-carousel');
    btn.style.bottom = '';
    if (ico) { ico.classList.remove('fa-chevron-up'); ico.classList.add('fa-chevron-down'); }
    mi.style.maxHeight       = 'calc(100% - 14rem)';
    iframeEl.style.maxHeight = 'calc(100% - 14rem)';
  } else {
    if (btn && videoArea) {
      videoArea.appendChild(btn);
      btn.classList.remove('in-carousel');
      btn.style.bottom = '0';
    }
    if (ico) { ico.classList.remove('fa-chevron-down'); ico.classList.add('fa-chevron-up'); }
    if (car) car.classList.add('hidden');
    mi.style.maxHeight       = 'calc(100% - 6rem)';
    iframeEl.style.maxHeight = 'calc(100% - 6rem)';
  }
}












function abrirModalMedio(e) {
  if (typeof e?.preventDefault === 'function') e.preventDefault();
  if (typeof e?.stopPropagation === 'function') e.stopPropagation();
   const thumb = e?.target?.closest?.('.media-thumb');
   if (!thumb) return;
  const carousel = document.getElementById('thumbnail-carousel');

  // ¿el carrusel ya estaba abierto?
  const wasOpen   = carousel && !carousel.classList.contains('hidden');
  const firstTime = !modal.dataset.carouselEverOpened;
  modal.dataset.carouselEverOpened = '1';

  const isFromCarousel =
    !!(thumb.closest('#thumbnail-carousel') || thumb.closest('#video-thumbnails'));



      const preserveSplit = isFromCarousel && modal.classList.contains('split-view');


     resetModalLayout({
    keepCarousel: firstTime ? true : wasOpen,
    preserveSplit
  });


  scale = 1;
  pos = { x: 0, y: 0 };
  zoomLevel.textContent = '100%';
  applyTransform();
  const videoId = thumb.dataset.videoId;
  const imgUrl  = thumb.dataset.imgUrl;
  const vid   = thumb.dataset.videoId;
  const title = thumb.dataset.videoTitle || '';
  const imgDesc = thumb.dataset.imgDesc || '';




  // ① Cargamos el vídeo
if (imgUrl) {
   // ► Mostrar imagen
   modal.classList.remove('video-mode');
   iframe.src = '';                     // + detiene el vídeo
     iframe.classList.add('hidden');
      imgEl.src = imgUrl;
      imgEl.classList.remove('hidden');
      titleEl.textContent = imgDesc;

      document.getElementById('video-desc-title').textContent = imgDesc;

   zoomBtn.classList.remove('hidden');
    zoomMenu.classList.remove('hidden');
 } else {
   // ► Mostrar vídeo
   modal.classList.add('video-mode');
    imgEl.classList.add('hidden');
    imgEl.removeAttribute('src');   // evita cualquier fallback
    imgEl.setAttribute('alt','');   // sin texto alternativo
    imgEl.removeAttribute('src');   // evita que el navegador muestre el alt
    imgEl.setAttribute('alt','');   // asegura que no haya texto alternativo
   iframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1`;
   iframe.classList.remove('hidden');
    titleEl.textContent = title;
    document.getElementById('video-desc-title').textContent = title;


    // ocultar por completo la opción de zoom/arrastre en modo video
    zoomBtn.classList.add('hidden');
    zoomMenu.classList.add('hidden');
    // — aquí podrías reubicar tu fetch() de descripción, si lo necesitas solo para vídeo —
  }
  modal.classList.remove('hidden');



    // ———————————————
  //  A) Ponemos el título en el panel de descripción

  // B) La línea de copyright ya viene estática en el HTML
  //    (si quisieras cambiarla dinámicamente también podrías hacerlo aquí)

  // C) Recuperamos la descripción vía YouTube Data API v3
  fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${vid}&key=AIzaSyD8KPi7phPuDjEVjjsv_GyYeF3gHJO2Ygg`)
    .then(resp => resp.json())
    .then(data => {
      const desc = data.items?.[0]?.snippet?.description || 'Descripción no disponible';
      document.getElementById('video-desc-text').textContent = desc;
      const mainText = document.getElementById('video-main-text');
  mainText.textContent = desc;
    })
    .catch(err => {
      console.error('Error al cargar descripción:', err);
      document.getElementById('video-desc-text').textContent = 'No se pudo cargar la descripción.';
    });
  // ———————————————



const thumbsContainer = document.getElementById('video-thumbnails');

// ¿El click vino desde el carrusel?
  // ¿El click vino del carrusel?
  const clickedFromCarousel = !!(
    thumb.closest('#video-thumbnails') ||
    thumb.closest('#thumbnail-carousel')
  );

// ① Detecta la galería de donde vino el click (Results/Overview/Subcat)
  // Galería origen (Results/Subcat/etc.)
  const galleryRoot =
    thumb.closest('.media-gallery') ||
    document.querySelector('#subcategoria-body') ||
    document;                                     // último recurso                                      // último recurso

// ② Recolecta TODAS las miniaturas hermanas visibles en esa galería
const peers = Array.from(galleryRoot.querySelectorAll('.media-thumb'));

  // ③ Pinta la barra con imágenes o vídeos según lo que se abrió
  //    ⚠️ Si el click vino del carrusel, NO repintes (evita que desaparezca)
  if (!clickedFromCarousel && imgUrl) {
  // — Imágenes —
  const relatedImgs = peers
    .filter(n => n.classList.contains('image-thumb'))
    .map(n => ({
      url:  n.dataset.imgUrl,
      desc: n.dataset.imgDesc || ''
    }));

  thumbsContainer.innerHTML = relatedImgs.map(img => `
    <figure class="media-thumb image-thumb" data-img-url="${img.url}" data-img-desc="${img.desc}">
      <img src="${img.url}" alt="${img.desc}" class="w-32 h-32 object-cover rounded shadow" />
    </figure>
  `).join('');
} else if (!clickedFromCarousel) {
  // — Vídeos —
  const relatedVids = peers
    .filter(n => n.classList.contains('video-thumb'))
    .map(n => ({
      id:        n.dataset.videoId,
      thumbnail: n.querySelector('img')?.src || n.dataset.thumbnail || '',
      title:     n.dataset.videoTitle || ''
    }));

  thumbsContainer.innerHTML = relatedVids.map(v => `
    <figure class="media-thumb video-thumb" data-video-id="${v.id}" data-video-title="${v.title}">
      <img src="${v.thumbnail}" alt="${v.title}" class="w-32 h-32 object-cover rounded shadow" />
      <div class="play-icon"><i class="fas fa-play"></i></div>
    </figure>
  `).join('');
}

// ④ Re-asignar manejadores y marcar la miniatura actual como “selected”
//    (si no repintamos, solo actualizamos selección)
const allThumbs = thumbsContainer.querySelectorAll('.media-thumb');
allThumbs.forEach(t => {
  t.classList.remove('selected');
  // reengancha handler por si repintamos
  t.removeEventListener('click', abrirModalMedio);
  t.addEventListener('click', abrirModalMedio);
});

setTimeout(() => {
  const sel = imgUrl
    ? Array.from(allThumbs).find(t => t.dataset.imgUrl === imgUrl)
    : Array.from(allThumbs).find(t => t.dataset.videoId === videoId);
  sel?.classList.add('selected');
}, 0);

  // ③ Volvemos a enlazar el click sobre esas miniaturas
  thumbsContainer.querySelectorAll('.media-thumb')
    .forEach(t =>{ t.addEventListener('click', abrirModalMedio);});
}

 // Delegación global (sirve para Results, Subcat, etc.)
 document.addEventListener('click', (ev) => {
   if (ev.target.closest('.media-thumb')) abrirModalMedio(ev);
 });



  function cerrarModal() {
  // ocultamos el modal y paramos el vídeo
  modal.classList.add('hidden');
  iframe.src = '';

  // si estábamos en split-view, lo desactivamos
  modal.classList.remove('split-view');
  document.body.classList.remove('split-view-active');

  // — opcional: si aplicaste inline styles al main, los borras —
  const main = document.getElementById('main-content');
  main.style.width = '';
  main.style.marginLeft = '';
}







  closeBtn.addEventListener('click', cerrarModal);
  modal.addEventListener('click', e => {
    if (e.target === modal) cerrarModal();
  });



// 2) Al hacer click en una miniatura, rellenar y mostrar modal


// 3) Cerrar modal con la “X”
closeBtn.addEventListener('click', () => {
  modal.classList.add('hidden');
  iframe.src = '';
});



// 4) También cerrar clicando fuera del contenedor
modal.addEventListener('click', e => {
  if (e.target === modal) {
    closeBtn.click();
  }
});






document.addEventListener('DOMContentLoaded', () => {
  const thumbsContainer = document.getElementById('video-thumbnails');
  const leftBtn         = document.getElementById('scroll-left');
  const rightBtn        = document.getElementById('scroll-right');

  function selectThumb(thumb) {
scale = 1;
    pos = { x: 0, y: 0 };
    zoomLevel.textContent = '100%';
    applyTransform();



    const prev = thumbsContainer.querySelector('.media-thumb.selected');
    if (prev) prev.classList.remove('selected');
    thumb.classList.add('selected');
    abrirModalMedio({ currentTarget: thumb });
  }

  leftBtn.addEventListener('click', () => {
    const thumbs = Array.from(thumbsContainer.children);
    const idx    = thumbs.findIndex(t => t.classList.contains('selected'));
    if (idx > 0) {
      const prevThumb = thumbs[idx - 1];
      selectThumb(prevThumb);
      prevThumb.scrollIntoView({ behavior: 'smooth', inline: 'center' });
    }
  });

  rightBtn.addEventListener('click', () => {
    const thumbs = Array.from(thumbsContainer.children);
    const idx    = thumbs.findIndex(t => t.classList.contains('selected'));
    if (idx < thumbs.length - 1) {
      const nextThumb = thumbs[idx + 1];
      selectThumb(nextThumb);
      nextThumb.scrollIntoView({ behavior: 'smooth', inline: 'center' });
    }
  });
});













</script>


<script>
  const zoomBtn   = document.getElementById('zoom-btn');
  const zoomMenu  = document.getElementById('zoom-menu');
  const zoomOut   = document.getElementById('zoom-out');
  const zoomIn    = document.getElementById('zoom-in');
  const zoomReset = document.getElementById('zoom-reset');
  const zoomLevel = document.getElementById('zoom-level');
  const img       = document.getElementById('modal-image');

  // -------- Utilidad: posicionar la "punta" del menú ----------
  function placeZoomCaret() {
    // Asegura que el menú esté visible para poder medirlo
    const wasHidden = zoomMenu.classList.contains('hidden');
    if (wasHidden) zoomMenu.classList.remove('hidden');

    // Medimos rectángulos del botón y del menú
    const m = zoomMenu.getBoundingClientRect();
    const b = zoomBtn.getBoundingClientRect();

    // Centro del botón relativo al borde izquierdo del menú
    let x = (b.left + b.width / 2) - m.left;

    // Pequeño clamp para que la punta no quede pegada a los bordes
    const pad = 10;
    x = Math.max(pad, Math.min(x, m.width - pad));

    zoomMenu.style.setProperty('--arrow-x', x + 'px');

    if (wasHidden) zoomMenu.classList.add('hidden');
  }

  // -------- Estado de zoom / pan ----------
  let scale = 1;
  let pos = { x: 0, y: 0 };
  let isPanning = false;
  let start = { x: 0, y: 0 };

  img.style.transformOrigin = 'center center';
  img.style.cursor = 'grab';

  function applyTransform() {
    img.style.transform = `translate(${pos.x}px, ${pos.y}px) scale(${scale})`;
  }

  // -------- Abrir / cerrar menú ----------
  zoomBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    zoomMenu.classList.toggle('hidden');
    if (!zoomMenu.classList.contains('hidden')) {
      // Coloca la punta cuando se abre
      requestAnimationFrame(placeZoomCaret);
    }
  });

  // Cerrar al hacer click fuera
  document.addEventListener('click', (e) => {
    if (!zoomMenu.contains(e.target) && e.target !== zoomBtn) {
      zoomMenu.classList.add('hidden');
    }
  });

  // Cerrar con ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') zoomMenu.classList.add('hidden');
  });

  // Recolocar la punta si cambia el layout
  window.addEventListener('resize', () => {
    if (!zoomMenu.classList.contains('hidden')) placeZoomCaret();
  });

  // -------- Controles de zoom ----------
  function setScale(next) {
    // límites 10%–300%
    scale = Math.min(3, Math.max(0.1, next));
    zoomLevel.textContent = Math.round(scale * 100) + '%';
    applyTransform();
  }

  zoomOut.addEventListener('click', () => setScale(scale - 0.1));
  zoomIn.addEventListener('click',  () => setScale(scale + 0.1));

  zoomReset.addEventListener('click', () => {
    scale = 1;
    pos = { x: 0, y: 0 };
    zoomLevel.textContent = '100%';
    applyTransform();
  });

  // -------- Panning ----------
  img.addEventListener('pointerdown', (e) => {
    e.preventDefault();
    isPanning = true;
    img.setPointerCapture?.(e.pointerId);
    img.style.cursor = 'grabbing';
    start.x = e.clientX - pos.x;
    start.y = e.clientY - pos.y;
  });

  window.addEventListener('pointermove', (e) => {
    if (!isPanning) return;
    pos.x = e.clientX - start.x;
    pos.y = e.clientY - start.y;
    applyTransform();
  });

  window.addEventListener('pointerup', (e) => {
    if (!isPanning) return;
    isPanning = false;
    img.releasePointerCapture?.(e.pointerId);
    img.style.cursor = 'grab';
  });

  // Inicial
  applyTransform();
  // (opcional) precalcula la punta por si el menú arranca abierto
  if (!zoomMenu.classList.contains('hidden')) placeZoomCaret();
</script>

<script>
// Delegación de evento: si haces click en cualquier botón dentro de .collapse-controls…
document.addEventListener('click', function(e) {
  const btn = e.target.closest('.collapse-controls > button');
  if (!btn) return;

  // Busca el <details> más cercano y ciérralo
  const detail = btn.closest('details');
  if (detail) detail.removeAttribute('open');
});
</script>


<script>
  // --- Dropdown comportamiento ---
  (() => {
    const wrap = document.getElementById('mode-dropdown');
    const btn  = document.getElementById('mode-btn');
    const lab  = document.getElementById('mode-label');
    const menu = document.getElementById('mode-menu');

    // abrir/cerrar
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      menu.classList.toggle('hidden');
    });

    // cerrar al clic fuera
    document.addEventListener('click', (e) => {
      if (!wrap.contains(e.target)) menu.classList.add('hidden');
    });

    // seleccionar opción
    menu.addEventListener('click', (e) => {
      const opt = e.target.closest('button[data-mode]');
      if (!opt) return;

      const mode = opt.getAttribute('data-mode');
      lab.textContent = mode;

      menu.querySelectorAll('button[data-mode]').forEach(b => {
        b.classList.remove('bg-gray-50');
        const check = b.querySelector('.fa-check');
        if (check) check.remove();
      });
      opt.classList.add('bg-gray-50');
      if (!opt.querySelector('.fa-check')) {
        opt.insertAdjacentHTML('beforeend', '<i class="fas fa-check mt-1 text-[rgb(29,125,138)]"></i>');
      }

      menu.classList.add('hidden');
    });
  })();
</script>

<script>
// Mantener split-view al hacer click en miniaturas del carrusel
(function keepSplitOnCarouselThumbs(){
  const root =
    document.getElementById('video-thumbnails') ||
    document.querySelector('#thumbnail-carousel');

  if (!root) return;

  // Delegación: escucha clicks en las miniaturas del carrusel
  root.addEventListener('click', (e) => {
    const thumb = e.target.closest('.media-thumb');
    if (!thumb) return;

    const modal = document.getElementById('video-modal');
    if (!modal || !modal.classList.contains('split-view')) return; // solo si ya estaba en split

    // Deja que el handler actual haga su trabajo y luego re-aplica split
    requestAnimationFrame(() => {
      modal.classList.add('split-view');
      document.body.classList.add('split-view-active');
    });
    // Reafirma una vez más por si hay lógica asíncrona
    setTimeout(() => {
      modal.classList.add('split-view');
      document.body.classList.add('split-view-active');
    }, 0);
  });
})();
</script>




<script>
(function(){
  function val(rootVar, fallback){
    const v = parseFloat(getComputedStyle(document.documentElement).getPropertyValue(rootVar));
    return Number.isFinite(v) ? v : fallback;
  }

  function computeSplit(){
    const modal = document.getElementById('video-modal');
    if (!modal || !modal.classList.contains('split-view')) return;

    const sb  = document.getElementById('sidebar');
    const toc = document.getElementById('subcategoria-sidebar');

    // ancho sidebar principal según estado
    let sbW = 0;
    if (sb) {
      if (sb.classList.contains('force-hidden')) {
        sbW = 0;
      } else if (sb.classList.contains('collapsed')) {
        sbW = val('--sb-collapsed', 40);
      } else {
        sbW = sb.offsetWidth || 0;
      }
    }

    // ancho TOC si visible
    const tocW = (toc && !toc.classList.contains('hidden'))
                  ? (toc.offsetWidth || val('--subcat-width', 180))
                  : 0;

    const vw = document.documentElement.clientWidth || window.innerWidth;
    const usable = Math.max(0, vw - (sbW + tocW));

    // —— mitad derecha del área útil ——
    const rightW = Math.max(360, Math.floor(usable / 2));
    const leftOffset = Math.floor(sbW + tocW + (usable - rightW));

    document.documentElement.style.setProperty('--split-left', leftOffset + 'px');
    document.documentElement.style.setProperty('--split-w', rightW + 'px');
  }

  // Recalcular en resize
  window.addEventListener('resize', () => requestAnimationFrame(computeSplit));

  // Observar cambios de clase que afecten layout (sidebar, toc, body, modal)
  const watch = (el) => {
    if (!el) return;
    new MutationObserver(() => requestAnimationFrame(computeSplit))
      .observe(el, { attributes: true, attributeFilter: ['class', 'style'] });
  };
  document.addEventListener('DOMContentLoaded', () => {
    watch(document.getElementById('sidebar'));
    watch(document.getElementById('subcategoria-sidebar'));
    watch(document.body);
    watch(document.getElementById('video-modal'));

    // primer cálculo por si ya entras en split
    computeSplit();
  });

  // Si en algún punto tu código añade/quita .split-view, vuelve a calcular
  document.addEventListener('click', (e) => {
    // ejemplo: botón que activa el split
    if (e.target.closest('#expand-video')) {
      setTimeout(computeSplit, 0);
    }
    // ejemplo: botón que colapsa/oculta sidebar
    if (e.target.closest('#menu-toggle')) {
      setTimeout(computeSplit, 0);
    }
  });

  // Por si llamas a toggleSidebarCollapse() programáticamente
  const orig = window.toggleSidebarCollapse;
  if (typeof orig === 'function') {
    window.toggleSidebarCollapse = function(...args){
      const r = orig.apply(this, args);
      requestAnimationFrame(computeSplit);
      return r;
    };
  }
})();
</script>

<script>
  function goToLibraryArticles() {
    // Mostrá el panel central de Library (tu función ya lo hace)
    switchView('library');


    

    const sidebar = document.getElementById('sidebar');
    const group   = document.getElementById('group-library');
    const btn     = group?.querySelector('button.sidebar-item');
    const acc     = document.getElementById('accordion-library');

    // Limpieza de estados previos
    document.querySelectorAll('#sidebar .sidebar-item')
      .forEach(el => el.classList.remove('is-active','active-link'));

    if (sidebar.classList.contains('collapsed')) {
      // En colapsado: NUNCA abrir el acordeón
      closeAllAccordions();
      acc?.classList.add('hidden');
      btn?.classList.remove('accordion-open');
      btn?.querySelector('.fa-chevron-down')?.classList.remove('rotate-180');
      group?.classList.remove('hover-open');

      // Solo dejar el ícono marcado
      btn?.classList.add('is-active');
    } else {
      // En ancho normal, si querés abrir automáticamente el acordeón de Library:
      toggleAccordion('library');
    }

    // <<< ESTA LÍNEA NUEVA >>>
    document.getElementById('lib-articles')?.click();
  }
</script>


<script>
(() => {
  const GROUP = document.getElementById('appearance-group');
  const ACTIVE_BG   = 'bg-[rgb(222,241,243)]';
  const ACTIVE_TXT  = 'text-[rgb(53,120,134)]';
  const ACTIVE_BDR  = 'border-[rgb(53,120,134)]';
  const INACTIVE_TXT= 'text-slate-600';
  const INACTIVE_BDR= 'border-[rgba(15,23,42,.14)]';

  function setActive(btn) {
    GROUP.querySelectorAll('button.seg').forEach((b, i) => {
      // base (inactivo)
      b.classList.remove(ACTIVE_BG, ACTIVE_TXT, ACTIVE_BDR);
      b.classList.add(INACTIVE_TXT, INACTIVE_BDR, 'rounded-none');
      // mantener unión sin doble borde salvo el primero
      if (i > 0) b.classList.add('-ml-px'); else b.classList.remove('-ml-px');
      // esquinas exteriores
      if (i === 0) { b.classList.add('first:rounded-l-[4px]'); }
      if (i === GROUP.children.length - 1) { b.classList.add('last:rounded-r-[4px]'); }
    });

    // activo
    btn.classList.remove(INACTIVE_BDR, INACTIVE_TXT);
    btn.classList.add(ACTIVE_BG, ACTIVE_TXT, ACTIVE_BDR, 'relative', 'z-10');
  }

  // inicia con "Light" activo
  setActive(GROUP.querySelector('button[data-theme="light"]'));

  GROUP.addEventListener('click', (e) => {
    const b = e.target.closest('button.seg');
    if (!b) return;
    setActive(b);
    // aquí puedes guardar el modo elegido si quieres
    // const theme = b.dataset.theme;
  });
})();
</script>
<script>
async function exitSplitIfAny() {
  const body  = document.body;
  const modal = document.getElementById('video-modal');

  // 0) Si hay Picture-in-Picture, cerrarlo
  try {
    if (document.pictureInPictureElement) await document.exitPictureInPicture();
  } catch {}

  // 1) Detener cualquier <video> HTML5 y <audio>
  document.querySelectorAll('video, audio').forEach(m => {
    try { m.pause(); } catch {}
    try { m.currentTime = 0; } catch {}
    try { m.removeAttribute('src'); m.load(); } catch {}
  });

  // 2) Neutralizar embeds (YouTube/Vimeo/lo que sea)
  const allFrames = Array.from(document.querySelectorAll('iframe'));
  allFrames.forEach(f => {
    // intenta pausar por API si es YT/Vimeo
    try {
      const src = (f.getAttribute('src') || '').toLowerCase();
      if (src.includes('youtube') || src.includes('youtu.be')) {
        f.contentWindow?.postMessage('{"event":"command","func":"stopVideo","args":""}', '*');
      } else if (src.includes('vimeo.com')) {
        f.contentWindow?.postMessage({ method: 'pause' }, '*');
      }
    } catch {}

    // ❗️NO eliminar el del modal: sólo limpiar su src
    if (f.id === 'modal-iframe') {
      try { f.src = ''; } catch {}
      return; // no lo remuevas del DOM
    }
    // Para el resto, con limpiar el src alcanza
    try { f.removeAttribute('src'); } catch {}
    // (si querés aún remover otros iframes, ok, pero nunca el del modal)
    // f.parentElement?.removeChild(f);
  });

  // 3) Cerrar split + modal + UI
  body.classList.remove('split-view-active');
  if (modal) {
    modal.classList.remove('split-view', 'video-mode');
    modal.classList.add('hidden');
    modal.querySelector('#thumbnail-carousel')?.classList.add('hidden');
  }

  // 4) Limpiar variables CSS del split
  const root = document.documentElement;
  root.style.removeProperty('--split-left');
  root.style.removeProperty('--split-w');
}
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const homeLink = document.querySelector('#group-home a.sidebar-item');
  if (!homeLink) return;

  // al iniciar la página, marcar Home
  homeLink.classList.add('active-link');

  // al clickear Home, volver a marcarlo
  homeLink.addEventListener('click', () => {
    setTimeout(() => {
      document.querySelectorAll('#sidebar .sidebar-item')
        .forEach(el => el.classList.remove('active-link','is-active'));
      homeLink.classList.add('active-link');
    }, 0);
  });
});
</script>


<!-- Botón flotante para ocultar/mostrar barras -->
<button id="sb-switch" aria-label="Ocultar barras" title="Ocultar barras"
        style="opacity:0; pointer-events:none;">
  <i class="fas fa-chevron-left" aria-hidden="true"></i>
</button>

<script>
(function(){
  const btn = document.getElementById('sb-switch');
  const sb  = document.getElementById('sidebar');
  const toc = document.getElementById('subcategoria-sidebar');

  // Estado previo para restaurar exactamente como estaba
  const saved = { sidebarClass: null, tocHidden: null };

  // Calcula el ancho realmente visible de las barras (principal + TOC si aplica)
  function currentSidebarsWidth(){
    let w = 0;
    if (sb && !sb.classList.contains('force-hidden')) {
      // ancho real actual (colapsada, abierta o “hover-expand”)
      w += sb.getBoundingClientRect().width || 0;
    }
    if (toc && !toc.classList.contains('hidden')) {
      w += toc.getBoundingClientRect().width || 0;
    }
    return w;
  }

  // Coloca el botón exactamente en el borde derecho de lo visible
  function cssVarPx(name, fallback = 0){
  const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  const n = parseFloat(v);
  return Number.isFinite(n) ? n : fallback;
}

function currentSidebarsWidthStable(){
  let w = 0;

  // 1) Sidebar principal: si está colapsada, usar --sb-collapsed fijo
  if (sb && !sb.classList.contains('force-hidden')) {
    if (sb.classList.contains('collapsed')) {
      w += cssVarPx('--sb-collapsed', 40);  // ← estable, no varía con el hover
    } else {
      w += sb.getBoundingClientRect().width || 0; // abierta: ancho real
    }
  }

  // 2) TOC: ancho real (no cambia con hover de la principal)
  if (toc && !toc.classList.contains('hidden')) {
    w += toc.getBoundingClientRect().width || 0;
  }

  return w;
}

function placeSwitch(){
  if (document.body.classList.contains('bars-hidden')) return; // en oculto queda a 8px
  const w = Math.max(0, currentSidebarsWidthStable());
  const overlap = 14; // “muerde” un poco el borde como en la captura
  const left = Math.max(8, w - overlap);
  document.documentElement.style.setProperty('--btn-left', left + 'px');
}


  // Observa cambios de tamaño/clases que afecten la posición
  const mo = new MutationObserver(placeSwitch);
  if (sb)  mo.observe(sb,  { attributes: true, attributeFilter:['class','style'] });
  if (toc) mo.observe(toc, { attributes: true, attributeFilter:['class','style'] });
  window.addEventListener('resize', placeSwitch, { passive:true });
  // Recalcula también cuando el user pasa el mouse sobre la barra colapsada (hover-expand)
  
  // Llamada inicial
  requestAnimationFrame(placeSwitch);

  // Toggle principal
  btn.addEventListener('click', () => {
    const hiding = !document.body.classList.contains('bars-hidden');

    if (hiding){
      // Guardar estado EXACTO
      saved.sidebarClass = sb ? sb.className : null;
      saved.tocHidden    = toc ? toc.classList.contains('hidden') : null;

      // Ocultar ambas barras
      if (sb)  sb.classList.add('force-hidden');
      if (toc) toc.classList.add('hidden');

      document.body.classList.add('bars-hidden');
      btn.setAttribute('aria-label','Mostrar barras');
      btn.title = 'Mostrar barras';
    } else {
      // Restaurar estado EXACTO
      if (sb && saved.sidebarClass !== null) sb.className = saved.sidebarClass;
      if (toc && saved.tocHidden === false) toc.classList.remove('hidden');
      if (toc && saved.tocHidden === true)  toc.classList.add('hidden');

      document.body.classList.remove('bars-hidden');
      btn.setAttribute('aria-label','Ocultar barras');
      btn.title = 'Ocultar barras';
      // Reposicionar al volver a aparecer
      requestAnimationFrame(placeSwitch);
    }
  });



    // NEW: click en overlay móvil reutiliza el toggle de #sb-switch
  const overlay = document.getElementById('mobile-overlay');
  if (overlay) {
    overlay.addEventListener('click', () => {
      if (!document.body.classList.contains('bars-hidden')) {
        btn.click();              // usa el mismo handler para ocultar barras
      }
      overlay.classList.remove('show'); // cierra el velo
    });
  }


  // Si cambias el modo "split-view" o similares, vuelve a posicionar
  const ro = new ResizeObserver(placeSwitch);
  if (sb)  ro.observe(sb);
  if (toc) ro.observe(toc);
})();
</script>


<script>
  const sidebar   = document.getElementById('sidebar');
  const home      = document.getElementById('home-content');
  const menuBtn   = document.getElementById('menu-toggle');
  const floatBtn  = document.getElementById('sb-switch'); // si lo usás para colapsar/expandir

  // Helpers de estado
  const isOnHome = () => home && !home.classList.contains('hidden');

  function showSidebarFull() {
    // Mostrar SIEMPRE completa (ni oculta ni colapsada)
    sidebar.classList.remove('force-hidden', 'collapsed');
    sidebar.classList.add('open');
    document.body.classList.remove('bars-hidden'); // si lo usás como marca global
  }

  function hideSidebar() {
    // Ocultar por completo (sin hover-expand)
    sidebar.classList.add('force-hidden');
    sidebar.classList.remove('open', 'collapsed');
    document.body.classList.add('bars-hidden');
  }

  function toggleHiddenOnly() {
    // Si está oculta => mostrar completa
    if (sidebar.classList.contains('force-hidden')) {
      showSidebarFull();
    } else {
      // Si está visible (abierta o colapsada) => ocultar
      hideSidebar();
    }
  }

  // 🔘 BOTÓN MENÚ (header)
  // En Home: solo ocultar/mostrar (nunca colapsar).
  // Fuera de Home: mantené tu comportamiento original (si usás el botón flotante).
  menuBtn?.addEventListener('click', () => {
    if (isOnHome()) {
      toggleHiddenOnly();          // ← NO deja "collapsed" al mostrar
    } else {
      // Comportamiento previo fuera de Home (si existía)
      // Por ejemplo, disparar el flotante para colapsar/expandir:
      floatBtn?.click();
    }
  });

  // 🔘 BOTÓN FLOTANTE (si querés mantener su función de colapsar/expandir)
  // Ejemplo de wiring típico (opcional — si ya lo tenés, dejalo tal cual):
  // floatBtn?.addEventListener('click', () => {
  //   // alternar entre abierto y colapsado (no oculto)
  //   if (sidebar.classList.contains('collapsed')) {
  //     sidebar.classList.remove('collapsed');
  //     sidebar.classList.add('open');
  //   } else {
  //     sidebar.classList.remove('open', 'force-hidden');
  //     sidebar.classList.add('collapsed');
  //     document.body.classList.remove('bars-hidden');
  //   }
  // });

  // 🛡️ Salvaguarda: si por cualquier acción termina "mostrada pero colapsada"
  // y estás en Home, al primer hover se “descolapsa” definitivamente:
  sidebar?.addEventListener('mouseenter', () => {
    if (isOnHome() && !sidebar.classList.contains('force-hidden')) {
      // forzar que quede abierta al interactuar en Home
      sidebar.classList.remove('collapsed');
      sidebar.classList.add('open');
    }
  });
</script>

<script>
(function(){
  const btn        = document.getElementById('sb-switch');
  const sidebar    = document.getElementById('sidebar');
  const userSect   = document.getElementById('user-section');

  if (!btn || !sidebar || !userSect) return;

  function setVisible(show){
    btn.style.opacity = show ? '1' : '0';
    btn.style.pointerEvents = show ? 'auto' : 'none';
    btn.setAttribute('aria-hidden', show ? 'false' : 'true');
  }

  function updateFloatBtnVisibility(){
    // visible solo si: estás dentro de la app (no en login) y la barra principal NO está oculta
    const loggedIn        = !userSect.classList.contains('hidden');
    const sidebarVisible  = !sidebar.classList.contains('force-hidden');
    setVisible(loggedIn && sidebarVisible);
  }

  // Inicial
  document.addEventListener('DOMContentLoaded', updateFloatBtnVisibility);

  // Cambios de autenticación
  if (window.firebase?.auth) {
    firebase.auth().onAuthStateChanged(() => updateFloatBtnVisibility());
  }

  // Cambios de clases en sidebar/body (open/collapsed/force-hidden, bars-hidden, etc.)
  new MutationObserver(updateFloatBtnVisibility)
    .observe(sidebar, { attributes: true, attributeFilter: ['class'] });

  new MutationObserver(updateFloatBtnVisibility)
    .observe(document.body, { attributes: true, attributeFilter: ['class'] });

  // Por si querés llamarlo manualmente desde otros handlers:
  window.updateFloatBtnVisibility = updateFloatBtnVisibility;
})();
</script>




<!-- === Retroceder === -->

<script>
/* Library history + restore sidebar + FIX first→second panel (compact, idempotent) */
(function () {
  // Evita navegación en <a href="#"> dentro del sidebar y los 3 paneles
  document.addEventListener('click', e => {
    const a = e.target.closest('a[href="#"]');
    if (a && (a.closest('#sidebar') || a.closest('#articles-panel'))) e.preventDefault();
  });

  // Cache originales
  const fn = {
    home:  window.showHome,
    lib:   window.showArticles,
    p2:    window.showSecondPanel,
    p3:    window.showThirdPanel,
    sub:   window.showSubcategoriaContent
  };

  let lastView = 'home';
  let lastViewBeforeSubcat = null;
  const setView = (view) => {
    if (view === 'subcat') {
      lastViewBeforeSubcat = lastView;
    } else {
      lastViewBeforeSubcat = null;
    }
    lastView = view;
  };

  // Guardar / Restaurar estado de la barra principal
  let sbPrev = null;
  const saveSB = () => {
    const sb = document.getElementById('sidebar'), b = document.body;
    if (!sb) return;
    sbPrev = {
      collapsed: sb.classList.contains('collapsed'),
      forceHidden: sb.classList.contains('force-hidden'),
      open: sb.classList.contains('open'),
      barsHidden: b.classList.contains('bars-hidden')
    };
  };
  const restoreSB = () => {
    if (!sbPrev) return;
    const sb = document.getElementById('sidebar'), b = document.body;
    sb.classList.remove('collapsed','force-hidden','open');
    if (sbPrev.forceHidden) sb.classList.add('force-hidden');
    if (sbPrev.collapsed)   sb.classList.add('collapsed');
    else if (sbPrev.open)   sb.classList.add('open');
    b.classList.toggle('bars-hidden', !!sbPrev.barsHidden);
  };

  const push = (view, extra={}) => history.pushState({ view, ...extra }, '', '');

  // Wrappers con historial y restauración de barra
  window.showHome     = () => { restoreSB(); fn.home(); setView('home'); push('home'); };
  window.showArticles = () => { restoreSB(); fn.lib();  setView('library'); push('library'); };

  // FIX: asegurar que el panel-2 se muestre tras cargar categorías
  window.showSecondPanel = async (el, sup) => {
    setView('library');
    await fn.p2(el, sup);
    requestAnimationFrame(() => document.getElementById('panel-2')?.classList.remove('hidden'));
    push('library', { sup });
  };

  window.showThirdPanel = async (el, cat) => {
    setView('library');
    await fn.p3(el, cat);
    const sup = document.querySelector('#articles-panel > div:first-child li.is-selected span')?.textContent?.trim();
    push('library', { sup, cat });
  };

  window.showSubcategoriaContent = async (...args) => {
    const maybeOpts = args[3] && typeof args[3] === 'object' ? args[3] : {};
    const skipShowView = !!maybeOpts.skipShowView;
    if (!skipShowView) {
      saveSB();
      const homeEl = document.getElementById('home-content');
      if (homeEl && !homeEl.classList.contains('hidden')) {
        lastView = 'home';
      }
      setView('subcat');
    }
    return fn.sub(...args);
  };

  // Restaurar EXACTAMENTE los 3 paneles como estaban (sin pushState)
  let restoring = false;
  window.restoreLibraryFromState = async (s) => {
    if (restoring) return;
    restoring = true;
    try {
      restoreSB();
      fn.lib(); // sin push
      if (s?.sup) {
        const a1 = [...document.querySelectorAll('#articles-panel > div:first-child li a')]
          .find(a => a.textContent.trim() === s.sup);
        if (a1) await fn.p2(a1, s.sup); // sin push
        requestAnimationFrame(() => document.getElementById('panel-2')?.classList.remove('hidden'));
      }
      if (s?.cat) {
        const a2 = [...document.querySelectorAll('#panel-2 a')]
          .find(a => a.textContent.trim() === s.cat);
        if (a2) await fn.p3(a2, s.cat); // sin push
      }
    } finally {
      restoring = false;
    }
  };

  // Back/forward: bloquear el listener original + restaurar sin duplicar
  window.addEventListener('popstate', (e) => {
    const subcatEl = document.getElementById('subcategoria-content');
    const inSubcat = subcatEl && !subcatEl.classList.contains('hidden');
    if (inSubcat && lastView === 'subcat' && lastViewBeforeSubcat === 'home') {
      e.stopImmediatePropagation?.();
      restoreSB();
      setView('home');
      return fn.home(); // sin push
    }
    const s = e.state;
    if (s?.view === 'home') {
      e.stopImmediatePropagation?.();
      restoreSB();
      setView('home');
      return fn.home(); // sin push
    }
    if (s?.view === 'library') {
      e.stopImmediatePropagation?.();
      setView('library');
      return window.restoreLibraryFromState(s);
    }
    e.stopImmediatePropagation?.();
    restoreSB();
    setView('library');
    fn.lib(); // fallback sin push
  }, true);
})();
</script>



















<!-- === NOTES panel === -->
<script>
(function(){
  // ===== Utils =====
  const hasFirestore = !!(firebase.firestore);
  const db = hasFirestore ? (window.db || firebase.firestore()) : null;

  // Contexto opcional por subcategoría
  window.__CURRENT_SUBCAT_CTX__ = window.__CURRENT_SUBCAT_CTX__ || null;
  window.setCurrentSubcatCtx = function(ctx){ window.__CURRENT_SUBCAT_CTX__ = ctx || null; };

  const slugify = s => String(s||'')
    .toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^\p{L}\p{N}]+/gu,'-')
    .replace(/^-+|-+$/g,'')
    .slice(0,80);

  function makeNoteId(detailsEl){
    const ctx = window.__CURRENT_SUBCAT_CTX__ || {};
    const title =
      detailsEl?.querySelector('summary span')?.textContent?.trim() ||
      detailsEl?.querySelector('summary')?.textContent?.trim() || 'section';

    const parts = [
      slugify(ctx.supracategoriaId),
      slugify(ctx.categoriaId),
      slugify(ctx.subcategoriaId),
      slugify(title)
    ].filter(Boolean);
    return parts.join('__') || slugify(title);
  }

  // ===== UI =====
  function ensureNotesCard(containerEl){
    let card = containerEl.querySelector(':scope > .notes-card');
    if (card) return card;

    card = document.createElement('div');
    card.className = 'notes-card';
    card.innerHTML = `
      <div class="notes-head">
        <div class="notes-title-wrap">
          <div class="notes-title">Notes</div>
          <span class="notes-counter" id="notes-counter">0/1000</span>
        </div>
        <div class="notes-actions">
          <button type="button" class="notes-btn-sm" data-act="cancel">Cancel</button>
          <button type="button" class="notes-btn-sm primary" data-act="save">Save</button>
        </div>
      </div>

      <div class="notes-toolbar">
        <button class="notes-tool" data-cmd="bold" title="Bold"><i class="fas fa-bold"></i></button>
        <button class="notes-tool" data-cmd="italic" title="Italic"><i class="fas fa-italic"></i></button>
        <button class="notes-tool" data-cmd="underline" title="Underline"><i class="fas fa-underline"></i></button>

        <button class="notes-tool" data-cmd="insertUnorderedList" title="Bulleted list"><i class="fas fa-list-ul"></i></button>
        <button class="notes-tool" data-cmd="insertOrderedList"  title="Numbered list"><i class="fas fa-list-ol"></i></button>

        <!-- Menú de formato -->
        <div class="notes-format">
          <button class="notes-tool notes-format-toggle" type="button" title="Paragraph formats">
            <i class="fas fa-paragraph"></i>
          </button>
          <div class="notes-menu" data-menu="format">
            <button type="button" class="notes-menu-item" data-format="p">Normal</button>
            <button type="button" class="notes-menu-item" data-format="h2"><span style="font-weight:700;font-size:1.1em">Heading 2</span></button>
            <button type="button" class="notes-menu-item" data-format="h3"><span style="font-weight:700;">Heading 3</span></button>
            <button type="button" class="notes-menu-item" data-format="h4"><span style="font-weight:700;">Heading 4</span></button>
          </div>
        </div>

        <button class="notes-tool" data-cmd="undo" title="Undo (⌘Z)"><i class="fas fa-undo"></i></button>
        <button class="notes-tool" data-cmd="redo" title="Redo (⌘⇧Z)"><i class="fas fa-redo"></i></button>

        <button class="notes-tool" data-cmd="formatBlock" data-value="blockquote" title="Quote"><i class="fas fa-quote-right"></i></button>
        <button class="notes-tool" data-cmd="removeFormat" title="Clear"><i class="fas fa-eraser"></i></button>
      </div>

      <div class="notes-editor notes-empty" contenteditable="true" spellcheck="true">
        Write your notes here…
      </div>
    `;
    containerEl.appendChild(card);

    const editor = card.querySelector('.notes-editor');

    // Desactivar/activar Redo según disponibilidad
const redoBtn = card.querySelector('.notes-tool[data-cmd="redo"]');

function updateRedoState(){
  const canRedo = typeof document.queryCommandEnabled === 'function'
    ? document.queryCommandEnabled('redo')
    : false;
  redoBtn.toggleAttribute('disabled', !canRedo);
  redoBtn.classList.toggle('opacity-40', !canRedo);
  redoBtn.classList.toggle('pointer-events-none', !canRedo);
}

// Actualizar en eventos típicos
['input','keyup','mouseup'].forEach(ev => editor.addEventListener(ev, updateRedoState));
document.addEventListener('selectionchange', updateRedoState);

// Tras cualquier botón que use execCommand, actualizar estado
card.querySelectorAll('.notes-tool').forEach(b=>{
  if (b.closest('.notes-format')) return;
  b.addEventListener('click', () => setTimeout(updateRedoState, 0));
});

updateRedoState();

    // Placeholder on focus/blur
    editor.addEventListener('focus', ()=>{
      if(editor.classList.contains('notes-empty')){
        editor.textContent=''; editor.classList.remove('notes-empty');
      }
    });
    editor.addEventListener('blur', ()=>{
      if(editor.textContent.trim()===''){
        editor.textContent='Write your notes here…'; editor.classList.add('notes-empty');
      }
    });

    // Botones básicos (execCommand)
card.querySelectorAll('.notes-tool').forEach(btn => {
  if (btn.closest('.notes-format')) return; // saltar botón de formato
  
  const cmd = btn.dataset.cmd;
  
  if (cmd === 'insertOrderedList') {
    // ✅ Botón lista numerada con lógica personalizada
    btn.addEventListener('click', (e) => {
      e.preventDefault(); 
      e.stopPropagation();
      editor.focus();
      
      const sel = window.getSelection();
      if (!sel || !sel.rangeCount) return;
      
      const range = sel.getRangeAt(0);
      const node = range.startContainer.nodeType === 1
        ? range.startContainer
        : range.startContainer.parentElement;
      
      // Verificar si estamos dentro de una lista
      const currentOL = node?.closest?.('ol');
      const currentUL = node?.closest?.('ul');
      const currentLI = node?.closest?.('li');
      
      if (currentOL) {
        // Ya estamos en lista numerada
        if (sel.isCollapsed && currentLI) {
          // Crear nuevo item en la lista existente
          const newLI = document.createElement('li');
          newLI.innerHTML = '<br>';
          
          // Insertar después del li actual
          if (currentLI.nextSibling) {
            currentOL.insertBefore(newLI, currentLI.nextSibling);
          } else {
            currentOL.appendChild(newLI);
          }
          
          // Posicionar cursor en el nuevo li
          const newRange = document.createRange();
          newRange.setStart(newLI, 0);
          newRange.collapse(true);
          sel.removeAllRanges();
          sel.addRange(newRange);
        } else {
          // Convertir de vuelta a texto normal
          document.execCommand('insertOrderedList');
        }
        return;
      }
      
      if (currentUL) {
        // Convertir de lista con bullets a lista numerada
        const parentUL = currentUL;
        const newOL = document.createElement('ol');
        
        // Copiar todos los li de ul a ol
        while (parentUL.firstChild) {
          newOL.appendChild(parentUL.firstChild);
        }
        
        // Reemplazar ul con ol
        parentUL.parentNode.replaceChild(newOL, parentUL);
        
        // Mantener la selección
        if (currentLI && newOL.contains(currentLI)) {
          const newRange = document.createRange();
          newRange.setStart(currentLI, 0);
          newRange.collapse(true);
          sel.removeAllRanges();
          sel.addRange(newRange);
        }
        return;
      }
      
      // No estamos en ninguna lista - crear nueva lista numerada
      if (sel.isCollapsed) {
        // Cursor sin selección - crear lista nueva
        const ol = document.createElement('ol');
        const li = document.createElement('li');
        li.innerHTML = '<br>';
        ol.appendChild(li);
        
        range.deleteContents();
        range.insertNode(ol);
        
        // Posicionar cursor dentro del li
        const newRange = document.createRange();
        newRange.setStart(li, 0);
        newRange.collapse(true);
        sel.removeAllRanges();
        sel.addRange(newRange);
      } else {
        // Hay texto seleccionado - convertir a lista numerada
        const selectedContent = range.extractContents();
        const ol = document.createElement('ol');
        const li = document.createElement('li');
        li.appendChild(selectedContent);
        ol.appendChild(li);
        
        range.insertNode(ol);
        
        // Seleccionar el contenido dentro del li
        const newRange = document.createRange();
        newRange.selectNodeContents(li);
        sel.removeAllRanges();
        sel.addRange(newRange);
      }
    });
  } else {
    // ✅ Botones normales (bold, italic, etc.)
    btn.addEventListener('click', () => {
      const val = btn.dataset.value || null;
      document.execCommand(cmd, false, val);
      editor.focus();
    });
  }
});


    // —— Menú de formato (Normal / H2 / H3 / H4)
    const fmtToggle = card.querySelector('.notes-format-toggle');
    const fmtMenu   = card.querySelector('.notes-menu[data-menu="format"]');

    function closeAllMenus(){
      document.querySelectorAll('.notes-menu.open').forEach(m=>m.classList.remove('open'));
    }
    fmtToggle.addEventListener('click', (e)=>{
      e.stopPropagation();
      const isOpen = fmtMenu.classList.contains('open');
      closeAllMenus();
      if (!isOpen) fmtMenu.classList.add('open');
    });
    fmtMenu.querySelectorAll('.notes-menu-item').forEach(it=>{
      it.addEventListener('click', ()=>{
        const tag = (it.dataset.format || 'p').toUpperCase(); // P/H2/H3/H4
        document.execCommand('formatBlock', false, tag === 'P' ? 'P' : tag);
        closeAllMenus();
        editor.focus();
      });
    });
    document.addEventListener('click', closeAllMenus);

    // ===== Contador de caracteres (0/1000) =====
    const LIMIT = 1000;
    const counterEl = card.querySelector('#notes-counter');
    const plainLen = () => (editor.textContent || '').trim().length;

    const updateCounter = () => {
      const len = plainLen();
      counterEl.textContent = `${len}/${LIMIT}`;
      counterEl.classList.toggle('is-over', len > LIMIT);
    };
    editor.addEventListener('input', updateCounter);
    editor.addEventListener('keyup', updateCounter);
    updateCounter();

    return card;
  }

  async function openNotesFor(detailsEl){
    // Cierra cualquier panel abierto
    document.querySelectorAll('.notes-card').forEach(c=>c.remove());

    // Montaje: en el footer si existe, arriba de los botones
    const footer = detailsEl.querySelector(':scope > .collapse-controls');
    const mount  = footer || detailsEl;
    const card   = ensureNotesCard(mount);

    if (footer) {
      let col = footer.querySelector('.notes-col-wrapper');
      if (!col) {
        col = document.createElement('div');
        col.className = 'notes-col-wrapper flex flex-col w-full';
        const rest = document.createElement('div');
        rest.className = 'collapse-row flex items-center justify-between mt-2';
        while (footer.firstChild) rest.appendChild(footer.firstChild);
        col.appendChild(card);
        col.appendChild(rest);
        footer.appendChild(col);
      } else {
        col.insertBefore(card, col.firstChild);
      }
    }

    const editor = card.querySelector('.notes-editor');

    const uid = firebase.auth().currentUser?.uid || null;
    const canPersist = !!(uid && db);

    // Carga Firestore
   const noteId = window.noteDocIdFromDetails(detailsEl);
   
    let docRef = null;

    if (canPersist){
      docRef = db.collection('users').doc(uid).collection('notes').doc(noteId);
      try{
        const snap = await docRef.get();
        if (snap.exists && snap.data()?.content){
          editor.innerHTML = DOMPurify.sanitize(snap.data().content);
          editor.classList.remove('notes-empty');
        } else {
          editor.textContent = 'Write your notes here…';
          editor.classList.add('notes-empty');
        }
      }catch(e){ console.error('Firestore read error', e); }
    } else {
      card.querySelector('.notes-title').textContent = 'Notes (local)';
      card.querySelector('[data-act="save"]').title = 'Inicia sesión para guardar en la nube';
    }

    // Recalcular contador tras la carga
    const counterEl = card.querySelector('#notes-counter');
    if (counterEl) {
      const len = (editor.textContent || '').trim().length;
      const LIMIT = 1000;
      counterEl.textContent = `${len}/${LIMIT}`;
      counterEl.classList.toggle('is-over', len > LIMIT);
    }

// Acciones
card.querySelector('[data-act="save"]').onclick = async ()=>{
  const html = editor.classList.contains('notes-empty') ? '' :
    DOMPurify.sanitize(editor.innerHTML, {
      ALLOWED_TAGS:[
        'b','strong','i','em','u',
        'ul','ol','li',
        'p','br','blockquote','span','a',
        'h2','h3','h4' // ← añadido
      ],
      ALLOWED_ATTR:['href','target','rel','style']
    });

  if (!canPersist){
    alert('Inicia sesión para guardar tus notas en la nube.');
    return;
  }
      try{
        await docRef.set({
          content: html,
          ctx: window.__CURRENT_SUBCAT_CTX__ || {},
          sectionTitle: (detailsEl.querySelector('summary span')?.textContent?.trim() ||
                        detailsEl.querySelector('summary')?.textContent?.trim() || ''),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

          paintNotesIndicator(detailsEl, !window.isEmptyHtml(html));        



        const btn = card.querySelector('[data-act="save"]');
        const old = btn.textContent; btn.textContent = 'Saved ✓';
        setTimeout(() => {
  btn.textContent = old;
  card.remove(); // 👈 Esta línea oculta el editor
}, 800);
      }catch(e){
        console.error('Firestore write error', e);
        alert('No se pudo guardar la nota.');
      }
    };

    card.querySelector('[data-act="cancel"]').onclick = ()=> card.remove();
  }

  // Delegación global: abre panel al pulsar .notes-btn
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.notes-btn');
    if (!btn) return;
    const details = btn.closest('details');
    if (!details) return;
    openNotesFor(details);
  });

  // Badges teal si ya hay notas guardadas (opcional)
  window.applyNotesBadgesInPage = async function(){
    if(!db) return;
    const uid = firebase.auth().currentUser?.uid; if(!uid) return;
    const ctx = window.__CURRENT_SUBCAT_CTX__ || {};
    const prefix = [slugify(ctx.supracategoriaId), slugify(ctx.categoriaId), slugify(ctx.subcategoriaId)]
      .filter(Boolean).join('__');
    const qs = await db.collection('users').doc(uid).collection('notes')
      .where(firebase.firestore.FieldPath.documentId(), '>=', prefix + '__')
      .where(firebase.firestore.FieldPath.documentId(), '<',  prefix + '___').get();
    const have = new Set(qs.docs.map(d=>d.id));
    document.querySelectorAll('#subcategoria-body details').forEach(d=>{
      const id = makeNoteId(d);
      const btn = d.querySelector('.notes-btn'); if(!btn) return;
      btn.classList.toggle('text-transparent', have.has(id));
    });
  };

  // Helper de prueba
  window.debugNotes = () => console.log('notes-btns encontrados:', document.querySelectorAll('.notes-btn').length);
})();


(function ensureNotesStyles(){
    if (document.getElementById('notes-typography')) return;
    const css = `
      .notes-card .notes-editor{ line-height:1.65; }
      .notes-card .notes-editor p,
      .notes-card .notes-editor li{ font-size:1.06rem; }        /* Normal un poco más grande */
      .notes-card .notes-editor h2{ font-size:1.45rem; font-weight:800; margin:.9rem 0 .45rem; }
      .notes-card .notes-editor h3{ font-size:1.28rem; font-weight:750; margin:.8rem 0 .4rem; }
      .notes-card .notes-editor h4{ font-size:1.16rem; font-weight:700; margin:.7rem 0 .35rem; }
      .notes-card .notes-editor ul,
      .notes-card .notes-editor ol{ padding-left:1.25rem; margin:.4rem 0 .6rem; }
      .notes-card .notes-editor blockquote{ border-left:3px solid #e5e7eb; padding-left:.75rem; margin:.75rem 0; font-style:italic; }
      .notes-card .notes-editor b,
      .notes-card .notes-editor strong{ font-weight:800; }
    `;
    const s = document.createElement('style');
    s.id = 'notes-typography';
    s.textContent = css;
    document.head.appendChild(s);
  })();

  








</script>




<!-- === flotante resaltar (nuevo árbol + multiline) === -->
<script>
(function(){
  // === Config / refs ===
  const CONTENT_ID     = 'subcategoria-body';
  const SCROLL_HOST_ID = 'main-content';
  const POP_ID         = 'hl-popover';

  // Firestore (usa la misma instancia global que Notes)
  const hasFirestore = !!(window.firebase && firebase.firestore);
  const db = hasFirestore ? (window.db || firebase.firestore()) : null;

  // slugify (reutiliza global si existe)
  const slugify = (window.slugify) ? window.slugify : (s => String(s||'')
    .toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^\p{L}\p{N}]+/gu,'-')
    .replace(/^-+|-+$/g,'')
    .slice(0,80)
  );

  // === Estado de ámbito ===
  let STATE = { sup:null, cat:null, sub:null };
  const BODY = () => document.getElementById(CONTENT_ID);
  const authed = () => !!(hasFirestore && firebase.auth().currentUser);
  const uid    = () => firebase.auth().currentUser?.uid;

  // Nuevo: ID estable del "contenido" (todo el body de la subcategoría)
  function contentId(){
    const ctx = window.__CURRENT_SUBCAT_CTX__ || {};
    return [slugify(ctx.supracategoriaId), slugify(ctx.categoriaId), slugify(ctx.subcategoriaId), 'body']
      .filter(Boolean).join('__');
  }
  // Nuevo: colección donde viven los highlights de ese contenido
  function highlightsCollRef(){
    if (!db || !authed()) return null;
    return db.collection('users').doc(uid())
             .collection('notes').doc(contentId())
             .collection('highlights');
  }

  // Popover único
  let pop = document.getElementById(POP_ID);
  if (!pop) {
    pop = document.createElement('div');
    pop.id = POP_ID;
    pop.setAttribute('role','toolbar');
    pop.innerHTML = `
      <button class="hlp-btn hlp-apply" title="Resaltar"><i class="fas fa-highlighter"></i></button>
      <button class="hlp-btn hlp-clear"  title="Quitar resaltado"><i class="fas fa-eraser"></i></button>
    `;
    document.body.appendChild(pop);
  }
  const applyBtn   = pop.querySelector('.hlp-apply');
  const clearBtn   = pop.querySelector('.hlp-clear');

  const content    = document.getElementById(CONTENT_ID);
  const scrollHost = document.getElementById(SCROLL_HOST_ID);

  // Estado UI
  let hoverHL = null;
  let lastHoverHL = null;
  let popHovered = false;
  let hideTO = null;

  // === Reglas donde NO debe aparecer el popover
  const FORBIDDEN_SEL = `
    summary,
    .collapse-controls, .collapse-controls *,
    .media-thumb, .media-thumb *,
    .thumb-caption, .thumb-caption *,
    #subcat-header, #subcat-header *,
    .highlighting-bar, .highlighting-bar *,
    #font-menu, #font-menu *,
    #lang-menu, #lang-menu *
  `;
  function selectionIntersectsForbidden(){
    const s = window.getSelection();
    if (!s || s.rangeCount === 0) return false;
    const range = s.getRangeAt(0);
    const nodes = content ? content.querySelectorAll(FORBIDDEN_SEL) : [];
    for (const n of nodes) {
      try { if (range.intersectsNode(n)) return true; } catch{}
    }
    return false;
  }

  // La selección debe iniciar y terminar dentro del contenido
  function selectionInsideContentStrict(){
    const s = window.getSelection();
    if (!s || s.rangeCount === 0 || s.isCollapsed) return false;
    const r = s.getRangeAt(0);
    return !!(content && content.contains(r.startContainer) && content.contains(r.endContainer));
  }

  // === Visual del popover ===
  const selRect = () => {
    const s = window.getSelection();
    if (!s || s.rangeCount === 0 || s.isCollapsed) return null;
    const r = s.getRangeAt(0).getBoundingClientRect();
    return (r && (r.width || r.height)) ? r : null;
  };
  const isInside = (node) => {
    if (!node) return false;
    const el = node.nodeType === 1 ? node : node.parentElement;
    return el && content && content.contains(el);
  };
  const positionPopoverAtRect = (r) => {
    pop.style.display = 'flex';
    pop.style.left = (r.left + r.width/2) + 'px';
    pop.style.top  = (r.top - 8) + 'px';
  };
  function showPopover(){
    const on = JSON.parse(localStorage.getItem('hl:on') || 'false');
    if (!on) return hidePopover();

    const s = window.getSelection();
    if (s && s.rangeCount && !s.isCollapsed && selectionInsideContentStrict() && !selectionIntersectsForbidden()) {
      const r = selRect(); if (!r) return hidePopover();
      positionPopoverAtRect(r);
      return;
    }
    if (hoverHL && content.contains(hoverHL)) {
      const r = hoverHL.getBoundingClientRect();
      if (r && (r.width || r.height)) { positionPopoverAtRect(r); return; }
    }
    if (popHovered && pop.style.display !== 'none') return;
    hidePopover();
  }
  function hidePopover(){ clearTimeout(hideTO); pop.style.display = 'none'; pop.dataset.target = ''; }

  document.addEventListener('mouseup', () => {
    setTimeout(() => {
      if (!selectionInsideContentStrict()) { hidePopover(); return; }
      showPopover();
    }, 0);
  });

  scrollHost?.addEventListener('scroll', () => { hoverHL = null; lastHoverHL = null; hidePopover(); }, { passive:true });
  document.addEventListener('mousedown', (e) => { if (!pop.contains(e.target)) hidePopover(); });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hidePopover(); });
  pop.addEventListener('mouseenter', () => { popHovered = true; clearTimeout(hideTO); });
  pop.addEventListener('mouseleave', () => {
    popHovered = false;
    const s = window.getSelection();
    if (!(s && s.rangeCount && !s.isCollapsed) && !hoverHL) hidePopover();
  });

  // === Utilidades DOM ===
  function splitText(node, offset){
    if (node.nodeType !== Node.TEXT_NODE) return node;
    if (offset <= 0 || offset >= node.nodeValue.length) return node;
    return node.splitText(offset);
  }
  function nextTextIn(root, from){
    const tw = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, { acceptNode(){ return NodeFilter.FILTER_ACCEPT; }});
    tw.currentNode = from; return tw.nextNode();
  }
  function prevTextIn(root, from){
    const tw = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, { acceptNode(){ return NodeFilter.FILTER_ACCEPT; }});
    tw.currentNode = from; return tw.previousNode();
  }
  function descendToText(container, offset, root, fromEnd){
    if (container.nodeType === Node.TEXT_NODE) return { node: container, offset };
    const cn = container.childNodes;
    let idx = fromEnd ? Math.max(0, Math.min(offset-1, cn.length-1)) : Math.max(0, Math.min(offset, cn.length-1));
    let probe = cn[idx] || container;

    let txt = fromEnd ? lastText(probe) : firstText(probe);
    if (!txt) txt = fromEnd ? prevTextIn(root, probe) : nextTextIn(root, probe);
    return { node: txt || container, offset: (fromEnd ? (txt?.nodeValue?.length || 0) : 0) };

    function firstText(node){ const t = document.createTreeWalker(node, NodeFilter.SHOW_TEXT, { acceptNode(){ return NodeFilter.FILTER_ACCEPT; } }); return t.nextNode(); }
    function lastText(node){ const t = document.createTreeWalker(node, NodeFilter.SHOW_TEXT, { acceptNode(){ return NodeFilter.FILTER_ACCEPT; } }); let last=null, cur; while((cur=t.nextNode())) last=cur; return last; }
  }
function normalizeRangeToText(range, root){
  let { startContainer, startOffset, endContainer, endOffset } = range;

  // --- FIX: si el fin está exactamente al inicio del siguiente nodo/elemento, retrocede al texto previo ---
  if (endContainer) {
    if (endContainer.nodeType === Node.TEXT_NODE && endOffset === 0){
      const prev = prevTextIn(root, endContainer);
      if (prev) { endContainer = prev; endOffset = prev.nodeValue.length; }
    } else if (endContainer.nodeType !== Node.TEXT_NODE && endOffset === 0){
      const prev = prevTextIn(root, endContainer);
      if (prev) { endContainer = prev; endOffset = prev.nodeValue.length; }
      else {
        ({ node: endContainer, offset: endOffset } = descendToText(endContainer, endOffset, root, true));
      }
    } else if (endContainer.nodeType !== Node.TEXT_NODE){
      ({ node: endContainer, offset: endOffset } = descendToText(endContainer, endOffset, root, true));
    }
  }

  // Normaliza inicio a nodo de texto
  if (startContainer && startContainer.nodeType !== Node.TEXT_NODE){
    ({ node: startContainer, offset: startOffset } = descendToText(startContainer, startOffset, root, false));
  }

  // Asegura el orden start <= end
  const test = document.createRange();
  try { test.setStart(startContainer, startOffset); test.setEnd(endContainer, endOffset); } catch {}
  if (test.collapsed && (startContainer !== endContainer || endOffset < startOffset)) {
    [startContainer, endContainer] = [endContainer, startContainer];
    [startOffset,   endOffset]     = [endOffset,   startOffset];
  }

  // Caso mismo nodo
  if (startContainer === endContainer && startContainer?.nodeType === 3) {
    if (endOffset < startContainer.nodeValue.length) splitText(startContainer, endOffset);
    if (startOffset > 0) startContainer = splitText(startContainer, startOffset);
    return { startText: startContainer, endText: startContainer };
  }

  // Divide según offsets
  if (startContainer?.nodeType === 3) {
    const right = splitText(startContainer, startOffset);
    if (right) startContainer = right;
  }
  if (endContainer?.nodeType === 3) {
    if (endOffset < endContainer.nodeValue.length) splitText(endContainer, endOffset);
  }

  return { startText: startContainer, endText: endContainer };
}


  function collectTextsBetween(root, startText, endText){
    const tw = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, { acceptNode(){ return NodeFilter.FILTER_ACCEPT; } });
    const nodes = [];
    let cur = startText;
    while (cur) { nodes.push(cur); if (cur === endText) break; tw.currentNode = cur; cur = tw.nextNode(); if (!cur) break; }
    return nodes;
  }
  function wrapTextNode(n, gid){
    if (!n.nodeValue || !n.nodeValue.trim().length) return;
    if (n.parentNode && n.parentNode.classList && n.parentNode.classList.contains('my-hl')) return;
    const span = document.createElement('span');
    span.className = 'my-hl';
    span.dataset.hlId = gid;
    n.parentNode.insertBefore(span, n);
    span.appendChild(n);
  }
  function mergeAdjacent(root){
    const list = root.querySelectorAll('.my-hl');
    for (let i=0;i<list.length;i++){
      const a = list[i], b = a.nextSibling;
      if (b && b.nodeType === 1 && b.classList.contains('my-hl') && a.dataset.hlId === b.dataset.hlId) {
        while (b.firstChild) a.appendChild(b.firstChild);
        b.remove(); i--;
      }
    }
  }

  // === TextQuoteSelector helpers ===
  function scanTextNodes(root){
    const tw = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
      acceptNode(n){ return n.nodeValue.trim() ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT; }
    });
    let n, full='', nodes=[];
    while((n = tw.nextNode())){
      nodes.push({node:n, start:full.length, end:full.length + n.nodeValue.length});
      full += n.nodeValue;
    }
    return {full, nodes};
  }

  function offsetsToRange(root, start, end, map){
    const rng = document.createRange();

    // start
    let s = null;
    for (const x of map.nodes) if (start >= x.start && start < x.end) { s = x; break; }
    if (!s) {
      for (let i = 0; i < map.nodes.length; i++){
        const x = map.nodes[i];
        if (x.end === start) { s = map.nodes[i+1] || x; break; }
      }
      if (!s) s = map.nodes[map.nodes.length - 1];
    }

    // end (exclusivo)
    let e = null;
    for (const x of map.nodes) if (end > x.start && end <= x.end) { e = x; break; }
    if (!e) {
      for (let i = 0; i < map.nodes.length; i++){
        const x = map.nodes[i];
        if (x.start === end) { e = map.nodes[i-1] || x; break; }
      }
      if (!e) {
        for (let i = map.nodes.length - 1; i >= 0; i--){
          const x = map.nodes[i];
          if (end > x.start) { e = x; break; }
        }
        if (!e) e = map.nodes[0];
      }
    }

    rng.setStart(s.node, Math.min(Math.max(start - s.start, 0), s.node.nodeValue.length));
    rng.setEnd  (e.node, Math.min(Math.max(end   - e.start, 0), e.node.nodeValue.length));
    return rng;
  }

  function normalizeSelectorText(s){
    return (s || '').replace(/\u00A0/g,' ').replace(/[\r\n\u2028\u2029]+/g,'');
  }

  function buildFlat(full){
    const flatChars = [];
    const flat2raw  = [];
    const raw2flat  = new Array(full.length).fill(-1);
    for (let i=0;i<full.length;i++){
      const ch = full[i];
      if (ch === '\r' || ch === '\n' || ch === '\u2028' || ch === '\u2029') continue;
      const out = (ch === '\u00A0') ? ' ' : ch;
      raw2flat[i] = flatChars.length;
      flatChars.push(out);
      flat2raw.push(i);
    }
    return { flat: flatChars.join(''), flat2raw, raw2flat };
  }

  function toGlobalOffset(root, container, offset, map, fromEnd){
    const r = (container && container.nodeType === Node.TEXT_NODE)
      ? { node: container, offset }
      : descendToText(container, offset, root, !!fromEnd);
    const rec = map.nodes.find(x => x.node === r.node);
    if (!rec) return 0;
    return rec.start + Math.max(0, Math.min(r.offset, r.node.nodeValue.length));
  }

  function findQuoteRange(root, sel){
    const map  = scanTextNodes(root);
    const full = map.full;
    const norm = (s) => (s || '').replace(/\u00A0/g,' ').replace(/[\r\n\u2028\u2029]+/g,'');

    if (typeof sel.at === 'number' && sel.at >= 0) {
      const start = Math.max(0, Math.min(sel.at, full.length));
      const rawLen = (typeof sel.len === 'number' && sel.len > 0) ? sel.len : (sel.exact ? sel.exact.length : 0);
      const end = Math.max(start, Math.min(start + rawLen, full.length));
      const sliceNow = norm(full.slice(start, end));
      const needle   = norm(sel.exact || '');
      if (needle && sliceNow === needle) {
        return offsetsToRange(root, start, end, map);
      }
    }

    const needle = norm(sel.exact || '');
    if (!needle) return null;

    const flatChars = [], flat2raw  = [];
    for (let i = 0; i < full.length; i++){
      const ch = full[i];
      if (ch === '\r' || ch === '\n' || ch === '\u2028' || ch === '\u2029') continue;
      flatChars.push(ch === '\u00A0' ? ' ' : ch);
      flat2raw.push(i);
    }
    const flat  = flatChars.join('');
    const preN  = norm(sel.prefix || '');
    const postN = norm(sel.suffix || '');

    const matches = [];
    let from = 0;
    while (true) {
      const idx = flat.indexOf(needle, from);
      if (idx < 0) break;
      const j = idx + needle.length;
      const beforeOK = !preN  || (idx >= preN.length && flat.slice(idx - preN.length, idx) === preN);
      const afterOK  = !postN || (flat.slice(j, j + postN.length) === postN);
      if (beforeOK && afterOK) matches.push(idx);
      from = idx + 1;
    }
    if (matches.length === 0) return null;

    let pick = matches[0];
    if (typeof sel.at === 'number' && sel.at >= 0) {
      let best = null, bestDist = Infinity;
      for (const m of matches) {
        const rawStart = flat2raw[m];
        const dist = Math.abs(rawStart - sel.at);
        if (dist < bestDist) { bestDist = dist; best = m; }
      }
      if (best !== null) pick = best;
    }

    const rawStart = flat2raw[pick];
    const rawEndFlat = pick + needle.length;
    const rawEnd = (rawEndFlat < flat2raw.length) ? flat2raw[rawEndFlat] : full.length;

    return offsetsToRange(root, rawStart, rawEnd, map);
  }

  function quoteFromRange(range){
    const map   = scanTextNodes(BODY());
    const gStart = toGlobalOffset(content, range.startContainer, range.startOffset, map, false);
    const gEnd   = toGlobalOffset(content, range.endContainer,   range.endOffset,   map, true);

    const start  = Math.max(0, Math.min(gStart, gEnd));
    const end    = Math.max(start, gEnd);
    const rawLen = end - start;

    const rawExact  = map.full.slice(start, end);
    const ctx       = 32;
    const rawPrefix = map.full.slice(Math.max(0, start - ctx), start);
    const rawSuffix = map.full.slice(end, Math.min(map.full.length, end + ctx));

    return {
      at:   start,
      len:  rawLen,
      exact:  normalizeSelectorText(rawExact),
      prefix: normalizeSelectorText(rawPrefix),
      suffix: normalizeSelectorText(rawSuffix)
    };
  }

  // hash estable para gid (incluye contentId)
  function makeGID(sel){
    const s = contentId() + '|' + JSON.stringify(sel);
    let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; }
    return 'hl-' + Math.abs(h);
  }

  // === Acciones: aplicar / borrar (DOM + Firestore) ===
  async function persistSave(gid, selector){
    if (!authed()) return;
    const coll = highlightsCollRef(); if (!coll) return;
    try {
      await coll.doc(gid).set({
        selector,
        color: null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });
    } catch(e){ console.error('saveHL', e); }
  }
  async function persistDelete(gid){
    if (!authed()) return;
    const coll = highlightsCollRef(); if (!coll) return;
    try { await coll.doc(gid).delete(); }
    catch(e){ console.error('delHL', e); }
  }

  // helpers de bloque (se mantienen por si los usas en el futuro)
  function isBlock(el){
    if (!el || el.nodeType !== 1) return false;
    const t = el.tagName;
    if (/^(P|DIV|LI|H[1-6]|SECTION|ARTICLE|DD|DT)$/.test(t)) return true;
    const cs = getComputedStyle(el);
    return cs.display === 'block' || cs.display === 'list-item';
  }

  // ⭐️ Aplica highlight a la selección ACTUAL (ahora sin “clamp” a un solo bloque)
  function highlightSelection(){
    const s = window.getSelection();
    if (!s || s.rangeCount === 0 || s.isCollapsed || !isInside(s.anchorNode)) { hidePopover(); return; }
    if (selectionIntersectsForbidden()) { hidePopover(); return; }

    const range = s.getRangeAt(0).cloneRange(); // ← rango tal cual, puede cruzar líneas/bloques

    // 1) Construir selector con at/len exactos (multibloque OK)
    const sel = quoteFromRange(range);
    if (!sel.exact.trim()) { hidePopover(); return; }
    const gid = makeGID(sel);

    // 2) Normalizar y envolver
    const { startText, endText } = normalizeRangeToText(range, content);
    if (!startText || !endText || startText.nodeType !== 3 || endText.nodeType !== 3) { hidePopover(); return; }
    const texts = collectTextsBetween(content, startText, endText);
    texts.forEach(n => wrapTextNode(n, gid));

    // limpiar selección, fusionar y persistir
    s.removeAllRanges();
    const after = document.createRange();
    after.setStartAfter(endText);
    after.collapse(true);
    s.addRange(after);

    mergeAdjacent(content);
    hidePopover();
    persistSave(gid, sel);
  }

  async function clearHighlight(){
    const target = (hoverHL && content.contains(hoverHL))
                ? hoverHL
                : (lastHoverHL && content.contains(lastHoverHL) ? lastHoverHL : null);

    const removeGroup = async (gid) => {
      const all = content.querySelectorAll(`.my-hl[data-hl-id="${gid}"]`);
      all.forEach(el => {
        const p = el.parentNode;
        while (el.firstChild) p.insertBefore(el.firstChild, el);
        el.remove();
        p.normalize();
      });
      await persistDelete(gid);
    };

    if (target) {
      const gid = target.dataset.hlId || null;
      if (gid) { await removeGroup(gid); }
      else {
        const p  = target.parentNode;
        while (target.firstChild) p.insertBefore(target.firstChild, target);
        target.remove(); p.normalize();
      }
      hoverHL = null; lastHoverHL = null; hidePopover(); return;
    }

    const s = window.getSelection();
    const r = s && s.rangeCount ? s.getRangeAt(0) : null;
    if (!content) return hidePopover();

    let targets = [];
    if (r) targets = Array.from(content.querySelectorAll('.my-hl')).filter(n => r.intersectsNode(n));
    if (targets.length === 0 && s && s.anchorNode) {
      const near = (s.anchorNode.nodeType === 1 ? s.anchorNode : s.anchorNode.parentElement)?.closest('.my-hl');
      if (near) targets = [near];
    }

    const groupSet = new Set(targets.map(n => n.dataset.hlId).filter(Boolean));
    if (groupSet.size === 1) {
      const gid = [...groupSet][0];
      await removeGroup(gid);
    } else {
      targets.forEach(el => {
        const p = el.parentNode;
        while (el.firstChild) p.insertBefore(el.firstChild, el);
        el.remove();
        p.normalize();
      });
    }
    hidePopover();
  }

  // === Rehidratación desde Firestore (nuevo árbol) ===
  async function restoreAll(){
    if (!authed() || !STATE.sup) return;
    try {
      const coll = highlightsCollRef(); if (!coll) return;

      const snap = await coll.get();
      snap.forEach(doc => {
        const { selector, color } = doc.data() || {};
        const rng = findQuoteRange(BODY(), selector);
        if (!rng) return;
        const { startText, endText } = normalizeRangeToText(rng, content);
        const texts = collectTextsBetween(content, startText, endText);
        texts.forEach(n => wrapTextNode(n, doc.id));
        if (color) {
          content.querySelectorAll(`.my-hl[data-hl-id="${doc.id}"]`)
                 .forEach(el => el.style.background = color);
        }
      });
      mergeAdjacent(content);
    } catch(e){ console.error('restoreHL', e); }
  }

  // === Bind del popover a acciones ===
  applyBtn.addEventListener('click', highlightSelection);
  clearBtn.addEventListener('click', clearHighlight);

  // === Hook al render de subcategoría ===
  window.addEventListener('subcat:rendered', (ev) => {
    STATE.sup = ev.detail.sup;
    STATE.cat = ev.detail.cat;
    STATE.sub = ev.detail.sub;
    hidePopover();
    restoreAll();
  });

  // Hover para mostrar popover
  content?.addEventListener('mousemove', (e) => {
    const s = window.getSelection();
    if (s && s.rangeCount && !s.isCollapsed) return;
    const targetHL = (e.target.closest && e.target.closest('.my-hl')) || null;
    if (targetHL) {
      hoverHL = targetHL;
      lastHoverHL = targetHL;
      clearTimeout(hideTO);
      showPopover();
    } else {
      hoverHL = null;
      clearTimeout(hideTO);
      hideTO = setTimeout(() => { if (!popHovered) hidePopover(); }, 220);
    }
  }, { passive:true });

})();
</script>




<!-- === Resultados + preguntas reales por keywords (con fallback texto) === -->

<script>
function prettifyAmbossBlob(src = '', UNESC_FN = null, opts = {}) {
  let t = (UNESC_FN ? UNESC_FN(src) : String(src || '')).trim();

  // 1) Títulos → bullets
  t = t.replace(/\*\*([A-Z][A-Za-z0-9 ]{1,60}?)\*\*\s*-\s*/g, (_m, h) => `\n\n### ${h}\n\n- `);
  // 2) " - " → bullets
  t = t.replace(/\s-\s/g, '\n- ');
  // 3) Limpieza de saltos
  t = t.replace(/\n{3,}/g, '\n\n');

  // 4) (Opcional) quita *cualquier* palabra suelta al final (no solo “vancomicina”)
  if (opts.stripTailSingleWord) {
    const lines = t.split('\n');
    const last  = (lines[lines.length - 1] || '').trim();
    // solo si la última línea es una palabra sin espacios, de 3–20 chars
    if (/^-?\s*[^\s]{3,20}$/u.test(last)) lines.pop();
    t = lines.join('\n');
  }
  return t;
}
</script>



<script>
// --- Markdown renderer exclusivo para "Articles" (sin dependencias) ---



function renderMD_ART(md = '') {
  if (!md) return '';

  // 0) mini "unescape" para normalizar comillas y símbolos comunes
  const UNESC = (s) => String(s ?? '')
    .replace(/&quot;|&#34;/g, '"')
    .replace(/&apos;|&#39;/g, "'")
    .replace(/&lt;/g, '<')
    .replace(/&gt;/g, '>')
    .replace(/&amp;/g, '&');

  // 1) escape seguro (SIN convertir comillas)
  const ESC = (typeof window.__escHTML === 'function')
    ? window.__escHTML
    : (s) => String(s ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

        md = prettifyAmbossBlob(md, UNESC);

  const inline = (s) => {
    // a) des-escapa lo que venga como entidad y b) vuelve a escapar <,>,&
    s = ESC(UNESC(s));

    // <mark>…</mark> → resaltado celeste (acepta tanto &lt;mark&gt; como <mark>)
    s = s
      .replace(/&lt;mark&gt;|<mark>/g,
        '<mark style="background:#dbeafe;color:#0c4a6e;padding:0 .2em;border-radius:.2em;">')
      .replace(/&lt;\/mark&gt;|<\/mark>/g, '</mark>');

    // links [texto](url)
    s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g,
      (_m, txt, href) => `<a href="${ESC(UNESC(href))}" target="_blank" rel="noopener noreferrer">${ESC(UNESC(txt))}</a>`
    );

    // **negrita**
    s = s.replace(/(\*\*|__)(.+?)\1/g, '<strong>$2</strong>');
    // *cursiva*
    s = s.replace(/(\*|_)([^*_][\s\S]*?)\1/g, '<em>$2</em>');

    return s;
  };

  const lines = String(md).replace(/\r\n?/g, '\n').split('\n');
  let html = '', inP = false, inUL = false, inOL = false;

  const flushP     = () => { if (inP) { html += '</p>'; inP = false; } };
  const closeLists = () => { if (inUL) { html += '</ul>'; inUL = false; } if (inOL) { html += '</ol>'; inOL = false; } };

  for (let raw of lines) {
    const line = raw, t = line.trim();
    if (!t) { flushP(); closeLists(); continue; }

    const mH = t.match(/^(#{1,6})\s+(.*)$/);
if (mH) {
  flushP(); 
  closeLists();
  const lvl = mH[1].length;
  // heading legible aun si el contenedor tiene text-xs
html += `<h${lvl} class="mt-1 mb-0.5 font-semibold text-[9px] md:text-[9px] leading-tight text-slate-700">${inline(mH[2])}</h${lvl}>`;
  continue;
}

if (/^[-*]\s+/.test(t)) {
  flushP();
  if (!inUL) {
    closeLists();
    html += '<ul class="list-disc list-outside pl-5 space-y-1">';
    inUL = true;
  }
  html += `<li class="ml-1">${inline(t.replace(/^[-*]\s+/, ''))}</li>`;
  continue;
}
if (/^\d+\.\s+/.test(t)) {
  flushP();
  if (!inOL) {
    closeLists();
    html += '<ol class="list-decimal list-outside pl-5 space-y-1">';
    inOL = true;
  }
  html += `<li class="ml-1">${inline(t.replace(/^\d+\.\s+/, ''))}</li>`;
  continue;
}
    if (!inP) { html += `<p>${inline(line)}`; inP = true; } else { html += `<br>${inline(line)}`; }
  }

  flushP(); closeLists();
  return html;
}


// --- Empty state (imagen + textos) ---
const EMPTY_IMG = './assets/noresultfound.png';
function renderEmptyState(kind = 'results') {
  const label =
    kind === 'articles'   ? 'article'
  : kind === 'drugs'      ? 'drug'
  : kind === 'media'      ? 'media'
  : kind === 'guidelines' ? 'guideline'
  : 'result';

  return `
    <div class="mt-10 grid place-items-center text-center select-none">
      <img src="${EMPTY_IMG}" alt="No ${label} results"
           class="w-40 h-40 object-contain opacity-80 pointer-events-none" />
      <div class="mt-3 text-slate-800 font-medium">No ${label} results found.</div>
      <div class="text-slate-500 text-sm">Please try with another search query.</div>
    </div>
  `;
}


</script>





<!-- === Preguntas === -->


<script>
  /* ------------ Firestore ready ------------- */
  try { if (!window.db && firebase?.firestore) window.db = firebase.firestore(); }
  catch(e){ console.warn('Firestore no disponible:', e); }

  /* ------------ Utils ------------- */
  function normalize(str){
    return (str||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  }
  function termsFromQuery(q){
    return Array.from(new Set(
      normalize(q||'').split(/[\s,.;:]+/).filter(Boolean)
    )).slice(0,10); // <= 10 para array-contains-any
  }
  function fmtDate(d){
    try{ if(!d) return ''; const x = d.toDate? d.toDate(): (d instanceof Date? d: new Date(d));
      return `${String(x.getDate()).padStart(2,'0')}.${String(x.getMonth()+1).padStart(2,'0')}.${x.getFullYear()}`;
    }catch{return String(d)}
  }

  /* ------------ Colecciones “planas” (articles/guidelines/…) ------------- */
  const COLLECTIONS = { articles:'articles', guidelines:'guidelines', drugs:'drugs', media:'media' };
  function pickFields(d={}){
    return {
      title: d.title || d.nombre || d.titulo || d.name || '(sin título)',
      meta:  d.meta  || d.subtitle || d.resumen || d.descripcion || '',
      url:   d.url   || d.link || d.href || d.permalink || '#',
      date:  fmtDate(d.date || d.fecha || d.publishedAt || d.updatedAt || '')
    };
  }
  function buildTextMatcher(query){
    const ts = termsFromQuery(query);
    if(!ts.length) return ()=>true;
    return (txt)=>{ const t = normalize(txt||''); return ts.every(k=>t.includes(k)); };
  }
  async function searchCollection(coll, query, limit=40){
    if(!window.db) return [];
    const snap = await db.collection(coll).limit(limit).get();
    const out=[]; const match = buildTextMatcher(query);
    snap.forEach(doc=>{
      const r = doc.data()||{};
      const hay = [
        r.title,r.titulo,r.nombre,r.name,
        r.meta,r.descripcion,r.resumen,r.body,r.content,r.texto,
        Array.isArray(r.keywords)? r.keywords.join(' '):'', Array.isArray(r.tags)? r.tags.join(' '):''
      ].filter(Boolean).join(' ');
      if(match(hay)) out.push(pickFields(r));
    });
    return out;
  }

  /* ------------ PREGUNTAS (collection group) ------------- */
  function pickQuestionText(d={}){
    return d.pregunta || d.titulo || d.enunciado || d.texto || d.explicacion || '';
  }

  // 1) por KEYWORDS exactos (normalizados)
  async function cgQuestionsByKeywords(query, limit=12){
    if(!window.db) return [];
    const terms = termsFromQuery(query);
    if(!terms.length) return [];
        let snap;
    try {
      snap = await db.collectionGroup('preguntas')
        .where('keywords','array-contains-any', terms)
        .limit(limit)
        .get();
    } catch (err) {
      // Si falta el índice (failed-precondition / create_exemption), no rompas la UI
      const msg = String(err && (err.code || err.message || err));
      if (msg.includes('failed-precondition') || msg.includes('create_exemption')) {
        console.warn('[cgQuestionsByKeywords] Falta índice; usando fallback por texto.', err);
        return [];
      }
      throw err; // otros errores sí se propagan
    }



    const out=[];
    snap.forEach(doc=>{
      const d = doc.data()||{};
      const text = String(pickQuestionText(d)).trim();
      if(text) out.push({ text, path: doc.ref.path, score: 2 }); // score alto por keyword
    });
    console.log('[cgQuestionsByKeywords] terms:', terms, 'hits:', out.length);
    return out;
  }

  // 2) fallback: *texto* cliente sobre campos de la pregunta
  async function cgQuestionsByText(query, limit=12){
    if(!window.db) return [];
    const match = buildTextMatcher(query);
    const snap  = await db.collectionGroup('preguntas').limit(50).get(); // lee un batch
    const out=[];
    snap.forEach(doc=>{
      const d = doc.data()||{};
      const blob = [
        pickQuestionText(d),
        Array.isArray(d.opciones)? d.opciones.join(' '):'',
        Array.isArray(d.keywords)? d.keywords.join(' '):''
      ].join(' ');
      if(match(blob)){
        const text = String(pickQuestionText(d)).trim();
        if(text) out.push({ text, path: doc.ref.path, score: 1 });
      }
    });
    console.log('[cgQuestionsByText] hits:', out.length);
    return out.slice(0, limit);
  }

  async function getRelatedQuestions(query){
    // primero keywords…
    let qs = await cgQuestionsByKeywords(query, 12);
    // …si no alcanza, mezclamos fallback por texto
    if(qs.length < 3){
      const fb = await cgQuestionsByText(query, 12);
      // evita duplicados por texto
      const seen = new Set(qs.map(q=>q.path));
      fb.forEach(q=>{ if(!seen.has(q.path)) qs.push(q); });
    }
    // ordena por score (keywords primero)
    qs.sort((a,b)=>b.score-a.score);
    return qs.map(q=>q.text);
  }


  






  /* ------------ UI de resultados ------------- */
// 1) Vista principal con contenedor dinámico
const resultsView = (data) => `

  <div>
    <div class="tabsbar tabsbar--xs" id="tabsbar">
      <button class="tab-btn is-active" data-tab="overview"><span>Overview</span></button>
      <button class="tab-btn" data-tab="articles"><i class="fa-regular fa-file-lines"></i><span>Articles <span class="count">(${data.counts.articles})</span></span></button>
      <button class="tab-btn" data-tab="drugs"><i class="fa-solid fa-capsules"></i><span>Drugs <span class="count">(${data.counts.drugs})</span></span></button>
      <button class="tab-btn" data-tab="media"><i class="fa-regular fa-image"></i><span>Media <span class="count">(${data.counts.media})</span></span></button>
      <button class="tab-btn" data-tab="guidelines"><i class="fa-solid fa-layer-group"></i><span>Guidelines <span class="count">(${data.counts.guidelines})</span></span></button>
      <span class="tabs-ink"></span>
    </div>

    <!-- Contenido dinámico -->
    <div id="tab-content">
      ${renderOverview(data)}
    </div>
  </div>
`;


    // --- renderizadores por bloque (reusables) ---
function renderArticlesBlock(data){
  if (!data.articles?.length) return `<p class="mt-2 text-sm text-gray-600">No results.</p>`;
  return `
    ${
      data.articles.map(a=>{
        const isSub = a.__kind === 'subtema';
        const pill = isSub
          ? `<span class="ml-2 text-[10px] px-2 py-0.5 rounded-full bg-sky-100 text-sky-700">
               ${__escHTML(a.__cat || a.__sup || 'Subtopic')}
             </span>`
          : '';

        const titleEl = isSub
          ? `<a href="#"
               class="text-sky-600 no-underline hover:underline hover:decoration-solid underline-offset-2 focus-visible:underline"
               data-result="subcat"
               data-sup="${__escHTML(a.__sup||'')}"
               data-cat="${__escHTML(a.__cat||'')}"
               data-sub="${__escHTML(a.__sub||'')}">${__escHTML(a.title)}</a>`
          : `<a href="${a.url||'#'}" class="text-sky-600 no-underline hover:underline hover:decoration-solid underline-offset-2 focus-visible:underline">${__escHTML(a.title)}</a>`;

        const body = isSub
          ? (a.__hits?.length
              ? `<ul class="mt-2 space-y-2 list-disc pl-5">
                  ${a.__hits.map(h => `
                    <li>
                      <button type="button"
                        class="text-xs text-gray-500 hover:text-sky-700 no-underline hover:underline hover:decoration-solid"
                        data-result="subcat-hit"
                        data-sup="${__escHTML(a.__sup||'')}"
                        data-cat="${__escHTML(a.__cat||'')}"
                        data-sub="${__escHTML(a.__sub||'')}"
                        data-subheading="${__escHTML(h.subheading||'')}"
                        title="Ver en subtema">
                        <span class="font-medium">${__escHTML(h.subheading)}</span>
                      </button>
                      <blockquote class="mt-1 text-xs text-gray-700 border-l-2 border-gray-200 pl-3">
                        ${renderMD_ART(h.snippetHTML)}
                      </blockquote>
                    </li>`).join('')}
                </ul>`
              : (a.meta ? `<div class="mt-2 text-sm text-gray-700 max-w-none">${renderMD_ART(a.meta)}</div>` : '')
            )
          : (a.meta ? `<div class="mt-1 text-sm text-gray-700 max-w-none">${renderMD_ART(a.meta)}</div>` : '');

        return `<article class="mt-3">${titleEl}${pill}${body}</article>`;
      }).join('')
    }`;
}

/* === Questions (igual que tenías) === */
function renderQuestionsBlock(data){
  return `
  <div class="mt-5 group">
    <div class="border-t border-b border-slate-200">
      <div class="flex items-center justify-between py-2">
        <h4 class="font-semibold text-slate-600 text-sm">Questions related to your search</h4>
        <label class="inline-flex items-center cursor-pointer">
          <input type="checkbox" id="toggle-qs" class="sr-only peer" checked>
          <span class="w-9 h-5 bg-gray-200 rounded-full peer-checked:bg-sky-500 relative after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:w-4 after:h-4 after:bg-white after:rounded-full after:transition-all peer-checked:after:translate-x-4"></span>
        </label>
      </div>
    </div>
    <div class="mt-2 hidden group-has-[input:checked]:block">
      <div id="qs-list" class="divide-y divide-slate-200">
        ${data.suggestions.length
          ? data.suggestions.slice(0,3).map((q, idx)=>`
              <details class="group" data-bookmark-key="qs:${idx}" data-bookmarked="false">
                <summary class="flex items-center justify-between cursor-pointer list-none py-2 pl-0">
                  <span class="text-slate-700 text-sm">${q}</span>
                  <span class="toggle-icons">
                    ${bookmarkToggleMarkup(q)}
                    <i class="fa-solid fa-chevron-down text-slate-400 text-xs transition-transform group-open:rotate-180"></i>
                  </span>
                </summary>
              </details>`).join('')
          : `<div class="p-2 text-xs text-gray-600">No matching questions.</div>`}
      </div>
      ${data.suggestions.length>3?`
        <div class="border-t border-slate-200 pt-2">
          <div class="flex items-center gap-3">
            <button id="qs-more" class="ml-2 font-semibold text-[7px] uppercase tracking-wide text-slate-600 hover:text-slate-800 flex items-center gap-1">
              More <i class="fa-solid fa-chevron-down text-[9px]"></i>
            </button>
            <button id="qs-less" class="font-semibold text-[7px] uppercase tracking-wide text-slate-600 hover:text-slate-800 flex items-center gap-1 hidden">
              Less <i class="fa-solid fa-chevron-up text-[9px]"></i>
            </button>
          </div>
        </div>`:''}
    </div>
  </div>`;
}

/* === Media === */
/* === Media === */
function renderMediaBlock(data, showSeeAll = true){
  if (!data.media?.length) return renderEmptyState('media');
  return `
  <h3 class="font-semibold flex items-center gap-2">
    <i class="fa-regular fa-image text-slate-400"></i>
    Media (${data.counts.media})
  </h3>
  <div class="flex gap-4 mb-3 mt-2 flex-wrap items-center">
    ${['Photos','Illustrations','Functional diag.'].map(lbl=>{
      const key = lbl==='Photos' ? 'photo'
                 : lbl==='Illustrations' ? 'illustration' : 'functional';
      const n = data.media.filter(m =>
        String(m.kind||m.type||'').toLowerCase().includes(key)
      ).length;
      return `
        <button
          class="inline-flex items-center gap-1.5 h-8 px-3 rounded-full
                 bg-white text-slate-700 text-[10px] font-medium
                 border border-slate-300/70
                 shadow-[0_1px_1px_rgba(15,23,42,.05),inset_0_1px_0_rgba(255,255,255,.9)]
                 hover:border-sky-300 hover:text-sky-700 transition"
          type="button">
          <span>${lbl}</span>
          <span class="text-slate-500">(${n})</span>
        </button>
      `;
    }).join('')}
  </div>
  <div class="overflow-x-auto">
    <div class="flex gap-3 pb-2 media-gallery" data-gallery="results-media">
      ${data.media.slice(0,8).map(m=>`
        <article class="w-[85px]">
          <figure
  class="media-thumb image-thumb block w-[85px] h-[85px] cursor-pointer
         bg-transparent shadow-none focus:outline-none focus:ring-0"
  data-img-url="${__escHTML(m.url || m.thumb || '')}"
  data-img-desc="${__escHTML(m.title || '(untitled)')}"
  title="Open preview"
>
  ${m.thumb || m.url
    ? `<img src="${__escHTML(m.thumb || m.url)}"
             alt="${__escHTML(m.title || '')}"
             class="w-[85px] h-[85px] object-cover rounded-lg">`
    : `<div class="w-[85px] h-[85px] grid place-items-center text-[8px] text-slate-500 rounded-lg bg-slate-100">
         ${__escHTML((m.kind||m.type||'MEDIA'))}
       </div>`
  }
</figure>
          <div class="mt-1 flex items-center gap-1 uppercase text-[8px] tracking-wide text-slate-600 truncate">
            <i class="fa-regular fa-image text-slate-400 text-[10px]"></i>
            ${__escHTML(String(m.kind||m.type||'').toUpperCase())}
          </div>
          <div class="text-slate-800 line-clamp-2 text-[9px] leading-tight">
            ${__escHTML(m.title||'(untitled)')}
          </div>
        </article>`).join('')}
    </div>
  </div>
  ${showSeeAll ? `
    <a class="inline-flex items-center gap-1 text-sky-600 text-sm mt-2 hover:underline" href="#" data-see-all="media">
      See all Media results (${data.counts.media})
      <i class="fa-solid fa-chevron-right text-xs"></i>
    </a>` : ``}
  `;
}

// Ir a la pestaña "Media" desde el link "See all Media results"
document.addEventListener('click', (e) => {
  const link = e.target.closest('a[data-see-all="media"]');
  if (!link) return;
  e.preventDefault();

  // Si ya tenés handler de tabs, delega con click:
  const tabBtn = document.querySelector('.tabsbar .tab-btn[data-tab="media"]');
  if (tabBtn) { tabBtn.click(); return; }

  // Fallback: activar manualmente si no existe el handler de tabs
  const content = document.getElementById('tab-content');
  document.querySelectorAll('.tabsbar .tab-btn')
    .forEach(b => b.classList.toggle('is-active', b.dataset.tab === 'media'));
  content.innerHTML = renderMediaBlock(window.__searchData || window.__lastResults || {}, false);
});


/* === Guidelines === */
function renderGuidelinesBlock(data){
  if (!data.guidelines?.length) return renderEmptyState('guidelines');
  return `
    <h3 class="font-semibold">Guidelines (${data.counts.guidelines})</h3>
    ${
      data.guidelines.map(g=>`
        <article class="mt-3">
          <a href="${g.url||'#'}" class="text-sky-600 hover:underline">${g.title}</a>
          ${g.date?`<div class="text-sm text-gray-500 mt-1">Published: ${g.date}</div>`:''}
        </article>`
      ).join('')
    }
  `;
}

/* === Drugs === */
function renderDrugsBlock(data){
  if (!data.drugs?.length) return renderEmptyState('drugs');
  return `
    <h3 class="font-semibold">Drugs (${data.counts.drugs})</h3>
    ${data.drugs.map(d=>`
      <article class="mt-3">
        <a href="${d.url||'#'}" class="text-sky-600 hover:underline">${__escHTML(d.title)}</a>
        ${d.meta?`<div class="mt-1 text-sm text-gray-700">${renderMD_ART(d.meta)}</div>`:''}
      </article>
    `).join('')}
  `;
}

// --- Overview = combinación tal cual tienes
// 2) OVERVIEW con TODO lo que tenías (Articles + Questions + Media + Guidelines)
function renderOverview(data){
  return `
   <section class="mt-6">
   <h3 class="font-semibold flex items-center gap-2">
  <i class="fa-regular fa-file-lines text-slate-400"></i>
  Articles (${data.counts.articles})
</h3>
    ${data.articles.length
      ? data.articles.map(a=>{
          const isSub = a.__kind === 'subtema';
          const pill = isSub
            ? `<span class="ml-2 text-[10px] px-2 py-0.5 rounded-full bg-sky-100 text-sky-700">
                 ${__escHTML(a.__cat || a.__sup || 'Subtopic')}
               </span>`
            : '';

          const titleEl = isSub
            ? `<a href="#"
                 class="text-sky-600 no-underline hover:underline hover:decoration-solid underline-offset-2 focus-visible:underline"
                 data-result="subcat"
                 data-sup="${__escHTML(a.__sup||'')}"
                 data-cat="${__escHTML(a.__cat||'')}"
                 data-sub="${__escHTML(a.__sub||'')}">${__escHTML(a.title)}</a>`
            : `<a href="${a.url||'#'}" class="text-sky-600 no-underline hover:underline hover:decoration-solid underline-offset-2 focus-visible:underline">${__escHTML(a.title)}</a>`;

          const body  = isSub
            ? (a.__hits && a.__hits.length
                ? `
                  <ul class="mt-2 space-y-2 list-disc pl-5">
                    ${a.__hits.map(h => `
                      <li>
                        <button
                          type="button"
                          class="text-xs text-gray-500 hover:text-sky-700 no-underline hover:underline hover:decoration-solid"
                          data-result="subcat-hit"
                          data-sup="${__escHTML(a.__sup||'')}"
                          data-cat="${__escHTML(a.__cat||'')}"
                          data-sub="${__escHTML(a.__sub||'')}"
                          data-subheading="${__escHTML(h.subheading||'')}"
                          title="Ver en subtema"
                        >
                          <span class="font-medium">${__escHTML(h.subheading)}</span>
                        </button>
                        <blockquote class="mt-1 text-xs text-gray-700 border-l-2 border-gray-200 pl-3">
                          ${renderMD_ART(h.snippetHTML)}
                        </blockquote>
                      </li>
                    `).join('')}
                  </ul>`
                : (a.meta?`<div class="mt-2 text-sm text-gray-700 max-w-none">${renderMD_ART(a.meta)}</div>`:'')
              )
            : (a.meta?`<div class="mt-1 text-sm text-gray-700 max-w-none">${renderMD_ART(a.meta)}</div>`:'');

          return `
            <article class="mt-3">
              ${titleEl}${pill}
              ${body}
            </article>`;
        }).join('')
      : `<p class="mt-2 text-sm text-gray-600">No results.</p>`
    }

    <div class="mt-5 group">
      <!-- header -->
      <div class="border-t border-b border-slate-200">
        <div class="flex items-center justify-between py-2">
          <h4 class="font-semibold text-slate-600 text-sm">
            Questions related to your search
          </h4>
          <label class="inline-flex items-center cursor-pointer">
            <input type="checkbox" id="toggle-qs" class="sr-only peer" checked>
            <span class="w-9 h-5 bg-gray-200 rounded-full peer-checked:bg-sky-500 relative after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:w-4 after:h-4 after:bg-white after:rounded-full after:transition-all peer-checked:after:translate-x-4"></span>
          </label>
        </div>
      </div>

      <!-- bloque que se oculta todo junto -->
      <div class="mt-2 hidden group-has-[input:checked]:block">
        <div id="qs-list" class="divide-y divide-slate-200">
          ${data.suggestions.length
            ? data.suggestions.slice(0,3).map((q, idx)=>`
                <details class="group" data-bookmark-key="qs:${idx}" data-bookmarked="false">
                  <summary class="flex items-center justify-between cursor-pointer list-none py-2 pl-0">
                    <span class="text-slate-700 text-sm">${q}</span>
                    <span class="toggle-icons">
                      ${bookmarkToggleMarkup(q)}
                      <i class="fa-solid fa-chevron-down text-slate-400 text-xs transition-transform group-open:rotate-180"></i>
                    </span>
                  </summary>
                </details>`).join('')
            : `<div class="p-2 text-xs text-gray-600">No matching questions.</div>`}
        </div>

        ${data.suggestions.length > 3 ? `
        <div class="border-t border-slate-200 pt-2">
          <div class="flex items-center gap-3">
            <button id="qs-more" class="ml-2 font-semibold text-[7px] uppercase tracking-wide text-slate-600 hover:text-slate-800 flex items-center gap-1">
              More <i class="fa-solid fa-chevron-down text-[9px]"></i>
            </button>
            <button id="qs-less" class="font-semibold text-[7px] uppercase tracking-wide text-slate-600 hover:text-slate-800 flex items-center gap-1 hidden">
              Less <i class="fa-solid fa-chevron-up text-[9px]"></i>
            </button>
          </div>
        </div>`:''}
      </div>
    </div>
   </section>

   <!-- ===== Media (debajo de Questions) ===== -->
   <section class="mt-8">
    <h3 class="font-semibold flex items-center gap-2">
  <i class="fa-regular fa-image text-slate-400"></i>
  Media (${data.counts.media})
</h3>

${data.media && data.media.length ? `
  <div class="flex gap-4 mb-3 mt-2 flex-wrap items-center">
    ${['Photos','Illustrations','Functional diag.'].map(lbl=>{
      const key = lbl==='Photos' ? 'photo'
                 : lbl==='Illustrations' ? 'illustration' : 'functional';
      const n = data.media.filter(m =>
        String(m.kind||m.type||'').toLowerCase().includes(key)
      ).length;

      return `
        <button
          class="inline-flex items-center gap-1.5 h-8 px-3 rounded-full
                 bg-white text-slate-700 text-[10px] font-medium
                 border border-slate-300/70
                 shadow-[0_1px_1px_rgba(15,23,42,.05),inset_0_1px_0_rgba(255,255,255,.9)]
                 hover:border-sky-300 hover:text-sky-700 transition"
          type="button">
          <span>${lbl}</span>
          <span class="text-slate-500">(${n})</span>
        </button>
      `;
    }).join('')}
  </div>

      <div class="overflow-x-auto">
        <div class="flex gap-3 pb-2 media-gallery" data-gallery="results-media">
          ${data.media.slice(0,8).map(m=>`
            <article class="w-[85px]">
             <figure
  class="media-thumb image-thumb block w-[85px] h-[85px] cursor-pointer
         bg-transparent shadow-none focus:outline-none focus:ring-0"
  data-img-url="${__escHTML(m.url || m.thumb || '')}"
  data-img-desc="${__escHTML(m.title || '(untitled)')}"
  title="Open preview"
>
  ${m.thumb || m.url
    ? `<img src="${__escHTML(m.thumb || m.url)}"
             alt="${__escHTML(m.title || '')}"
             class="w-[85px] h-[85px] object-cover rounded-lg">`
    : `<div class="w-[85px] h-[85px] grid place-items-center text-[8px] text-slate-500 rounded-lg bg-slate-100">
         ${__escHTML((m.kind||m.type||'MEDIA'))}
       </div>`
  }
</figure>
              <div class="mt-0.2 flex items-center gap-1 uppercase text-[8px] tracking-wide text-slate-600 truncate">
  <i class="fa-regular fa-image text-slate-400 text-[10px]"></i>
  ${__escHTML(String(m.kind||m.type||'').toUpperCase())}
</div>
<div class="mt-0.5 text-slate-800 line-clamp-2 text-[9px] leading-tight">
  ${__escHTML(m.title||'(untitled)')}
</div>
            </article>
          `).join('')}
        </div>
      </div>

      <a class="inline-flex items-center gap-1 text-sky-600 text-sm mt-2 hover:underline"
        href="#" data-see-all="media">
        See all Media results (${data.counts.media})
        <i class="fa-solid fa-chevron-right text-xs"></i>
      </a>
    ` : `<p class="mt-2 text-sm text-gray-600">No results.</p>`}
   </section>

   <section class="mt-8">
    <h3 class="font-semibold flex items-center gap-2">
  <i class="fa-solid fa-layer-group text-slate-400"></i>
  Guidelines (${data.counts.guidelines})
</h3>
    ${data.guidelines.length
      ? data.guidelines.map(g=>`
          <article class="mt-3">
            <a href="${g.url||'#'}" class="text-sky-600 hover:underline">${g.title}</a>
            ${g.date?`<div class="text-sm text-gray-500 mt-1">Published: ${g.date}</div>`:''}
          </article>`).join('')
      : `<p class="mt-2 text-sm text-gray-600">No results.</p>`}
   </section>
  `;
}





    // --- SUBTEMAS (collection group: subcategorias) -----------------

function pickSubtemaFields(doc, query){
  const d = doc.data() || {};
  const hits = findHitsInSubtemaData(d, query);

  // Ruta: supracategorias/{SUP}/categorias/{CAT}/subcategorias/{SUB}
  const subId = doc.id;
  const catDoc = doc.ref.parent?.parent || null;
  const supDoc = catDoc?.parent?.parent || null;

  const catId = catDoc ? catDoc.id : '';
  const supId = supDoc ? supDoc.id : '';

  return {
    title: d.nombre || d.denomination || d.title || '(sin título)',
    meta:  d.descripcion || d.descripciongeneral || '',
    url:   `/subcategoria.html?path=${encodeURIComponent(doc.ref.path)}`,
    date:  '',
    __kind: 'subtema',
    __hits: hits,
    __sup: supId,           // 👈 NUEVO
    __cat: catId,           // 👈 NUEVO
    __sub: subId            // 👈 NUEVO
  };
}

// 1) por KEYWORDS (rápido si hay índice)
async function searchSubtemasByKeywords(query, limit=30){
  if(!window.db) return [];
  const terms = termsFromQuery(query);
  if(!terms.length) return [];
  try{
    const snap = await db.collectionGroup('subcategorias')
      .where('keywords','array-contains-any', terms)
      .limit(limit)
      .get();
    const out = [];
    snap.forEach(doc => out.push(pickSubtemaFields(doc, query))); // <-- aquí
    return out;
  }catch(err){
    // si falta índice, devolvemos vacío para que tome el fallback
    const msg = String(err && (err.code || err.message || err));
    if (msg.includes('failed-precondition') || msg.includes('create_exemption')){
      console.warn('[searchSubtemasByKeywords] Falta índice; usando fallback texto.', err);
      return [];
    }
    throw err;
  }
}

// 2) Fallback por texto (cliente)

async function searchSubtemasByText(query, limit=30){
  if(!window.db) return [];
  const match = buildTextMatcher(query);
  const snap  = await db.collectionGroup('subcategorias').limit(120).get();
  const out=[];
  snap.forEach(doc=>{
    const d = doc.data()||{};
    const blob = [
      d.nombre, d.denomination, d.descripcion,
      Array.isArray(d.keywords)? d.keywords.join(' '):''
    ].filter(Boolean).join(' ');
    if (match(blob)) out.push(pickSubtemaFields(doc, query)); // <-- aquí
  });
  return out.slice(0, limit);
}

// Orquestador de subtemas
async function searchSubtemas(query){
  let items = await searchSubtemasByKeywords(query, 30);
  if(items.length < 5){
    const fb = await searchSubtemasByText(query, 30);
    // evitar duplicados por título+url
    const seen = new Set(items.map(i=>i.title+'|'+i.url));
    fb.forEach(i=>{ const k=i.title+'|'+i.url; if(!seen.has(k)) items.push(i); });
  }
  return items;
}




// === Helpers para hallar fragmentos dentro de un subtema ===



// === Helpers multi-hit (reemplaza los anteriores findHit..., _makeSnippet, etc.) ===
function _escapeRe(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

// ¿Es parte de “palabra”? (letras con tildes, marcas, números y guion bajo)
function _isWordChar(ch){ return /\p{L}|\p{M}|\p{N}|_/u.test(ch); }

// Expande [start,end) hasta cubrir la palabra entera
function _expandToWord(text, start, end){
  let i = start, j = end;
  while (i > 0 && _isWordChar(text[i-1])) i--;
  while (j < text.length && _isWordChar(text[j])) j++;
  return [i, j];
}

/** Snippet: marca por caracteres, expande a palabra completa y recorta por palabras */
// Marca todas las coincidencias expandiéndolas a la PALABRA completa
function _markAllWholeWord(text, terms = []) {
  const uniq = Array.from(new Set((terms || []).filter(Boolean)));
  if (!uniq.length || !text) return text;

  // 1) recolectar rangos [start,end) de TODAS las coincidencias (expandidas a palabra)
  const ranges = [];
  for (const t of uniq) {
    const re = new RegExp(_escapeRe(t), 'gi');
    let m;
    while ((m = re.exec(text)) !== null) {
      const start = m.index;
      const end   = m.index + m[0].length;
      const [wStart, wEnd] = _expandToWord(text, start, end); // <-- expande a palabra
      ranges.push([wStart, wEnd]);
      // evita loops con matches vacíos
      if (re.lastIndex === m.index) re.lastIndex++;
    }
  }

  if (!ranges.length) return text;

  // 2) fusionar rangos que se solapan o tocan
  ranges.sort((a,b)=> a[0]-b[0] || a[1]-b[1]);
  const merged = [];
  for (const [s,e] of ranges) {
    if (!merged.length || s > merged[merged.length-1][1]) {
      merged.push([s,e]);
    } else {
      merged[merged.length-1][1] = Math.max(merged[merged.length-1][1], e);
    }
  }

  // 3) construir el string con <mark> alrededor de los rangos fusionados
  let out = '', prev = 0;
  for (const [s,e] of merged) {
    out += text.slice(prev, s) + '<mark>' + text.slice(s, e) + '</mark>';
    prev = e;
  }
  out += text.slice(prev);
  return out;
}






// === reemplaza tu _makeSnippet por este ===
function _makeSnippet(text, terms, radiusWords = 25) {
  if (!text) return { snippetHTML: '' };

  // 1) encuentra el *primer* match para centrar el recorte
  let first = null, firstTerm = '';
  for (const t of (terms || [])) {
    if (!t) continue;
    const re = new RegExp(_escapeRe(t), 'i');
    const m = text.match(re);
    if (m) { first = { index: m.index, len: m[0].length }; firstTerm = m[0]; break; }
  }

  // 2) si no hay match → inicio plano (sin marcas)
  if (!first) {
    const words = text.trim().split(/\s+/);
    const slice = words.slice(0, radiusWords * 2).join(' ');
    const more  = words.length > radiusWords * 2 ? '…' : '';
    return { snippetHTML: __escHTML(slice) + more };
  }

  // 3) construye un “window” de ±radiusWords alrededor del primer término
  const center = _escapeRe(firstTerm);
  const windowRe = new RegExp(
    `(?:\\S+\\s+){0,${radiusWords}}\\S*${center}\\S*(?:\\s+\\S+){0,${radiusWords}}`,
    'i'
  );
  const m2 = text.match(windowRe);
  const rawSlice = m2 ? m2[0] : text;

  // 4) marca **todas** las ocurrencias de *todos* los términos dentro del slice
  const markedAll = _markAllWholeWord(rawSlice, terms);

  // 5) escapado seguro preservando <mark> y puntos suspensivos si recortamos
  let safe = __escHTML(markedAll)
              .replace(/&lt;mark&gt;/g, '<mark>')
              .replace(/&lt;\/mark&gt;/g, '</mark>');
  const prefix = m2 && m2.index > 0 ? '…' : '';
  const suffix = m2 && (m2.index + m2[0].length < text.length) ? '…' : '';

  return { snippetHTML: prefix + safe + suffix };
}

// --- utils para evaluar si un snippet es trivial
function _stripHtml(s=''){
  return String(s)
    .replace(/<[^>]+>/g, '')       // quita tags
    .replace(/\s+/g, ' ')          // colapsa espacios
    .trim();
}
function _isTrivialSnippet(snippetHTML, terms){
  const plain = _stripHtml(snippetHTML).replace(/^…|…$/g, '').trim();
  if (!plain) return true;

  // 1) muy corto (<= 2 palabras o <= 12 chars)
  const words = plain.split(/\s+/).filter(Boolean);
  if (plain.length <= 12 || words.length <= 2) return true;

  // 2) está compuesto solo por los términos buscados (marcados o no)
  const norm = (s)=>s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  const set  = new Set((terms||[]).map(norm));
  const onlyFromTerms = words.every(w => set.has(norm(w.replace(/[^\p{L}\p{N}_]+/gu,''))));
  if (onlyFromTerms) return true;

  return false;
}



// Recolecta pares {heading, text} recorriendo el objeto del subtema



// Recolecta pares {heading, text} pero IGNORA imágenes/media
function _collectStringsWithHeading(node, currentHeading = '', out = [], parentKey = '') {
  const keyNorm = String(parentKey || '').toLowerCase();

  // 🔕 listas de claves a ignorar
  const BLACKLIST_KEYS = ['imagen', 'imagenes', 'imageness', 'images', 'figuras', 'media', 'multimedia', 'photos', 'gallery'];

  // Si toda la rama es de imágenes → no entrar
  if (BLACKLIST_KEYS.some(k => keyNorm.includes(k))) return out;

  // Si es un "objeto imagen" típico → no recolectar su texto
  const isImageObj = node && typeof node === 'object' && !Array.isArray(node) &&
    (
      ('url' in node && ('descripcion' in node || 'desc' in node || 'caption' in node || 'alt' in node)) ||
      ('src' in node && ('caption' in node || 'alt' in node))
    );
  if (isImageObj) return out;

  if (Array.isArray(node)) {
    node.forEach(n => _collectStringsWithHeading(n, currentHeading, out, parentKey));
    return out;
  }

  if (node && typeof node === 'object') {
    const maybeTitle = node.titulo || node.title || node.nombre || node.clave || node.heading || '';
    const nextHeading = (typeof maybeTitle === 'string' && maybeTitle.trim()) ? maybeTitle : currentHeading;

    for (const k of Object.keys(node)) {
      _collectStringsWithHeading(node[k], nextHeading, out, k); // 👈 pasa la clave hija
    }
    return out;
  }

  if (typeof node === 'string') {
    out.push({ heading: currentHeading, text: node });
  }

  return out;
}

/** Devuelve TODAS las coincidencias relevantes dentro del subtema */
function findHitsInSubtemaData(data, query, {maxHits=6} = {}){
  const terms = termsFromQuery(query);
  if (!terms.length) return [];

  const matchAll   = buildTextMatcher(query);
  const buckets    = _collectStringsWithHeading(data);
  const prioritized= buckets.sort((a,b)=>{
    const score = r => /texto|content|descripcion|body/i.test((r.heading||'')) ? -1 : 0;
    return score(a) - score(b);
  });

  const hits = [];
  const seenKey     = new Set();         // evita duplicados exactos
  const usedHeading = new Set();         // (opcional) 1 hit por subheading

  for (const item of prioritized){
    if (!matchAll(item.text)) continue;

    const { snippetHTML } = _makeSnippet(item.text, terms, 90);

    // 🔕 descarta snippets triviales (“vancomicina”, “dique”, etc.)
    if (_isTrivialSnippet(snippetHTML, terms)) continue;

    // (opcional) máximo 1 hit por subheading para no repetir “Generalidades”
    const h = item.heading || '(sin subtítulo)';
    if (usedHeading.has(h)) continue;

    const key = h + '|' + snippetHTML;
    if (seenKey.has(key)) continue;

    seenKey.add(key);
    usedHeading.add(h);

    hits.push({ subheading: h, snippetHTML });
    if (hits.length >= maxHits) break;
  }
  return hits;
}
// Normaliza texto (minúsculas, sin tildes)
function _norm(s){ return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim(); }

// Espera a que el contenido de la subcategoría haya quedado renderizado
function waitForSubcatRendered({sup,cat,sub}, timeout=1500){
  return new Promise(resolve=>{
    let done=false, t;
    const finish=()=>{ if(done) return; done=true; window.removeEventListener('subcat:rendered', on); clearTimeout(t); resolve(); };
    const on = (e)=>{ const d=e.detail||{}; if(d.sup===sup && d.cat===cat && d.sub===sub) finish(); };
    window.addEventListener('subcat:rendered', on, {once:true});
    t=setTimeout(finish, timeout); // fallback
  });
}

// Encuentra el <summary> cuyo texto coincide con el subheading encontrado en la búsqueda
function findHeadingInSubcontent(text){
  const needle = _norm(text);
  if(!needle) return null;
  const nodes = Array.from(document.querySelectorAll('#subcategoria-body details > summary'));
  // match exacto/relajado
  for (const s of nodes){
    const raw = (s.querySelector('span')?.textContent || s.textContent || '').replace(/^⤷\s*/,'');
    const n = _norm(raw);
    if (n === needle || n.includes(needle) || needle.includes(n)) return s;
  }
  return null;
}

// Abre el <details> del objetivo (y ancestros si los hay)
async function ensureExpandedPathTo(el){
  if(!el) return;
  let d = el.closest('details');
  while(d){ d.open = true; d = d.parentElement?.closest?.('details') || null; }
}

// Scroll con compensación por header sticky
function scrollWithOffset(el, extra=8){
  const container = document.getElementById('main-content');
  if(!container || !el) return;
  const cR = container.getBoundingClientRect();
  const r  = el.getBoundingClientRect();
  const off = (window.STICKY_H || 0) + extra;
  const top = container.scrollTop + (r.top - cR.top) - off;
  container.scrollTo({ top, behavior:'smooth' });
}

// Pequeño “flash” para que el usuario vea dónde cayó
function flashHighlight(el){
  const target = el.querySelector('span') || el;
  target.classList.remove('flash-mark'); void target.offsetWidth;
  target.classList.add('flash-mark');
  target.addEventListener('animationend', ()=>target.classList.remove('flash-mark'), {once:true});
}

// (opcionales para sincronizar TOC si usas sus nombres en tu handler)
function findSidebarItemForHeading(text){
  const n = _norm(text);
  const btns = document.querySelectorAll('#subcategoria-sidebar-content .toc-h2, #subcategoria-sidebar-content .toc-h3');
  for (const b of btns){ if (_norm(b.textContent).includes(n)) return b; }
  return null;
}
function selectSidebarItem(btn){
  if(!btn) return;
  btn.scrollIntoView({block:'nearest'});
}


  



  
  
    /* ------------ Orquestador ------------- */



    // Recolector muy simple de imágenes {url, descripcion/desc/caption}
function _collectImages(node, heading = '', out = []) {
  if (Array.isArray(node)) { node.forEach(n => _collectImages(n, heading, out)); return out; }
  if (node && typeof node === 'object') {
    const h = node.titulo || node.title || node.nombre || heading;

    // ¿Es un nodo imagen?
    if (node.url && (node.descripcion || node.desc || node.caption)) {
      out.push({
        title: node.descripcion || node.desc || node.caption || '(sin descripción)',
        thumb: node.url,       // úsalo como miniatura
        url:   node.url,       // o abre la misma url
        kind:  'photo',
        from:  h               // opcional: dónde estaba
      });
    }
    for (const k in node) _collectImages(node[k], h, out);
  }
  return out;
}




  async function searchImagesInSubtemas(query, limit = 20) {
  if (!window.db) return [];
  const match = buildTextMatcher(query);            // ya lo tienes
  const snap  = await db.collectionGroup('subcategorias').limit(120).get();
  const out = [];
  snap.forEach(doc => {
    const imgs = _collectImages(doc.data() || {});
    imgs.forEach(im => { if (match(im.title)) out.push(im); });
  });
  return out.slice(0, limit);
}
  
  
  async function fetchSearchData(query){
  const [articles, guidelines, drugs, mediaColl, subtemas, mediaFromSub] = await Promise.all([
    searchCollection(COLLECTIONS.articles,   query),
    searchCollection(COLLECTIONS.guidelines, query),
    searchCollection(COLLECTIONS.drugs,      query),
    searchCollection(COLLECTIONS.media,      query),   // si tienes colección "media"
    searchSubtemas(query),
    searchImagesInSubtemas(query) 
  ]);

  // Mezclamos: subtemas primero, luego artículos normales
  const articlesMerged = [
    // etiquetamos mentalmente para el rendering (opcional)
    ...subtemas.map(a => ({...a, __kind:'subtema'})),
    ...articles.map(a   => ({...a, __kind:'article'}))
  ];

  const suggestions = await getRelatedQuestions(query);
  const media = [...mediaFromSub, ...mediaColl];

  return {
    counts: { overview:1, articles: articlesMerged.length, drugs: drugs.length,
              media: media.length, guidelines: guidelines.length },
    articles:  articlesMerged,
    guidelines,
    media,                                           // 👈 asegúrate de devolverlo
    suggestions
  };
}


  


  async function showSearchPage(query){
    const mount = document.getElementById('search-page');
    if(!window.db){
      mount.innerHTML = `<p class="text-sm text-gray-600">Firestore no está disponible.</p>`;
      return;
    }
    try{
      const data = await fetchSearchData(query?.trim());
      console.log('[search] query:', query, data);
      mount.innerHTML = resultsView(data);



      // controlador de tabs (aisla el contenido por pestaña)
(function wireTabsSwitching(){
  const bar = document.getElementById('tabsbar');
  const content = document.getElementById('tab-content');
  if(!bar || !content) return;

  function setTab(tab){
  // activa botón
  bar.querySelectorAll('.tab-btn')
    .forEach(b => b.classList.toggle('is-active', b.dataset.tab === tab));

  // pinta contenido
  if (tab === 'overview') {
  content.innerHTML = renderOverview(data);
  setupOverviewInteractivity(data);   // <-- re-engancha Questions (opciones, reset, etc.)
} else if (tab === 'articles') {
  content.innerHTML = `<section class="mt-6">${renderArticlesBlock(data)}</section>`;
} else if (tab === 'drugs') {
  content.innerHTML = `<section class="mt-6">${renderDrugsBlock(data)}</section>`;
} else if (tab === 'media') {
  // ⟵ usamos el flag false para ocultar "See all…"
  content.innerHTML = `<section class="mt-6">${renderMediaBlock(data, false)}</section>`;
} else if (tab === 'guidelines') {
    content.innerHTML = `<section class="mt-6">${renderGuidelinesBlock(data)}</section>`;
  }
}

  // click en tabs
  bar.addEventListener('click', (e)=>{
    const btn = e.target.closest('.tab-btn');
    if(!btn) return;
    const tab = btn.dataset.tab;
    setTab(tab);
    // recoloca la ink bar (tu inicializador ya existe; lo reusamos)
    const ink = bar.querySelector('.tabs-ink');
    if(ink){
      const r = btn.getBoundingClientRect(), b = bar.getBoundingClientRect();
      ink.style.left = (r.left - b.left) + bar.scrollLeft + 'px';
      ink.style.width = r.width + 'px';
    }
  });

  // estado inicial
  setTab('overview');
})();



// 3) Wire de tabs + re-enganche de la sección Questions al entrar a Overview
function wireTabs(data){
  const bar = document.getElementById('tabsbar');
  const content = document.getElementById('tab-content');
  if (!bar || !content) return;

  const renderers = {
    overview(){ content.innerHTML = renderOverview(data); setupOverviewInteractivity(data); },
    articles(){ content.innerHTML = renderArticles(data); },
    drugs(){ content.innerHTML = renderDrugs(data); },
    media(){ content.innerHTML = renderMedia(data); },
    guidelines(){ content.innerHTML = renderGuidelines(data); },
  };

  // inicial
  setupOverviewInteractivity(data);

  bar.addEventListener('click', (e)=>{
    const btn = e.target.closest('.tab-btn'); if(!btn) return;
    const tab = btn.dataset.tab;
    if (!renderers[tab]) return;

    // activar visualmente
    bar.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('is-active'));
    btn.classList.add('is-active');

    // render
    renderers[tab]();

    // recolocar la "ink" si usas initTabsInk
    const ink = bar.querySelector('.tabs-ink');
    if (ink && typeof btn.getBoundingClientRect === 'function'){
      const r = btn.getBoundingClientRect();
      const b = bar.getBoundingClientRect();
      ink.style.left = (r.left - b.left + bar.scrollLeft) + 'px';
      ink.style.width = r.width + 'px';
    }
  });
}



// 4) Re-enganche de la interactividad específica de QUESTIONS (misma que tenías)
function setupOverviewInteractivity(data){
  // estado local por render
  let shown   = Math.min(3, data.suggestions.length);
  const batches = [];

  async function renderQs() {
    const list   = document.getElementById('qs-list');
    const btnMore= document.getElementById('qs-more');
    const btnLess= document.getElementById('qs-less');
    if (!list) return;

    const abiertos = new Set(
      Array.from(list.querySelectorAll('details[open] summary span'))
           .map(el => el.textContent.trim())
    );

    await renderSuggestionsConOpciones(list, data, shown);

    // restaurar abiertos + animaciones
    Array.from(list.querySelectorAll('details')).forEach(det => {
      const txt = det.querySelector('summary span')?.textContent.trim();
      if (abiertos.has(txt)) det.setAttribute('open', 'true');
    });
    wireExpandoAnimations(list);

    if (btnMore) btnMore.classList.toggle('hidden', shown >= data.suggestions.length);
    if (btnLess) btnLess.classList.toggle('hidden', batches.length === 0);
  }

  document.getElementById('qs-more')?.addEventListener('click', async () => {
    const remaining = data.suggestions.length - shown;
    if (remaining <= 0) return;
    const add = Math.min(3, remaining);
    shown += add;
    batches.push(add);
    await renderQs();
  });

  document.getElementById('qs-less')?.addEventListener('click', async () => {
    if (batches.length === 0) return;
    const last = batches.pop();
    shown = Math.max(3, shown - last);
    await renderQs();
  });

  // render inicial
  renderQs();
}



      (function initTabsInkAndPanels(barId='tabsbar'){
  const bar = document.getElementById(barId);
  if(!bar) return;
  const ink = bar.querySelector('.tabs-ink');
  const btns = Array.from(bar.querySelectorAll('.tab-btn'));
  const panels = Array.from(document.querySelectorAll('[data-tabpanel]'));

  function placeInk(btn){
    const r = btn.getBoundingClientRect();
    const b = bar.getBoundingClientRect();
    ink.style.left = (r.left - b.left + bar.scrollLeft) + 'px';
    ink.style.width = r.width + 'px';
  }
  function showPanel(name){
    panels.forEach(p=>p.classList.toggle('is-active', p.dataset.tabpanel === name));
  }

  // inicial
  const active = btns.find(b=>b.classList.contains('is-active')) || btns[0];
  if (active){ placeInk(active); showPanel(active.dataset.tab); }

  // click handler
  bar.addEventListener('click', (e)=>{
    const btn = e.target.closest('.tab-btn');
    if(!btn || !bar.contains(btn)) return;
    btns.forEach(b=>b.classList.remove('is-active'));
    btn.classList.add('is-active');
    placeInk(btn);
    showPanel(btn.dataset.tab);
    // opcional: scroll al inicio del contenedor principal
    document.getElementById('main-content')?.scrollTo({top:0, behavior:'smooth'});
  });

  // re-colocar en resize
  window.addEventListener('resize', ()=>{
    const cur = bar.querySelector('.tab-btn.is-active') || btns[0];
    if(cur) placeInk(cur);
  });
})();



      // Delegación de clicks en resultados "subtema" (Articles)
// Delegación de clicks en resultados "subtema" (Articles)
mount.addEventListener('click', (e) => {
  const el = e.target.closest('[data-result="subcat"]');
  if (!el) return;

  e.preventDefault();
  const { sup, cat, sub } = el.dataset;
  if (!sup || !cat || !sub) return;

  // 1) abrir la subcategoría
  showSubcategoriaContent(sub, cat, sup);

  // 2) ⬅️ NUEVO: ocultar la página de resultados y mostrar la vista de subcategoría
  const sp   = document.getElementById('search-page');
  const subc = document.getElementById('subcategoria-content');
  sp?.classList.add('hidden');
  subc?.classList.remove('hidden');

  // 3) ocultar el dropdown del buscador (si estuviera abierto)
  document.getElementById('search-results')?.classList.add('hidden');

  // 4) quitar foco del input global
  document.getElementById('global-search')?.blur();
});


mount.addEventListener('click', async (e) => {
  const el = e.target.closest('[data-result="subcat-hit"]');
  if (!el) return;

  e.preventDefault();
  const { sup, cat, sub, subheading } = el.dataset;
  if (!sup || !cat || !sub) return;

  // 1) abrir la subcategoría
  await showSubcategoriaContent(sub, cat, sup);

  // 2) ocultar resultados y mostrar la vista de subcategoría
  document.getElementById('search-page')?.classList.add('hidden');
  document.getElementById('subcategoria-content')?.classList.remove('hidden');

  // 3) cerrar dropdown y quitar foco
  document.getElementById('search-results')?.classList.add('hidden');
  document.getElementById('global-search')?.blur();

  // 4) esperar render de Capa A (si emite evento)
  updateStickyHeight();
  await new Promise(r => requestAnimationFrame(r));

  // 5) buscar el heading y abrir acordeones padres si hace falta
  const target = findHeadingInSubcontent(subheading || '');
  if (target){
    await ensureExpandedPathTo(target);
    scrollWithOffset(target, 72);
    flashHighlight(target);

    // 6) seleccionar el mismo ítem en la barra lateral (TOC), si existe
    const tocItem = findSidebarItemForHeading(subheading || '');
    selectSidebarItem(tocItem);
  }
});








// Paginación con "deshacer" del último agregado
let shown   = Math.min(3, data.suggestions.length); // visibles iniciales
const batches = []; // tamaños agregados secuencialmente (p.ej. [3,3,3,2])

async function renderQs() {
  const list   = document.getElementById('qs-list');
  const btnMore= document.getElementById('qs-more');
  const btnLess= document.getElementById('qs-less');
  if (!list) return;

  // 🧠 guardar cuáles estaban abiertas (por su texto del summary)
  const abiertos = new Set(
    Array.from(list.querySelectorAll('details[open] summary span'))
         .map(el => el.textContent.trim())
  );

  // re-render normal
  await renderSuggestionsConOpciones(list, data, shown);

  // 🔁 restaurar las que ya estaban abiertas
  // 🔁 restaurar las que ya estaban abiertas
Array.from(list.querySelectorAll('details')).forEach(det => {
  const txt = det.querySelector('summary span')?.textContent.trim();
  if (abiertos.has(txt)) det.setAttribute('open', 'true');
});

// 🪄 asegurar animaciones asociadas al estado final
wireExpandoAnimations(list);

  if (btnMore) btnMore.classList.toggle('hidden', shown >= data.suggestions.length);
  if (btnLess) btnLess.classList.toggle('hidden', batches.length === 0);
}







document.getElementById('qs-more')?.addEventListener('click', async () => {
  const remaining = data.suggestions.length - shown;
  if (remaining <= 0) return;
  const add = Math.min(3, remaining);
  shown += add;
  batches.push(add);
  await renderQs();
});

document.getElementById('qs-less')?.addEventListener('click', async () => {
  if (batches.length === 0) return;
  const last = batches.pop();
  shown = Math.max(3, shown - last);
  await renderQs();
});

// render inicial
await renderQs();


    }catch(err){
      console.error('[search] error:', err);
      mount.innerHTML = `<p class="text-sm text-red-600">Error buscando resultados: ${err?.message||err}</p>`;
    }
    document.getElementById('home-content')?.classList.add('hidden');
    document.getElementById('articles-panel')?.classList.add('hidden');
    document.getElementById('subcategoria-content')?.classList.add('hidden');
    mount.classList.remove('hidden');
  }

  // Hook Enter (modificado)
(() => {
  const input = document.getElementById('global-search');
  if (!input) return;

  // Handler en CAPTURA para anular otros listeners
  input.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter') return;
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();

    // Ocultar vistas actuales
    document.getElementById('search-results')?.classList.add('hidden');
    document.getElementById('home-content')?.classList.add('hidden');
    document.getElementById('articles-panel')?.classList.add('hidden');
    document.getElementById('panel-2')?.classList.add('hidden');
    document.getElementById('panel-3')?.classList.add('hidden');
    document.getElementById('subcategoria-content')?.classList.add('hidden');

    // Sidebars
    const sb  = document.getElementById('sidebar');              // barra principal
    const toc = document.getElementById('subcategoria-sidebar'); // barra secundaria


    




    toc?.classList.add('hidden');
    document.body.classList.remove('bars-hidden');
    sb?.classList.remove('force-hidden');

    // Expandir barra principal
    if (typeof toggleSidebarCollapse === 'function') {
      toggleSidebarCollapse(false);
    } else {
      sb?.classList.remove('collapsed');
      sb?.classList.add('open');
      const main = document.getElementById('main-content');
      if (main) {
        main.style.marginLeft  = '';
        main.style.width       = '100%';
        main.style.paddingLeft = '64px';
      }
    }

    // Mostrar resultados
    document.getElementById('search-page')?.classList.remove('hidden');

    const term = input.value.trim();
    if (term && typeof window.saveSearchTermForHistory === 'function') {
      window.saveSearchTermForHistory(term);
    }

    showSearchPage(input.value);

    // Quitar foco
    input.blur();
  }, true); // capture
})();
</script>





<script>
// Renderiza preguntas mostrando opciones por ID
// Utilidad: parte un array en chunks de N (Firestore "in" soporta hasta 10)
// util



const chunk = (arr, size = 10) => {
  const out = []; for (let i = 0; i < arr.length; i += size) out.push(arr.slice(i, i + size));
  return out;
};


// ↳ estado persistente de opciones tachadas (pregunta||opción)
const markedOpts = new Set();
const answersState = new Map(); // key: data-qkey (texto exacto de la pregunta o id estable)

// busca opciones por id de DOC y, si no hay id, por texto exacto de "pregunta"



async function getOpcionesParaItems(items){
  const byKey = new Map();

  const ids = [];
  const texts = [];
  for (const it of items){
    if (typeof it === 'object' && (it.id || it.qid)) {
      ids.push(String(it.id || it.qid));
    } else {
      const t = typeof it === 'string' ? it : (it?.text || it?.q || '');
      texts.push(String(t).trim());
    }
  }

  // 1) por ID
  if (ids.length){
    const fpId = firebase.firestore.FieldPath.documentId();
    for (const g of chunk([...new Set(ids)], 10)){
      const snap = await db.collectionGroup('preguntas').where(fpId, 'in', g).get();
      snap.forEach(d => {
        const data = d.data() || {};
        byKey.set(d.id, {
        opciones: Array.isArray(data.opciones) ? data.opciones : [],
        corr: Number(data.corr ?? -1),
        explicacion: data.explicacion || '',
        explicacionimagen: data.explicacionimagen || ''
      });
      });
    }
  }

  // 2) por TEXTO exacto
  const uniqueTexts = [...new Set(texts.filter(Boolean))];
  await Promise.all(uniqueTexts.map(async (t) => {
    const qs = await db.collectionGroup('preguntas').where('pregunta', '==', t).limit(1).get();
    if (!qs.empty){
      const data = qs.docs[0].data() || {};
      byKey.set(`__TXT__${t}`, {
        opciones: Array.isArray(data.opciones) ? data.opciones : [],
        corr: Number(data.corr ?? -1),
        explicacion: data.explicacion || '',
        explicacionimagen: data.explicacionimagen || ''
        
      });
    }
  }));

  return byKey;
}
function __escHTML(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}

function renderCorrectExplanation(list){
  if (!list) return;
  const corr = Number(list.dataset.corr ?? -1);
  const txt  = list.dataset.exp || '';
  const img  = list.dataset.expimg || '';

  const corrRow = list.querySelector(`.option-row[data-idx="${corr}"]`);
  if (!corrRow) return;

  // ⛔ evita duplicados
  const li = corrRow.closest('li') || corrRow.parentElement;
  if (!li) return;
  if (li.querySelector(':scope > .explicacion-box')) return;


  corrRow.classList.remove('rounded-md','ring-1','ring-green-500');
corrRow.classList.add('border','border-green-500','bg-green-50','rounded-t-md','rounded-b-none');

  // 🧩 Card de explicación (borde y fondo verdes, tipografía más grande)
  const box = document.createElement('div');
  box.className = [
  'explicacion-box',
  '-mt-px',        // une los bordes (sin separación)
  'ml-0',          // alinea con el inicio del texto (px-3 + w-3 + gap-3 = 2.25rem)
  'text-[10px]',
  'leading-relaxed',
  'text-slate-800'
].join(' ');

box.innerHTML = `
  <div class="border border-green-500 rounded-md rounded-t-none bg-green-50 p-3 md:p-4">
    ${txt ? `<div class="whitespace-pre-wrap">${__escHTML(txt)}</div>` : ''}
    ${img ? `
      <figure class="mt-3">
        <img src="${__escHTML(img)}" alt="explicación" loading="lazy"
             class="w-28 h-20 object-cover rounded-md border border-green-200">
      </figure>` : ''}
  </div>
`;

  // ⬇️ Insertar como hermano, justo debajo del row correcto
  li.insertBefore(box, corrRow.nextSibling);
}

function applyAnswerState(list, st){
  if (!list || !st) return;
  const { locked, selected, corr } = st;
  const allRows = list.querySelectorAll('.option-row');
  const allBullets = list.querySelectorAll('.opt-bullet');

  // baseline: todo rojo (err)
allRows.forEach(r => r.classList.remove(
  'bg-green-50','bg-green-100','bg-red-100',
  'ring-1','ring-green-500','ring-red-500',
  'border','border-green-500','border-red-500',
  'rounded-b-none','rounded-t-md'
));
  allBullets.forEach(b => {
    b.classList.remove('ok','ok-solid','err','err-solid');
    b.classList.add('err');
  });

  const selRow = list.querySelector(`.option-row[data-idx="${selected}"]`);
  const selBullet = selRow?.querySelector('.opt-bullet');
  const corrRow = list.querySelector(`.option-row[data-idx="${corr}"]`);
  const corrBullet = corrRow?.querySelector('.opt-bullet');

  if (selected === corr) {
    selRow?.classList.add('correct');
    selBullet?.classList.remove('err');
    selBullet?.classList.add('ok-solid');
  } else {
    selRow?.classList.add('bg-red-100','ring-1','ring-red-500');
    selBullet?.classList.remove('err');
    selBullet?.classList.add('err-solid');
    if (corrRow){
      corrRow.classList.add('correct');
      corrBullet?.classList.remove('err');
      corrBullet?.classList.add('ok');
    }
  }


    // 🔄 restaurar iconos bloqueados
  const allIcons = list.querySelectorAll('.opt-x i');
  allIcons.forEach(icon => { icon.className = 'fas fa-minus text-slate-400'; });
  const corrIcon = list.querySelector(`.option-row[data-idx="${corr}"] .opt-x i`);
  if (corrIcon) corrIcon.className = 'fas fa-check text-green-600';

  if (locked){
    list.dataset.locked = '1';
    list.classList.add('locked');
    list.querySelectorAll('.opt-x').forEach(b=>{
      b.setAttribute('aria-disabled','true');

    renderCorrectExplanation(list);
    enableReset(list, true);

    });
    
  }
  
  // 🚫 al estar bloqueado, deshabilitar los botones de tachar
  if (locked){
    
  }




}

function reapplyStrikes(root){
  // Vuelve a tachar las opciones que el usuario marcó con la X
  root.querySelectorAll('.opt-list').forEach(list=>{
    const qText = list.dataset.qkey || '';
    list.querySelectorAll('.option-row .opt-text').forEach(optEl=>{
      const key = `${qText}||${optEl.textContent?.trim() || ''}`;
      if (markedOpts.has(key)) optEl.classList.add('striked');
    });
  });
}


function enableReset(list, on){
  const btn = list.closest('.expando')?.querySelector('.opt-reset');
  if(!btn) return;
  btn.disabled = !on;
  btn.classList.toggle('enabled', !!on);
}

// util: borra clases que empiecen por un prefijo (p.ej. bg-green-)
function removeClassesByPrefix(el, prefix){
  el.classList.forEach(c => { if (c.startsWith(prefix)) el.classList.remove(c); });
}

function resetQuestion(list){
  if(!list) return;

  // 1) eliminar explicación si existe
  list.querySelectorAll(':scope > li > .explicacion-box').forEach(el=>el.remove());

  // 2) desbloquear
  list.dataset.locked = '0';
  list.classList.remove('locked');

  // 3) limpiar filas y bullets (incluye bg-green-50 que quedaba)
  list.querySelectorAll('.option-row').forEach(row=>{
    row.classList.remove(
      'correct','bg-red-100','ring-1','ring-green-500','ring-red-500',
      'border','border-green-500','rounded-t-md','rounded-b-none'
    );
    removeClassesByPrefix(row, 'bg-green-');   // <- quita bg-green-50/100/200/etc
  });
  list.querySelectorAll('.opt-bullet').forEach(b=>{
    b.classList.remove('ok','ok-solid','err','err-solid');
  });

  // 4) restaurar iconos y tachados
  list.querySelectorAll('.opt-x').forEach(b=>{
    b.removeAttribute('aria-disabled');
    const i = b.querySelector('i'); if(i) i.className = 'fas fa-times';
  });

  const qText = list.dataset.qkey || '';
  list.querySelectorAll('.opt-text').forEach(opt=>{
    const key = `${qText}||${(opt.textContent||'').trim()}`;
    opt.classList.remove('striked'); markedOpts.delete(key);
  });

  // 5) olvidar estado y desactivar botón
  answersState.delete(qText);
  enableReset(list, false);
}


// NUEVO render con soporte id/texto
async function renderSuggestionsConOpciones(list, data, shown) {
  const letters = i => String.fromCharCode(65 + i);
  const esc = s => String(s ?? '')
  .replace(/&/g,'&amp;').replace(/</g,'&lt;')
  .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

  const items = data.suggestions.slice(0, shown);
  const infoMap = await getOpcionesParaItems(items);

  list.innerHTML = items.map((item, idx) => {
    const texto = typeof item === 'string' ? item : (item.text || item.q || '');
    const sid   = typeof item === 'object' ? (item.id || item.qid || null) : null;
    const bookmarkKey = sid ? `sugg:${sid}` : `sugg:${idx}`;

    const keyTxt = `__TXT__${String(texto).trim()}`;
    const meta   = sid ? (infoMap.get(String(sid)) || {}) : (infoMap.get(keyTxt) || {});
    const opciones = Array.isArray(meta.opciones) ? meta.opciones : [];
    const corr = Number(meta.corr ?? -1);

    const opcionesHtml = opciones.length
      ? opciones.map((op, i) => `
          <li>
            <div class="option-row flex items-center gap-3 px-3 py-1 rounded-md cursor-pointer hover:bg-slate-50"
                 data-idx="${i}">
              <span class="opt-bullet w-3 font-semibold text-slate-500">${letters(i)}</span>
              <span class="opt-text grow text-[10px] text-slate-800">${esc(op)}</span>
              <button type="button" class="opt-x ml-2 text-slate-400 hover:text-slate-600" aria-label="Tachar opción">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </li>`).join('')
      : `<li class="text-xs text-slate-400 px-3 py-2">Sin opciones registradas</li>`;

    return `
  <details class="group" data-bookmark-key="${bookmarkKey}" data-bookmarked="false">
    <summary class="flex items-center justify-between cursor-pointer list-none py-2 pl-0">
      <span class="text-slate-700 text-sm">${esc(texto)}</span>
      <span class="toggle-icons">
        ${bookmarkToggleMarkup(texto)}
        <i class="fa-solid fa-chevron-down text-slate-400 text-xs transition-transform group-open:rotate-180"></i>
      </span>
    </summary>

  <div class="pl-4 pr-2 pb-2 overflow-hidden">
      <div class="expando" style="max-height:0; opacity:0; transition:max-height 250ms ease, opacity 200ms ease;">
                <ul class="opt-list list-none p-0 m-0"
            data-qkey="${esc(texto)}"
            data-corr="${corr}"
            data-locked="0"
            data-exp="${esc(meta.explicacion || '')}"
            data-expimg="${esc(meta.explicacionimagen || '')}">
          ${opcionesHtml}
               </ul>
        <div class="opt-footer">
          <div class="opt-divider"></div>
          <button type="button" class="opt-reset" disabled>Reset question</button>
        </div>
      </div>
    </div>
  </details>`;
  }).join('');

  initializeBookmarkControls(list);
    reapplyStrikes(list);
  list.querySelectorAll('.opt-list').forEach(ul=>{
   const key = ul.dataset.qkey || '';
    const st = answersState.get(key);
    if (st) applyAnswerState(ul, st);
  });







}


function _openPanel(panel) {
  // desde colapsado → expandido
  panel.style.willChange = 'max-height, opacity';
  panel.style.opacity = '1';
  panel.style.maxHeight = panel.scrollHeight + 'px';

  const onEnd = () => {
    panel.style.maxHeight = 'none'; // permite altura auto tras expandir
    panel.style.willChange = '';
    panel.removeEventListener('transitionend', onEnd);
  };
  panel.addEventListener('transitionend', onEnd);
}

function _closePanel(panel) {
  // desde expandido → colapsado
  panel.style.willChange = 'max-height, opacity';
  // fijar altura actual para poder animar hacia 0
  panel.style.maxHeight = panel.scrollHeight + 'px';
  // forzar reflow para que el cambio a 0 anime
  void panel.offsetHeight;
  panel.style.opacity = '0';
  panel.style.maxHeight = '0px';

  const onEnd = () => {
    panel.style.willChange = '';
    panel.removeEventListener('transitionend', onEnd);
  };
  panel.addEventListener('transitionend', onEnd);
}

function wireExpandoAnimations(root) {
  root.querySelectorAll('details').forEach(det => {
    const panel = det.querySelector('.expando');
    if (!panel) return;

    // Estado inicial (si se restaura abierto)
    if (det.open) {
      panel.style.maxHeight = 'none';
      panel.style.opacity = '1';
    } else {
      panel.style.maxHeight = '0px';
      panel.style.opacity = '0';
    }

    det.addEventListener('toggle', () => {
      if (det.open) _openPanel(panel);
      else _closePanel(panel);
    });
  });
}


document.addEventListener('click', (e) => {
  const btn = e.target.closest('.opt-x');
  if (!btn) return;



    // ⛔ si la lista está bloqueada, no permitir tachar
  const listLocked = btn.closest('.opt-list')?.dataset.locked === '1';
  if (listLocked) return;
  // ⛔ si el icono ya no es "X", no permitir tachar
  const iconEl = btn.querySelector('i');
  if (iconEl && !iconEl.classList.contains('fa-times')) return;

  const row   = btn.closest('.option-row');
  const optEl = row?.querySelector('.opt-text');
  const qText = btn.closest('details')?.querySelector('summary span')?.textContent?.trim() || '';
  const key   = `${qText}||${optEl?.textContent?.trim() || ''}`;

  if (!optEl) return;

  if (markedOpts.has(key)) {
    markedOpts.delete(key);
    optEl.classList.remove('striked');
  } else {
    markedOpts.add(key);
    optEl.classList.add('striked');
  }
});

document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.opt-reset');
  if(!btn) return;
  const list = btn.closest('.expando')?.querySelector('.opt-list');
  if(!list) return;
  resetQuestion(list);
});


document.addEventListener('click', (e) => {
  const row = e.target.closest('.option-row');
  if (!row) return;
  if (e.target.closest('.opt-x')) return; // ignora clicks en la X

  const list = row.closest('.opt-list');
  if (!list) return;


  if (String(list.dataset.locked) === '1') return;

  const corr = Number(list.dataset.corr ?? -1);
  const idx  = Number(row.dataset.idx ?? -1);

  // reset estilos de contenedor (ya lo hacías)
  list.querySelectorAll('.option-row').forEach(r=>{
  r.classList.remove('bg-green-100','ring-1','ring-green-500','bg-red-100','ring-red-500');
  removeClassesByPrefix(r, 'bg-green-');   // <- por si acaso
});

  // 🔁 reset de TODOS los bullets y deja como baseline "err" (rojo contorno/letra)
  const allBullets = list.querySelectorAll('.opt-bullet');
  allBullets.forEach(b=>{
    b.classList.remove('ok','ok-solid','err','err-solid');
    b.classList.add('err'); // todos en rojo contorno/letra por defecto
  });

  const selectedBullet = row.querySelector('.opt-bullet');
  const corrRow = list.querySelector(`.option-row[data-idx="${corr}"]`);
  const corrBullet = corrRow?.querySelector('.opt-bullet');

  if (idx === corr) {
    // ✅ seleccionó la correcta
    row.classList.add('correct','rounded-t-md','rounded-b-none');
    selectedBullet?.classList.remove('err');
    selectedBullet?.classList.add('ok-solid');   // círculo verde sólido, letra blanca
    // las demás ya quedaron con borde/letra rojos (err)
  } else {
    // ❌ seleccionó incorrecta
    row.classList.add('bg-red-100','ring-1','ring-red-500');
    selectedBullet?.classList.remove('err');
    selectedBullet?.classList.add('err-solid');  // círculo rojo sólido, letra blanca

    if (corrRow) {
      corrRow.classList.add('correct');
      if (corrBullet){
        corrBullet.classList.remove('err');
        corrBullet.classList.add('ok');          // correcto: contorno/letra verdes (bg transparente)
      }
    }
    // el resto permanece con borde/letra rojos (err)
  }

  list.dataset.locked = '1';
  list.classList.add('locked');

  

  const qKey = list.dataset.qkey || '';
  answersState.set(qKey, { locked: 1, selected: idx, corr });

    // 🔄 cambiar iconos de X → "-" y marcar ✔ en la correcta
  list.querySelectorAll('.opt-x i').forEach(icon=>{
    icon.className = 'fas fa-minus text-slate-400'; // todos se vuelven "−"
  });
  if (corrRow){
    const corrIcon = corrRow.querySelector('.opt-x i');
    if (corrIcon){
      corrIcon.className = 'fas fa-check text-green-600'; // solo la correcta se convierte en check
    }
  }


    list.querySelectorAll('.opt-x').forEach(b=>{
    b.setAttribute('aria-disabled', 'true');
  });


  renderCorrectExplanation(list);

  enableReset(list, true);




  


});





</script>

<script>
/* --- util --- */
function pinMainSidebar() {
  const sb = document.getElementById('sidebar');
  if (!sb) return;
  sb.classList.remove('collapsed', 'force-hidden');
  sb.classList.add('open');              // quítalo si no usas .open
  sb.style.position = '';
  sb.style.width = '';
  sb.style.paddingLeft = '';
  sb.style.paddingRight = '';
  document.body.classList.remove('bars-hidden');
}

/* selector SOLO subitems dentro de acordeones */
const SUBITEM_SELECTOR =
  '#sidebar .sidebar-group > div[id^="accordion-"] a.sidebar-item';

/* whitelist de grupos permitidos */
const ALLOWED_TITLES = [
  'clinical resources',
  'exams & cme',
  'library',
  'account & settings',
  'help & privacy'
];

function isWhitelistedSubitem(el) {
  const group = el.closest('.sidebar-group');
  if (!group) return false;
  const header = group.querySelector(':scope > button.sidebar-item, :scope > a.sidebar-item');
  const title = (header?.textContent || '').trim().toLowerCase();
  return ALLOWED_TITLES.includes(title);
}

/* click: SOLO subitems de los grupos whitelist mientras la barra esté colapsada */
document.addEventListener('click', (ev) => {
  const sb = document.getElementById('sidebar');
  if (!sb || !sb.classList.contains('collapsed')) return;

  const subitem = ev.target.closest(SUBITEM_SELECTOR);
  if (!subitem) return;                  // ignorar títulos y otros clics
  if (!isWhitelistedSubitem(subitem)) return;

  // Fijar barra antes de que navegue/abra acordeón
  pinMainSidebar();
}, true); // capture para ejecutar antes de otros handlers

/* teclado (Enter/Espacio) en esos subitems */
document.addEventListener('keydown', (ev) => {
  const sb = document.getElementById('sidebar');
  if (!sb || !sb.classList.contains('collapsed')) return;
  if (ev.key !== 'Enter' && ev.key !== ' ') return;

  const subitem = ev.target.closest(SUBITEM_SELECTOR);
  if (subitem && isWhitelistedSubitem(subitem)) {
    pinMainSidebar();
  }
});
</script>



<script>
/**
 * Cierra split y modal al lanzar una nueva búsqueda con Enter
 * (no interfiere con tu lógica existente).
 */
(function closeSplitAndModalOnSearchEnter(){
  if (window.__closeOnSearchEnterBound) return;
  window.__closeOnSearchEnterBound = true;

  document.addEventListener('keydown', function(e){
    // Solo si el Enter viene del input de búsqueda global
    if (e.key !== 'Enter') return;
    const t = e.target;
    if (!t || t.id !== 'global-search') return;

    try {
      // Preferir tu helper completo si existe
      if (typeof window.exitSplitIfAny === 'function') {
        window.exitSplitIfAny();
        return;
      }
      // Alternativas suaves si no está ese helper
      if (typeof window.hardCloseModal === 'function') window.hardCloseModal();
      else if (typeof window.cerrarModal === 'function') window.cerrarModal();
      else {
        // Fallback mínimo y seguro
        const modal = document.getElementById('video-modal');
        const iframe = document.getElementById('modal-iframe');
        modal?.classList.add('hidden');
        modal?.classList.remove('split-view','video-mode');
        document.body.classList.remove('split-view-active');
        if (iframe) iframe.src = '';
      }
    } catch(_) { /* no-op */ }
  }, true); // ← capture: corre incluso si otro listener hace stopPropagation
})();
</script>



<script>
(function(){
  const overlay   = document.getElementById('mobile-overlay');
  const sbMain    = document.getElementById('sidebar');
  const sbTOC     = document.getElementById('subcategoria-sidebar');

  const isMobile = () => window.matchMedia('(max-width: 639.98px)').matches;

  const isShown = (el, isMain=false) => {
    if (!el) return false;
    if (isMain && el.classList.contains('force-hidden')) return false;
    if (el.classList.contains('hidden')) return false;
    return el.offsetWidth > 0 && el.offsetHeight > 0;
  };

  function hideSidebarsMobile(){
    if (!isMobile()) return;
    if (sbMain) sbMain.classList.add('force-hidden');
    if (sbTOC)  sbTOC.classList.add('hidden');
    overlay.classList.remove('show');
    overlay.classList.add('hidden');
  }

  function updateMobileOverlay(){
    const show = isMobile() && (isShown(sbMain, true) || isShown(sbTOC, false));
    overlay.classList.toggle('show', show);
    overlay.classList.toggle('hidden', !show);
  }

  overlay.addEventListener('click', hideSidebarsMobile);

  // —— REGLA pedida: cerrar solo en items sin subitems y en subitems ——
  function isDirectTopLink(target){
    const a = target.closest('a.sidebar-item');
    if (!a) return false;
    // si está dentro de un acordeón, NO es top-level directo
    if (a.closest('div[id^="accordion-"]')) return false;
    const group = a.closest('.sidebar-group');
    if (!group) return false;
    // el grupo NO debe tener acordeón (o sea, item sin subitems)
    const hasAccordion = !!group.querySelector('div[id^="accordion-"]');
    return !hasAccordion;
  }
  function isAccordionSubitem(target){
    return !!target.closest('div[id^="accordion-"] a.sidebar-item');
  }

  // Main sidebar: cierra SOLO si cumple las reglas anteriores
  if (sbMain){
    sbMain.addEventListener('click', (ev) => {
      if (!isMobile()) return;
      if (isDirectTopLink(ev.target) || isAccordionSubitem(ev.target)){
        hideSidebarsMobile();
      }
      // Nota: clicks en botones de grupo (que abren/cierra acordeón) NO cierran
    });
  }

  // TOC: si quieres que también cierre al navegar, mantenemos cierre en h2/h3/enlaces
  if (sbTOC){
    sbTOC.addEventListener('click', (ev) => {
      if (!isMobile()) return;
      if (ev.target.closest('.toc-h2, .toc-h3, a')) hideSidebarsMobile();
    });
  }

  const moCfg = { attributes: true, attributeFilter: ['class','style'], subtree: true };
  const mo = new MutationObserver(updateMobileOverlay);
  if (sbMain) mo.observe(sbMain, moCfg);
  if (sbTOC)  mo.observe(sbTOC,  moCfg);

  const ro = new ResizeObserver(updateMobileOverlay);
  if (sbMain) ro.observe(sbMain);
  if (sbTOC)  ro.observe(sbTOC);

  window.addEventListener('resize', updateMobileOverlay);
  document.addEventListener('DOMContentLoaded', updateMobileOverlay);
  updateMobileOverlay();
})();
</script>

<script>
(function () {
  const isMobile = () => window.matchMedia('(max-width: 639.98px)').matches;

  function hideSidebarsOnMobile() {
    if (!isMobile()) return;
    const sbMain  = document.getElementById('sidebar');
    const sbTOC   = document.getElementById('subcategoria-sidebar');
    const overlay = document.getElementById('mobile-overlay');

    if (sbMain) sbMain.classList.add('force-hidden'); // oculta barra principal
    if (sbTOC)  sbTOC.classList.add('hidden');        // oculta TOC
    if (overlay){                                     // quita overlay si quedó
      overlay.classList.remove('show');
      overlay.classList.add('hidden');
      overlay.style.left = '0px';
    }
  }

  // 👉 Úsala al abrir los resultados
  window.hideSidebarsOnMobileForResults = hideSidebarsOnMobile;

  // 👉 Auto: si #search-page existe y se hace visible
  const sp = document.getElementById('search-page');
  if (sp) {
    new MutationObserver(() => {
      if (!isMobile()) return;
      const visible = !sp.classList.contains('hidden');
      if (visible) hideSidebarsOnMobile();
    }).observe(sp, { attributes: true, attributeFilter: ['class','style'] });
  }
})();
</script>

<script>
(function(){
  const modal = document.getElementById('video-modal');

  function isMobile(){ return window.matchMedia('(max-width: 639.98px)').matches; }

  function ensureSwitchBtn(){
    let btn = document.getElementById('mobile-split-switch');
    if (!btn){
      btn = document.createElement('button');
      btn.id = 'mobile-split-switch';
      btn.type = 'button';
      btn.textContent = 'SWITCH VIEW';
      document.body.appendChild(btn);
      btn.addEventListener('click', ()=>{
        const b = document.body;
        if (b.classList.contains('show-right')){
          b.classList.remove('show-right'); b.classList.add('show-left');
        } else {
          b.classList.remove('show-left'); b.classList.add('show-right');
        }
      });
    }
    return btn;
  }

  function removeSwitchBtn(){
    document.getElementById('mobile-split-switch')?.remove();
  }

  function applyMobileSolo(){
    const body = document.body;
    const activeSplit = modal && !modal.classList.contains('hidden') && modal.classList.contains('split-view');

    if (isMobile() && activeSplit){
      body.classList.add('mobile-solo');             // activa modo “solo uno”
      if (!body.classList.contains('show-left') && !body.classList.contains('show-right')){
        body.classList.add('show-right');            // por defecto: muestra el modal
      }
      ensureSwitchBtn();
    } else {
      body.classList.remove('mobile-solo','show-left','show-right');
      removeSwitchBtn();
    }
  }

  /* Observa cambios en el modal (cuando entras/sales de split-view) */
  if (modal){
    const mo = new MutationObserver(applyMobileSolo);
    mo.observe(modal, { attributes:true, attributeFilter:['class'] });
  }

  /* Recalcula al cargar y al redimensionar */
  window.addEventListener('load',   applyMobileSolo);
  window.addEventListener('resize', applyMobileSolo);

  /* Limpieza al cerrar fuerte el modal (engancha tu función existente) */
  const _hardCloseModal = window.hardCloseModal;
  window.hardCloseModal = function(){
    try{ _hardCloseModal && _hardCloseModal(); }finally{
      document.body.classList.remove('mobile-solo','show-left','show-right');
      removeSwitchBtn();
    }
  };
})();
</script>

<script>
  // Ocultar barras al seleccionar un item del TOC (h2, h3 o enlace)
  document.addEventListener('click', function (e) {
    const tocItem = e.target.closest(
      '#subcategoria-sidebar .toc-h2, ' +
      '#subcategoria-sidebar .toc-h3, ' +
      '#subcategoria-sidebar a, ' +
      '#subcategoria-sidebar .toc-a'
    );
    if (!tocItem) return;

    // Oculta barras laterales solo en móvil; en desktop se mantiene fijo
    const isMobile = window.matchMedia('(max-width: 639.98px)').matches;
    if (isMobile) {
      document.body.classList.add('bars-hidden');
    }

    // Quita el velo gris si estuviera activo
    const overlay = document.getElementById('mobile-overlay');
    if (overlay) overlay.classList.remove('show');
  });
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Solo el dropdown del TOPBAR
  const dd  = document.querySelector('#topbar #lang-dropdown');
  if (!dd) return;

  const langBtnTop  = dd.querySelector('#lang-btn');
  const langMenuTop = dd.querySelector('#lang-menu');

  langBtnTop.addEventListener('click', (e) => {
    e.stopPropagation();
    langMenuTop.classList.toggle('hidden');
  });

  // Cerrar si clic fuera
  document.addEventListener('click', (e) => {
    if (!dd.contains(e.target)) langMenuTop.classList.add('hidden');
  });
});
</script>

<script>
  (function () {
    const mq = window.matchMedia('(min-width: 640px)');

    function applyLayout() {
      const isDesktop = mq.matches;
      const body = document.body;
      const sidebar = document.getElementById('sidebar');
      const subcat  = document.getElementById('subcategoria-sidebar');

      if (isDesktop) {
        // Desktop: barras visibles
        body.classList.remove('bars-hidden');
        sidebar.classList.add('open');
        sidebar.classList.remove('collapsed','force-hidden');

        // La segunda barra solo si realmente la vas a usar
        if (!subcat.dataset.forceShow) subcat.classList.add('hidden');
      } else {
        // Móvil: ocultas por defecto
        body.classList.add('bars-hidden');
        sidebar.classList.remove('open');
        sidebar.classList.add('collapsed');
        subcat.classList.add('hidden');
      }
    }

    document.addEventListener('DOMContentLoaded', applyLayout);
    mq.addEventListener('change', applyLayout);
  })();
</script>

<!-- === Vaciar buscador al cambiar de segmento === -->
<script>
(function () {
  const input   = document.getElementById('global-search');
  const results = document.getElementById('search-results');

  function clearSearchBox() {
    if (!input) return;
    input.value = '';
    // dispara listeners que dependan de "input"
    input.dispatchEvent(new Event('input', { bubbles: true }));
    // oculta/limpia el dropdown si estuviera abierto
    if (results) { results.innerHTML = ''; results.classList.add('hidden'); }
  }

  // 1) Clic en enlaces de la sidebar (Home, Articles, etc.)
  document.getElementById('sidebar')?.addEventListener('click', (e) => {
    const a = e.target.closest('a');      // solo <a>, no botones de acordeón
    if (a) clearSearchBox();
  });

  // 2) Botones/enlaces fuera de la sidebar que navegan (p.ej. "Go to library")
  document.addEventListener('click', (e) => {
    const el = e.target.closest('a,button');
    if (!el || el.closest('#searchbox')) return; // no limpiar si el click es en el propio buscador
    const oc = el.getAttribute('onclick') || '';
    if (/(show(Home|Articles|SecondPanel|ThirdPanel)|goToLibraryArticles)/i.test(oc)) {
      clearSearchBox();
    }
  });

  // 3) Opción futura: si tu código emite un evento al cambiar de segmento
  // window.dispatchEvent(new Event('segment:change'))
  window.addEventListener('segment:change', clearSearchBox);
})();
</script>



<!-- === Aprendido === -->


<script>
  // Marca o desmarca un tema como aprendido para el usuario actual
  async function setLearned(topicId, on = true) {
    const uid = firebase.auth().currentUser.uid;
    const ref = db.doc(`users/${uid}/learned/${topicId}`);
    return on
      ? ref.set({ learned: true, ts: firebase.firestore.FieldValue.serverTimestamp() })
      : ref.delete();
  }

  // Devuelve true si el tema ya está aprendido por ese usuario
  async function isLearned(topicId) {
    const uid = firebase.auth().currentUser.uid;
    return (await db.doc(`users/${uid}/learned/${topicId}`).get()).exists;
  }
</script>




<!-- === recently === -->


<script>
(function(){
  const hasFirestore = !!(window.firebase && firebase.firestore);
  const db = hasFirestore ? (window.db || firebase.firestore()) : null;
  const COLLECTION = 'recentArticles';
  const RECENT_LIMIT = 10;

  const currentUid = () => firebase.auth().currentUser?.uid || null;

  const recentColl = (uid) => {
    if (!db || !uid) return null;
    return db.collection('users').doc(uid).collection(COLLECTION);
  };

  window.recordRecentArticle = async function(meta = {}) {
    const uid = currentUid();
    const coll = recentColl(uid);
    if (!uid || !coll) return;

    const { supracategoriaId, categoriaId, subcategoriaId, title } = meta;
    if (!supracategoriaId || !categoriaId || !subcategoriaId) return;

    const docId = [supracategoriaId, categoriaId, subcategoriaId].filter(Boolean).join('__');
    const payload = {
      supracategoriaId,
      categoriaId,
      subcategoriaId,
      title: title || subcategoriaId,
      viewedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
      await coll.doc(docId).set(payload, { merge: true });

      const snap = await coll.orderBy('viewedAt', 'desc').get();
      const excess = snap.docs.slice(RECENT_LIMIT);
      excess.forEach(d => d.ref.delete().catch(()=>{}));
    } catch (err) {
      console.error('recentArticles write error', err);
    }
  };

  let unsubscribe = null;
  let listEl = null;
  let emptyEl = null;
  let loadingEl = null;

  function ensureRefs() {
    if (listEl && emptyEl && loadingEl) return true;
    listEl = document.getElementById('recent-articles-list');
    emptyEl = document.getElementById('recent-articles-empty');
    loadingEl = document.getElementById('recent-articles-loading');
    return !!(listEl && emptyEl && loadingEl);
  }

  const escapeHtml = (str) => String(str ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  const escapeAttr = (str) => String(str ?? '').replace(/"/g, '&quot;');

  function setLoading(isLoading) {
    if (!ensureRefs()) return;
    loadingEl.classList.toggle('hidden', !isLoading);
  }

  function renderList(items) {
    if (!ensureRefs()) return;
    setLoading(false);
    const hasItems = items.length > 0;
    emptyEl.classList.toggle('hidden', hasItems);
    listEl.classList.toggle('hidden', !hasItems);

    if (!hasItems) {
      listEl.innerHTML = '';
      return;
    }

    listEl.innerHTML = items.map(item => {
      const title = escapeHtml(item.title || item.subcategoriaId || 'Article');
      const sup = escapeAttr(item.supracategoriaId);
      const cat = escapeAttr(item.categoriaId);
      const sub = escapeAttr(item.subcategoriaId);
      return `
        <li>
          <button type="button"
                  class="w-full flex items-stretch text-left hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-blue-500 transition"
                  data-recent-article
                  data-sup="${sup}"
                  data-cat="${cat}"
                  data-sub="${sub}">
            <span class="w-12 flex items-center justify-center border-r border-gray-200 py-2">
              <img src="./assets/iconopanel3b.png" alt="" class="w-3 h-5 opacity-80">
            </span>
            <span class="flex-1 pl-4 py-2 text-slate-700">${title}</span>
          </button>
        </li>
      `;
    }).join('');
  }

  function detachListener() {
    if (unsubscribe) {
      unsubscribe();
      unsubscribe = null;
    }
  }

  function attachListener(uid) {
    const coll = recentColl(uid);
    if (!coll) {
      renderList([]);
      setLoading(false);
      return;
    }

    detachListener();
    setLoading(true);
    unsubscribe = coll
      .orderBy('viewedAt', 'desc')
      .limit(RECENT_LIMIT)
      .onSnapshot(
        snap => {
          const items = snap.docs
            .map(doc => ({ id: doc.id, ...(doc.data() || {}) }))
            .filter(it => it.supracategoriaId && it.categoriaId && it.subcategoriaId);
          renderList(items);
        },
        err => {
          console.error('recentArticles listen error', err);
          renderList([]);
        }
      );
  }

  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      attachListener(user.uid);
    } else {
      detachListener();
      renderList([]);
    }
  });

  document.addEventListener('click', (event) => {
    const trigger = event.target.closest('[data-recent-article]');
    if (!trigger) return;
    const { sup, cat, sub } = trigger.dataset;
    if (!sup || !cat || !sub) return;
    if (typeof window.showSubcategoriaContent === 'function') {
      window.showSubcategoriaContent(sub, cat, sup);
    }
  });
})();
</script>





<!-- === Otro === -->

<script>
(function () {
  const input   = document.getElementById('global-search');
  const popover = document.getElementById('search-results');
  const box     = document.getElementById('searchbox');

  

  if (!input || !popover || !window.db) return;
  const db = window.db || firebase.firestore();

  // Util: quitar acentos y bajar a minúsculas (búsqueda insensible a tildes)
  const norm = s => (s || '')
    .toString()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .toLowerCase().trim();

  const HISTORY_LIMIT = 9;
  let cachedHistory = null;
  let activeIndex = -1;
  let typedValue = input.value || '';

  const getPopoverItems = () => Array.from(popover.querySelectorAll('.history-item'))
    .filter(btn => !btn.classList.contains('history-empty'));

  const getItemValue = (btn) => btn?.dataset.historyTerm
    || btn?.querySelector('span')?.textContent?.trim()
    || '';

  function setActiveItem(index) {
    const items = getPopoverItems();
    items.forEach((btn, i) => btn.classList.toggle('is-active', i === index));
    if (index >= 0 && index < items.length) {
      activeIndex = index;
      items[index].scrollIntoView({ block: 'nearest' });
      const value = getItemValue(items[index]);
      if (value) {
        input.value = value;
        input.setSelectionRange(value.length, value.length);
      }
    } else {
      activeIndex = -1;
      input.value = typedValue;
      input.setSelectionRange(input.value.length, input.value.length);
    }
  }

  const getActiveItem = () => {
    const items = getPopoverItems();
    return activeIndex >= 0 && activeIndex < items.length ? items[activeIndex] : null;
  };

  function moveActive(delta) {
    const items = getPopoverItems();
    if (!items.length) return;
    let next = activeIndex + delta;
    if (next < 0) next = items.length - 1;
    if (next >= items.length) next = 0;
    setActiveItem(next);
  }
  function setPopoverMode(mode) {
    const isHistory = mode === 'history';
    const isResults = mode === 'results';
    popover.classList.toggle('history-mode', isHistory);
    popover.classList.toggle('results-mode', isResults);
    if (isHistory || isResults) {
      popover.style.maxHeight = 'none';
      popover.style.overflowY = 'visible';
    } else {
      popover.style.maxHeight = '';
      popover.style.overflowY = '';
    }
    setActiveItem(-1);
  }

  const escapeHtml = (str) => String(str ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  const escapeAttr = (str) => String(str ?? '').replace(/"/g, '&quot;');

  const currentUid = () => firebase.auth().currentUser?.uid || null;

  const historyDoc = () => {
    const uid = currentUid();
    return uid && db ? db.collection('users').doc(uid) : null;
  };

  async function fetchSearchHistory(force = false) {
    if (!force && Array.isArray(cachedHistory)) return cachedHistory;
    const ref = historyDoc();
    if (!ref) return [];
    try {
      const snap = await ref.get();
      const raw = snap.exists ? snap.data()?.searchHistory || [] : [];
      const list = Array.isArray(raw) ? raw.filter(Boolean).slice(0, HISTORY_LIMIT) : [];
      cachedHistory = list;
      return list;
    } catch (err) {
      console.error('No se pudo leer el historial de búsqueda:', err);
      return [];
    }
  }

  async function saveSearchTerm(term) {
    const query = (term || '').trim();
    if (!query) return;
    const ref = historyDoc();
    if (!ref) return;
    try {
      const snap = await ref.get();
      const raw = snap.exists ? snap.data()?.searchHistory || [] : [];
      const existing = Array.isArray(raw) ? raw.filter(Boolean) : [];
      const updated = [query, ...existing.filter(item => item !== query)].slice(0, HISTORY_LIMIT);
      cachedHistory = updated;
      await ref.set({ searchHistory: updated }, { merge: true });
    } catch (err) {
      console.error('No se pudo guardar el historial de búsqueda:', err);
    }
  }

  function shortcutsFooter() {
    return `
      <div class="history-footer">
        <span><span class="history-shortcut">⌘+K</span> Open</span>
        <span><span class="history-shortcut">↑↓</span> Navigate suggestions</span>
        <span><span class="history-shortcut">Space</span> Use suggestion</span>
        <span><span class="history-shortcut">Enter</span> Submit</span>
      </div>
    `;
  }

  function renderHistoryPopover(items) {
    const listMarkup = items.length
      ? items.map(term => {
          const safeValue = escapeAttr(term);
          const safeLabel = escapeHtml(term);
          return `
            <button type="button"
                    class="history-item"
                    data-history-term="${safeValue}">
              <i class="fas fa-search history-icon"></i>
              <span>${safeLabel}</span>
            </button>
          `;
        }).join('')
      : '<div class="history-item history-empty">No search history yet.</div>';

    return `
      <div class="history-container">
        <div class="history-header">Search History</div>
        <div class="history-list">
          ${listMarkup}
        </div>
        ${shortcutsFooter()}
      </div>
    `;
  }

  function handleHistorySelection(term) {
    const query = (term || '').trim();
    if (!query) return;
    saveSearchTerm(query);
    input.value = query;
    input.focus();
    cachedHistory = (cachedHistory || []).filter(Boolean);
    last = '';
    searchNow(query);
    const evt = new Event('input', { bubbles: true });
    input.dispatchEvent(evt);
  }

  window.showSearchHistoryPopover = async function () {
    if (typeof t !== 'undefined') clearTimeout(t);
    const history = await fetchSearchHistory(true);
    setPopoverMode('history');
    popover.innerHTML = renderHistoryPopover(history);
    popover.classList.remove('hidden');
  };

  window.saveSearchTermForHistory = saveSearchTerm;

  // Pequeño índice en memoria con todas las subcategorías
  // Estructura: { label, subcategoriaId, categoriaId, supracategoriaId }
  let INDEX = [];
  let ready = false;

  // Construye índice la primera vez que el usuario está logueado
  firebase.auth().onAuthStateChanged(async (user) => {
    cachedHistory = null;
    if (!user || ready) return;
    try {
      // Busca en TODAS las colecciones 'subcategorias' (collection group)
      const snap = await db.collectionGroup('subcategorias').get();
INDEX = snap.docs.map(d => {
  const data = d.data() || {};
  const subId = d.id;

  // Ruta: supracategorias/{S}/categorias/{C}/subcategorias/{subId}
  const catDoc = d.ref.parent.parent;
  const supDoc = catDoc && catDoc.parent && catDoc.parent.parent;
  const catId  = catDoc ? catDoc.id : '';
  const supId  = supDoc ? supDoc.id : '';

  const label = data.denominacion || data.nombre || subId;

  // ←— NUEVO: normaliza keywords (array de strings)
  const kws = Array.isArray(data.keywords) ? data.keywords.filter(Boolean) : [];
  const kwNorm = kws.map(k => norm(k));

  // Puedes agregar otros campos al “haystack” si quieres (p. ej. descripcion)
  const haystack = norm(
    [label, ...(kws || []), data.descripcion || ''].join(' ')
  );

  return {
    label,
    labelNorm: norm(label),
    keywords: kws,
    kwNorm,               // keywords normalizados
    haystack,             // todo junto para búsquedas
    subcategoriaId: subId,
    categoriaId: catId,
    supracategoriaId: supId
  };
});
ready = true;
    } catch (e) {
      console.error('No se pudo construir el índice de búsqueda:', e);
    }
  });

  // Render de resultados
  function render(items) {
    setPopoverMode('results');

    const qTokens = norm(input.value).split(/\s+/).filter(Boolean);
    const listMarkup = items.slice(0, 12).map(it => {
      const hit = (it.keywords || []).find((kw, i) => {
        const n = it.kwNorm?.[i] || norm(kw);
        return qTokens.some(t => n.includes(t));
      });
      const badge = hit ? `<span class="history-badge">${hit}</span>` : '';

      return `
        <button type="button"
                class="history-item"
                data-sup="${it.supracategoriaId}"
                data-cat="${it.categoriaId}"
                data-sub="${it.subcategoriaId}">
          <i class="fas fa-search history-icon"></i>
          <span class="flex-1 text-slate-800">${it.label}</span>
          ${badge}
        </button>
      `;
    }).join('');

    const content = items.length
      ? listMarkup
      : '<div class="history-item history-empty">No search results. Please try another query.</div>';

    popover.innerHTML = `
      <div class="history-container">
        <div class="history-header">Search Results</div>
        <div class="history-list">
          ${content}
        </div>
        ${shortcutsFooter()}
      </div>
    `;

    popover.classList.remove('hidden');
  }

  function handleResultSelection(btn) {
    if (!btn) return;
    const { sup, cat, sub } = btn.dataset;
    const query = input.value.trim();
    if (query) saveSearchTerm(query);
    popover.classList.add('hidden');
    input.blur();
    if (typeof showSubcategoriaContent === 'function') {
      showSubcategoriaContent(sub, cat, sup);
    }
  }

  // Filtrar en memoria
  let last = '';
  


  function matchItem(item, qn) {
  // AND por tokens: "endo aureus" debe estar todo
  const tokens = qn.split(/\s+/).filter(Boolean);
  if (!tokens.length) return false;

  // buscamos en el “haystack” (label + keywords + descripcion)
  return tokens.every(t => item.haystack.includes(t));
}
  
  function searchNow(q) {
  const qn = norm(q);
  if (!ready || !qn) { popover.classList.add('hidden'); return; }
  if (qn === last) return;
  last = qn;

  const res = INDEX.filter(it => matchItem(it, qn));
  render(res);
}

  // Debounce suave
  let t;
  input.addEventListener('input', () => {
    clearTimeout(t);
    typedValue = input.value;
    if (document.activeElement === input && input.value.trim() === '') {
      if (typeof window.showSearchHistoryPopover === 'function') {
        window.showSearchHistoryPopover();
      }
      return;
    }
    t = setTimeout(() => searchNow(input.value), 120);
  });


  input.addEventListener('focus', () => {
    if (document.activeElement === input && input.value.trim() === '') {
      if (typeof window.showSearchHistoryPopover === 'function') {
        window.showSearchHistoryPopover();
      }
    } else {
      clearTimeout(t);
      last = '';
      searchNow(input.value);
    }
  });

  // Enter = ir al primer resultado
  input.addEventListener('keydown', (e) => {
    if ((e.key === 'ArrowDown' || e.key === 'ArrowUp') && !popover.classList.contains('hidden')) {
      e.preventDefault();
      const items = getPopoverItems();
      if (!items.length) return;
      if (activeIndex === -1) typedValue = input.value;
      if (e.key === 'ArrowDown') {
        if (activeIndex === -1) {
          setActiveItem(0);
        } else if (activeIndex === items.length - 1) {
          setActiveItem(-1);
        } else {
          moveActive(1);
        }
      } else {
        if (activeIndex === -1) {
          setActiveItem(items.length - 1);
        } else if (activeIndex === 0) {
          setActiveItem(-1);
        } else {
          moveActive(-1);
        }
      }
    } else if (e.key === 'Enter') {
      const active = getActiveItem();
      if (active) {
        e.preventDefault();
        active.click();
        return;
      }
      const first = popover.querySelector('button[data-sub]');
      if (first) {
        first.click();
      } else {
        const query = input.value.trim();
        if (query) saveSearchTerm(query);
      }
    } else if (e.key === 'Escape') {
      popover.classList.add('hidden');
    }
  });

  // Click en resultado -> abre la subcategoría con tu función existente
  // 1) Abrir contenido SOLO con clic real en un resultado
popover.addEventListener('mousedown', (e) => {
  const btn = e.target.closest('button[data-sub]');
  if (!btn) return;                   // no es un item
  // (mousedown no se dispara con Enter)
  handleResultSelection(btn);
});

popover.addEventListener('click', (e) => {
  const historyBtn = e.target.closest('[data-history-term]');
  if (historyBtn) {
    e.preventDefault();
    handleHistorySelection(historyBtn.dataset.historyTerm);
    return;
  }

  if (e.detail === 0) {
    const btn = e.target.closest('button[data-sub]');
    if (btn) handleResultSelection(btn);
  }
});

// 2) Con Enter: ocultar lista, NO abrir contenido
function hideOnEnter(e) {
  if (e.key === 'Enter') {
    e.preventDefault();               // evita click sintético del teclado
    e.stopPropagation();
    popover.classList.add('hidden');  // solo ocultar
    // input.blur();                  // si quieres mantener foco, no hagas blur
  }
}

// Enter desde el input de búsqueda:
input.addEventListener('keydown', hideOnEnter);

// (opcional) Enter cuando el foco está dentro del popover:
popover.addEventListener('keydown', hideOnEnter);


  // Cerrar si clic fuera
  document.addEventListener('click', (e) => {
    if (!box.contains(e.target)) popover.classList.add('hidden');
  });

  // Atajo ⌘+K / Ctrl+K para enfocar
  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'k') {
      e.preventDefault();
      input.focus();
      const len = input.value.length;
      input.setSelectionRange(len, len);
    }
  });
})();
</script>


<!-- === touchimagen === -->

<script>
(function () {
  var img = document.getElementById('modal-image');
  var area = document.getElementById('video-area');

  if (area) area.style.touchAction = 'none';
  if (img) {
    img.style.touchAction = 'none';
    img.style.willChange = 'transform'; // micro-mejora de rendimiento
    // Evita que Chrome intente scroll durante el arrastre
    img.addEventListener('touchmove', function (e) {
      e.preventDefault();
    }, { passive: false });
  }
})();
</script>

<!-- === icono cerrar en buscador === -->

<script>
  const searchInput = document.getElementById('global-search');
  const hint = document.getElementById('search-hint');
  const clearBtn = document.getElementById('search-clear');

  searchInput.addEventListener('input', () => {
    if (searchInput.value.trim() !== '') {
      hint.classList.add('hidden');
      clearBtn.classList.remove('hidden');
    } else {
      clearBtn.classList.add('hidden');
      hint.classList.remove('hidden');
    }
  });

  clearBtn.addEventListener('click', () => {
    searchInput.value = '';
    clearBtn.classList.add('hidden');
    hint.classList.remove('hidden');
    searchInput.focus();
    if (typeof window.showSearchHistoryPopover === 'function') {
      window.showSearchHistoryPopover();
    }
  });
</script>









<button id="mobile-split-switch" type="button">
  <i class="fas fa-arrow-left"></i><span>SWITCH VIEW</span>
</button>





</body>

</html>

<!-- === 17eeeeeee octubre noche nochiiilaeeeeee === -->
